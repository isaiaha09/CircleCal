name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: circlecalproject
    env:
      SECRET_KEY: 'ci-secret-key'

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-playwright pytest-django
        python -m playwright install

    - name: Clean DB
      run: |
        rm -f db.sqlite3 || true

    - name: Run Django migrations
      run: |
        python manage.py migrate --noinput

    - name: Run Django unit tests
      run: |
        python manage.py test

    - name: Seed test data for E2E (management command)
      run: |
        python manage.py seed_e2e > tests/e2e/seed_output.json

    - name: Start dev server for E2E
      run: |
        # Start the Django dev server in the background and wait for it to respond
        nohup python manage.py runserver 127.0.0.1:8000 &> tests/e2e/devserver.log &
        for i in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15; do
          if curl -sSf http://127.0.0.1:8000/ >/dev/null 2>&1; then
            echo "Server is up"
            break
          fi
          sleep 1
          if [ "$i" -eq 15 ]; then
            echo "Server did not start; output from devserver.log:"; tail -n 200 tests/e2e/devserver.log; exit 1
          fi
        done

    - name: Run Playwright E2E tests
      env:
        DJANGO_SETTINGS_MODULE: circlecalproject.settings
      run: |
        # Run Playwright E2E tests (retry once on failure to reduce flaky CI runs)
        pytest -q tests/e2e || (sleep 2 && pytest -q tests/e2e)

    - name: Upload E2E artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: e2e-artifacts
        path: |
          tests/e2e/devserver.log
          tests/e2e/seed_output.json
