<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <title>{% block title %}CircleCal{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="theme-color" content="#3b82f6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="CircleCal">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="manifest" href="/manifest.webmanifest">
    <link rel="icon" href="{% static 'icons/favicon.ico' %}" sizes="any">
    <link rel="icon" href="{% static 'icons/favicon-32x32.png' %}" sizes="32x32" type="image/png">
    <link rel="icon" href="{% static 'icons/favicon-16x16.png' %}" sizes="16x16" type="image/png">
    <link rel="icon" href="{% static 'icons/icon.svg' %}" type="image/svg+xml">
    <link rel="apple-touch-icon" href="{% static 'icons/apple-touch-icon.png' %}">

    {# iOS PWA splash screens require explicit startup images (manifest is ignored). #}
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-640x1136.png' %}" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-750x1334.png' %}" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-828x1792.png' %}" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1125x2436.png' %}" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1170x2532.png' %}" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1179x2556.png' %}" media="(device-width: 393px) and (device-height: 852px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1242x2208.png' %}" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1242x2688.png' %}" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1284x2778.png' %}" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1290x2796.png' %}" media="(device-width: 430px) and (device-height: 932px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1536x2048.png' %}" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1668x2224.png' %}" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1668x2388.png' %}" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-2048x2732.png' %}" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">

    {# Fallback: some newer devices and/or Display Zoom modes may not match exact device-width/device-height queries. #}
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1290x2796.png' %}" media="screen and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="{% static 'icons/splash/splash-1290x2796.png' %}">

    <!-- Tailwind (built via CLI for production; see package.json scripts) -->
    <link rel="stylesheet" href="{% static 'css/tailwind.min.css' %}">

        <script>
            // PWA: register service worker (no-op in unsupported browsers)
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/sw.js').catch(() => {});
                });
            }
        </script>

        <style>
                /* Two-factor specific styles: make token input visible and increase spacing */
                .twofactor-page input[type="text"],
                .twofactor-page input[type="tel"],
                .twofactor-page input[type="password"] {
                    border: 2px solid rgba(55,65,81,0.15); /* slightly stronger than default */
                    box-shadow: none;
                    padding: 0.5rem 0.75rem;
                    border-radius: 0.375rem;
                }

                .twofactor-page label.token-label {
                    display: block;
                    margin-bottom: 0.25rem;
                    font-weight: 600;
                    color: rgba(17,24,39,0.9);
                }

                .twofactor-page .twofactor-instructions p {
                    margin-top: 0.75rem;
                    margin-bottom: 0.75rem;
                    line-height: 1.5;
                }

                .twofactor-page .secret-value {
                    background: #f8fafc;
                    padding: 0.5rem 0.75rem;
                    border: 1px dashed rgba(55,65,81,0.12);
                    border-radius: 0.375rem;
                    display: inline-block;
                    margin-top: 0.5rem;
                    max-width: 100%;
                    white-space: normal;
                    overflow-wrap: anywhere;
                    word-break: break-all;
                }

                /* Some django-two-factor-auth templates render the secret as plain text (no .secret-value).
                   Ensure any long unbroken strings wrap instead of overflowing the card on mobile/desktop. */
                .twofactor-page {
                    max-width: 100%;
                    overflow-wrap: anywhere;
                    word-break: break-word;
                }
                .twofactor-page p,
                .twofactor-page li,
                .twofactor-page div,
                .twofactor-page span {
                    overflow-wrap: anywhere;
                    word-break: break-word;
                }
                .twofactor-page code,
                .twofactor-page pre,
                .twofactor-page kbd,
                .twofactor-page samp {
                    overflow-wrap: anywhere;
                    word-break: break-all;
                    max-width: 100%;
                }

                /* Mobile: make long secrets always fit without leaking */
                @media (max-width:640px) {
                    .twofactor-page .secret-value {
                        width: 100%;
                    }
                }

                /* Disable action: make links/buttons reading 'Disable' more prominent */
                .twofactor-disable-btn {
                    display: inline-flex;
                    align-items: center;
                    gap: 8px;
                    padding: 0.5rem 0.9rem;
                    border-radius: 0.5rem;
                    background: #ef4444; /* red-500 */
                    color: #ffffff;
                    text-decoration: none;
                    border: none;
                    font-weight: 600;
                    box-shadow: 0 6px 18px rgba(239,68,68,0.08);
                }
                .twofactor-disable-btn:hover { background: #dc2626; }
                @media (max-width:640px) {
                    .twofactor-disable-btn { width:100%; justify-content:center; }
                }

                /* Extra spacing for pages where 2FA is being disabled */
                .twofactor-disable-page {
                    padding: 2.25rem; /* larger container padding for clarity */
                }
                @media (max-width:640px) {
                    .twofactor-disable-page { padding: 1.25rem; }
                }

                /* Make the numeric generator/token input clearly visible (not blend into white) */
                .twofactor-page input#id_generator-token,
                .twofactor-page input[name="generator-token"] {
                    background: #ffffff; /* ensure pure white to contrast card */
                    border: 2px solid #cbd5e1; /* gray-300 */
                    padding: 0.375rem 0.75rem; /* slightly shorter vertically */
                    border-radius: 0.375rem;
                    box-shadow: inset 0 1px 2px rgba(2,6,23,0.04);
                    font-size: 1rem;
                    color: #0f172a;
                    display: inline-block;
                    width: 68%; /* a bit wider but leave room for actions */
                    max-width: 520px;
                    margin-right: 0.75rem; /* spacing if button sits inline */
                    margin-bottom: 0.75rem; /* spacing if stacked */
                    line-height: 1.4;
                }

                .twofactor-page input#id_generator-token:focus,
                .twofactor-page input[name="generator-token"]:focus {
                    outline: none;
                    border-color: #3b82f6; /* blue-500 */
                    box-shadow: 0 0 0 4px rgba(59,130,246,0.12);
                }

            /* Scoped styles for two-factor pages to make token fields clearer */
            .twofactor-page .cc-2fa-token,
            .twofactor-page .cc-2fa-token pre,
            .twofactor-page .cc-2fa-token textarea,
            .twofactor-page .cc-2fa-token input[type="text"],
            .twofactor-page pre,
            .twofactor-page code,
            .twofactor-page .token-field,
            .twofactor-page input[type="text"] {
                font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', 'Helvetica Neue', monospace;
                background: #f8fafc; /* light */
                border: 1px solid #cbd5e1; /* gray-300 */
                padding: 12px 14px;
                border-radius: 8px;
                font-size: 0.95rem;
                color: #0f172a;
                width: 100%;
                box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
                white-space: pre-wrap;
                word-break: break-word;
            }
            .twofactor-page .cc-2fa-token + .cc-2fa-actions { margin-top: 8px; }
            .twofactor-page .cc-2fa-actions .btn-copy { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; border:1px solid #e2e8f0; background:#fff; color:#0f172a; }
            .twofactor-page .cc-2fa-help { font-size:0.92rem; color:#475569; margin-top:8px; }
            /* Add more vertical spacing for paragraphs and list items inside two-factor card */
            .twofactor-page p,
            .twofactor-page li,
            .twofactor-page .help-text {
                margin-bottom: 0.9rem;
                line-height: 1.5;
            }
            /* Make token label and input stand out */
            .twofactor-page label[for*="token"], .twofactor-page .token-label {
                display:block; font-weight:600; margin-bottom:6px; color:#0f172a;
            }

            /* Shared button styles used across templates */
            .btn-primary {
                background: linear-gradient(90deg,#2563eb,#4f46e5);
                color: white;
                padding: .45rem .9rem;
                border-radius: .5rem;
                display: inline-block;
                min-width: 10rem;
                text-align: center;
                transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease;
                text-decoration: none;
            }
            .btn-ghost {
                background: transparent;
                border: 1px solid #e5e7eb;
                padding: .4rem .6rem;
                border-radius: .5rem;
                transition: background 120ms ease, border-color 120ms ease;
                text-decoration: none;
                color: inherit;
            }
            .btn-danger {
                background: white;
                border: 1px solid #f87171;
                color: #b91c1c;
                padding: .4rem .6rem;
                border-radius: .5rem;
                transition: transform 120ms ease, box-shadow 120ms ease;
                text-decoration: none;
            }
            .btn-primary, .btn-ghost, .btn-danger { cursor: pointer; }
            .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(37,99,235,0.12); filter: brightness(1.03); }
            .btn-ghost:hover { background: #f8fafc; border-color: #dbeafe; }
            .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(248,113,113,0.08); }
            /* Prevent horizontal page scroll and guard against wide carousel overflow */
            html, body { max-width: 100%; overflow-x: hidden; }

            /*
              Global modal behavior
              - Grey out the page (including navbar/footer)
              - Prevent background scroll/clicks
              - Works even when a modal is declared inside <main>
            */
            html.cc-modal-open,
            body.cc-modal-open {
                overflow: hidden !important;
                height: 100%;
            }
            body.cc-modal-open header,
            body.cc-modal-open main,
            body.cc-modal-open footer {
                filter: grayscale(1) brightness(0.9) opacity(0.55);
                pointer-events: none;
            }
            /* Ensure portaled modals stay interactive */
            body > .cc-portal-modal {
                pointer-events: auto;
            }

            /* Navbar: fixed only on home page */
            .cc-site-header { position: relative; }
            body[data-cc-home="1"] .cc-site-header {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                /* On the splash screen, the header border/shadow reads like a stray line above the logo.
                   Keep the header itself, but hide the divider until the user scrolls. */
                border-bottom-width: 0;
                box-shadow: none;
            }
            body[data-cc-home="1"] .cc-site-header.cc-home-header-scrolled {
                border-bottom-width: 1px;
                border-bottom-style: solid;
                border-bottom-color: rgba(229, 231, 235, 1); /* Tailwind gray-200 */
                box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Tailwind shadow-sm */
            }

            /* Navbar centered logo (always present; home crossfades it in via JS) */
            .cc-nav-center-logo {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%) translateY(var(--cc-nav-center-logo-y, 0px));
                opacity: var(--cc-nav-center-logo-opacity, 1);
                transition: opacity 520ms cubic-bezier(.2,.9,.2,1), transform 560ms cubic-bezier(.2,.9,.2,1);
                will-change: opacity, transform;
            }
            body[data-cc-home="1"] .cc-nav-center-logo {
                --cc-nav-center-logo-opacity: 0;
                --cc-nav-center-logo-y: -8px;
                pointer-events: none; /* JS enables once visible */
            }
            body[data-cc-home="0"] .cc-nav-center-logo {
                --cc-nav-center-logo-opacity: 1;
                --cc-nav-center-logo-y: 0px;
                pointer-events: auto;
            }
            .cc-nav-center-logo-img {
                width: 90px;
                height: 90px;
                object-fit: contain;
                filter: drop-shadow(0 10px 24px rgba(15,23,42,0.12));
            }
            @media (max-width: 640px) {
                /* Mobile: make the centered navbar logo noticeably larger */
                .cc-nav-center-logo-img { width: 92px; height: 92px; }
            }
            @media (min-width: 430px) and (max-width: 640px) {
                /* Larger phones: bump the logo further */
                .cc-nav-center-logo-img { width: 102px; height: 102px; }
            }

            /* Home splash (logo-only screen) */
            body[data-cc-home="1"] main { padding-top: var(--cc-home-header-h, 156px); }
            body[data-cc-home="1"] #cc-home-splash {
                position: relative;
                min-height: calc(100vh - var(--cc-home-header-h, 156px));
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 24px 16px;
            }

            /* Site-wide: subtle animated background blobs (disabled for embeds/custom-domain embeds) */
            body[data-cc-embed="0"] {
                position: relative;
            }
            body[data-cc-embed="0"]::before,
            body[data-cc-embed="0"]::after {
                content: "";
                position: fixed;
                width: 520px;
                height: 520px;
                border-radius: 9999px;
                filter: blur(64px);
                opacity: 0.55;
                pointer-events: none;
                z-index: 0;
            }
            body[data-cc-embed="0"]::before {
                top: -140px;
                left: -180px;
                background: radial-gradient(circle at 30% 30%, rgba(37,99,235,0.55), rgba(37,99,235,0) 62%);
                animation: ccHomeBlobA 18s ease-in-out infinite;
            }
            body[data-cc-embed="0"]::after {
                bottom: -180px;
                right: -220px;
                /* Match the same blue as the top-left blob */
                background: radial-gradient(circle at 70% 70%, rgba(37,99,235,0.55), rgba(37,99,235,0) 62%);
                animation: ccHomeBlobB 22s ease-in-out infinite;
            }

            /* Keep page content above the background blobs. Do NOT lower header z-index,
               otherwise the page content can sit on top of the navbar and block clicks. */
            body[data-cc-embed="0"] main,
            body[data-cc-embed="0"] footer {
                position: relative;
                z-index: 1;
            }

            @keyframes ccHomeBlobA {
                0% { transform: translate3d(0, 0, 0) scale(1); }
                50% { transform: translate3d(60px, 80px, 0) scale(1.15); }
                100% { transform: translate3d(0, 0, 0) scale(1); }
            }
            @keyframes ccHomeBlobB {
                0% { transform: translate3d(0, 0, 0) scale(1.05); }
                50% { transform: translate3d(-70px, -60px, 0) scale(1.18); }
                100% { transform: translate3d(0, 0, 0) scale(1.05); }
            }
            body[data-cc-home="1"] #cc-home-hero { scroll-margin-top: calc(var(--cc-home-header-h, 156px) + 12px); }
            body[data-cc-home="1"] #cc-home-hero-logo {
                position: relative;
                z-index: 1;
                transform: translateY(var(--cc-home-hero-logo-y, 0px)) scale(var(--cc-home-hero-logo-scale, 1));
                transform-origin: 50% 25%;
                opacity: calc(var(--cc-home-hero-logo-opacity, 1) * var(--cc-home-hero-logo-show, 0));
                z-index: 40; /* below header (z-50) so it can slide under */
                will-change: transform, opacity;
                transition: opacity 900ms ease;
                text-decoration: none;
                display: inline-flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            body[data-cc-home="1"] #cc-home-hero-logo .cc-home-splash-title {
                font-weight: 900;
                letter-spacing: 0.08em;
                text-transform: uppercase;
                text-align: center;
                margin-bottom: 18px;
                /* Gradient: blue on the left fading to black on the right */
                background: linear-gradient(90deg, #2563EB 0%, #0B1220 68%, #000000 100%);
                -webkit-background-clip: text;
                background-clip: text;
                color: transparent;
                font-size: clamp(26px, 3.2vw, 54px);
                line-height: 1.05;
                filter: drop-shadow(0 10px 26px rgba(15, 23, 42, 0.14));
            }
            body[data-cc-home="1"] #cc-home-hero-logo img {
                width: clamp(260px, 42vw, 560px);
                height: auto;
                object-fit: contain;
                filter: drop-shadow(0 18px 48px rgba(15,23,42,0.18));
            }
            @media (max-width: 640px) {
                body[data-cc-home="1"] #cc-home-hero-logo img { width: min(88vw, 430px); }
                /* Mobile: make the splash header much bigger */
                body[data-cc-home="1"] #cc-home-hero-logo .cc-home-splash-title { margin-bottom: 14px; font-size: 32px; }
            }

            @media (min-width: 430px) and (max-width: 640px) {
                /* Larger phones: extra bump so it reads like a real headline */
                body[data-cc-home="1"] #cc-home-hero-logo .cc-home-splash-title { font-size: 36px; }
            }

            /* Home: fade/slide-in reveals for hero content (used in index.html) */
            .cc-reveal {
                opacity: 0;
                transform: translateY(14px);
                filter: blur(3px);
                transition:
                    opacity 680ms ease,
                    transform 720ms cubic-bezier(.2,.9,.2,1),
                    filter 680ms ease;
                transition-delay: var(--cc-reveal-delay, 0ms);
                will-change: opacity, transform, filter;
            }
            .cc-reveal.cc-reveal-in {
                opacity: 1;
                transform: translateY(0);
                filter: blur(0);
            }

            @media (prefers-reduced-motion: reduce) {
                body[data-cc-embed="0"]::before,
                body[data-cc-embed="0"]::after {
                    animation: none !important;
                }
                .cc-reveal {
                    opacity: 1 !important;
                    transform: none !important;
                    filter: none !important;
                    transition: none !important;
                }
            }

            /* Allow visual overflow for large desktop carousels, but clamp on smaller screens
               to avoid creating a horizontal scrollbar when transforms/absolute positioning
               push children outside the viewport. */
            #pricing-carousel { overflow: visible; }
            @media (max-width: 1024px) {
                #pricing-carousel { overflow-x: hidden; }
                #pricing-track { position: relative; }
            }
            /* Ensure the mobile menu always sits above animated top-gradients
               so gradients remain visible but render underneath the nav. */
            #mobileMenu {
                z-index: 9999; /* keep menu above page content */
            }

            /* Mobile hamburger button should feel like a real button:
               - "pops up" when menu is open
               - returns "down" when menu closes
               (icon swap/rotation animation is handled in JS) */
            #mobileMenuBtn {
                padding: 8px;
                border-radius: 12px;
                /* Keep the soft "box" background visible even when not hovered/focused. */
                background-color: rgba(37, 99, 235, 0.06);
                border: 1px solid rgba(37, 99, 235, 0.10);
                /* Subtle inner shadow so the border feels "set in". */
                box-shadow:
                    inset 0px 0px 4px 3px rgba(34, 53, 97, 0.23);
                transition: transform 160ms ease, box-shadow 160ms ease, background-color 160ms ease, border-color 160ms ease;
                -webkit-tap-highlight-color: transparent;
            }
            #mobileMenuBtn:hover {
                background-color: rgba(37, 99, 235, 0.08);
                border-color: rgba(37, 99, 235, 0.14);
            }
            #mobileMenuBtn:active {
                transform: translateY(0px) scale(0.98);
            }
            #mobileMenuBtn.cc-mobile-menu-btn-open {
                background-color: #eff6ff; /* blue-50 */
                border-color: #bfdbfe; /* blue-200 */
                box-shadow:
                    inset 0 1px 0 rgba(255, 255, 255, 0.75),
                    inset 0 0 0 1px rgba(255, 255, 255, 0.50),
                    inset 0 -2px 10px rgba(15, 23, 42, 0.08),
                    0 10px 25px rgba(37, 99, 235, 0.18);
                transform: translateY(-2px);
            }

            /* Smoother icon morph (avoid transition-all on mobile). */
            #mobileMenuIconHamburger,
            #mobileMenuIconClose {
                transition: transform 220ms cubic-bezier(.22,.61,.36,1), opacity 180ms ease;
                will-change: transform, opacity;
                transform-origin: 50% 50%;
            }
            /* Make the panel a fixed stacking context so it always overlays
               the page (and its pseudo-elements), avoiding hide/show toggles. */
            #mobileMenuPanel {
                position: fixed;
                top: var(--cc-header-h, 72px);
                left: 0;
                right: 0;
                bottom: 0;
                z-index: 10000;
                /* preserve existing visuals */
                background: white;
                /* Smooth on mobile: compositor-friendly transform + momentum scrolling */
                -webkit-overflow-scrolling: touch;
                backface-visibility: hidden;
                will-change: transform;
                transform: translate3d(100%, 0, 0);
                transition: transform 280ms cubic-bezier(.22,.61,.36,1);
            }
            #mobileMenuPanel.cc-mobile-menu-panel-open {
                transform: translate3d(0, 0, 0);
            }

            /* Prevent background scroll on iOS while menu open (JS sets fixed positioning). */
            body.mobile-menu-open {
                overflow: hidden;
                touch-action: none;
            }
            body.mobile-menu-open #mobileMenuPanel {
                touch-action: pan-y;
            }
            /* Prevent decorative gradient bars appearing on menu items inside
               the mobile menu panel (we want gradients site-wide, but not on
               simple nav buttons). This only targets elements inside the
               menu panel and does not toggle based on open/close state. */
            #mobileMenuPanel .section-card::before,
            #mobileMenuPanel .border.rounded-lg::before,
            #mobileMenuPanel .rounded-lg::before,
            #mobileMenuPanel .section-card .section-title::before {
                display: none !important;
                height: 0 !important;
                background: none !important;
                content: none !important;
            }
        </style>

    {% block extra_head %}{% endblock %}
</head>

{% if request.GET.embed == '1' or request.custom_domain_organization %}
<body class="bg-transparent text-gray-900" data-cc-home="{% if request.path == '/' %}1{% else %}0{% endif %}" data-cc-embed="1">
{% else %}
<body class="bg-blue-50  text-gray-900" data-cc-home="{% if request.path == '/' %}1{% else %}0{% endif %}" data-cc-embed="0">
{% endif %}

    {% if request.GET.embed != '1' and not request.custom_domain_organization %}
    <header class="bg-white border-b shadow-sm relative z-50 cc-site-header">
        <div class="max-w-7xl mx-auto px-4 py-10 md:py-9">
            <div class="flex items-center relative">
                <!-- Left: Logo -->
                <a id="cc-nav-left-brand" href="{% url 'calendar_app:home' %}" class="font-bold text-2xl md:text-3xl text-blue-600">
                    CircleCal
                </a>

                <!-- Center: Home logo (appears after scroll on the home page) -->
                <a id="cc-nav-center-logo" href="{% url 'calendar_app:home' %}" aria-label="CircleCal home" class="cc-nav-center-logo">
                    <img src="{% static 'icons/circlecalicon-transparent-v4.png' %}" alt="CircleCal" class="cc-nav-center-logo-img" />
                </a>

                <!-- Mobile Menu Button -->
                <button id="mobileMenuBtn" class="md:hidden ml-auto text-gray-700 focus:outline-none" aria-label="Toggle menu" aria-expanded="false" aria-controls="mobileMenu">
                    <span class="relative block w-8 h-8">
                        <svg id="mobileMenuIconHamburger" class="absolute inset-0 w-8 h-8 transition-all duration-200 ease-in-out" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                        </svg>
                        <svg id="mobileMenuIconClose" class="absolute inset-0 w-8 h-8 transition-all duration-200 ease-in-out opacity-0 rotate-90" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </span>
                </button>

                <!-- Desktop Navigation -->
                {% if request.user.is_authenticated %}
                    {% if request.organization %}
                        {# If the current user's role for this org is staff/manager, show a restricted navbar #}
                        {% if user_org_role == 'staff' or user_org_role == 'manager' %}
                            <nav class="hidden md:flex items-center justify-end ml-auto space-x-6 text-lg lg:text-xl">
                                <a href="{% url 'calendar_app:dashboard' request.organization.slug %}" class="text-gray-700 hover:text-blue-600">Dashboard</a>
                                <form action="{% url 'accounts:logout' %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-base lg:text-lg">Logout</button>
                                </form>
                            </nav>
                        {% else %}
                            <nav class="hidden md:flex items-center justify-end ml-auto space-x-6 text-lg lg:text-xl">
                                <a href="{% url 'calendar_app:calendar' request.organization.slug %}" class="text-gray-700 hover:text-blue-600">Calendar</a>
                                <a href="{% url 'calendar_app:dashboard' request.organization.slug %}" class="text-gray-700 hover:text-blue-600">Dashboard</a>
                                <a href="{% url 'calendar_app:pricing_page' request.organization.slug %}" class="text-gray-700 hover:text-blue-600">Pricing</a>
                                <a href="{% url 'calendar_app:team_dashboard' request.organization.slug %}" class="text-gray-700 hover:text-blue-600">Staff</a>
                                <a href="{% url 'calendar_app:choose_business' %}" class="text-gray-700 hover:text-blue-600">Switch</a>
                                <form action="{% url 'accounts:logout' %}" method="post" class="inline">
                                    {% csrf_token %}
                                    <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-base lg:text-lg">Logout</button>
                                </form>
                            </nav>
                        {% endif %}
                    {% else %}
                        <nav class="hidden md:flex items-center justify-end ml-auto space-x-5 text-lg lg:text-xl">
                            <a href="{% url 'calendar_app:choose_business' %}" class="text-blue-600 font-medium">Create Business</a>
                            <form action="{% url 'accounts:logout' %}" method="post" class="inline">
                                {% csrf_token %}
                                <button type="submit" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-base lg:text-lg">Logout</button>
                            </form>
                        </nav>
                    {% endif %}
                {% else %}
                    <nav class="hidden md:flex items-center justify-end ml-auto space-x-5 text-lg lg:text-xl">
                        <a href="{% url 'calendar_app:about' %}" class="text-gray-700 hover:text-blue-600">About</a>
                        <a href="{% url 'accounts:login' %}" class="text-gray-700 hover:text-blue-600">Login</a>
                        <a href="{% url 'accounts:reactivate' %}" class="text-gray-700 hover:text-blue-600">Reactivate</a>
                        <a href="{% url 'calendar_app:signup' %}" class="text-blue-600 font-semibold">Sign Up</a>
                    </nav>
                {% endif %}
            </div>

        </div>
    </header>

    <!-- Mobile Navigation (slides in below header; header stays clickable) -->
    <div id="mobileMenu" class="hidden md:hidden fixed left-0 right-0 bottom-0 z-40 pointer-events-none" style="top: var(--cc-header-h, 72px); display: none; pointer-events: none;">
        <div id="mobileMenuPanel" class="absolute inset-0 bg-white transform translate-x-full transition-transform duration-200 ease-in-out overflow-y-auto pointer-events-none" style="pointer-events: none;">
            <div class="max-w-7xl mx-auto px-6 py-6 h-full">
                

                <nav class="mt-4 h-[calc(100%-3rem)] flex flex-col justify-between">
                    <div class="space-y-2">
                        {% if request.user.is_authenticated %}
                        {% if request.organization %}
                            {% if user_org_role == 'staff' or user_org_role == 'manager' %}
                                <a href="{% url 'calendar_app:dashboard' request.organization.slug %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Dashboard</a>
                            {% else %}
                                <a href="{% url 'calendar_app:dashboard' request.organization.slug %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Dashboard</a>
                                <a href="{% url 'calendar_app:calendar' request.organization.slug %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Calendar</a>
                                <a href="{% url 'calendar_app:pricing_page' request.organization.slug %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Pricing</a>
                                <a href="{% url 'calendar_app:team_dashboard' request.organization.slug %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Team</a>
                                <a href="{% url 'calendar_app:choose_business' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Switch Business</a>
                            {% endif %}
                        {% else %}
                            <a href="{% url 'calendar_app:choose_business' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-blue-600 font-medium">Create Business</a>
                        {% endif %}
                        {% else %}
                            <a href="{% url 'calendar_app:about' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">About</a>
                            <a href="{% url 'accounts:login' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Login</a>
                            <a href="{% url 'accounts:reactivate' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-gray-700 hover:text-blue-600">Reactivate</a>
                            <a href="{% url 'calendar_app:signup' %}" class="block w-full px-4 py-3 rounded-lg border border-gray-200 bg-white shadow-sm hover:shadow transition text-blue-600 font-semibold">Sign Up</a>
                        {% endif %}
                    </div>

                    <div class="pt-6">
                        {% if request.user.is_authenticated %}
                            <form action="{% url 'accounts:logout' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="w-full text-left px-4 py-3 bg-red-500 text-white rounded-lg shadow-sm hover:shadow transition hover:bg-red-600">Logout</button>
                            </form>
                        {% endif %}
                    </div>
                </nav>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Content -->
    <main class="{% block main_class %}max-w-6xl mx-auto px-4 py-6 md:p-6{% endblock %}">
        {% if messages %}
        <div class="mb-4 px-4 sm:px-0" role="status" aria-live="polite">
            <div class="mx-auto w-full max-w-3xl space-y-2">
                {% for message in messages %}
                    {% if message.tags == 'success' %}
                        <div class="px-4 py-3 rounded bg-green-100 text-green-800 text-center">{{ message }}</div>
                    {% elif message.tags == 'error' %}
                        <div class="px-4 py-3 rounded bg-red-100 text-red-800 text-center">{{ message }}</div>
                    {% else %}
                        <div class="px-4 py-3 rounded bg-blue-100 text-blue-800 text-center">{{ message }}</div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    {% if request.GET.embed != '1' and not request.custom_domain_organization %}
    <div id="cc-cookie-banner" class="hidden" style="position:fixed;left:0;right:0;bottom:0;z-index:10001;">
        <div class="bg-white border-t shadow-sm" style="padding-bottom: env(safe-area-inset-bottom);">
            <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                <div class="text-sm text-gray-700">
                    <div class="font-semibold text-gray-900">Cookies</div>
                    <p>
                         CircleCal only uses essential cookies to help the app work properly for certain functionalities such as to keep you signed in. They are required for core features like security and session authentication. 
                        <a href="{% url 'calendar_app:privacy' %}" class="text-blue-600 hover:underline">Learn more</a>.
                    </p>
                </div>
                <button id="cc-cookie-banner-dismiss" type="button" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm">
                    Ok
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            // Cookie banner: keep it outside <main> so it doesn't get covered by the footer's stacking context.
            const STORAGE_KEY = 'cc_cookie_banner_dismissed';

            let dismissed = false;
            try {
                dismissed = localStorage.getItem(STORAGE_KEY) === '1';
            } catch (e) {
                dismissed = false;
            }

            const banner = document.getElementById('cc-cookie-banner');
            const dismissBtn = document.getElementById('cc-cookie-banner-dismiss');
            if (banner && dismissBtn && !dismissed) {
                banner.classList.remove('hidden');
                dismissBtn.addEventListener('click', function () {
                    banner.classList.add('hidden');
                    try {
                        localStorage.setItem(STORAGE_KEY, '1');
                    } catch (e) {}
                });
            }
        })();
    </script>
    {% endif %}

    <script>
        (function () {
            // Exclusions: fixed overlays that are not "page modals".
            const EXCLUDE_IDS = new Set([
                'mobileMenu',
                'mobileMenuPanel',
                'toast-container',
                'cc-ios-install-overlay',
                'cc-ios-install-modal'
            ]);

            function isExcluded(el) {
                try {
                    if (!el) return true;
                    const id = (el.id || '').trim();
                    if (id && EXCLUDE_IDS.has(id)) return true;
                    if (id && (id.startsWith('mobileMenu') || id.startsWith('cc-ios-install'))) return true;
                    // Skip the mobile menu container/panel entirely
                    if (el.closest && el.closest('#mobileMenu')) return true;
                    return false;
                } catch (e) {
                    return true;
                }
            }

            function isFixedOverlay(el) {
                try {
                    if (isExcluded(el)) return false;
                    const cs = window.getComputedStyle(el);
                    if (!cs) return false;
                    if (cs.position !== 'fixed') return false;
                    // Heuristic: true overlays usually cover the viewport.
                    const r = el.getBoundingClientRect();
                    const coversW = r.width >= window.innerWidth * 0.85;
                    const coversH = r.height >= window.innerHeight * 0.5;
                    // Many modals are centered and the overlay/backdrop is the fixed element.
                    // If it's fixed and covers a lot, treat it as an overlay.
                    return coversW && coversH;
                } catch (e) {
                    return false;
                }
            }

            function isVisible(el) {
                try {
                    if (!el) return false;
                    if (el.getAttribute && el.getAttribute('aria-hidden') === 'true') return false;
                    const cs = window.getComputedStyle(el);
                    if (!cs) return false;
                    if (cs.display === 'none' || cs.visibility === 'hidden' || cs.opacity === '0') return false;
                    const rects = el.getClientRects();
                    return rects && rects.length > 0;
                } catch (e) {
                    return false;
                }
            }

            function findModalCandidates() {
                // Broad net; then filtered by computed style.
                const nodes = Array.from(document.querySelectorAll(
                    '[role="dialog"], [aria-modal="true"], [id*="modal" i], [class*="modal" i]'
                ));
                // Include known overlays that don't use role attributes.
                return nodes;
            }

            function portalOverlayToBody(el) {
                try {
                    if (!el || el.parentElement === document.body) return;
                    // Only portal fixed overlays (backdrops), not tiny dialogs.
                    if (!isFixedOverlay(el)) return;
                    // Keep it out of <main>'s stacking context.
                    el.classList.add('cc-portal-modal');
                    document.body.appendChild(el);
                } catch (e) {
                    // ignore
                }
            }

            function updateModalState() {
                try {
                    const candidates = findModalCandidates();
                    for (const el of candidates) {
                        portalOverlayToBody(el);
                    }

                    let anyOpen = false;
                    for (const el of candidates) {
                        if (isExcluded(el)) continue;
                        if (!isFixedOverlay(el)) continue;
                        if (isVisible(el)) { anyOpen = true; break; }
                    }
                    document.documentElement.classList.toggle('cc-modal-open', anyOpen);
                    document.body.classList.toggle('cc-modal-open', anyOpen);
                } catch (e) {
                    // ignore
                }
            }

            // Initial run and keep in sync.
            function start() {
                updateModalState();

                let raf = 0;
                const schedule = function () {
                    if (raf) return;
                    raf = window.requestAnimationFrame(function () {
                        raf = 0;
                        updateModalState();
                    });
                };

                const obs = new MutationObserver(function () { schedule(); });
                obs.observe(document.body, {
                    subtree: true,
                    childList: true,
                    attributes: true,
                    attributeFilter: ['class', 'style', 'hidden', 'aria-hidden']
                });

                window.addEventListener('resize', schedule);
                window.addEventListener('scroll', schedule, { passive: true });
            }

            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', start);
            } else {
                start();
            }
        })();
    </script>

            <!-- iOS Add-to-Home-Screen prompt (iOS has no native install banner) -->
            <div id="cc-ios-install-overlay" class="hidden" style="position:fixed;inset:0;z-index:99998;background:rgba(2,6,23,0.55);backdrop-filter:saturate(1.2) blur(4px);display:none;opacity:0;transition:opacity 220ms ease;"></div>
            <div id="cc-ios-install-modal" class="hidden" role="dialog" aria-modal="true" aria-labelledby="cc-ios-install-title" style="position:fixed;inset:0;z-index:99999;align-items:center;justify-content:center;padding:18px;display:none;opacity:0;transition:opacity 220ms ease;">
                <div style="width:100%;max-width:520px;background:#ffffff;border-radius:16px;box-shadow:0 24px 70px rgba(15,23,42,0.25);border:1px solid rgba(15,23,42,0.10);overflow:hidden;">
                    <div style="padding:16px 18px;border-bottom:1px solid rgba(15,23,42,0.08);display:flex;align-items:center;justify-content:space-between;gap:12px;">
                        <div>
                            <div id="cc-ios-install-title" style="font-size:16px;font-weight:800;letter-spacing:-0.2px;color:#0f172a;">Install CircleCal</div>
                            <div style="font-size:12.5px;color:rgba(15,23,42,0.72);margin-top:2px;">Add CircleCal to your Home Screen for quick access.</div>
                        </div>
                        <button id="cc-ios-install-close" type="button" aria-label="Close" style="background:transparent;border:0;cursor:pointer;padding:6px;border-radius:10px;">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6l12 12" stroke="#334155" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                        </button>
                    </div>
                    <div style="padding:16px 18px;color:#0f172a;">
                        <ol style="margin:0;padding-left:18px;color:rgba(15,23,42,0.85);line-height:1.55;">
                            <li>Tap the Share button in your browser.</li>
                            <li>Select <span style="font-weight:700;">Add to Home Screen</span>.</li>
                            <li>Confirm to install.</li>
                        </ol>
                        <div style="margin-top:12px;font-size:12px;color:rgba(15,23,42,0.65);">Note: iOS does not show an automatic install prompt like Chrome.</div>
                    </div>
                    <div style="padding:14px 18px;border-top:1px solid rgba(15,23,42,0.08);display:flex;justify-content:flex-end;gap:10px;">
                        <button id="cc-ios-install-notnow" type="button" class="btn-ghost" style="padding:8px 12px;">Not now</button>
                        <button id="cc-ios-install-ok" type="button" class="btn-primary" style="padding:8px 12px;">OK</button>
                    </div>
                </div>
            </div>

        <!-- Toast container + helper: used to replace alert() with non-blocking toasts -->
        <div id="toast-container" style="position:fixed;right:16px;top:16px;z-index:99999;display:flex;flex-direction:column;gap:8px;pointer-events:none"></div>
        <script>
            function createToastElement(type, msg) {
                const wrap = document.createElement('div');
                wrap.style.pointerEvents = 'auto';
                wrap.style.display = 'flex';
                wrap.style.alignItems = 'flex-start';
                wrap.style.gap = '10px';
                wrap.style.minWidth = '240px';
                wrap.style.maxWidth = '520px';
                wrap.style.padding = '10px 12px';
                wrap.style.borderRadius = '10px';
                wrap.style.boxShadow = '0 8px 28px rgba(15,23,42,0.12)';
                wrap.style.color = '#022047';
                wrap.style.fontSize = '13px';
                wrap.style.lineHeight = '1.25';
                wrap.style.opacity = '0';
                wrap.style.transition = 'opacity 180ms ease, transform 200ms ease';
                wrap.style.transform = 'translateY(-6px)';

                // color by type
                if (type === 'success') {
                    wrap.style.background = '#ECFDF5';
                    wrap.style.borderLeft = '4px solid #10B981';
                } else if (type === 'error') {
                    wrap.style.background = '#FEF2F2';
                    wrap.style.borderLeft = '4px solid #EF4444';
                } else if (type === 'warn' || type === 'warning') {
                    wrap.style.background = '#FFFBEB';
                    wrap.style.borderLeft = '4px solid #F59E0B';
                } else {
                    wrap.style.background = '#EFF6FF';
                    wrap.style.borderLeft = '4px solid #3B82F6';
                }

                // icon
                const icon = document.createElement('div');
                icon.style.flex = '0 0 20px';
                icon.style.marginTop = '2px';
                icon.innerHTML = ({
                    'success': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="#059669" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    'error': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 9v4" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17h.01" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M21 12A9 9 0 1 1 3 12a9 9 0 0 1 18 0z" stroke="#DC2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    'warning': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" stroke="#B45309" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 9v4" stroke="#B45309" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 17h.01" stroke="#B45309" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>',
                    'info': '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 16h-1v-4h-1" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 8h.01" stroke="#2563EB" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="12" r="9" stroke="#2563EB" stroke-width="2"/></svg>'
                })[type === 'warn' ? 'warning' : (type in {success:1,error:1,warning:1,info:1} ? type : 'info')];
                wrap.appendChild(icon);

                // content
                const content = document.createElement('div');
                content.style.flex = '1 1 auto';
                content.style.overflow = 'hidden';
                content.style.maxHeight = '6.5em';
                content.style.whiteSpace = 'normal';
                content.style.wordBreak = 'break-word';
                const text = document.createElement('div');
                text.textContent = msg;
                content.appendChild(text);
                wrap.appendChild(content);

                // close button
                const closeBtn = document.createElement('button');
                closeBtn.setAttribute('aria-label', 'Dismiss');
                closeBtn.style.marginLeft = '8px';
                closeBtn.style.flex = '0 0 auto';
                closeBtn.style.background = 'transparent';
                closeBtn.style.border = 'none';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.padding = '4px';
                closeBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M18 6L6 18M6 6l12 12" stroke="#374151" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                wrap.appendChild(closeBtn);

                closeBtn.addEventListener('click', () => {
                    try { wrap.style.opacity = '0'; wrap.style.transform = 'translateY(-6px)'; setTimeout(() => { wrap.remove(); }, 200); } catch(e){}
                });

                return wrap;
            }

            function showToast(type, msg, timeout=4200) {
                try {
                    const container = document.getElementById('toast-container');
                    if (!container) return null;
                    const el = createToastElement(type, msg);
                    container.appendChild(el);
                    // animate in
                    requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });

                    const ms = Number(timeout);
                    const shouldAutoDismiss = Number.isFinite(ms) && ms > 0;
                    let to = null;

                    if (shouldAutoDismiss) {
                        to = setTimeout(() => {
                            try { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(() => { try { el.remove(); } catch(e){} }, 220); } catch(e){}
                        }, ms);
                        // dismiss on click of body also
                        el.addEventListener('click', () => {
                            try { if (to) clearTimeout(to); } catch(e){}
                            try { el.style.opacity = '0'; setTimeout(() => { el.remove(); }, 220); } catch(e){}
                        });
                    }

                    // When timeout <= 0, toast stays until X is clicked.
                    return el;
                } catch (e) { console.error('showToast failed', e); }
            }

            // Override window.alert to use non-blocking toasts by default.
            try { window.alert = function(msg){ try { showToast('info', String(msg)); } catch(e){ /* fallback suppressed */ } }; } catch(e){}

            // iOS install prompt: show once on iOS when not already installed.
            (function() {
                function isIOS() {
                    try {
                        const ua = navigator.userAgent || '';
                        const platform = (navigator.userAgentData && navigator.userAgentData.platform) || navigator.platform || '';
                        const touchPoints = Number(navigator.maxTouchPoints || 0);

                        // Hard exclude obvious non-iOS platforms.
                        if (/Windows|Win32|Win64/i.test(platform) || /Windows NT/i.test(ua)) return false;

                        // iOS devices always have touch.
                        if (!Number.isFinite(touchPoints) || touchPoints < 1) return false;

                        // iPhone/iPod classic detection.
                        if (/iPad|iPhone|iPod/i.test(ua)) return true;

                        // iPadOS 13+: UA often contains "Macintosh" but also "Mobile".
                        if (/Macintosh/i.test(ua) && /Mobile/i.test(ua)) return true;

                        return false;
                    } catch (e) { return false; }
                }

                function isStandalone() {
                    try {
                        if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return true;
                    } catch (e) {}
                    try { if (window.navigator && window.navigator.standalone) return true; } catch (e) {}
                    return false;
                }

                function showIOSInstallModal() {
                    const overlay = document.getElementById('cc-ios-install-overlay');
                    const modal = document.getElementById('cc-ios-install-modal');
                    if (!(overlay && modal)) return;
                    try { overlay.classList.remove('hidden'); } catch (e) {}
                    try { modal.classList.remove('hidden'); } catch (e) {}
                    try { overlay.style.display = 'block'; } catch (e) {}
                    try { modal.style.display = 'flex'; } catch (e) {}

                    // Fade in (force a reflow so the transition always triggers)
                    try { overlay.style.opacity = '0'; } catch (e) {}
                    try { modal.style.opacity = '0'; } catch (e) {}
                    let card = null;
                    try {
                        // First child is the dialog card.
                        card = modal.firstElementChild;
                        if (card) {
                            const card = modal.firstElementChild;
                            card.style.transform = 'translateY(10px) scale(0.985)';
                            card.style.opacity = '0';
                        }
                    } catch (e) { card = null; }

                    try { void overlay.offsetHeight; } catch (e) {}
                    try { void modal.offsetHeight; } catch (e) {}
                    try { if (card) void card.offsetHeight; } catch (e) {}

                    setTimeout(() => {
                        try { overlay.style.opacity = '1'; } catch (e) {}
                        try { modal.style.opacity = '1'; } catch (e) {}
                        try {
                            if (card) {
                                card.style.transform = 'translateY(0) scale(1)';
                                card.style.opacity = '1';
                            }
                        } catch (e) {}
                    }, 0);
                }

                function hideIOSInstallModal() {
                    const overlay = document.getElementById('cc-ios-install-overlay');
                    const modal = document.getElementById('cc-ios-install-modal');

                    // Fade out then fully hide
                    try { if (overlay) overlay.style.opacity = '0'; } catch (e) {}
                    try { if (modal) modal.style.opacity = '0'; } catch (e) {}
                    try {
                        if (modal) {
                            const card = modal.firstElementChild;
                            if (card) {
                                card.style.transform = 'translateY(6px) scale(0.985)';
                                card.style.opacity = '0';
                            }
                        }
                    } catch (e) {}

                    setTimeout(() => {
                        try { if (overlay) overlay.classList.add('hidden'); } catch (e) {}
                        try { if (modal) modal.classList.add('hidden'); } catch (e) {}
                        try { if (overlay) overlay.style.display = 'none'; } catch (e) {}
                        try { if (modal) modal.style.display = 'none'; } catch (e) {}
                        try {
                            document.dispatchEvent(new CustomEvent('cc:iosInstallModalDismissed'));
                        } catch (e) {}
                    }, 240);
                }

                try {
                    let force = false;
                    try {
                        const qs = new URLSearchParams(location.search || '');
                        force = qs.get('cc_force_a2hs') === '1';
                    } catch (e) { force = false; }

                    if (!force) {
                        if (!isIOS()) return;
                        if (isStandalone()) return;
                        // Only prompt on the homepage.
                        try { if ((location && location.pathname) !== '/') return; } catch (e) {}
                    }

                    const key = 'cc_ios_a2hs_prompt_dismissed_v1';
                    if (!force) {
                        if (localStorage.getItem(key) === '1') return;
                    }

                    const dismiss = () => {
                        try { if (!force) localStorage.setItem(key, '1'); } catch (e) {}
                        hideIOSInstallModal();
                    };

                    function initIOSInstallPrompt() {
                        try {
                            const closeBtn = document.getElementById('cc-ios-install-close');
                            const notNowBtn = document.getElementById('cc-ios-install-notnow');
                            const okBtn = document.getElementById('cc-ios-install-ok');
                            const overlay = document.getElementById('cc-ios-install-overlay');
                            if (closeBtn) closeBtn.addEventListener('click', dismiss);
                            if (notNowBtn) notNowBtn.addEventListener('click', dismiss);
                            if (okBtn) okBtn.addEventListener('click', dismiss);
                            if (overlay) overlay.addEventListener('click', dismiss);
                        } catch (e) {}

                        // Slight delay so it doesn't feel like a hard-blocking gate.
                        setTimeout(() => {
                            try { showIOSInstallModal(); } catch (e) {}
                        }, 650);
                    }

                    // Initialize even if the page is already loaded (DevTools emulation can be quirky).
                    try {
                        if (document.readyState === 'complete' || document.readyState === 'interactive') {
                            setTimeout(initIOSInstallPrompt, 0);
                        } else {
                            document.addEventListener('DOMContentLoaded', initIOSInstallPrompt);
                        }
                        // Also handle bfcache restores.
                        window.addEventListener('pageshow', (evt) => {
                            try { if (evt && evt.persisted) initIOSInstallPrompt(); } catch (e) {}
                        });
                    } catch (e) {
                        try { window.addEventListener('load', initIOSInstallPrompt); } catch (e2) {}
                    }
                } catch (e) {}
            })();

        </script>

        {% block extra_scripts %}{% endblock %}

        <!-- Global loading overlay (site-wide) -->
        <div id="global-loading-overlay" class="hidden fixed inset-0 z-50 items-center justify-center bg-black bg-opacity-30">
            <div class="bg-white p-6 rounded-lg flex flex-col items-center shadow-lg">
                <div class="animate-spin rounded-full border-8 border-t-8 border-gray-200 h-16 w-16 mb-4" style="border-top-color:#2563EB"></div>
                <div class="text-gray-700">Loading</div>
            </div>
        </div>

        <script>
            // Global loading overlay helpers
            function showLoading(msg) {
                const ov = document.getElementById('global-loading-overlay');
                if (!ov) return;
                try {
                    if (msg) {
                        const txt = ov.querySelector('div.text-gray-700');
                        if (txt) txt.textContent = msg;
                    }
                } catch(e){}
                ov.classList.remove('hidden');
                ov.classList.add('flex');
            }
            function hideLoading() {
                const ov = document.getElementById('global-loading-overlay');
                if (!ov) return;
                ov.classList.add('hidden');
                ov.classList.remove('flex');
                try { const txt = ov.querySelector('div.text-gray-700'); if (txt) txt.textContent = 'Loading'; } catch(e){}
            }
            try { window.showLoading = showLoading; window.hideLoading = hideLoading; } catch(e){}
        </script>

        <!-- Loading utilities (site-wide) -->
        <script src="{% static 'js/loading.js' %}"></script>

        <!-- Mobile Menu Toggle -->
    <script>
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const mobileMenu = document.getElementById('mobileMenu');
        const mobileMenuPanel = document.getElementById('mobileMenuPanel');
        const mobileMenuCloseBtn = document.getElementById('mobileMenuCloseBtn');
        const mobileMenuIconHamburger = document.getElementById('mobileMenuIconHamburger');
        const mobileMenuIconClose = document.getElementById('mobileMenuIconClose');

        const _MOBILE_MENU_BTN_OPEN_CLASS = 'cc-mobile-menu-btn-open';

        function _setMobileMenuBtnOpen(isOpen) {
            if (!mobileMenuBtn) return;
            try {
                if (isOpen) mobileMenuBtn.classList.add(_MOBILE_MENU_BTN_OPEN_CLASS);
                else mobileMenuBtn.classList.remove(_MOBILE_MENU_BTN_OPEN_CLASS);
            } catch (e) {}
        }

        function _setMobileMenuIcon(isOpen) {
            if (!(mobileMenuIconHamburger && mobileMenuIconClose)) return;
            if (isOpen) {
                mobileMenuIconHamburger.classList.add('opacity-0', '-rotate-90');
                mobileMenuIconHamburger.classList.remove('opacity-100', 'rotate-0');
                mobileMenuIconClose.classList.remove('opacity-0', 'rotate-90');
                mobileMenuIconClose.classList.add('opacity-100', 'rotate-0');
            } else {
                mobileMenuIconHamburger.classList.remove('opacity-0', '-rotate-90');
                mobileMenuIconHamburger.classList.add('opacity-100', 'rotate-0');
                mobileMenuIconClose.classList.add('opacity-0', 'rotate-90');
                mobileMenuIconClose.classList.remove('opacity-100', 'rotate-0');
            }
        }

        const _MOBILE_MENU_TRANSITION_MS = 280;
        let _mobileMenuScrollY = 0;

        function _lockBodyScroll() {
            try {
                _mobileMenuScrollY = window.scrollY || 0;
            } catch (e) {
                _mobileMenuScrollY = 0;
            }
            // Preserve the scroll position so other UI (like the home logo crossfade)
            // doesn't think we're back at the top while body is position:fixed.
            try { document.body.dataset.ccLockedScrollY = String(Math.max(0, _mobileMenuScrollY || 0)); } catch (e) {}
            try {
                // iOS Safari ignores overflow:hidden in many cases; position:fixed is more reliable.
                document.body.style.position = 'fixed';
                document.body.style.top = (-_mobileMenuScrollY) + 'px';
                document.body.style.left = '0';
                document.body.style.right = '0';
                document.body.style.width = '100%';
            } catch (e) {}
        }

        function _unlockBodyScroll() {
            try {
                document.body.style.position = '';
                document.body.style.top = '';
                document.body.style.left = '';
                document.body.style.right = '';
                document.body.style.width = '';
            } catch (e) {}
            try { delete document.body.dataset.ccLockedScrollY; } catch (e) {}
            try {
                window.scrollTo(0, Math.max(0, _mobileMenuScrollY || 0));
            } catch (e) {}
        }

        function openMobileMenu() {
            if (!(mobileMenu && mobileMenuPanel)) return;
            try {
                const header = document.querySelector('header');
                const h = header ? header.offsetHeight : 72;
                document.documentElement.style.setProperty('--cc-header-h', (h || 72) + 'px');
            } catch (e) {}
            mobileMenu.classList.remove('hidden');
            // Do not rely solely on Tailwind utilities here; ensure behavior even if
            // a prebuilt CSS bundle is missing classes in some environments.
            try { mobileMenu.style.display = 'block'; } catch (e) {}
            try { mobileMenu.style.pointerEvents = 'auto'; } catch (e) {}
            try { mobileMenuPanel.style.pointerEvents = 'auto'; } catch (e) {}
            try { mobileMenu.classList.remove('pointer-events-none'); } catch (e) {}
            try { mobileMenuPanel.classList.remove('pointer-events-none'); } catch (e) {}
            _setMobileMenuBtnOpen(true);
            try { if (mobileMenuPanel) mobileMenuPanel.style.zIndex = '200'; } catch(e) {}
            try { document.body.classList.add('mobile-menu-open'); } catch(e) {}
            try { _lockBodyScroll(); } catch (e) {}

            // Ensure the initial transform is applied, then animate in.
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    try { mobileMenuPanel.classList.add('cc-mobile-menu-panel-open'); } catch (e) {}
                });
            });
            try { mobileMenuBtn.setAttribute('aria-expanded', 'true'); } catch (e) {}
            _setMobileMenuIcon(true);
        }

        function closeMobileMenu() {
            if (!(mobileMenu && mobileMenuPanel)) return;
            _setMobileMenuBtnOpen(false);
            // Immediately stop the panel from intercepting clicks while it animates out.
            try { mobileMenuPanel.classList.add('pointer-events-none'); } catch (e) {}
            try { mobileMenu.classList.add('pointer-events-none'); } catch (e) {}
            try { mobileMenuPanel.style.pointerEvents = 'none'; } catch (e) {}
            try { mobileMenu.style.pointerEvents = 'none'; } catch (e) {}
            try { mobileMenuPanel.classList.remove('cc-mobile-menu-panel-open'); } catch (e) {}
            try { mobileMenuBtn.setAttribute('aria-expanded', 'false'); } catch (e) {}
            _setMobileMenuIcon(false);

            const finish = () => {
                try { mobileMenu.classList.add('hidden'); } catch (e) {}
                try { mobileMenu.style.display = 'none'; } catch (e) {}
                try { if (mobileMenuPanel) mobileMenuPanel.style.zIndex = ''; } catch(e) {}
                try { document.body.classList.remove('mobile-menu-open'); } catch(e) {}
                try { _unlockBodyScroll(); } catch (e) {}
            };

            // Prefer transitionend for accuracy; fall back to a timeout.
            try {
                let done = false;
                const onEnd = (evt) => {
                    if (done) return;
                    if (evt && evt.target !== mobileMenuPanel) return;
                    done = true;
                    try { mobileMenuPanel.removeEventListener('transitionend', onEnd); } catch (e) {}
                    finish();
                };
                mobileMenuPanel.addEventListener('transitionend', onEnd);
                setTimeout(() => {
                    if (done) return;
                    done = true;
                    try { mobileMenuPanel.removeEventListener('transitionend', onEnd); } catch (e) {}
                    finish();
                }, _MOBILE_MENU_TRANSITION_MS + 80);
            } catch (e) {
                setTimeout(finish, _MOBILE_MENU_TRANSITION_MS + 80);
            }
        }

        if (mobileMenuBtn && mobileMenu && mobileMenuPanel) {
            mobileMenuBtn.addEventListener('click', () => {
                const isOpen = !mobileMenu.classList.contains('hidden');
                if (isOpen) closeMobileMenu();
                else openMobileMenu();
            });
        }
        if (mobileMenuCloseBtn) {
            mobileMenuCloseBtn.addEventListener('click', closeMobileMenu);
        }
        document.addEventListener('keydown', (e) => {
            if (e.key !== 'Escape') return;
            if (!mobileMenu || mobileMenu.classList.contains('hidden')) return;
            closeMobileMenu();
        });
    </script>

    <script>
        // Home page: animate big hero logo upward, then swap to centered nav logo.
        (function(){
            try {
                const body = document.body;
                if (!body || body.getAttribute('data-cc-home') !== '1') return;

                const splash = document.getElementById('cc-home-splash');
                const hero = document.getElementById('cc-home-hero');
                const heroLogo = document.getElementById('cc-home-hero-logo');
                const navLogo = document.getElementById('cc-nav-center-logo');
                const navLeftBrand = document.getElementById('cc-nav-left-brand');

                const header = document.querySelector('header.cc-site-header');
                if (!(splash && hero && heroLogo && navLogo && navLeftBrand && header)) return;

                // Ensure the logo is hidden until we explicitly reveal it (fade-in).
                try { heroLogo.style.setProperty('--cc-home-hero-logo-show', '0'); } catch (e) {}

                function easeInOutCubic(t) {
                    return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2;
                }

                let _scrollAnimId = 0;
                let _isAutoScrolling = false;

                function cancelAutoScroll() {
                    if (!_isAutoScrolling) return;
                    _isAutoScrolling = false;
                    _scrollAnimId++;
                }

                // On mobile, momentum scrolling + JS-driven scroll can feel rough.
                // If the user starts interacting, cancel the auto-scroll immediately.
                try {
                    const cancelEvents = ['touchstart', 'touchmove', 'pointerdown', 'wheel', 'keydown'];
                    cancelEvents.forEach((evt) => {
                        window.addEventListener(evt, cancelAutoScroll, { passive: true });
                    });
                } catch (e) {}

                function isTouchDevice() {
                    try {
                        const touchPoints = Number(navigator.maxTouchPoints || 0);
                        if (Number.isFinite(touchPoints) && touchPoints > 0) return true;
                        // Fallback for older browsers.
                        return ('ontouchstart' in window);
                    } catch (e) {
                        return false;
                    }
                }

                function nativeSmoothScrollTo(targetY) {
                    try {
                        window.scrollTo({ top: Math.max(0, targetY), behavior: 'smooth' });
                        return true;
                    } catch (e) {
                        return false;
                    }
                }

                function animateScrollTo(targetY, durationMs) {
                    const startY = window.scrollY || 0;
                    const delta = targetY - startY;

                    const effectiveDuration = Math.max(120, Number(durationMs) || 800);

                    // Respect reduced-motion preferences.
                    try {
                        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                            window.scrollTo(0, Math.max(0, targetY));
                            return;
                        }
                    } catch (e) {}

                    const id = ++_scrollAnimId;
                    _isAutoScrolling = true;

                    // Mobile browsers (especially iOS) tend to scroll more smoothly using the
                    // native smooth-scrolling implementation than a JS rAF loop.
                    // However, native smooth-scroll duration is browser-controlled and can feel
                    // way too fast. Only use native smooth-scroll for shorter durations.
                    if (isTouchDevice() && effectiveDuration <= 900) {
                        if (nativeSmoothScrollTo(targetY)) {
                            // Best-effort: mark complete after the intended duration.
                            setTimeout(() => {
                                if (id === _scrollAnimId) _isAutoScrolling = false;
                            }, effectiveDuration);
                            return;
                        }
                    }

                    const start = performance.now();

                    function step(now) {
                        if (id !== _scrollAnimId) return;
                        const t = Math.max(0, Math.min(1, (now - start) / effectiveDuration));
                        const eased = easeInOutCubic(t);
                        try { window.scrollTo(0, startY + delta * eased); } catch (e) {}
                        if (t < 1) requestAnimationFrame(step);
                        else if (id === _scrollAnimId) _isAutoScrolling = false;
                    }

                    requestAnimationFrame(step);
                }

                function isIOSLike() {
                    try {
                        const ua = navigator.userAgent || '';
                        const platform = (navigator.userAgentData && navigator.userAgentData.platform) || navigator.platform || '';
                        const touchPoints = Number(navigator.maxTouchPoints || 0);
                        if (/Windows|Win32|Win64/i.test(platform) || /Windows NT/i.test(ua)) return false;
                        if (!Number.isFinite(touchPoints) || touchPoints < 1) return false;
                        if (/iPad|iPhone|iPod/i.test(ua)) return true;
                        if (/Macintosh/i.test(ua) && /Mobile/i.test(ua)) return true;
                        return false;
                    } catch (e) { return false; }
                }

                function shouldWaitForIOSModal() {
                    try {
                        if (!isIOSLike()) return false;
                        // If already installed, don't wait.
                        try {
                            if (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) return false;
                        } catch (e) {}
                        try { if (window.navigator && window.navigator.standalone) return false; } catch (e) {}

                        // If user already dismissed in the past, don't wait.
                        try {
                            const key = 'cc_ios_a2hs_prompt_dismissed_v1';
                            if (localStorage.getItem(key) === '1') return false;
                        } catch (e) {}

                        return true;
                    } catch (e) {
                        return false;
                    }
                }

                function revealHeroLogo() {
                    try { heroLogo.style.setProperty('--cc-home-hero-logo-show', '1'); } catch (e) {}
                }

                function getHeaderH() {
                    try { return header.offsetHeight || 156; } catch (e) { return 156; }
                }

                function setHeaderVar() {
                    const h = getHeaderH();
                    try { document.documentElement.style.setProperty('--cc-home-header-h', h + 'px'); } catch (e) {}
                }

                function getHeroTargetY() {
                    const h = getHeaderH();
                    try {
                        const r = hero.getBoundingClientRect();
                        return Math.max(0, Math.round((window.scrollY || 0) + r.top - h - 10));
                    } catch (e) {
                        return 220;
                    }
                }

                // Fade-in behavior: on iOS, wait until the A2HS modal is dismissed.
                if (shouldWaitForIOSModal()) {
                    try {
                        document.addEventListener('cc:iosInstallModalDismissed', () => {
                            // let the modal fade out first
                            setTimeout(() => { try { revealHeroLogo(); } catch (e) {} }, 80);
                        }, { once: true });
                    } catch (e) {}
                } else {
                    setTimeout(revealHeroLogo, 120);
                }

                // Click: scroll down to the hero header (stop when header is near top). Slow + smooth.
                try {
                    heroLogo.addEventListener('click', (ev) => {
                        try { ev.preventDefault(); } catch (e) {}
                        setHeaderVar();
                        const y = getHeroTargetY();
                        animateScrollTo(y, 2400);
                    });
                } catch (e) {}

                // Nav logo: scroll back to the top (splash). Slow + smooth.
                try {
                    navLogo.addEventListener('click', (ev) => {
                        try { ev.preventDefault(); } catch (e) {}
                        animateScrollTo(0, 1600);
                    });
                } catch (e) {}

                let ticking = false;

                function updateHomeLogo() {
                    ticking = false;
                    let y = window.scrollY || 0;
                    // When the mobile menu opens we lock the body with position:fixed.
                    // Many mobile browsers report window.scrollY as 0 in that state,
                    // which would incorrectly fade the nav logo out on the home screen.
                    try {
                        if (isTouchDevice && isTouchDevice() && document.body.classList.contains('mobile-menu-open')) {
                            const locked = Number(document.body.dataset.ccLockedScrollY);
                            if (Number.isFinite(locked) && locked >= 0) y = locked;
                        }
                    } catch (e) {}

                    // Hide the header divider line on the splash (top), restore once scrolled.
                    try { header.classList.toggle('cc-home-header-scrolled', y > 6); } catch (e) {}

                    setHeaderVar();
                    const targetY = Math.max(180, getHeroTargetY());
                    const p = Math.max(0, Math.min(1, y / targetY));

                    // Crossfade: big logo fades out as we approach the hero header;
                    // nav logo fades in smoothly at the same time.
                    // Keep the big logo around longer; fade more gradually (jptvt.com-like pacing).
                    const crossStart = 0.26;
                    const crossEnd = 0.92;
                    const t = Math.max(0, Math.min(1, (p - crossStart) / (crossEnd - crossStart)));
                    const smooth = t * t * (3 - 2 * t); // smoothstep
                    const fade = Math.pow(smooth, 1.35); // slower fade-in/out (vs linear)

                    const risePx = Math.round(180 * p);
                    const scale = (1 - 0.22 * p);
                    const opacity = (1 - fade);

                    const navOpacity = fade;
                    // Move UP from below (positive -> 0), not down from above.
                    const navY = Math.round((14) * (1 - fade));

                    try {
                        heroLogo.style.setProperty('--cc-home-hero-logo-y', (-risePx) + 'px');
                        heroLogo.style.setProperty('--cc-home-hero-logo-scale', String(scale));
                        heroLogo.style.setProperty('--cc-home-hero-logo-opacity', String(Math.max(0, Math.min(1, opacity))));
                    } catch (e) {}

                    try {
                        navLogo.style.setProperty('--cc-nav-center-logo-opacity', String(Math.max(0, Math.min(1, navOpacity))));
                        navLogo.style.setProperty('--cc-nav-center-logo-y', navY + 'px');
                        navLogo.style.pointerEvents = navOpacity > 0.2 ? 'auto' : 'none';
                    } catch (e) {}
                }

                function onScroll() {
                    if (ticking) return;
                    ticking = true;
                    window.requestAnimationFrame(updateHomeLogo);
                }

                window.addEventListener('scroll', onScroll, { passive: true });
                window.addEventListener('resize', onScroll);
                updateHomeLogo();
            } catch (e) {}
        })();
    </script>

    <script>
        // Home page: subtle reveal-on-scroll for hero content.
        (function(){
            try {
                const body = document.body;
                if (!body || body.getAttribute('data-cc-home') !== '1') return;

                const reduceMotion = !!(window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches);
                const els = Array.from(document.querySelectorAll('.cc-reveal'));
                if (!els.length) return;

                if (reduceMotion || !('IntersectionObserver' in window)) {
                    els.forEach(el => el.classList.add('cc-reveal-in'));
                    return;
                }

                const obs = new IntersectionObserver((entries) => {
                    entries.forEach(entry => {
                        if (!entry.isIntersecting) return;
                        try { entry.target.classList.add('cc-reveal-in'); } catch (e) {}
                        try { obs.unobserve(entry.target); } catch (e) {}
                    });
                }, { threshold: 0.12, rootMargin: '0px 0px -8% 0px' });

                els.forEach(el => obs.observe(el));

                // Safety: reveal anything already in view shortly after load.
                setTimeout(() => {
                    els.forEach(el => {
                        try {
                            const r = el.getBoundingClientRect();
                            if (r.top < window.innerHeight * 0.92) el.classList.add('cc-reveal-in');
                        } catch (e) {}
                    });
                }, 160);
            } catch (e) {}
        })();
    </script>

    <script>
        // If we're on two-factor pages, wrap the page content in a centered card
        (function(){
            try{
                const path = window.location.pathname || '';
                if (!(path.startsWith('/two_factor') || path.indexOf('/two_factor/') !== -1 || path.indexOf('/accounts/two_factor') !== -1)) return;
                const main = document.querySelector('main');
                if (!main) return;
                // Find existing messages container (leave it above the wrapper)
                const msgs = main.querySelector('.mb-4.space-y-2');
                // Create wrapper card
                const card = document.createElement('div');
                card.className = 'max-w-3xl mx-auto bg-white border border-blue-100 rounded-xl p-6 shadow-sm twofactor-page relative';
                card.style.marginTop = '16px';
                card.style.marginBottom = '16px';

                // Move all children except messages into the card
                const children = Array.from(main.children);
                children.forEach(ch => {
                    if (msgs && ch === msgs) return; // keep messages outside
                    card.appendChild(ch);
                });

                // Remove moved children from main (they were moved by appendChild)
                // Insert card after messages (or at start of main)
                if (msgs && msgs.parentNode === main) {
                    main.insertBefore(card, msgs.nextSibling);
                } else {
                    main.insertBefore(card, main.firstChild);
                }
                // Add a bottom 'Back to profile' link and enhance disable pages
                try {
                    const profileUrl = "{% url 'accounts:profile' %}";
                    // bottom back link for mobile/stacked layouts (kept only)
                    const bottomLink = document.createElement('div');
                    bottomLink.className = 'mt-4';
                    bottomLink.innerHTML = `<a href="${profileUrl}" class="text-sm text-blue-600 hover:underline"> Back to profile</a>`;
                    card.appendChild(bottomLink);

                    // Find and restyle any 'Disable' actions inside the card to be prominent buttons
                    try {
                        const candidates = Array.from(card.querySelectorAll('a, button, input[type="submit"], input[type="button"]'));
                        const disableEls = candidates.filter(el => {
                            const txt = (el.textContent || el.value || '').trim();
                            return /\bdisable\b/i.test(txt);
                        });
                        if (disableEls.length > 0) {
                            card.classList.add('twofactor-disable-page');
                        }
                        disableEls.forEach(el => {
                            el.classList.add('twofactor-disable-btn');
                            if (el.tagName.toLowerCase() === 'a') el.setAttribute('role', 'button');
                        });
                    } catch(e){ console.warn('twofactor: failed to style disable actions', e); }
                } catch(e){ console.warn('failed adding profile links', e); }
            }catch(e){ console.warn('two-factor wrapper failed', e); }
        })();
    </script>

        

    {% if request.GET.embed != '1' and not request.custom_domain_organization %}
    <!-- Footer -->
    <footer class="bg-white border-t mt-12 py-8">
        <div class="max-w-7xl mx-auto px-4">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <!-- About -->
                <div>
                    <h3 class="font-bold text-lg mb-3">CircleCal</h3>
                    <p class="text-gray-600 text-sm">Your all-in-one scheduling and booking platform. Manage appointments, availability, and teams effortlessly.</p>
                </div>

                <!-- Quick Links -->
                <div>
                    <h3 class="font-bold text-lg mb-3">Quick Links</h3>
                    <ul class="space-y-2 text-sm">
                        {% if request.user.is_authenticated and request.organization %}
                            <li><a href="{% url 'calendar_app:calendar' request.organization.slug %}" class="text-gray-600 hover:text-blue-600">Calendar</a></li>
                            <li><a href="{% url 'calendar_app:dashboard' request.organization.slug %}" class="text-gray-600 hover:text-blue-600">Dashboard</a></li>
                            <li><a href="{% url 'calendar_app:pricing_page' request.organization.slug %}" class="text-gray-600 hover:text-blue-600">Pricing</a></li>
                            <li><a href="{% url 'calendar_app:privacy' %}" class="text-gray-600 hover:text-blue-600">Privacy Policy</a></li>
                            <li><a href="{% url 'calendar_app:team_dashboard' request.organization.slug %}" class="text-gray-600 hover:text-blue-600">Team</a></li>
                            <li><a href="{% url 'calendar_app:terms' %}" class="text-gray-600 hover:text-blue-600">Terms of Service</a></li>
                        {% else %}
                            <li><a href="{% url 'accounts:login' %}" class="text-gray-600 hover:text-blue-600">Login</a></li>
                            <li><a href="{% url 'calendar_app:signup' %}" class="text-gray-600 hover:text-blue-600">Sign Up</a></li>
                            <li><a href="{% url 'calendar_app:privacy' %}" class="text-gray-600 hover:text-blue-600">Privacy Policy</a></li>
                            <li><a href="{% url 'calendar_app:terms' %}" class="text-gray-600 hover:text-blue-600">Terms of Service</a></li>
                        {% endif %}
                    </ul>
                </div>

                <!-- Contact -->
                <div>
                    <h3 class="font-bold text-lg mb-3">Contact</h3>
                    <ul class="space-y-2 text-sm text-gray-600">
                        <li><a href="{% url 'calendar_app:contact' %}" class="text-gray-600 hover:text-blue-600">CircleCal Support</a></li>
                    </ul>
                </div>
            </div>

            <!-- Copyright -->
            <div class="mt-8 pt-6 border-t text-center text-sm text-gray-500 space-y-2">
                <div>
                    Copyright &copy; 2025 CircleCal - All rights reserved.
                </div>
                <div class="text-xs text-gray-500">
                    <strong>Refund Policy (CircleCal)</strong>: Bookings and payments processed through CircleCal are subject to the platform Terms of Service. Merchants may define their own refund policy per service.
                </div>
                
            </div>
        </div>
    </footer>
    {% endif %}
</body>
</html>
