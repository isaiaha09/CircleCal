{% extends "calendar_app/base.html" %}
{% block title %}Custom Domain – {{ org.name }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
    <div class="flex items-center justify-between mb-4">
        <h1 class="text-2xl font-bold text-blue-700">Custom Domain</h1>
        <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-blue-700 font-semibold hover:underline">← Back</a>
    </div>

    {% if not can_use_custom_domain %}
        <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
            <div class="font-semibold text-blue-900">Upgrade required</div>
            <div class="text-blue-800 text-sm mt-1">Custom domains require an active Pro or Team plan (not trial).</div>
        </div>
    {% endif %}

    <div class="bg-white border border-blue-100 rounded-xl p-6 shadow-lg mt-4">
        <h2 class="text-lg font-bold text-blue-700">Domain</h2>
        <p class="text-sm text-gray-600 mt-1">
            Use a subdomain like <span class="font-mono">booking.yoursite.com</span>.
            This does <span class="font-semibold">not</span> replace your website — it’s the URL your embedded booking widget loads from so bookings can stay inside your site.
        </p>
        <p class="text-sm text-gray-600 mt-2">If you don’t own a domain yet, you’ll need to purchase one before you can set up a custom booking subdomain.</p>

        <div class="mt-4 bg-blue-50 border border-blue-100 rounded-xl p-4 text-sm text-blue-900">
            <div class="font-semibold">Embed vs Custom Domain</div>
            <div class="mt-2 space-y-1 text-blue-800">
                <div><span class="font-semibold">Embed</span> = the iframe code you paste into your website.</div>
                <div><span class="font-semibold">Custom domain</span> = your booking subdomain pointing to CircleCal (recommended) so the booking flow stays reliably inside the iframe.</div>
                <div class="mt-2 pt-2 border-t border-blue-100">
                    <span class="font-semibold">Good to know:</span> Changing your business name or your public URL (slug) does <span class="font-semibold">not</span> require updating DNS or re-verifying your custom domain.
                    You only need DNS changes if you change the actual subdomain (example: <span class="font-mono">booking.yoursite.com</span> → <span class="font-mono">schedule.yoursite.com</span>).
                </div>
                <div>
                    If you change your slug, just re-copy the embed code from the Services page (so your website uses the latest link).
                </div>
                <div class="mt-2">Get your iframe code here: <a href="{% url 'calendar_app:services_page' org.slug %}" class="font-semibold underline">Services →</a></div>
            </div>
        </div>

        <form method="post" class="mt-4">
            {% csrf_token %}
            <input type="hidden" name="action" value="set_domain" />
            <label class="block text-sm font-semibold text-blue-800">Custom domain</label>
            <div class="flex flex-col sm:flex-row gap-2 mt-2">
                <input name="custom_domain" value="{{ org.custom_domain|default:'' }}" placeholder="booking.yoursite.com"
                       class="flex-1 w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600"
                       {% if not can_use_custom_domain %}disabled{% endif %} />
                <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-xl hover:bg-blue-700" {% if not can_use_custom_domain %}disabled{% endif %}>Save</button>
            </div>
        </form>

        {% if org.custom_domain %}
            <div class="mt-4 text-sm">
                <div>
                    <span class="font-semibold text-blue-800">Status:</span>
                    {% if org.custom_domain_verified %}
                        <span class="text-green-700 font-semibold">Verified</span>
                    {% else %}
                        <span class="text-yellow-700 font-semibold">Not verified</span>
                    {% endif %}
                </div>
            </div>

            {% if txt_name and txt_value %}
                <div class="mt-4 bg-blue-50 border border-blue-100 rounded-xl p-6">
                    <div class="font-semibold text-blue-900">DNS verification (TXT)</div>
                    <p class="text-sm text-gray-600 mt-1">Add this TXT record to prove you own the domain:</p>
                    <div class="mt-3 text-sm">
                        <div class="text-blue-800"><span class="font-semibold">Name</span></div>
                        <div class="mt-2 font-mono text-xs bg-white border border-blue-100 rounded-xl p-3">{{ txt_name }}</div>
                        <div class="text-blue-800 mt-4"><span class="font-semibold">Value</span></div>
                        <div class="mt-2 font-mono text-xs bg-white border border-blue-100 rounded-xl p-3">{{ txt_value }}</div>
                    </div>

                    <form method="post" class="mt-4">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="verify_domain" />
                        <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-xl hover:bg-blue-700" {% if not can_use_custom_domain %}disabled{% endif %}>Verify</button>
                    </form>
                </div>
            {% endif %}

            <form method="post" class="mt-4" onsubmit="return confirm('Remove this custom domain?');">
                {% csrf_token %}
                <input type="hidden" name="action" value="remove_domain" />
                <button type="submit" class="text-red-600 hover:text-red-800 font-semibold text-sm" {% if not can_use_custom_domain %}disabled{% endif %}>Remove custom domain</button>
            </form>
        {% endif %}
    </div>

    {% if render_enabled and is_owner %}
        <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-lg">
            <h2 class="text-lg font-bold text-blue-700">Internal domain provisioning</h2>
            <p class="text-sm text-gray-600 mt-1">
                This section is visible to owners only. It helps you confirm the app can automatically attach verified domains and provision HTTPS.
            </p>

            <form method="post" class="mt-3">
                {% csrf_token %}
                <input type="hidden" name="action" value="test_render_api" />
                <button type="submit" class="bg-blue-600 text-white font-semibold px-4 py-3 rounded-xl hover:bg-blue-700">Test API connection</button>
            </form>

            {% if render_verification_status %}
                <p class="text-sm text-gray-700 mt-3"><span class="font-semibold text-blue-800">Provisioning status:</span>
                    {% if render_verification_status == 'verified' %}
                        <span class="text-green-700 font-semibold">Verified</span>
                    {% else %}
                        <span class="text-yellow-700 font-semibold">Unverified</span>
                    {% endif %}
                </p>
            {% endif %}
            <p class="text-sm text-gray-600 mt-2">If status is <span class="font-mono">Unverified</span>, double-check your CNAME/A record for the domain in your DNS provider and wait a few minutes for propagation.</p>
        </div>
    {% endif %}
</div>
{% endblock %}
