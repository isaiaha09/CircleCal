{% extends 'calendar_app/base.html' %}
{% load tz static %}
{% block title %}Calendar{% endblock %}
{% block extra_head %}
<!-- Select2 + FullCalendar (self-hosted to avoid third-party CDN warnings) -->
<meta name="viewport" content="width=device-width, initial-scale=1">

<link href="{% static 'vendor/select2/4.1.0-rc.0/css/select2.min.css' %}" rel="stylesheet" />
<link href="{% static 'vendor/fullcalendar/5.11.3/css/main.min.css' %}" rel="stylesheet" />

<script src="{% static 'vendor/jquery/jquery-3.6.0.min.js' %}"></script>
<script src="{% static 'vendor/select2/4.1.0-rc.0/js/select2.min.js' %}"></script>
<script src="{% static 'vendor/fullcalendar/5.11.3/js/main.min.js' %}"></script>
{% endblock %}

{% block content %}

<div style="margin-bottom:32px;">
    <div style="display:flex; justify-content:center; align-items:center; margin-bottom:12px; flex-direction:column;">
        <div style="text-align:center;">
            <h1 class="calendar-title" style="font-size:32px; font-weight:800; margin:0 0 8px 0; letter-spacing:-0.5px;">Calendar</h1>
            <p style="color:var(--gray-600); font-size:15px; margin:0;">Manage your availability and view bookings</p>
        </div>
        {% if is_team_plan or is_pro_plan %}
            <div id="ccScopeWrap" style="width:min(460px, 92vw); margin-top:12px; text-align:center;">
                <label for="memberSelect" style="display:block;font-size:12px;color:var(--gray-600);margin-bottom:6px;">Showing calendar for</label>
                <!-- Keep a hidden select in the DOM for legacy initialization code that enumerates members. -->
                {% if is_team_plan %}
                <select id="memberSelect" style="display:none" aria-hidden="true">
                    {% for m in members_list %}
                        {% with fname=m.user__first_name lname=m.user__last_name email=m.user__email %}
                            <option value="{{ m.id }}">{% if fname or lname %}{{ fname }} {{ lname }}{% else %}{{ email }}{% endif %}</option>
                        {% endwith %}
                    {% endfor %}
                </select>
                {% else %}
                <select id="memberSelect" style="display:none" aria-hidden="true"></select>
                {% endif %}

                <!-- Scope menu:
                     - Team plan: Members -> Personal Services
                     - Pro plan: Overall availability -> Services -->
                <div id="ccScopeMenuRoot" style="position:relative; display:inline-block; width:100%; text-align:left;">
                    <button id="ccScopeMenuButton" type="button" style="width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--gray-200); background:white; box-shadow: 0 1px 2px rgba(16,24,40,0.04); font-size:14px; color:var(--gray-900); display:flex; align-items:center; justify-content:space-between; gap:10px;">
                        <span id="ccScopeMenuButtonLabel" style="flex:1; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">{% if is_pro_plan and not is_team_plan %}Overall availability{% else %}Select member{% endif %}</span>
                        <span style="color:var(--gray-600); font-size:16px; line-height:1;">▾</span>
                    </button>

                    <div id="ccScopeMenu" style="display:none; position:absolute; left:0; top:calc(100% + 6px); width:100%; background:white; border:1px solid var(--gray-200); border-radius:12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1); z-index:10001; overflow:hidden;">
                        <div id="ccScopeMenuMembers" style="max-height:280px; overflow:auto;"></div>
                    </div>

                    {% if is_team_plan %}
                    <div id="ccScopeSubmenu" style="display:none; position:absolute; left:100%; top:calc(100% + 6px); width:100%; background:white; border:1px solid var(--gray-200); border-radius:12px; box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1); z-index:10002; overflow:hidden;">
                        <div id="ccScopeSubmenuInner" style="max-height:280px; overflow:auto;"></div>
                    </div>
                    {% endif %}
                </div>

                <!-- Duration/buffer overlap groups (Team is conditional; Pro can be always visible) -->
                <div id="ccSharedSignatureSummary" role="note" aria-live="polite" style="margin-top:10px; padding:10px 12px; border:1px solid var(--gray-200); border-radius:12px; background: rgba(249, 250, 251, 0.95);">
                    <div id="ccSharedSignatureTitle" style="font-weight:800; font-size:13px; color:var(--gray-900); margin-bottom:4px;">Duration/buffer overlap groups</div>
                    <div id="ccSharedSignatureDesc" style="font-size:13px; color:var(--gray-700); line-height:1.35;">
                        Services with the same duration and buffer settings share the same availability group, so their schedules can overlap.
                    </div>
                    <div id="ccSharedSignatureList" style="margin-top:8px; font-size:13px; color:var(--gray-700);"></div>

                    {% if not is_team_plan %}
                        {# Non-Team: keep the simple server-rendered listing #}
                        <script>
                            (function(){
                                try {
                                    const list = document.getElementById('ccSharedSignatureList');
                                    if (!list) return;
                                    const groups = {{ shared_signature_groups|default:'[]'|safe }} || [];
                                    if (!groups.length) {
                                        list.textContent = 'No services share the same duration/buffer settings right now.';
                                        return;
                                    }
                                    for (const g of groups) {
                                        try {
                                            const names = (g || []).map(x => x && x.name ? String(x.name) : 'Service').filter(Boolean);
                                            const row = document.createElement('div');
                                            row.style.marginTop = '4px';
                                            row.textContent = `• ${names.join(', ')}`;
                                            list.appendChild(row);
                                        } catch (e) {}
                                    }
                                } catch (e) {}
                            })();
                        </script>
                    {% endif %}
                </div>

                    <!-- Mobile tweaks: make the "Set Available Time" modal smaller and scale contents down -->
                    <style>
                    @media (max-width: 480px) {
                        /* Shrink the modal card to fit narrow viewports while keeping proportions */
                        #timeModal > div {
                            width: 95vw !important;
                            max-width: 95vw !important;
                            padding: 14px !important;
                            border-radius: 12px !important;
                            box-shadow: 0 14px 20px rgba(0,0,0,0.12) !important;
                            max-height: 86vh !important;
                            overflow: auto !important;
                            -webkit-overflow-scrolling: touch !important;
                            font-size: 0.92rem !important; /* slightly reduce base text size inside modal */
                        }
                        #timeModal h3 { font-size: 18px !important; margin-bottom:8px !important; }
                        #timeModal p { font-size: 13px !important; margin-bottom:12px !important; }
                        /* Reduce padding on action buttons so they fit on one line when possible */
                        #timeModal button {
                            padding: 8px 12px !important;
                            border-radius: 8px !important;
                            font-size: 13px !important;
                        }
                        /* Make inputs and selects a bit smaller and responsive */
                        #timeModal input, #timeModal select {
                            font-size: 13px !important;
                            padding: 6px 8px !important;
                            box-sizing: border-box !important;
                        }
                        /* Tighten ranges container spacing */
                        #modalRangesContainer { gap:6px !important; margin-top:8px !important; }
                        #addModalRangeBtn { padding:6px 10px !important; font-size:13px !important; }

                        /* Ensure modal range rows shrink correctly and inputs do not overflow */
                        #timeModal .modal-range-row { gap:6px !important; justify-content:flex-start !important; align-items:center !important; }
                        #timeModal .modal-range-row label { min-width: 40px !important; width: auto !important; font-size:11px !important; text-align:right !important; white-space:nowrap !important; }
                        /* Give more horizontal room to time inputs while keeping them responsive */
                        #timeModal .modal-range-row .time-input-container { flex: 1 1 0 !important; min-width: 0 !important; }
                        #timeModal .modal-range-row input[type="time"],
                        #timeModal .modal-range-row .modal-range-start,
                        #timeModal .modal-range-row .modal-range-end {
                            width: 100% !important;
                            max-width: none !important;
                            padding: 4px 6px !important;
                            font-size: 14px !important;
                            line-height: 20px !important;
                            box-sizing: border-box !important;
                            text-align: center !important;
                        }
                        /* Make the remove and action buttons smaller to save space */
                        #timeModal .modal-range-row button,
                        #timeModal button {
                            padding:6px 8px !important;
                            font-size:11px !important;
                            border-radius:8px !important;
                        }
                        /* Ensure the remove button doesn't push inputs off-screen */
                        #timeModal .modal-range-row button.remove-range-btn, #timeModal .modal-range-row > button {
                            flex: 0 0 auto !important;
                            margin-left: 8px !important;
                        }

                        /* Mobile-only: make modal remove control a compact X button */
                        #timeModal .modal-range-row .remove-range-btn {
                            width: 32px !important;
                            height: 32px !important;
                            padding: 0 !important;
                            display: inline-flex !important;
                            align-items: center !important;
                            justify-content: center !important;
                            gap: 0 !important;
                        }
                        #timeModal .modal-range-row .remove-range-btn .remove-text { display: none !important; }
                        #timeModal .modal-range-row .remove-range-btn .remove-icon { font-size: 16px !important; line-height: 1 !important; }
                        /* Tweak webkit datetime fields to match smaller font/line-height */
                        #timeModal input[type="time"]::-webkit-datetime-edit-hour-field,
                        #timeModal input[type="time"]::-webkit-datetime-edit-minute-field,
                        #timeModal input[type="time"]::-webkit-datetime-edit-text {
                            font-size: 12px !important;
                            line-height: 20px !important;
                        }
                    }
                    </style>

                    <!-- Additional mobile fix: ensure time input values are not clipped (line-height/appearance) -->
                    <style>
                    @media (max-width:480px) {
                        #timeModal input[type="time"] {
                            height: 36px !important;
                            line-height: 36px !important;
                            font-size: 14px !important;
                            color: var(--gray-900) !important;
                            padding: 6px 8px !important;
                            box-sizing: border-box !important;
                            -webkit-appearance: none !important;
                            appearance: none !important;
                            text-align: center !important;
                            overflow: visible !important;
                        }
                        /* WebKit internal fields for time inputs */
                        #timeModal input[type="time"]::-webkit-datetime-edit,
                        #timeModal input[type="time"]::-webkit-datetime-edit-fields-wrapper,
                        #timeModal input[type="time"]::-webkit-datetime-edit-hour-field,
                        #timeModal input[type="time"]::-webkit-datetime-edit-minute-field,
                        #timeModal input[type="time"]::-webkit-datetime-edit-text {
                            color: var(--gray-900) !important;
                            font-size: 14px !important;
                            line-height: 36px !important;
                            padding: 0 !important;
                        }
                    }
                    </style>

                <style>
                /* Mobile: make the scope submenu open beneath the menu (full-width)
                   instead of off to the right where it can overflow the viewport. */
                @media (max-width: 480px) {
                    #ccScopeMenu, #ccScopeSubmenu {
                        left: 0 !important;
                        right: auto !important;
                        top: calc(100% + 6px) !important;
                        width: 100% !important;
                        box-shadow: 0 8px 20px rgba(0,0,0,0.12) !important;
                        border-radius: 10px !important;
                        position: absolute !important;
                        transform: none !important;
                    }
                    /* Ensure inner scroll areas fit the mobile viewport comfortably */
                    #ccScopeSubmenuInner, #ccScopeMenuMembers { max-height: 320px !important; overflow:auto !important; }
                }
                </style>

                <div style="margin-top:6px; display:flex; justify-content:center;">
                    <span id="memberScopeBadge" style="font-size:12px;color:var(--gray-600);padding:6px 10px;border-radius:999px;border:1px solid var(--gray-200);background:transparent;">{% if is_pro_plan and not is_team_plan %}Showing overall availability{% else %}Showing org defaults{% endif %}</span>
                </div>

                <style>
                    /* Mobile: center scope dropdown + overlap box, 95% width */
                    @media (max-width: 768px) {
                        #ccScopeWrap { width: 100% !important; }
                        #ccScopeMenuRoot,
                        #ccSharedSignatureSummary {
                            width: 95% !important;
                            margin-left: auto !important;
                            margin-right: auto !important;
                        }
                    }
                </style>
            </div>
        {% endif %}
    </div>
        <!-- Inline Audit Modal -->
        <div id="inlineAuditModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 10000; padding: 20px;">
            <div style="background: white; padding: 18px; border-radius: 10px; max-width: 640px; width: 100%;">
                <button onclick="closeInlineAudit()" style="position: absolute; right: 18px; top: 14px; border: none; background: none; font-size: 22px; cursor: pointer;">×</button>
                <h4 style="margin:0 0 10px 0;">Audit Details</h4>
                <div id="inlineAuditContent" style="white-space:pre-wrap; background:#f8f9fa; padding:12px; border-radius:6px; max-height:60vh; overflow:auto;"></div>
                <div style="display:flex; justify-content:flex-end; margin-top:12px;"><button onclick="closeInlineAudit()" style="padding:8px 12px; background:#6c757d; color:white; border:none; border-radius:6px;">Close</button></div>
            </div>
        </div>
  </div>
</div>
<script>
// Wire bookings visible-rows select for calendar page after DOM is ready
document.addEventListener('DOMContentLoaded', function(){
    const key = 'cc_bookings_visible_rows';
    const sel = document.getElementById('bookingsVisibleRowsSelect');
    const customInput = document.getElementById('bookingsVisibleRowsCustomInput');
    const container = document.getElementById('bookingsInlineSection');
    const scrollWrapper = document.getElementById('bookingsScrollWrapper');
    const auditWrapper = container ? container.querySelector('.inline-audit-wrapper') : null;

    function apply(v){
        try{
            const defaultVal = Number(getComputedStyle(container || document.documentElement).getPropertyValue('--bookings-visible-default')) || 10;
            if (!scrollWrapper) return;
            if (v === 'all'){
                scrollWrapper.classList.add('cc-visible-all');
                if (auditWrapper) auditWrapper.classList.add('cc-visible-all');
                scrollWrapper.style.removeProperty('--bookings-visible-rows');
            } else {
                scrollWrapper.classList.remove('cc-visible-all');
                if (auditWrapper) auditWrapper.classList.remove('cc-visible-all');
                const n = Number(v) || defaultVal;
                scrollWrapper.style.setProperty('--bookings-visible-rows', String(n));
                if (auditWrapper) auditWrapper.style.setProperty('--bookings-visible-rows', String(n));
            }
            if (sel) sel.value = String(v);
            if (customInput){
                if (sel && sel.value === 'custom'){ customInput.style.display = 'inline-block'; customInput.focus(); } else { customInput.style.display = 'none'; }
            }
        }catch(e){ console.error(e); }
    }

    function setAndStore(v){ try{ window.localStorage.setItem(key, String(v)); }catch(e){} apply(v); }

    try{
        const stored = window.localStorage.getItem(key);
        if (stored) apply(stored); else apply(sel ? sel.value : String(Number(getComputedStyle(container || document.documentElement).getPropertyValue('--bookings-visible-default')) || 10));
    }catch(e){ apply(sel ? sel.value : '10'); }

    if (sel){
        sel.addEventListener('change', function(){
            const v = this.value;
            if (v === 'custom'){
                if (customInput){ customInput.style.display = 'inline-block'; customInput.focus(); }
                return;
            }
            setAndStore(v);
        });
    }

    if (customInput){
        customInput.addEventListener('change', function(){
            const n = Math.max(1, Number(this.value) || 10);
            setAndStore(String(n));
                if (sel) sel.value = 'custom';
        });
        customInput.addEventListener('keyup', function(e){ if (e.key === 'Enter') this.dispatchEvent(new Event('change')); });
    }
});
</script>

<!-- Assets moved to extra_head -->

<style>
/* Modern color palette */
:root {
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-600: #059669;
    --danger-500: #ef4444;
    --danger-600: #dc2626;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-900: #111827;
    --cc-wave-duration: 14s;
    --cc-page-gutter: 16px; /* default page gutter for consistent side padding */
    --cc-inner-max: 1180px;
}

/* Calendar base styling with modern card design */
#calendar {
    width: 100%;
    margin: auto;
    height: auto;
    border: none !important;
    background-color: white;
    padding: 24px;
    border-radius: 16px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Calendar loading overlay (service-scope parity) */
#calendar.cc-calendar-loading .fc {
    opacity: 0.45;
    filter: grayscale(1);
    pointer-events: none;
}
#calendar .cc-calendar-loading-overlay {
    position: absolute;
    inset: 0;
    display: none;
    z-index: 120;
    background: rgba(255, 255, 255, 0.72);
    backdrop-filter: blur(2px);
    align-items: center;
    justify-content: center;
    flex-direction: column;
    gap: 10px;
    text-align: center;
    pointer-events: auto;
}
#calendar.cc-calendar-loading .cc-calendar-loading-overlay {
    display: flex;
}
.cc-calendar-spinner {
    width: 40px;
    height: 40px;
    border-radius: 999px;
    border: 4px solid var(--gray-200);
    border-top-color: var(--primary-500);
    animation: cc-calendar-spin 0.8s linear infinite;
}
@keyframes cc-calendar-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.cc-calendar-loading-text {
    color: var(--gray-700);
    font-weight: 600;
    font-size: 14px;
}

/* Calendar disabled overlay (service scope: no remaining availability) */
#calendar.cc-svc-no-availability .fc-view-harness {
    opacity: 0.55;
    pointer-events: none;
}
#calendar.cc-svc-no-availability .cc-svc-no-availability-overlay {
    display: flex;
}
.cc-svc-no-availability-overlay {
    display: none;
    position: absolute;
    left: 0;
    right: 0;
    /* Leave space for the FullCalendar header toolbar */
    top: 72px;
    bottom: 0;
    z-index: 10050;
    pointer-events: auto;
    align-items: center;
    justify-content: center;
    background: rgba(255, 255, 255, 0.72);
    backdrop-filter: blur(2px);
}
.cc-svc-no-availability-overlay .panel {
    max-width: 520px;
    width: calc(100% - 28px);
    background: rgba(255,255,255,0.96);
    border: 1px solid rgba(226,232,240,0.9);
    border-radius: 14px;
    padding: 14px 14px;
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.18);
    color: var(--gray-900);
}
.cc-svc-no-availability-overlay .title {
    font-weight: 800;
    font-size: 14px;
}
.cc-svc-no-availability-overlay .body {
    margin-top: 6px;
    font-size: 13px;
    line-height: 1.35;
    color: var(--gray-700);
}
.cc-svc-no-availability-overlay .actions {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 12px;
}
.cc-svc-no-availability-overlay .btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 9px 12px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    border: 1px solid rgba(59,130,246,0.25);
    background: rgba(59,130,246,0.08);
    color: var(--primary-700);
}
.cc-svc-no-availability-overlay .btn.secondary {
    border: 1px solid rgba(148,163,184,0.35);
    background: rgba(148,163,184,0.10);
    color: var(--gray-800);
}

#calendar-controls.cc-disabled {
    opacity: 0.55;
    pointer-events: none;
}

/* Improved member/service select styling */
#memberSelect {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background: white url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="%23343a40" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"/></svg>') no-repeat right 10px center/12px 12px;
    padding: 10px 36px 10px 12px;
    border-radius: 10px;
    border: 1px solid var(--gray-200);
    box-shadow: 0 1px 2px rgba(16,24,40,0.04);
    font-size: 14px;
    color: var(--gray-900);
}

#memberSelect option {
    padding: 6px 8px;
}

#memberSelect.optgroup-service {
    font-weight: 600;
}

/* Remove all calendar borders/grid lines */
.fc-scrollgrid { border-color: transparent !important; }
.fc-scrollgrid td:last-of-type { border-right-color: transparent !important; }
.fc-scrollgrid-section.fc-scrollgrid-section-body td[role='presentation'] { border-bottom-color: transparent !important; }
[role='row']:last-of-type td { border-bottom-color: transparent !important; }
th[role='presentation'] { border-right-color: transparent !important; }
.fc { border: none !important; }
.fc .fc-daygrid-day,
.fc .fc-daygrid-body,
.fc .fc-scrollgrid,
.fc .fc-col-header-cell,
.fc .fc-daygrid-day-frame { border: none !important; }

/* Hide extra frame cells that appear below the last week */
.fc-daygrid-day-frame {
    background: transparent !important;
}

/* Hide day cells that are outside the current month */
.fc-day-other {
    display: none !important;
}

/* Ensure grid sections have no grey background */
.fc .fc-daygrid-body,
.fc .fc-scrollgrid-section-body,
.fc .fc-scrollgrid {
    background: transparent !important;
}

/* Push calendar grid down while keeping header/title at top */
.fc .fc-view-harness { margin-top: 100px; }

/* Day number circle */
.fc-daygrid-day-frame {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
}

/* Top border color wave for section cards */
.section-card, .cc-page > .section-card, .border.rounded-lg, .section-card .section-title {
    position: relative;
}
.section-card::before, .border.rounded-lg::before {
    content: '';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: -6px;
    height: 6px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    /* Use the canonical per-date overrides gradient */
    background: linear-gradient(to right, var(--primary-500), var(--success-500), var(--danger-500));
    background-size: 400% 100%;
    /* smooth oscillation using multi-stop keyframes (no alternate) */
    animation: cc-wave var(--cc-wave-duration, 14s) ease-in-out infinite;
    animation-delay: var(--cc-wave-offset, 0s);
    z-index: 0;
}
@keyframes cc-wave {
    0% { background-position: 0% 50%; }
    25% { background-position: 50% 50%; }
    50% { background-position: 100% 50%; }
    75% { background-position: 50% 50%; }
    100% { background-position: 0% 50%; }
}

/* Apply animated top-border gradient to main sections at all screen sizes */
/* Make top gradient part of each container's rounded top by clipping
   the pseudo-element to the container and using the container's radius. */
#defaultAvailabilityContainer,
#bookingsInlineSection,
#calendar,
#timeModal,
#timeCirclesModal {
    position: relative;
    overflow: hidden; /* clip the ::before gradient to container border-radius */
}

#defaultAvailabilityContainer::before,
#bookingsInlineSection::before,
#calendar::before,
#timeModal::before,
#timeCirclesModal::before {
    content: '';
    display: block;
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 6px;
    /* inherit the container's top border radius so the gradient visually
       appears as part of the container (prevents the 'hat' effect). */
    border-top-left-radius: inherit;
    border-top-right-radius: inherit;
    background: linear-gradient(to right, var(--primary-500), var(--success-500), var(--danger-500));
    background-size: 400% 100%;
    animation: cc-wave var(--cc-wave-duration, 14s) ease-in-out infinite;
    animation-delay: var(--cc-wave-offset, 0s);
    z-index: 0;
    pointer-events: none;
}

/* Mobile-friendly adjustments */
@media (max-width: 768px) {
        --cc-page-gutter: 16px; 
        Default Weekly Availability keeps desktop baseline styles */
    #bookingsInlineSection,
    #calendar,
    #timeModal,
    #timeCirclesModal {
        position: relative; /* ensure pseudo-element positions relative to container */
    }

    /* Place the gradient inside the container (top:0) so it's not clipped on desktop.
       Use a CSS var for animation-delay so we can sync multiple elements from JS. */
    #bookingsInlineSection::before,
    #calendar::before,
    #timeModal::before,
    #timeCirclesModal::before {
        content: '';
        display: block;
        position: absolute;
        right: 0;
        top: 0; /* inside the container to avoid being clipped by overflow */
        height: 6px;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
            background: linear-gradient(to right, var(--primary-500), var(--success-500), var(--danger-500));
            background-size: 400% 100%;
            animation: cc-wave var(--cc-wave-duration, 14s) ease-in-out infinite;
            /* allow external sync via --cc-wave-offset */
            animation-delay: var(--cc-wave-offset, 0s);
        z-index: 0;
        pointer-events: none;
    }
    #calendar { padding: 12px; }
    .fc .fc-view-harness { margin-top: 80px; }
    /* Slightly smaller day circles on mobile to fit narrow columns */
    .fc-daygrid-day-number { width: 36px; height: 36px; font-size: 14px !important; }
    /* Ensure past / unavailable / today variants honor mobile sizing */
    .fc-daygrid-day-number.past-day,
    .fc-daygrid-day-number.unavailable-number,
    .fc .fc-day-today .fc-daygrid-day-number {
        width: 36px !important;
        height: 36px !important;
        line-height: 36px !important;
        font-size: 14px !important;
    }
    /* Nav buttons: enforce square buttons and center icon */
    .fc .fc-prev-button, .fc .fc-next-button {
        width: 40px;
        height: 40px;
        padding: 0;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        box-sizing: border-box;
    }
    /* Reset button line-height to avoid baseline offset (don't zero font-size) */
    .fc .fc-button { line-height: 0; }
    .fc .fc-button svg, .fc .fc-button .fc-icon { width: 14px; height: 14px; display: block; margin: 0; transform: none; }
    /* Ensure any inner wrapper/span fills the button and centers its contents */
    .fc .fc-prev-button > *,
    .fc .fc-next-button > *,
    .fc .fc-prev-button > .fc-icon, .fc .fc-next-button > .fc-icon,
    .fc .fc-prev-button svg, .fc .fc-next-button svg {
        width: 100%;
        height: 100%;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    .time-circle { width: 56px !important; height: 56px !important; font-size: 12px !important; }
}
.fc-daygrid-day-number {
    position: absolute;
    margin-top: 100%;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
    font-size: 1.5rem;
    border-radius: 50% !important;
    font-weight: 600;
    transition: transform 0.2s ease, background-color 0.2s ease;
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    user-select: none;
}

/* Ensure time-circle elements remain circular */
.time-circle { border-radius: 50% !important; overflow: visible; }

/* Pointer for available day numbers */
.fc-day-available .fc-daygrid-day-number { cursor: pointer !important; }
.fc-day-unavailable .fc-daygrid-day-number { cursor: pointer !important; }

/* Available day number - modern gradient */
.fc-day-available .fc-daygrid-day-number {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.15));
    border: 2px solid var(--primary-500);
    color: var(--primary-600);
    box-shadow: 0 2px 4px rgba(59, 130, 246, 0.1);
}

/* Hover effect - enhanced */
.fc-day-available .fc-daygrid-day-number:hover {
    transform: translate(-50%, -50%) scale(1.15);
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.25));
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
}

/* Selected day number - vibrant */
.fc-daygrid-day-number.selected {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    transform: translate(-50%, -50%) scale(1.25);
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
    border-color: var(--primary-700);
}

/* Mobile Safari can leave :hover “stuck” after a tap. Make selected available days always win. */
.fc-day-available .fc-daygrid-day-number.selected,
.fc-day-available .fc-daygrid-day-number.selected:hover {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600)) !important;
    color: white !important;
    border-color: var(--primary-700) !important;
    box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4) !important;
}

/* Prevent frame highlighting */
  .fc-daygrid-day.fc-day-available {
      background: transparent !important;
  }

    /* Hover effect */
  .fc-daygrid-day-number:hover {
      transform: translate(-50%, -50%) scale(1.2);
  }

  /* Temporary highlight during drag - available days */
.fc-day-available .fc-daygrid-day-number.temp-highlight {
    background-color: rgba(0, 123, 255, 0.5);
    color: white;
    transform: translate(-50%, -50%) scale(1.3);
}

/* Temporary highlight during drag - unavailable days */
    .fc-day-unavailable .fc-daygrid-day-number.temp-highlight {
        background: linear-gradient(135deg, rgba(45, 45, 45, 0.8), rgba(26, 26, 26, 0.9));
        color: white;
        transform: translate(-50%, -50%) scale(1.3);
        border-color: #000000;
}

/* Removed: centralized mobile rules for availability UI — will be replaced with scoped media below */
/* (rules targeting .availability-ui removed) */


/* Current day styling - highlighted */
.fc-day-today { background-color: transparent !important; }
.fc .fc-day-today .fc-daygrid-day-number {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    font-weight: bold;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    line-height: 28px;
    text-align: center;
    box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
    animation: pulse 2s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35); }
    50% { box-shadow: 0 6px 16px rgba(59, 130, 246, 0.5); }
}

/* Modern calendar buttons */
#calendar-controls {
    display: flex;
    justify-content: center;
    gap: 12px;
    margin-bottom: 20px;
    background: linear-gradient(to bottom, rgba(255,255,255,0.95), rgba(255,255,255,0.9));
    backdrop-filter: blur(8px);
    padding: 16px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.08), 0 0 1px rgba(0,0,0,0.05);
}
.calendar-btn {
    background-color: var(--primary-500);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.calendar-btn:hover { 
    background-color: var(--primary-600); 
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}
.calendar-btn:active { transform: translateY(0); }
.calendar-btn:disabled { 
    background-color: var(--gray-300); 
    cursor: not-allowed; 
    transform: none;
    box-shadow: none;
}

/* Nav button shared style (kept minimal since inline styles are applied) */
#topNav .nav-btn:hover { 
    transform: translateY(-1px);
    background: var(--primary-600);
}
#topNav .nav-btn:active { transform: translateY(0); }

.fc-daygrid-day-number.selected::after,
.fc-daygrid-day-number.temp-highlight::after {
    content: none !important; /* removes any text overlay */
}
.fc-daygrid-event {
  display: none !important;  /* hides event text labels from calendar cells */
}
#timeModal, #bookingModal {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  justify-content: center;
  align-items: center;
  z-index: 9999;
  animation: fadeIn 0.2s ease-out;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes modalSlideUp {
  from { 
    opacity: 0;
    transform: translateY(20px);
  }
  to { 
    opacity: 1;
    transform: translateY(0);
  }
}

/* Button hover effects */
button:not(:disabled):hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.15) !important;
}
button:not(:disabled):active {
  transform: translateY(0);
}
#timeCirclesContainer > div {
  border-bottom: 1px solid #ccc;  
  padding-bottom: 40px;

}

#timeCirclesContainer > div:first-child {
  padding-top: 20px;
}

/* Remove line from the last row */
#timeCirclesContainer > div:last-child {
  border-bottom: none;
}

.fc-daygrid-day-number.selected.past-day {
    background-color: #ccc !important; /* grey circle for real past-day + selected */
    color: #fff !important;
    border: 2px solid #999 !important;
    
}

.fc-daygrid-day-number.past-day {
    /* show a circular outline for past days rather than a filled block */
    background-color: #7d7d7d28 !important;
    color: #4f4b4bff !important; /* muted text color */
    font-weight: 600;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    line-height: 46px;
    text-align: center;
    border: 2px solid #dcdcdc; /* subtle circle outline */
}

/* Unavailable day number (distinct from past-day) */
.fc-daygrid-day-number.unavailable-number {
    /* Grey circular outline for unavailable future days, number stays visible */
    background-color: #69696990 !important;
    color: #393535ff !important; /* visible but muted */
    font-weight: 600;
    border: 2px solid #454545ff;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    line-height: 46px;
    text-align: center;
}

/* Selected unavailable day - dark grey/black with white numbers */
.fc-daygrid-day-number.unavailable-number.selected {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a) !important;
    color: white !important;
    border-color: #000000 !important;
    transform: translate(-50%, -50%) scale(1.25) !important;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5) !important;
}

/* When an unavailable day is selected via fc-day-unavailable class */
.fc-day-unavailable .fc-daygrid-day-number.selected {
    background: linear-gradient(135deg, #2d2d2d, #1a1a1a) !important;
    color: white !important;
    transform: translate(-50%, -50%) scale(1.25) !important;
    border: 2px solid #000000 !important;
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.5) !important;
}

/* Overrides header styling */
.overrides-header { text-align:center; margin:0 0 10px; }
.overrides-base { font-weight:500; }
.overrides-month { font-weight:700; font-size:1.25em; }

/* Modern select and input styling */
select, input[type="time"], input[type="number"] {
    padding: 6px 10px;
    border: 2px solid var(--gray-300);
    border-radius: 6px;
    font-size: 13px;
    color: var(--gray-900);
    background: white;
    transition: all 0.2s ease;
    outline: none;
}

select:focus, input[type="time"]:focus, input[type="number"]:focus {
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

select:hover, input[type="time"]:hover, input[type="number"]:hover {
  border-color: var(--gray-400);
}

/* Time input wrapper for relative positioning */
.time-input-container {
  position: relative;
  display: inline-block;
}


/* Range row layout adjustments to prevent action buttons overlapping inputs on small screens */
.range-row {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: nowrap;
}
.range-row .time-input-container {
    flex: 0 0 auto;
    min-width: 0; /* allow mobile overrides to control width; avoid forcing large widths on desktop */
}
.range-start, .range-end, .modal-range-start, .modal-range-end {
    text-align: center;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid var(--gray-300);
    background: white;
    font-weight: 600;
    min-width: 0; /* allow responsive rules to set exact widths per breakpoint */
}
.remove-range-btn {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 3px 6px;
    border: none;
    background: #dc3545;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 600;
    font-size: 12px;
}
.remove-range-btn .remove-icon { font-size: 14px; line-height: 1; }
    .remove-range-btn .remove-text { display: none; }
/* Position the unavailable checkbox slightly lower and to the right
   so it visually aligns near the remove button across all devices. */
.unavailable-checkbox {
    position: relative;
    top: 6px; /* move down */
    left: 6px; /* move right */
    width: 18px;
    height: 18px;
}
.add-range-btn {
    padding: 6px 10px !important;
    background: #007bff !important;
    color: white !important;
    border: none !important;
    border-radius: 6px !important;
    cursor: pointer !important;
    font-weight: 600;
    font-size: 13px;
}

/* When a day is marked unavailable, Add range becomes disabled. Make it look disabled. */
.add-range-btn:disabled {
    opacity: 0.45;
    cursor: not-allowed !important;
    filter: grayscale(1);
}

/* Removed mobile @media rules that targeted availability-specific classes so
   Default Weekly Availability keeps desktop baseline styles. */


/* Custom Time Picker Dropdown */
.custom-time-picker {
  position: absolute;
  top: calc(100% + 5px);
  left: 0;
  background: white;
  border: 1px solid var(--gray-300);
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1);
  z-index: 1000;
  padding: 16px;
  min-width: 280px;
  display: none;
  animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.custom-time-picker.active {
  display: block;
}

/* Center the custom time picker on small screens for better UX */
@media (max-width: 480px) {
    .custom-time-picker {
        position: fixed !important;
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: calc(100% - 32px) !important;
        max-width: 420px !important;
        min-width: auto !important;
        padding: 12px !important;
        z-index: 20000 !important;
        box-shadow: 0 16px 35px rgba(0,0,0,0.25) !important;
    }
}

.time-picker-header {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 12px;
  text-align: center;
}

.time-picker-display {
  font-size: 32px;
  font-weight: 700;
  text-align: center;
  color: var(--primary-600);
  margin-bottom: 16px;
  font-variant-numeric: tabular-nums;
  letter-spacing: 0.05em;
}

.time-picker-selectors {
  display: flex;
  gap: 12px;
  margin-bottom: 16px;
}

.time-selector {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.time-selector-label {
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  color: var(--gray-600);
  text-align: center;
  letter-spacing: 0.5px;
}

.time-scroll-container {
  height: 180px;
  overflow-y: auto;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  background: var(--gray-50);
  padding: 4px;
}

.time-scroll-container::-webkit-scrollbar {
  width: 6px;
}

.time-scroll-container::-webkit-scrollbar-track {
  background: transparent;
}

.time-scroll-container::-webkit-scrollbar-thumb {
  background: var(--gray-300);
  border-radius: 3px;
}

.time-option {
  padding: 10px;
  text-align: center;
  cursor: pointer;
  border-radius: 6px;
  font-size: 15px;
  font-weight: 500;
  transition: all 0.15s ease;
  color: var(--gray-700);
}

.time-option:hover {
  background: white;
  color: var(--primary-600);
}

.time-option.selected {
  background: var(--primary-500);
  color: white;
  font-weight: 600;
}

.time-option.disabled {
    opacity: 0.35;
    filter: grayscale(1);
    cursor: not-allowed;
    pointer-events: none;
}

.time-picker-actions {
  display: flex;
  gap: 8px;
  margin-top: 12px;
}

.time-picker-btn {
  flex: 1;
  padding: 10px;
  border: none;
  border-radius: 8px;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.time-picker-btn.confirm {
  background: var(--primary-500);
  color: white;
}

.time-picker-btn.confirm:hover {
  background: var(--primary-600);
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
}

.time-picker-btn.cancel {
  background: var(--gray-200);
  color: var(--gray-700);
}

.time-picker-btn.cancel:hover {
  background: var(--gray-300);
}

/* Keep default browser scrollbars for the main page.
     Note: We still style only the time picker scrollers via .time-scroll-container::-webkit-scrollbar above. */

/* Improved table row hover */
#overridesTable tbody tr:hover {
  background: var(--gray-50);
  transition: background 0.15s ease;
}

#defaultAvailabilityTable tr:hover {
  background: var(--gray-50);
  transition: background 0.15s ease;
}

/* Weekly editor constraint bar (service scope) */
.cc-constraints-wrap {
    display: none;
    margin-top: 8px;
    padding-top: 6px;
    border-top: 1px dashed var(--gray-200);
}
.cc-constraints-bar {
    position: relative;
    height: 10px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7); /* slate-400 */
    background: rgba(241, 245, 249, 0.98);      /* slate-50 */
    overflow: hidden;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
}
.cc-constraints-bar:hover {
    border-color: rgba(59, 130, 246, 0.55);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.12), inset 0 1px 0 rgba(255,255,255,0.85);
}
.cc-constraints-seg {
    position: absolute;
    top: 0;
    height: 100%;
}
.cc-constraints-seg .cc-constraints-label {
    position: absolute;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    font-weight: 800;
    letter-spacing: 0.3px;
    text-transform: uppercase;
    white-space: nowrap;
    pointer-events: none;
    user-select: none;
    opacity: 0.95;
}
.cc-constraints-seg.member .cc-constraints-label {
    color: rgba(17, 24, 39, 0.88);
    text-shadow: 0 1px 0 rgba(255,255,255,0.65);
}
.cc-constraints-seg.other .cc-constraints-label {
    color: rgba(255,255,255,0.98);
    text-shadow: 0 1px 1px rgba(0,0,0,0.25);
}
.cc-constraints-seg.member {
    /* Outside member availability (warm/attention but not "error") */
    background: rgba(245, 158, 11, 0.62); /* amber-500 */
    box-shadow: inset 0 0 0 1px rgba(180, 83, 9, 0.25);
}
.cc-constraints-seg.other {
    /* Reserved by other services (cool + striped for color-blind clarity) */
    background: rgba(59, 130, 246, 0.82); /* CircleCal blue (primary-500) */
    background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.25) 0px,
        rgba(255,255,255,0.25) 6px,
        rgba(255,255,255,0.00) 6px,
        rgba(255,255,255,0.00) 12px
    );
    box-shadow: inset 0 0 0 1px rgba(30, 64, 175, 0.28);
}

.cc-constraints-caption {
    margin-top: 6px;
    font-size: 12px;
    line-height: 1.25;
    color: var(--gray-700);
}

/* Mobile-only: tighten the explanatory text under Time Ranges (service scope) */
@media (max-width: 768px) {
    /* Make all text inside the constraints container smaller on mobile */
    #defaultAvailabilityContainer .cc-constraints-wrap {
        font-size: 9px;
    }

    /* Inline segment labels */
    #defaultAvailabilityContainer .cc-constraints-wrap .cc-constraints-seg .cc-constraints-label {
        font-size: 7px;
        letter-spacing: 0.25px;
    }

    #defaultAvailabilityContainer .cc-constraints-caption {
        font-size: 9px;
        line-height: 1.2;
        margin-top: 5px;
    }
}

/* Service-scope explainer (client-facing mental model) */
.cc-scope-explainer {
    display: none;
    margin: 10px 0 14px 0;
    padding: 10px 12px;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    background: rgba(249, 250, 251, 0.95);
}
.cc-scope-explainer .title {
    font-weight: 800;
    font-size: 13px;
    color: var(--gray-900);
    margin-bottom: 4px;
}
.cc-scope-explainer .body {
    font-size: 13px;
    color: var(--gray-700);
    line-height: 1.35;
}
.cc-scope-explainer .cc-scope-compat {
    margin-top: 8px;
    padding: 8px 10px;
    border-left: 3px solid var(--primary-500);
    background: rgba(59, 130, 246, 0.06);
    border-radius: 10px;
    font-size: 12px;
    color: var(--gray-800);
}
.cc-scope-explainer .cc-scope-compat .label {
    font-weight: 800;
    color: var(--gray-900);
}
.cc-scope-explainer .cc-scope-compat .names {
    margin-top: 2px;
    color: var(--gray-700);
}
.cc-scope-legend {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    margin-top: 8px;
}
.cc-scope-legend .item {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: var(--gray-700);
}
.cc-scope-legend .swatch {
    width: 18px;
    height: 10px;
    border-radius: 999px;
    border: 1px solid rgba(148, 163, 184, 0.7);
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.8);
}
.cc-scope-legend .swatch.member { background: rgba(245, 158, 11, 0.62); }
.cc-scope-legend .swatch.other {
    background: rgba(59, 130, 246, 0.82);
    background-image: repeating-linear-gradient(
        45deg,
        rgba(255,255,255,0.25) 0px,
        rgba(255,255,255,0.25) 6px,
        rgba(255,255,255,0.00) 6px,
        rgba(255,255,255,0.00) 12px
    );
}

/* Fully blocked day (service scope): make row non-interactive */
.cc-weekly-row-locked {
    opacity: 0.55;
}
.cc-weekly-row-locked input,
.cc-weekly-row-locked button {
    pointer-events: none;
}
.cc-weekly-row-locked .add-range-btn,
.cc-weekly-row-locked .remove-range-btn {
    filter: grayscale(1);
}
.cc-weekly-row-locked td {
    background: rgba(243, 244, 246, 0.55);
}


/* Per-date Overrides: enhanced card styling */
#overridesContainer {
    position: relative;
    overflow: hidden;
    font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
}
#overridesContainer::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    /* Use the canonical per-date overrides gradient and animate it (in sync) */
    background: linear-gradient(to right, var(--primary-500), var(--success-500), var(--danger-500));
    background-size: 400% 100%;
    animation: cc-wave var(--cc-wave-duration, 14s) ease-in-out infinite;
    animation-delay: var(--cc-wave-offset, 0s);
    z-index: 50;
    pointer-events: none;
}

/* Quick attention flash when an override save is denied */
.cc-overrides-flash {
    outline: 3px solid rgba(239, 68, 68, 0.35);
    outline-offset: 3px;
}

/* Pro/Team-only feature: when locked, keep visible but greyed out */
.cc-overrides-disabled {
    opacity: 0.55;
}
.cc-overrides-disabled * {
    pointer-events: none;
}
.cc-overrides-lock-overlay {
    position: absolute;
    inset: 0;
    z-index: 60;
    background: transparent;
    /* Default: do not block interaction when overrides are enabled */
    display: none;
    pointer-events: none;
}
.cc-overrides-disabled .cc-overrides-lock-overlay {
    /* Locked state: capture clicks to show the upgrade prompt */
    display: block;
    pointer-events: auto;
}
.cc-overrides-disabled button,
.cc-overrides-disabled a {
    cursor: not-allowed;
}

/* Overrides table visuals */
#overridesTable {
    border-collapse: separate;
    border-spacing: 0;
}
#overridesTable thead tr {
    background: linear-gradient(to right, rgba(59, 130, 246, 0.08), rgba(16, 185, 129, 0.08));
}
#overridesTable th {
    padding: 10px;
    text-align: left;
    font-weight: 700;
    font-size: 12.5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--gray-700);
}
#overridesTable td {
    padding: 10px;
    border-bottom: 1px solid var(--gray-100);
    font-size: 13px;
    color: var(--gray-700);
}

/* Reset All Overrides button: shift left more on wide screens */
#resetAllOverridesBtn {
    transform: translateX(-16px);
}
@media (min-width: 1025px) {
    #resetAllOverridesBtn {
        transform: translateX(-36px);
    }
}

/* Default Weekly Availability: prevent overflow and keep content visible */
#defaultAvailabilityContainer table { table-layout: fixed; width: 100%; }
#defaultAvailabilityContainer th, #defaultAvailabilityContainer td { white-space: nowrap; overflow: visible; }
/* Allow time range cells to wrap naturally but keep day names intact */
#defaultAvailabilityContainer tbody td:first-child { white-space: nowrap; }
#defaultAvailabilityContainer tbody td:not(:first-child) { white-space: normal; }
/* Subtle borders between day rows with padding for spacing */
#defaultAvailabilityContainer tbody tr { border-bottom: 1px solid var(--gray-200); }
#defaultAvailabilityContainer tbody tr:last-child { border-bottom: none; }
#defaultAvailabilityContainer tbody td { padding-top: 16px; padding-bottom: 16px; }


/* Type badges */
.type-badge {
    display: inline-block;
    padding: 6px 10px;
    border-radius: 999px;
    font-weight: 600;
    font-size: 12px;
}
.type-badge.available {
    background: rgba(16, 185, 129, 0.15);
    color: var(--success-600);
    border: 1px solid rgba(16, 185, 129, 0.25);
}
.type-badge.blocked {
    background: rgba(239, 68, 68, 0.15);
    color: var(--danger-600);
    border: 1px solid rgba(239, 68, 68, 0.25);
}

/* Action buttons */
#overridesTable button.overrides-btn {
    padding: 8px 12px;
    border-radius: 8px;          /* slightly smaller buttons */
    background: var(--primary-500);
    color: white;
    border: none;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.15s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    box-shadow: 0 1px 3px rgba(0,0,0,0.12);
}
#overridesTable button.overrides-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 12px rgba(59, 130, 246, 0.30);
    background: var(--primary-600);
}
#overridesTable button.overrides-btn:active {
    transform: translateY(0);
}

/* Loading state for overrides buttons */
#overridesTable button.overrides-btn.cc-btn-loading,
#resetAllOverridesBtn.cc-btn-loading {
    opacity: 0.85;
    cursor: wait;
}
.cc-inline-spinner {
    width: 14px;
    height: 14px;
    border-radius: 999px;
    border: 2px solid rgba(59, 130, 246, 0.25);
    border-top-color: rgba(59, 130, 246, 0.95);
    display: inline-block;
    vertical-align: middle;
    animation: cc-inline-spin 0.7s linear infinite;
}
@keyframes cc-inline-spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.cc-btn-loading-content {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

/* Fallback: if a button in overrides table has no inner text, show its data-label */
#overridesTable button.overrides-btn:empty::after {
    content: attr(data-label);
}

</style>

<style>
/* Very small phones: keep title + actions on single line and shrink buttons to fit */
@media (max-width: 480px) {
    /* prevent the header row from wrapping so title and actions remain inline;
       allow wrapping only to push the controls to a second row */
    #bookingsInlineSection > div:first-child {
        display: flex !important;
        align-items: center !important;
        justify-content: space-between !important;
        gap: 8px !important;
        flex-wrap: wrap !important;
    }

    /* allow the heading to shrink so the actions can fit and ensure it stays first */
    #bookingsInlineSection > div:first-child h3 {
        flex: 1 1 auto !important;
        min-width: 0 !important;
        margin: 0 8px 0 0 !important;
        font-size: 16px !important;
        line-height: 1.1 !important;
        order: 1 !important;
    }

    /* keep the two action buttons grouped and small, and place them after the title */
    #bookingsInlineSection > div:first-child .bookings-top-actions {
        display: flex !important;
        gap: 6px !important;
        flex: 0 0 auto !important;
        align-items: center !important;
        order: 2 !important;
        margin-left: auto !important;
    }

    /* Make both buttons compact and equal height */
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        padding: 4px 6px !important;
        font-size: 12px !important;
        height: 32px !important;
        min-width: 56px !important;
        border-radius: 6px !important;
        line-height: 1 !important;
        white-space: nowrap !important;
    }

    /* Ensure search + rows controls drop to a second row but keep inputs aligned */
    #bookingsInlineSection > div:first-child .bookings-controls {
        order: 3 !important;
        flex: 1 1 100% !important;
        width: 100% !important;
        margin-top: 8px !important;
        gap: 8px !important;
        align-items: center !important;
        justify-content: flex-start !important;
    }

    /* Slightly reduce select/input height to match compact buttons */
    #bookingsInlineSection > div:first-child .bookings-controls input,
    #bookingsInlineSection > div:first-child .bookings-controls select {
        height: 32px !important;
        padding: 6px 8px !important;
        font-size: 13px !important;
    }
}
</style>

<style>
/* Mobile-specific container height to ensure availability card has enough room */
@media (max-width: 768px) {
    #defaultAvailabilityContainer {
        /* Let the card grow with content (ranges + Save button) */
        min-height: unset !important;
        height: auto !important;
        max-height: none !important;
        overflow: hidden !important;
    }
}
</style>
<style>
/* Animated, stylish calendar title */
.calendar-title {
    /* Match available day circle highlight (primary blue gradient) */
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    background-size: 200% auto;
    animation: titleGradientShift 8s ease-in-out infinite, titleFloatIn 600ms ease-out both;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,0.06));
}
/* Per-date overrides month label: match available day circle highlight */
#overridesHeaderMonth {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent !important; /* override inline color */
    background-size: 200% auto;
    animation: titleGradientShift 8s ease-in-out infinite;
}
@keyframes titleGradientShift {
    0% { background-position: 0% center; }
    50% { background-position: 100% center; }
    100% { background-position: 0% center; }
}
@keyframes titleFloatIn {
    0% { opacity: 0; transform: translateY(6px); }
    100% { opacity: 1; transform: translateY(0); }
}

/* Mobile Responsive Styles */
@media (max-width: 768px) {
    /* Title adjustments */
    .calendar-title {
        font-size: 24px !important;
        margin-top: 20px !important;
    }

    /* Per-date overrides header: shrink title text on mobile (overrides inline styles) */
    #overridesHeader {
        font-size: 15px !important;
        line-height: 1.25 !important;
    }
    /* Remove extra top offset on mobile since controls are not overlaid */
    .fc .fc-view-harness { margin-top: 0 !important; }

    /* Slightly smaller day circles on mobile */
    .fc-daygrid-day-number,
    .fc .fc-day-today .fc-daygrid-day-number,
    .fc-daygrid-day-number.past-day,
    .fc-daygrid-day-number.unavailable-number {
        width: 40px !important;
        height: 40px !important;
        font-size: 1.25rem !important;
        line-height: 36px !important;
    }
    /* Reduce hover/selected scale to match smaller size */
    .fc-daygrid-day-number:hover { transform: translate(-50%, -50%) scale(1.1) !important; }
    .fc-daygrid-day-number.selected { transform: translate(-50%, -50%) scale(1.15) !important; }
    
    /* Per-date Overrides Table */
    #overridesContainer {
        padding: 16px !important;
        margin-top: 16px !important;
        overflow-x: auto;
    }
    
    #overridesTable {
        font-size: 11px;
        min-width: 600px;
    }
    
    #overridesTable th {
        padding: 8px !important;
        font-size: 10px !important;
    }
    
    #overridesTable td {
        padding: 8px !important;
        font-size: 11px !important;
    }
    
    #overridesTable button {
        padding: 6px 8px !important;
        font-size: 11px !important;
    }

    /* Removed nested desktop @media that touched .range-row to avoid
       any accidental mobile/medium interactions. */

    /* Default Weekly Availability: responsive rules removed per request. */
    /* (Removed mobile/medium @media blocks and small-screen overrides that targeted
       #defaultAvailabilityContainer, .range-row, .range-start, .range-end,
       .remove-range-btn, .unavailable-checkbox so desktop styles are the baseline.) */
    
    /* Calendar Container */
    div[style*="flex:2 1 640px"] {
        flex: 1 1 100% !important;
        min-width: 100% !important;
        margin-bottom: 16px !important;
    }
    
    #calendar {
        padding: 12px !important;
        height: auto !important;
        min-height: 420px !important;
    }
    
    /* Calendar Controls */
    /* Place controls inline under month title; simplified styling */
    #calendar-controls {
        position: static !important;
        transform: none !important;
        margin-bottom: 12px;
        flex-wrap: wrap;
        justify-content: center;
        background: transparent !important;
        box-shadow: none !important;
        padding: 8px !important;
    }
    
    .calendar-btn {
        padding: 8px 12px !important;
        font-size: 12px !important;
    }
    
    /* Main flex container */
    #weeklyCalendarRow { gap: 16px !important; flex-wrap: wrap !important; }
}

/* Landscape Mobile (tablets in landscape, large phones) */
@media (max-width: 1200px) and (min-width: 769px) {
    #weeklyCalendarRow { flex-wrap: wrap !important; }
    /* Default availability responsive settings removed */
    
    div[style*="flex:2 1 640px"] {
        flex: 1 1 500px !important;
        min-width: 500px !important;
    }
}

/* Small phones (portrait) */
@media (max-width: 480px) {
    #overridesContainer,
    #calendar {
        border-radius: 12px !important;
    }
    
    .calendar-title {
        font-size: 20px !important;
    }
    
    /* Default availability time input mobile sizing removed */
    
    #calendar-controls {
        gap: 6px !important;
    }
    
    .calendar-btn {
        padding: 6px 10px !important;
        font-size: 11px !important;
    }
}

/* Full width on mobile - override base.html max-width containers */
@media (max-width: 768px) {
    /* Prevent horizontal scrolling */
    html, body {
        overflow-x: hidden;
        width: 100%;
        max-width: 100vw;
    }
    
    body {
        padding: 0;
        margin: 0;
    }
    
    /* Mobile: use a 95% width column (centered) */
    main.max-w-6xl,
    main.max-w-7xl,
    main {
        max-width: 95vw !important;
        width: 95vw !important;
        margin: 0 auto !important;
        padding: 0 !important;
        box-sizing: border-box !important;
    }

    /* Scope dropdown: match the 95vw mobile column even if the header is centered/narrow */
    #ccScopeMenuRoot {
        width: 95vw !important;
        max-width: 95vw !important;
        margin-left: auto !important;
        margin-right: auto !important;
    }
    #ccScopeMenu,
    #ccScopeSubmenu {
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }
    

    
    /* Cards: fill the 95vw column */
    #overridesContainer,
    #defaultAvailabilityContainer,
    #calendar,
    #bookingsInlineSection {
        margin-left: 0 !important;
        margin-right: 0 !important;
        width: 100% !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
        overflow-x: visible !important;
    }
    
    /* Title stays fixed, only table wrapper scrolls */
    #overridesTableWrapper {
        overflow-x: auto !important;
        -webkit-overflow-scrolling: touch !important;
    }
    
    #overridesTable {
        min-width: 600px !important;
    }
    
    /* Full width page title container */
    div[style*="margin-bottom:32px; text-align:center"] {
        margin-bottom: 16px !important;
        padding: 0 !important;
        width: 100% !important;
        box-sizing: border-box !important;
    }
    
    /* Default availability media rules removed */
}

/* Widen layout on desktop: use more of the screen width */
@media (min-width: 1025px) {
    /* Expand base containers from base.html */
    main.max-w-6xl,
    main.max-w-7xl,
    main {
        max-width: 95vw !important;
        width: 95vw !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
        box-sizing: border-box !important;
    }

    /* Increase gap between weekly availability and calendar on wide screens */
    #weeklyCalendarRow { gap: 60px !important; }
    /* Make calendar fill column height */
    #calendar { height: 100% !important; }
}

/* Keep a consistent horizontal gutter (side padding) for medium viewports
   so content doesn't touch the right edge as the layout narrows. This
   preserves the current visual spacing until the availability column must
   wrap on small screens. */
@media (min-width: 481px) and (max-width: 1200px) {
    main.max-w-6xl,
    main.max-w-7xl,
    main {
        padding-left: 12px !important;
        padding-right: 12px !important;
        box-sizing: border-box !important;
    }

    /* Add a small inner gutter for the two-column calendar/availability row */
    #weeklyCalendarRow {
        padding-left: 12px !important;
        padding-right: 12px !important;
        box-sizing: border-box !important;
    }
}


</style>

<style>
/* Removed: minimal mobile-only availability rules targeting .availability-ui */
</style>

<style>
/* Center content column and prevent edge leakage across wide and medium viewports */
@media (min-width: 900px) {
    :root { 
        --cc-page-gutter: 16px; 
        --cc-inner-max: 1180px; 
    }

    main.max-w-6xl,
    main.max-w-7xl,
    main {
        width: 100% !important;
        margin-left: auto !important;
        margin-right: auto !important;
        padding-left: var(--cc-page-gutter) !important;
        padding-right: var(--cc-page-gutter) !important;
        box-sizing: border-box !important;
    }



    /* Align the main cards to the centered column and allow them to shrink */
    #overridesContainer,
    #weeklyCalendarRow,
    #defaultAvailabilityContainer,
    #calendar,
    #bookingsInlineSection {
        max-width: 100% !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        box-sizing: border-box !important;
    }

    /* Override inline min-widths (set on elements via style attributes) so they
       don't push past the centered column and leak to the viewport edge. */
    #defaultAvailabilityContainer, div[style*="flex:2 1 640px"] {
        min-width: 0 !important;
        max-width: 100% !important;
        box-sizing: border-box !important;
    }

    /* Keep weekly row aligned with the centered column */
    #weeklyCalendarRow { padding-left: 0 !important; padding-right: 0 !important; box-sizing: border-box !important; }
}
</style>

 <!-- Mobile responsive fixes for View Day Schedule / Time Circles modal -->
<style>
    @media (max-width: 480px) {
        /* Shrink the modal wrapper so it fits within the viewport */
        #timeCirclesModal { padding: 6px !important; }
        #timeCirclesModalPanel {
            width: calc(100% - 20px) !important;
            max-width: 96vw !important;
            padding: 12px !important;
            box-sizing: border-box !important;
            border-radius: 12px !important;
            max-height: 92vh !important;
            overflow-y: auto !important;
        }

        /* Title should never collide with the close button */
        #circleModalTitle {
            font-size: 14px !important;
            line-height: 1.15 !important;
            word-break: break-word !important;
        }

        /* Keep header actions compact on small screens */
        #ccChangeInEditServiceBtn { padding: 10px 10px !important; font-size: 12px !important; border-radius: 12px !important; }
        #closeCirclesBtn { font-size: 20px !important; padding: 4px !important; }

        /* Make any tables or grids inside responsive */
        #timeCirclesModal table, #timeCirclesModal .time-circles-grid, #timeCirclesModal .time-circles-table {
            width: 100% !important;
            max-width: 100% !important;
            table-layout: auto !important;
            overflow-wrap: break-word !important;
        }

        /* Prevent fixed-width children from overflowing */
        #timeCirclesModal * { box-sizing: border-box !important; }
        #timeCirclesModal img, #timeCirclesModal svg { max-width: 100% !important; height: auto !important; }

        /* If there is a horizontal scroller, make it touch friendly */
        #timeCirclesModal .horizontal-scroll, #timeCirclesModal .time-scroll-container {
            overflow-x: auto !important;
            -webkit-overflow-scrolling: touch !important;
            width: 100% !important;
        }

        /* Reduce inner spacing and keep action buttons readable */
        #timeCirclesModal .tc-actions button, #timeCirclesModal button {
            padding: 8px 10px !important;
            font-size: 13px !important;
        }
    }
</style>

<!-- Controls will be overlaid inside the calendar area -->
<!-- Removed mobile/medium @media rules that targeted the Default Weekly Availability UI -->
<!-- Per-date Overrides Table - Modern Card (moved to top) -->
<div id="overridesContainer" class="{% if not can_use_overrides %}cc-overrides-disabled{% endif %}" style="margin-top:24px; padding:24px; background:white; border:none; border-radius:16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
    {% if not can_use_overrides %}
        <div class="cc-overrides-lock-overlay" aria-hidden="true"></div>
    {% endif %}
    <div id="cc-overrides-save-banner" role="status" aria-live="polite" style="display:none; margin:0 auto 14px auto; width:100%; max-width:920px; padding:12px 12px; border-radius:12px; border:1px solid #fecaca; background:#fef2f2; color:#7f1d1d; font-size:14px; line-height:1.35; text-align:center;">
        <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
            <div id="cc-overrides-save-banner-body" style="flex:1; text-align:center;"></div>
            <button type="button" id="cc-overrides-save-banner-close" onclick="try{window.ccDismissOverrideBanner&&window.ccDismissOverrideBanner();}catch(e){}" style="border:0; background:transparent; color:#7f1d1d; font-weight:700; cursor:pointer; padding:2px 6px; border-radius:8px;">×</button>
        </div>
    </div>
    <h3 id="overridesHeader" class="overrides-header" style="margin:0 0 20px 0; font-size:18px; font-weight:700; color:var(--gray-900);">
        <span class="overrides-base" style="font-weight:600;">Per-date Overrides for </span>
                {% if is_team_plan or is_pro_plan %}
                    <span id="overridesHeaderSelection" class="overrides-month" style="color:var(--primary-600); font-size:inherit;"></span>
                    <span style="color:var(--gray-600);"> in </span>
                {% else %}
                    <span id="overridesHeaderSelection" style="display:none;"></span>
                {% endif %}
        <span id="overridesHeaderMonth" class="overrides-month" style="color:var(--primary-600);"></span>
    </h3>
    <div id="overridesTableWrapper" style="overflow-x:auto; -webkit-overflow-scrolling:touch;">
        <table id="overridesTable" style="width:100%; border-collapse:collapse;">
            <thead>
                <tr style="text-align:left; border-bottom:2px solid var(--gray-200); background:var(--gray-50);">
                    <th style="padding:12px; width:16%; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-600);">Date</th>
                    <th style="padding:12px; width:16%; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-600);">Type</th>
                    <th style="padding:12px; width:38%; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-600);">Time Ranges</th>
                    <th style="padding:12px; width:15%; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-600); text-align:center;">Reset All</th>
                    <th style="padding:12px; width:15%; font-weight:600; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-600);">Group Actions</th>
                </tr>
            </thead>
            <tbody id="overridesTableBody">
                <tr><td colspan="5" style="text-align:center; color:var(--gray-600); padding:24px; font-style:italic;">No per-date overrides</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div id="weeklyCalendarRow" style="display:flex; gap:40px; align-items:stretch; flex-wrap:nowrap; margin-top:24px; width:100%;">
        <div id="defaultAvailabilityContainer" class="availability-ui" style="flex:1 1 540px; min-width:540px; margin-bottom:32px; padding:24px; background:white; border:none; border-radius:16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
                <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; margin:0 0 10px 0;">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <h3 id="cc-weekly-availability-title" style="margin:0; font-size:18px; font-weight:700; color:var(--gray-900);">Default Weekly Availability</h3>
                        <div id="cc-weekly-availability-desc" style="display:none; font-size:13px; color:var(--gray-600); line-height:1.4; max-width:640px;">
                            This is the staff member's overall weekly availability. Services that are assigned to this specific staff must fit within their overall weekly availability.
                        </div>
                    </div>
                    <a id="cc-open-edit-service-from-calendar"
                       href="#"
                       style="display:none; padding:10px 12px; border-radius:10px; background:white; border:1px solid var(--primary-500); color:var(--primary-600); font-weight:700; cursor:pointer; text-decoration:none;">

        <!-- Compact bookings header controls for mobile so they fit comfortably -->
        <style>
        @media (max-width: 768px) {
            #bookingsInlineSection .booking-controls,
            #bookingsInlineSection .bookings-top,
            #bookingsInlineSection .bookings-actions {
                display: flex;
                gap: 8px;
                align-items: center;
                justify-content: flex-start;
                flex-wrap: nowrap;
            }

            #bookingsInlineSection .booking-controls .calendar-btn,
            #bookingsInlineSection .bookings-top .calendar-btn {
                padding: 8px 10px !important;
                font-size: 13px !important;
                border-radius: 8px !important;
                line-height: 1 !important;
                white-space: nowrap !important;
            }

            /* Make search input compact and allow it to shrink */
            #bookingsInlineSection .booking-controls input[type="search"],
            #bookingsInlineSection input.search,
            #bookingsInlineSection .search-input {
                padding: 8px 10px !important;
                font-size: 13px !important;
                min-width: 0 !important;
                flex: 1 1 auto !important;
                max-width: 280px !important;
            }

            /* Small square refresh/icon buttons */
            #bookingsInlineSection .refresh-btn,
            #bookingsInlineSection .refresh-button,
            #bookingsInlineSection button.refresh {
                width: 36px !important;
                height: 36px !important;
                padding: 6px !important;
                border-radius: 8px !important;
                display: inline-flex !important;
                align-items: center !important;
                justify-content: center !important;
            }
        }

        @media (max-width: 420px) {
            #bookingsInlineSection .booking-controls,
            #bookingsInlineSection .bookings-top {
                gap: 6px;
            }

            #bookingsInlineSection .booking-controls .calendar-btn,
            #bookingsInlineSection .bookings-top .calendar-btn {
                padding: 6px 8px !important;
                font-size: 12px !important;
            }

            #bookingsInlineSection .booking-controls input[type="search"],
            #bookingsInlineSection input.search {
                font-size: 12px !important;
                padding: 6px 8px !important;
                max-width: 180px !important;
            }
        }
        </style>
                        Open Edit Service
                    </a>
                </div>
                {% if is_team_plan or is_pro_plan %}
                    <div id="cc-weekly-interchange-note" style="margin:0 0 14px 0; font-size:13px; color:var(--gray-600); line-height:1.4;">
                        Tip: When you select a service scope, this weekly schedule is interchangeable with that service’s availability on the Edit Service page.
                    </div>
                {% endif %}

                <div id="ccServiceScopeExplainer" class="cc-scope-explainer" role="note" aria-live="polite">
                    <div class="title" id="ccServiceScopeExplainerTitle">Client-facing availability</div>
                    <div class="body" id="ccServiceScopeExplainerBody">
                        Select a service to preview what clients can actually book.
                    </div>
                    <div class="cc-scope-legend">
                        <span class="item"><span class="swatch member"></span>Outside overall availability</span>
                        <span class="item"><span class="swatch other"></span>Reserved by other services</span>
                    </div>
                </div>
    <table style="width:100%; border-collapse:collapse;">
        <thead>
        <tr style="border-bottom:2px solid var(--gray-200); background:var(--gray-50);">
            <th style="padding:12px; text-align:left; font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-900); width:20%;">Day</th>
            <th style="padding:12px; text-align:center; font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-900); width:55%;" colspan="2">Time Ranges</th>
            <th style="padding:12px; text-align:center; font-weight:700; font-size:13px; text-transform:uppercase; letter-spacing:0.5px; color:var(--gray-900); width:25%;">Unavailable</th>
        </tr>
        </thead>
        <tbody id="defaultAvailabilityTable"></tbody>
    </table>
    <button id="saveDefaultAvailabilityBtn" 
            style="display:none; margin-top:20px; padding:12px 24px; background:var(--primary-500); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        Save Changes
    </button>
    </div>

        <!-- === Your Calendar === -->
        <div style="position:relative; flex:2 1 640px; min-width:640px; margin-bottom:32px; display:flex; flex-direction:column;">
            <div id="calendar" style="position:relative;"></div>
            <div id="calendar-controls" style="position:absolute; left:50%; transform:translateX(-50%); top:80px; display:flex; gap:10px; z-index:10;">
                <button id="selectDaysBtn" class="calendar-btn">Select Day</button>
                <button id="selectAllBtn" class="calendar-btn" style="background:var(--success-500);">Highlight All</button>
                <button id="clearSelectionBtn" class="calendar-btn" style="background:var(--danger-500);">Clear</button>
                <button id="retryInitCalendarBtn" class="calendar-btn" style="background:transparent; color:var(--primary-500); border:1px solid var(--primary-500);">Retry</button>
            </div>
        </div>
</div>
<!-- Inline Bookings Section -->
<style>
/* Apply horizontal scrolling for bookings only on small–medium screens */
@media (max-width: 1200px) {
    #bookingsScrollWrapper { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #bookingsScrollWrapper table { min-width: 720px; width: 100%; }
}
</style>

<style>
/* Small screens: match default availability gutters to other cards (safe, mobile-only) */
@media (max-width: 768px) {
    /* Match the inline padding used by other cards (24px) so edges align */
    #defaultAvailabilityContainer {
        width: 100% !important;
        box-sizing: border-box !important;
        padding-left: 24px !important;
        padding-right: 24px !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    /* Ensure the inner table respects card padding and doesn't add extra left offset */
    #defaultAvailabilityContainer table {
        width: 100% !important;
        table-layout: fixed !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        box-sizing: border-box !important;
    }

    /* When the weekly row stacks, remove any row-level padding so cards line up */
    #weeklyCalendarRow {
        padding-left: 0 !important;
        padding-right: 0 !important;
        box-sizing: border-box !important;
    }
}
</style>

<style>
/* Emergency mobile overrides to prevent right-edge overflow caused by inline min-widths
     Only active on small viewports so desktop styles remain untouched. */
@media (max-width: 768px) {
    /* Force the weekly row to stack vertically so columns don't push past viewport */
    #weeklyCalendarRow {
        flex-direction: column !important;
        gap: 16px !important;
        padding-left: 0 !important;
        padding-right: 0 !important;
        box-sizing: border-box !important;
    }

    /* IMPORTANT: when stacked (flex-direction: column), inline flex-basis values become HEIGHT.
       The desktop inline styles use flex-basis for widths (540px/640px), but on mobile that
       can effectively pin card heights and clip the weekly table. Force natural sizing. */
    #defaultAvailabilityContainer {
        flex: 0 0 auto !important;
    }
    #weeklyCalendarRow > div[style*="flex:2 1 640px"] {
        flex: 0 0 auto !important;
        height: auto !important;
        max-height: none !important;
    }

    /* Allow both columns to shrink and fit the viewport */
    #defaultAvailabilityContainer,
    div[style*="flex:2 1 640px"],
    #calendar {
        min-width: 0 !important;
        width: 100% !important;
        box-sizing: border-box !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
    }

    /* Ensure the table inside the availability card doesn't add extra width */
    #defaultAvailabilityContainer table {
        width: 100% !important;
        table-layout: fixed !important;
        margin-left: 0 !important;
        margin-right: 0 !important;
        box-sizing: border-box !important;
    }

    /* Reduce any large fixed min-widths applied elsewhere to prevent overflow */
    [style*="min-width:540px"], [style*="min-width:640px"], [style*="min-width:600px"] {
        min-width: 0 !important;
        max-width: 100% !important;
    }
}
</style>

<style>
/* Mobile-only: compact and left-align contents inside Default Weekly Availability */
@media (max-width: 768px) {
    /* Make the card contents align left and use slightly smaller spacing */
    #defaultAvailabilityContainer {
        text-align: left !important;
        padding-left: 16px !important;
        padding-right: 16px !important;
        box-sizing: border-box !important;
        /* base font-size for the card so everything is smaller */
        font-size: 12px !important;
    }

    /* Headings and table text smaller */
    #defaultAvailabilityContainer h3 {
        font-size: 14px !important;
        margin-bottom: 10px !important;
        text-align: left !important;
    }
    /* day label and other tds slightly smaller */
    #defaultAvailabilityContainer table th,
    #defaultAvailabilityContainer table td {
        font-size: 10px !important;
        padding: 6px 6px !important;
        vertical-align: middle !important;
    }
    /* specifically reduce the first column (day name) padding and size */
    #defaultAvailabilityContainer tbody td:first-child {
        font-size: 10px !important;
        padding-top: 6px !important;
        padding-bottom: 6px !important;
        white-space: nowrap !important;
    }

    /* Compact range rows and inputs */
    #defaultAvailabilityContainer .range-row {
        gap: 6px !important;
        align-items: center !important;
        justify-content: flex-start !important;
        flex-wrap: nowrap !important;
    }
    #defaultAvailabilityContainer .range-row .time-input-container {
        display: inline-block !important;
    }
    #defaultAvailabilityContainer .range-start,
    #defaultAvailabilityContainer .range-end {
        padding: 2px !important;
        font-size: 11px !important;
        border-radius: 6px !important;
        min-width: 0 !important;
        width: 86px !important; /* compact width to help layout on narrow phones */
        box-sizing: border-box !important;
    }

    /* Smaller action buttons */
    #defaultAvailabilityContainer .add-range-btn {
        padding: 3px 6px !important;
        font-size: 10px !important;
        border-radius: 6px !important;
        min-height: 26px !important;
        line-height: 1 !important;
    }
    #defaultAvailabilityContainer .remove-range-btn {
        font-size: 10px !important;
        border-radius: 4px !important;
        height: 24px !important;
        line-height: 24px !important;
        min-width: 32px !important;
    }

    /* Nudge the checkbox a bit less on small screens */
    #defaultAvailabilityContainer .unavailable-checkbox {
        top: 3px !important;
        left: 3px !important;
        width: 14px !important;
        height: 14px !important;
    }

    /* Ensure the time-picker appended to body doesn't overflow the card visually */
    #defaultAvailabilityContainer .time-input-container .custom-time-picker { max-width: 240px !important; }
}
</style>

<style>
/* Extra compact adjustments for very small phones (narrow portrait devices) */
@media (max-width: 420px) {
    /* Tighten spacing so both time inputs + actions fit on one line */
    #defaultAvailabilityContainer .range-row {
        gap: 4px !important;
    }
    #defaultAvailabilityContainer .range-start,
    #defaultAvailabilityContainer .range-end {
        width: 68px !important;
        padding: 2px !important;
        font-size: 7.5px !important;
    }

    /* Make the Add button extra compact on very small phones */
    #defaultAvailabilityContainer .add-range-btn {
        padding: 2px 5px !important;
        font-size: 9px !important;
        min-height: 22px !important;
        line-height: 1 !important;
    }

    /* Make the Remove button extra small and square on very small phones */
    #defaultAvailabilityContainer .remove-range-btn {
        font-size: 9px !important;
        height: 20px !important;
        line-height: 20px !important;
        border-radius: 6px !important;
        gap: 6px !important;
        min-width: 28px !important;
        justify-content: center !important;
    }

    /* Smaller unavailable checkbox */
    #defaultAvailabilityContainer .unavailable-checkbox {
        width: 12px !important;
        height: 12px !important;
        top: 2px !important;
        left: 2px !important;
    }

    /* Slightly reduce the time-picker width on very small viewports */
    #defaultAvailabilityContainer .time-input-container .custom-time-picker { max-width: 200px !important; }
    /* Extra-small phones: make day circles and nav arrows even smaller */
    .fc-daygrid-day-number { width: 32px !important; height: 32px !important; font-size: 13px !important; }
    .fc-daygrid-day-number.past-day,
    .fc-daygrid-day-number.unavailable-number,
    .fc .fc-day-today .fc-daygrid-day-number {
        width: 32px !important;
        height: 32px !important;
        line-height: 32px !important;
        font-size: 13px !important;
    }
    .fc .fc-prev-button, .fc .fc-next-button {
        width: 36px !important;
        height: 36px !important;
        padding: 0 !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        border-radius: 6px !important;
        box-sizing: border-box !important;
    }
    .fc .fc-button { line-height: 0 !important; }
    .fc .fc-button svg, .fc .fc-button .fc-icon { width: 12px !important; height: 12px !important; display: block !important; margin: 0 !important; transform: none !important; }
    .fc .fc-prev-button > *,
    .fc .fc-next-button > *,
    .fc .fc-prev-button > .fc-icon, .fc .fc-next-button > .fc-icon,
    .fc .fc-prev-button svg, .fc .fc-next-button svg {
        width: 100% !important;
        height: 100% !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        margin: 0 !important;
        padding: 0 !important;
    }
    /* Tighten calendar controls spacing on very small phones */
    #calendar-controls { padding: 10px !important; gap: 8px !important; }
}
</style>

<!-- Tight, specific mobile rules for the bookings header controls (targets inline IDs) -->
<style>
@media (max-width: 768px) {
    /* make the control row non-wrapping and allow the search to shrink */
    #bookingsInlineSection > div:first-child {
        display: flex !important;
        gap: 8px !important;
        align-items: center !important;
        justify-content: space-between !important;
        flex-wrap: wrap !important;
    }

    /* compact the primary 'View all bookings' link and match Refresh size */
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        padding: 6px 12px !important;
        font-size: 13px !important;
        min-width: 86px !important;
        height: 36px !important;
        border-radius: 8px !important;
        white-space: nowrap !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
    }

    /* allow search to flex and shrink so it doesn't force overflow; align inputs/selects */
    #bookingsInlineSection > div:first-child .bookings-controls input[type="search"],
    #bookingsInlineSection > div:first-child .bookings-controls input#bookingsSearchInline,
    #bookingsInlineSection > div:first-child .bookings-controls select,
    #bookingsInlineSection > div:first-child .bookings-controls input[type="number"] {
        padding: 6px 8px !important;
        font-size: 13px !important;
        min-width: 0 !important;
        flex: 1 1 auto !important;
        max-width: 220px !important;
        height: 36px !important;
        line-height: normal !important;
    }

    /* place controls (search + rows) on their own row beneath the title/actions */
    #bookingsInlineSection > div:first-child .bookings-controls {
        order: 3 !important;
        flex: 1 1 100% !important;
        width: 100% !important;
        margin-top: 8px !important;
        justify-content: flex-start !important;
        gap: 8px !important;
        align-items: center !important;
    }

    #bookingsInlineSection > div:first-child h3 {
        order: 1 !important;
        flex: 0 0 auto !important;
    }

    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        order: 2 !important;
        flex: 0 0 auto !important;
        margin-left: 8px !important;
    }
}

@media (max-width: 420px) {
    #bookingsInlineSection > div:first-child {
        gap: 6px !important;
    }
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn {
        padding: 6px 6px !important;
        font-size: 12px !important;
    }
    #bookingsInlineSection > div:first-child input#bookingsSearchInline {
        padding: 6px 8px !important;
        font-size: 12px !important;
        max-width: 140px !important;
    }
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        min-width: 72px !important;
        height: 34px !important;
        padding: 6px 10px !important;
    }
}
</style>

<div id="bookingsInlineSection" style="margin-top:24px; padding:24px; background:white; border:none; border-radius:16px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);">
<style>
/* Final mobile overrides for bookings header (placed immediately before markup to beat earlier rules) */
@media (max-width: 480px) {
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        padding: 3px 6px !important;
        font-size: 12px !important;
        height: 30px !important;
        min-width: 40px !important;
        border-radius: 6px !important;
        box-sizing: border-box !important;
    }
    #bookingsInlineSection > div:first-child .bookings-top-actions { margin-left: auto !important; }
    /* prefer full labels on slightly larger mobile widths */
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn .btn-full,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn .btn-full { display: inline !important; }
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn .btn-short,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn .btn-short { display: none !important; }
}

@media (max-width: 360px) {
    /* show short labels and compress buttons further */
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn .btn-full,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn .btn-full { display: none !important; }
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn .btn-short,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn .btn-short { display: inline !important; }
    #bookingsInlineSection > div:first-child a#bookingsViewAllBtn,
    #bookingsInlineSection > div:first-child button#bookingsRefreshBtn {
        padding: 2px 6px !important;
        min-width: 36px !important;
        height: 28px !important;
        font-size: 12px !important;
    }
}
</style>
    <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:12px;">
        <h3 style="margin:0; font-size:18px; font-weight:700; color:var(--gray-900);">Bookings</h3>
        <div class="bookings-top-actions" style="display:flex; gap:8px; align-items:center;">
            <a id="bookingsViewAllBtn" href="{% url 'calendar_app:bookings_list' organization.slug %}" style="padding:8px 12px; background:var(--primary-500); color:white; border:none; border-radius:8px; font-weight:600; text-decoration:none; display:inline-flex; align-items:center; justify-content:center;">View all bookings</a>
            <button id="bookingsRefreshBtn" type="button" style="padding:8px 12px; background:var(--primary-500); color:white; border:none; border-radius:8px; font-weight:600; cursor:pointer; display:inline-flex; align-items:center; justify-content:center;">Refresh</button>
        </div>
        <div class="bookings-controls" style="display:flex; gap:8px; align-items:center; flex:1 1 100%; width:100%; margin-top:8px;">
            <input id="bookingsSearchInline" type="text" placeholder="Search name or email" style="padding:8px 10px; border:1px solid var(--gray-300); border-radius:6px; font-size:13px; flex:1 1 auto; min-width:0;" />
            <label for="bookingsVisibleRowsSelect" style="margin-left:6px; font-size:13px; color:var(--gray-700);">Rows:</label>
            <select id="bookingsVisibleRowsSelect" style="padding:6px 8px; border-radius:6px; font-size:13px;">
                <option value="5">5</option>
                <option value="10">10</option>
                <option value="15">15</option>
                <option value="20">20</option>
                <option value="all">All</option>
                <option value="custom">Custom</option>
            </select>
            <input id="bookingsVisibleRowsCustomInput" type="number" min="1" placeholder="Rows" style="display:none; margin-left:6px; padding:6px 8px; width:90px; border-radius:6px;" />
        </div>
    </div>
    <style>
    /* bookings scroll sizing using CSS variables so JS can control visible rows */
    #bookingsInlineSection { --bookings-row-height: 56px; --bookings-visible-default: 10; }
    #bookingsScrollWrapper { --bookings-visible-rows: var(--bookings-visible, var(--bookings-visible-default)); max-height: calc(var(--bookings-row-height) * var(--bookings-visible-rows)); overflow:auto; }
    #bookingsScrollWrapper.cc-visible-all { max-height: none !important; }
    #bookingsInlineSection .inline-audit-wrapper { --bookings-visible-rows: var(--bookings-visible, var(--bookings-visible-default)); max-height: calc(var(--bookings-row-height) * var(--bookings-visible-rows)); overflow:auto; margin-top:8px; }
    #bookingsInlineSection .inline-audit-wrapper.cc-visible-all { max-height: none !important; }
    </style>
    <div id="bookingsScrollWrapper">
    <table style="width:100%; border-collapse:collapse;">
        <thead>
            <tr style="border-bottom:2px solid var(--gray-200); background:var(--gray-50);">
                <th style="padding:10px; text-align:left; font-size:13px; font-weight:700; color:var(--gray-900);">Date & Time</th>
                <th style="padding:10px; text-align:left; font-size:13px; font-weight:700; color:var(--gray-900);">Client</th>
                <th style="padding:10px; text-align:left; font-size:13px; font-weight:700; color:var(--gray-900);">Service</th>
                <th style="padding:10px; text-align:left; font-size:13px; font-weight:700; color:var(--gray-900);">Status</th>
                <th style="padding:10px; text-align:left; font-size:13px; font-weight:700; color:var(--gray-900);">Actions</th>
            </tr>
        </thead>
        <tbody id="bookingsInlineTBody">
            <tr><td colspan="5" style="text-align:center; color:var(--gray-600); padding:16px;">Loading…</td></tr>
        </tbody>
    </table>
    </div>
    <!-- Inline Audit Feed (recently deleted/cancelled) -->
    <div style="margin-top:16px;">
        <h4 style="margin:6px 0 8px 0; font-size:14px; font-weight:700; color:var(--gray-900);">Recent Deleted / Cancelled</h4>
        <div class="inline-audit-wrapper" style="font-size:13px; color:var(--gray-700);">
                {% if audit_entries %}
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; gap:8px;">
                    <label style="font-size:13px;"><input type="checkbox" id="auditInlineSelectAll"> Select all</label>
                    <div style="display:flex;gap:8px;"><button class="btn-sm btn-view" id="exportAuditInlineBtn">Export Selected (PDF)</button><button class="btn-sm btn-delete" id="deleteAuditInlineBtn">Delete Selected</button></div>
                </div>
                <ul style="list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:8px;">
                {% for a in audit_entries %}
                    <li class="cc-inline-audit-row" data-service-id="{{ a.service.id|default:'' }}" style="display:flex; justify-content:space-between; align-items:center; gap:12px; padding:8px; border-radius:8px; background:var(--gray-50);">
                        <input type="checkbox" class="auditRowCbInline" value="{{ a.id }}" style="margin-right:8px;">
                    <div style="flex:1;">
                        <div style="font-weight:600;">{{ a.get_event_type_display|capfirst }}{% if a.booking_id %} — #{{ a.booking_id }}{% endif %}</div>
                        <div style="font-size:13px; color:var(--gray-600);">{{ a.service.name|default:'-' }} &middot; {% if a.start %}{% timezone organization.timezone %}{{ a.start|date:'M d, Y g:i A' }}{% endtimezone %}{% else %}-{% endif %}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        <button class="btn-sm btn-view" onclick="openAuditInline(this)" data-snapshot='{{ a.booking_snapshot|escapejs }}'>View</button>
                    </div>
                </li>
                {% endfor %}
            </ul>
            <div id="inlineAuditEmptyScoped" style="color:var(--gray-600); display:none; padding:8px 0;">No recent audited deletions for this member/service.</div>
            {% else %}
                <div style="color:var(--gray-600);">No recent audited deletions.</div>
            {% endif %}
        </div>
    </div>
</div>
<!-- Time Frame Modal -->
<!-- ========================= -->
<!-- TIME MODAL (Availability) -->
<!-- ========================= -->
<div id="timeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px);
    justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; padding:32px; border-radius:20px; width:440px; text-align:center; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation:modalSlideUp 0.3s ease-out;">
    <h3 style="margin:0 0 12px 0; font-size:22px; font-weight:700; color:var(--gray-900);">Set Available Time</h3>
    <p id="selectedDaysSummary" style="font-size:14px; color:var(--gray-600); margin-bottom:24px; line-height:1.5;"></p>

                <!-- Per-date ranges UI (each row shows Start / End on the left) -->
        <!-- Multiple ranges container for per-date overrides -->
        <div id="modalRangesContainer" class="availability-ui" style="display:flex; flex-direction:column; gap:8px; margin-top:12px;"></div>
        <div style="display:flex; justify-content:center; gap:8px; margin-top:8px;">
            <button type="button" id="addModalRangeBtn" style="padding:6px 10px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;">Add Range</button>
        </div>

    <div style="margin-top:24px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap;">
      <button id="saveTimeBtn" 
              style="background:var(--primary-500); color:white; border:none; padding:12px 24px; 
                      border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Save</button>
          <button id="resetToDefaultBtn" 
              style="background:var(--gray-600); color:white; border:none; padding:12px 24px; 
                  border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">Reset to default</button>
              <button id="makeUnavailableBtn"
                  style="background:var(--gray-700); color:white; border:none; padding:12px 24px; 
                         border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:none;">Make Unavailable</button>
              <button id="makeAvailableBtn"
                  style="background:#06b6d4; color:white; border:none; padding:12px 24px; 
                         border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:none;">Make Available</button>
      <button id="viewDayBtn" 
              style="background:var(--success-500); color:white; border:none; padding:12px 24px; 
                      border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1); display:none;">View Day Schedule</button>
      <button id="closeTimeBtn" 
              style="background:var(--gray-200); color:var(--gray-700); border:none; padding:12px 24px; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease;">Cancel</button>
    </div>    
  </div>
</div>

<!-- =============================== -->
<!-- Overrides Upgrade Required Modal -->
<!-- =============================== -->
<div id="ccOverridesUpgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10050;">
    <div style="background:white; padding:28px; border-radius:20px; width:440px; max-width:92vw; text-align:left; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation:modalSlideUp 0.3s ease-out;">
        <h3 style="margin:0 0 10px 0; font-size:20px; font-weight:800; color:var(--gray-900);">Upgrade required</h3>
        <p style="margin:0; font-size:14px; color:var(--gray-600); line-height:1.5;">Upgrade to at least the Pro plan to override days (per-date availability).</p>
        <div style="margin-top:20px; display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
            <button id="ccOverridesUpgradeCancelBtn" type="button" style="background:var(--gray-200); color:var(--gray-700); border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; transition:all 0.2s ease;">Cancel</button>
            <button id="ccOverridesUpgradeGoBtn" type="button" style="background:var(--primary-500); color:white; border:none; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:700; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">{% if cc_app_mode %}OK{% else %}View pricing{% endif %}</button>
        </div>
    </div>
</div>

<!-- Focused mobile modal CSS (non-stacking): keep time inputs inline and use full width) -->
<style>
@media (max-width: 480px) {
    /* Expand modal to most of viewport so inputs can grow horizontally */
    #timeModal > div {
        width: 95vw !important;
        max-width: 95vw !important;
        padding: 16px !important;
        box-sizing: border-box !important;
    }

    /* Keep each range row inline — label + inputs + remove button */
    #modalRangesContainer .modal-range-row {
        display: flex !important;
        align-items: center !important;
        gap: 3px !important;
        justify-content: flex-start !important;
        width: 100% !important;
        box-sizing: border-box !important;
        flex-wrap: nowrap !important;
    }

    /* Fixed (small) label width so inputs can take remaining space */
    #modalRangesContainer .range-label {
        flex: 0 0 42px !important;
        min-width: 42px !important;
        text-align: right !important;
        font-size: 13px !important;
        white-space: nowrap !important;
    }

    /* Let time input container expand to fill available horizontal space */
    #modalRangesContainer .time-input-container {
        flex: 1 1 auto !important;
        min-width: 0 !important; /* allow flex child to shrink when needed */
    }

    /* Make time inputs occupy full width of their container and remove restrictive max-widths */
    #modalRangesContainer input[type="time"],
    #modalRangesContainer input.modal-range-start,
    #modalRangesContainer input.modal-range-end {
        width: 90% !important;
        max-width: none !important;
        padding: 5px 0px !important;
        font-size: 14px !important;
        box-sizing: border-box !important;
        line-height: 1.2 !important;
    }

    /* Keep remove button compact and not growing */
    #modalRangesContainer .remove-range-btn {
        flex: 0 0 auto !important;
        margin-left: 8px !important;
    }

    /* Slightly reduce modal actions to free horizontal room */
    #timeModal > div > div button,
    #timeModal button {
        padding: 9px 12px !important;
        font-size: 13px !important;
    }
}

@media (max-width: 360px) {
    /* Keep rows inline (no stacking) but tighten label and input sizing on very narrow screens */
    #timeModal > div {
        width: 95vw !important;
        max-width: 95vw !important;
        padding: 12px !important;
    }
    #modalRangesContainer .range-label {
        flex: 0 0 23px !important;
        min-width: 23px !important;
        font-size: 11px !important;
    }
    #modalRangesContainer input[type="time"] {
        font-size: 9px !important;
        padding: 6px 1px !important;
    }
    #timeModal button { padding: 8px 10px !important; font-size: 12px !important; }
}
</style>


<!--==========================-->
<!--TIME CIRCLES-->
<!--==========================-->
<div id="timeCirclesModal" style="display:none; flex-direction:column; padding:10px; position:fixed; inset:0; 
    background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:200000; animation:fadeIn 0.2s ease-out; overscroll-behavior:contain;">
    <div id="timeCirclesModalPanel" style="background:white; padding:32px; border-radius:20px; width:min(640px, 92vw); max-width:92vw; max-height:calc(100vh - 24px); box-sizing:border-box; overflow-y:auto; position:relative; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation:modalSlideUp 0.3s ease-out;">

        <!-- Header: Title + close, then a prominent Edit Service button -->
        <div id="ccTimeCirclesHeader" style="display:flex; flex-direction:column; gap:10px; margin-bottom:18px;">
            <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
                <div id="circleModalTitle" style="font-weight:800; font-size:16px; color:var(--gray-900); line-height:1.2; flex:1 1 auto; min-width:0;"></div>
                <button id="closeCirclesBtn" type="button" aria-label="Close" style="background:none; border:none; font-size:22px; line-height:1; cursor:pointer; color:#6b7280; padding:6px;">✖</button>
            </div>
            <a id="ccChangeInEditServiceBtn" href="#" style="display:none; padding:10px 12px; border-radius:12px; background:var(--primary-500); color:white; text-decoration:none; font-weight:900; width:100%; text-align:center;">Edit Service: Client Slot Settings &amp; Price</a>
        </div>

        <!-- Member-scope entry flow (shown only when a member is selected) -->
        <div id="ccDayScheduleMemberChooser" style="display:none; margin-bottom:18px; padding:20px; border-radius:12px; background:var(--gray-50);">
            <h3 style="margin:0 0 10px 0; font-size:16px; font-weight:700; color:var(--gray-900);">View Day Schedule</h3>
            <div id="ccDayScheduleChooserDesc" style="font-size:13px; color:var(--gray-700); margin-bottom:14px;">Choose what to view for this member on this day:</div>
            <div style="display:flex; flex-direction:column; gap:10px;">
                <button id="ccDayScheduleChooseServicesBtn" type="button" style="padding:10px 14px; border-radius:10px; border:1px solid var(--gray-200); background:white; font-weight:600; cursor:pointer; text-align:left;">
                    View services assigned to this member
                </button>
                <button id="ccDayScheduleChooseAppointmentsBtn" type="button" style="padding:10px 14px; border-radius:10px; border:1px solid var(--gray-200); background:white; font-weight:600; cursor:pointer; text-align:left;">
                    View all appointments for this day
                </button>
            </div>
        </div>

        <div id="ccDayScheduleMemberServices" style="display:none; margin-bottom:18px; padding:20px; border-radius:12px; background:var(--gray-50);">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <h3 style="margin:0; font-size:16px; font-weight:700; color:var(--gray-900);">Services</h3>
                <button id="ccDayScheduleBackToChooserFromServices" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--gray-200); background:white; cursor:pointer;">Back</button>
            </div>
            <div id="ccDayScheduleMemberServicesList" style="margin-top:12px; display:flex; flex-direction:column; gap:8px;"></div>
        </div>

        <div id="ccDayScheduleMemberAppointments" style="display:none; margin-bottom:18px; padding:20px; border-radius:12px; background:var(--gray-50);">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <h3 style="margin:0; font-size:16px; font-weight:700; color:var(--gray-900);">Appointments</h3>
                <button id="ccDayScheduleBackToChooserFromAppointments" type="button" style="padding:8px 10px; border-radius:8px; border:1px solid var(--gray-200); background:white; cursor:pointer;">Back</button>
            </div>
            <div id="ccDayScheduleMemberAppointmentsList" style="margin-top:12px; display:flex; flex-direction:column; gap:10px;"></div>
        </div>

        <!-- Fixed settings (service scope) -->
        <div id="clientTimeSettings" style="margin-bottom: 24px; padding:20px; border-radius:12px; background:var(--gray-50);">
            <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:700; color:var(--gray-900);">Day Schedule Settings</h3>
            <div style="display:flex; gap:16px; align-items:flex-end; flex-wrap:wrap;">
                <div>
                    <div style="font-size:12px; color:var(--gray-600);">Duration</div>
                    <div id="ccDayScheduleHourBlockValue" style="font-weight:700; color:var(--gray-900);">—</div>
                </div>
                <div>
                    <div style="font-size:12px; color:var(--gray-600);">Increment</div>
                    <div id="ccDayScheduleIncrementValue" style="font-weight:700; color:var(--gray-900);">—</div>
                </div>
            </div>
            <div id="ccDayScheduleSettingsNote" style="margin-top:10px; font-size:13px; color:var(--gray-600);">
                Duration and increment are fixed based on the service’s settings.
            </div>
        </div>

    <div id="timeCirclesContainer" style="display:flex; flex-direction:column; gap:40px;"></div>

  </div>
</div>

<!-- ========================= -->
<!-- BOOKING MODAL (Client Info) -->
<!-- ========================= -->
<div id="bookingModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10000; animation:fadeIn 0.2s ease-out;">
  <div style="background:white; padding:32px; border-radius:20px; width:480px; box-shadow:0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04); animation:modalSlideUp 0.3s ease-out;">
    <h3 id="bookingTitle" style="margin:0 0 20px 0; font-size:22px; font-weight:700; color:var(--gray-900);">Booking Details</h3>
    <div style="margin-bottom:16px; padding:16px; background:var(--gray-50); border-radius:12px;">
      <p style="margin:8px 0; color:var(--gray-700);"><strong style="color:var(--gray-900); font-weight:600;">Client:</strong> <span id="clientName"></span></p>
      <p style="margin:8px 0; color:var(--gray-700);"><strong style="color:var(--gray-900); font-weight:600;">Lesson Type:</strong> <span id="lessonType"></span></p>
      <p style="margin:8px 0; color:var(--gray-700);"><strong style="color:var(--gray-900); font-weight:600;">Time:</strong> <span id="lessonTime"></span></p>
      <p style="margin:8px 0; color:var(--gray-700);"><strong style="color:var(--gray-900); font-weight:600;">Payment:</strong> <span id="paymentMethod"></span></p>
    </div>

    <div style="margin-top:24px; display:flex; justify-content:space-between; gap:12px;">
      <button id="viewClientBookingsBtn" 
              style="flex:1; background:var(--primary-500); color:white; border:none; padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease; box-shadow:0 1px 3px rgba(0,0,0,0.1);">
        View All Bookings
      </button>
      <button id="closeBookingBtn" 
              style="background:var(--gray-200); color:var(--gray-700); border:none; padding:12px 20px; border-radius:10px; cursor:pointer; font-weight:600; transition:all 0.2s ease;">
        Close
      </button>
    </div>
  </div>
</div>


{% endblock %}

<!-- -------------------------
     Calendar JS
------------------------- -->
{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
        // Helper to read CSRF token from cookie (used by fetch calls)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrftoken = getCookie('csrftoken');

        // Ensure any fetch calls to our authenticated endpoints include
        // credentials by default so the session cookie is sent. Many existing
        // calls in this template call `fetch('/bus/...')` without options.
        // Monkeypatch window.fetch to inject `credentials: 'same-origin'`
        // for same-origin relative `/bus/` paths.
        (function ensureBusFetchCredentials(){
            try {
                const _origFetch = window.fetch.bind(window);
                window.fetch = function(input, init){
                    try{
                        // Resolve URL string when provided
                        const urlStr = (typeof input === 'string') ? input : (input && input.url) || '';
                        if (typeof urlStr === 'string' && urlStr.startsWith('/bus/')) {
                            init = init || {};
                            if (!('credentials' in init)) init.credentials = 'same-origin';
                        }
                    } catch(e) { /* non-fatal */ }
                    return _origFetch(input, init);
                };
            } catch(e) {
                // If monkeypatching fails, fall back to leaving fetch as-is.
                console.warn('Could not monkeypatch fetch for /bus/ credentials', e);
            }
        })();
        // -----------------------------
        // 1️⃣ Initialize default availability from server (fall back to sensible defaults)
        // -----------------------------
        const serverAvail = {{ coach_availability_json|default:"{}"|safe }} || {};
        // Per-member availability map (membership_id -> availability payload)
        const memberAvailMap = {{ member_availability_map|default:"{}"|safe }} || {};
        const weekdayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

        // Helper to build availability map from a server payload (same shape as coach_availability_json)
        function buildAvailabilityFromPayload(payload) {
            const out = {};
            for (let i = 0; i < 7; i++) out[i] = { start: '09:00', end: '17:00', unavailable: true, ranges: [] };

            if (Array.isArray(payload)) {
                    // Detect two common array shapes:
                    // 1) array of per-day objects: [{ day_of_week: 0, ranges: [...], unavailable: bool }, ...]
                    // 2) weekly-array: [ ['09:00-12:00'], [], ['10:00-11:00'], ... ] (index=0 => Sunday)
                    if (payload.length === 7 && (Array.isArray(payload[0]) || typeof payload[0] === 'string' || payload[0] === null)) {
                        // weekly-array shape
                        payload.forEach((slots, idx) => {
                            let ranges = [];
                            if (Array.isArray(slots)) ranges = slots.slice();
                            else if (typeof slots === 'string' && slots.trim() !== '') ranges = [slots];
                            out[idx].unavailable = !(ranges && ranges.length);
                            out[idx].ranges = ranges || [];
                            if (out[idx].ranges && out[idx].ranges.length) {
                                const first = out[idx].ranges[0];
                                if (first && first.includes('-')) {
                                    const [s,e] = first.split('-');
                                    out[idx].start = s.trim();
                                    out[idx].end = e.trim();
                                }
                            }
                        });
                    } else {
                        payload.forEach(item => {
                            let dayIndex = null;
                            if (typeof item.day_of_week === 'number') dayIndex = item.day_of_week;
                            else if (typeof item.day_of_week === 'string' && item.day_of_week.trim() !== '') dayIndex = parseInt(item.day_of_week, 10);
                            if (isNaN(dayIndex) || dayIndex === null) return;
                            dayIndex = ((dayIndex % 7) + 7) % 7;
                            out[dayIndex].unavailable = !!item.unavailable;
                            out[dayIndex].ranges = item.ranges || [];
                            if (item.ranges?.length > 0) {
                                const [start, end] = item.ranges[0].split('-');
                                out[dayIndex].start = start;
                                out[dayIndex].end = end;
                            }
                        });
                    }
                } else if (payload && typeof payload === 'object') {
                Object.entries(payload).forEach(([dayName, slots]) => {
                    try {
                        const dn = String(dayName).trim();
                        const idx = weekdayNames.indexOf(dn);
                        if (idx === -1) return;
                        if (!Array.isArray(slots) || slots.length === 0) {
                            out[idx].unavailable = true;
                            out[idx].ranges = [];
                        } else {
                            out[idx].unavailable = false;
                            out[idx].ranges = slots;
                            const first = slots[0];
                            if (first && first.includes('-')) {
                                const [s,e] = first.split('-');
                                out[idx].start = s.trim();
                                out[idx].end = e.trim();
                            }
                        }
                    } catch (e) { }
                });
            }
            return out;
        }

        // Helper: produce a server-format availability array marking all days unavailable
        function makeAllUnavailablePayload() {
            const names = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            return names.map(n => ({ day: n, ranges: [], unavailable: true }));
        }

        // Build the canonical org-wide availability once
        const orgDefaultAvailability = buildAvailabilityFromPayload(serverAvail);

        // Build per-member availability map (membership_id -> availability)
        const memberDefaultAvailability = {};
        try {
            // First convert any server-provided member maps
            for (const k of Object.keys(memberAvailMap || {})) {
                try { memberDefaultAvailability[String(k)] = buildAvailabilityFromPayload(memberAvailMap[k]); } catch(e){ /* fallthrough */ }
            }
        } catch(e){ /* ignore */ }

        // Ensure every membership present in the selector has an entry (new members default to all-unavailable)
        try {
            const sel = document.getElementById('memberSelect');
            if (sel) {
                Array.from(sel.options).forEach(opt => {
                    try{
                        const val = opt.value;
                        if (!val) return;
                        // skip service pseudo-options
                        if (String(val).startsWith('svc:')) return;
                        if (!memberDefaultAvailability[String(val)]){
                            memberDefaultAvailability[String(val)] = buildAvailabilityFromPayload(makeAllUnavailablePayload());
                        }
                    }catch(e){}
                });
            } else {
                // fallback: ensure known MEMBERS have entries
                if (Array.isArray(MEMBERS)){
                    for (const m of MEMBERS){
                        const mid = String(m.id);
                        if (!memberDefaultAvailability[mid]) memberDefaultAvailability[mid] = buildAvailabilityFromPayload(makeAllUnavailablePayload());
                    }
                }
            }
        } catch(e){ /* ignore */ }

        // The live defaultAvailability object used by the UI. Initialized to org defaults.
        const defaultAvailability = JSON.parse(JSON.stringify(orgDefaultAvailability));

        // -----------------------------
        // Default range helper for per-date “Make Available”
        // -----------------------------
        function _ccParseTimeToMinutes(t) {
            try {
                if (!t || typeof t !== 'string') return null;
                const parts = t.split(':');
                const h = parseInt((parts[0] || '0').trim(), 10);
                const m = parseInt((parts[1] || '0').trim(), 10);
                if (isNaN(h) || isNaN(m)) return null;
                return (h * 60) + m;
            } catch (e) { return null; }
        }

        function _ccMinutesToTime(mins) {
            try {
                const m = Math.max(0, Math.min(24 * 60, parseInt(mins, 10)));
                const hh = String(Math.floor(m / 60)).padStart(2, '0');
                const mm = String(m % 60).padStart(2, '0');
                return `${hh}:${mm}`;
            } catch (e) { return '09:00'; }
        }

        function _ccIntervalsFromAvailabilityMap(avMap, dow) {
            const out = [];
            try {
                if (!avMap) return out;
                const info = avMap[dow] || {};
                const ranges = (info.ranges && info.ranges.length)
                    ? info.ranges
                    : ((info.start && info.end) ? [`${info.start}-${info.end}`] : []);
                (ranges || []).forEach(r => {
                    try {
                        if (!r || !String(r).includes('-')) return;
                        const parts = String(r).split('-');
                        const s = (parts[0] || '').trim();
                        const e = (parts[1] || '').trim();
                        const sm = _ccParseTimeToMinutes(s);
                        const em = _ccParseTimeToMinutes(e);
                        if (sm === null || em === null) return;
                        if (em <= sm) return;
                        out.push([sm, em]);
                    } catch (e) { /* ignore */ }
                });
                out.sort((a, b) => a[0] - b[0]);
            } catch (e) { /* ignore */ }
            return out;
        }

        function _ccIntersectIntervals(a, b) {
            const out = [];
            try {
                const aa = Array.isArray(a) ? a : [];
                const bb = Array.isArray(b) ? b : [];
                for (const ia of aa) {
                    for (const ib of bb) {
                        const s = Math.max(ia[0], ib[0]);
                        const e = Math.min(ia[1], ib[1]);
                        if (e > s) out.push([s, e]);
                    }
                }
                out.sort((x, y) => x[0] - y[0]);
            } catch (e) { /* ignore */ }
            return out;
        }

        function ccDefaultRangeForTargetDate(target, dateStr) {
            try {
                const d = parseYMD(dateStr);
                const dow = d.getDay();

                // Service-scope: prefer the service’s effective weekly_map (may be inherited)
                // but always fall back to member-overall (solo) or overlap (group) windows.
                if (target && String(target).startsWith('svc:')) {
                    const svcId = String(target).slice(4);
                    const svc = SERVICES.find(s => String(s.id) === String(svcId)) || null;
                    if (svc && svc.weekly_map) {
                        try {
                            const svcBuilt = buildAvailabilityFromPayload(svc.weekly_map);
                            const svcIntervals = _ccIntervalsFromAvailabilityMap(svcBuilt, dow);
                            if (svcIntervals.length) {
                                return { start: _ccMinutesToTime(svcIntervals[0][0]), end: _ccMinutesToTime(svcIntervals[0][1]) };
                            }
                        } catch (e) { /* ignore */ }
                    }

                    const assigned = (svc && typeof getAssignedMembersForService === 'function')
                        ? (getAssignedMembersForService(svc) || [])
                        : [];

                    if (assigned.length === 1) {
                        const mid = String(assigned[0]);
                        // Match backend semantics: member overall availability = member weekly if set, else org weekly.
                        const memberMap = memberDefaultAvailability[mid] || null;
                        let ints = _ccIntervalsFromAvailabilityMap(memberMap, dow);
                        if (!ints.length) ints = _ccIntervalsFromAvailabilityMap(orgDefaultAvailability, dow);
                        if (ints.length) return { start: _ccMinutesToTime(ints[0][0]), end: _ccMinutesToTime(ints[0][1]) };
                        return null;
                    }

                    if (assigned.length >= 2) {
                        // Match backend semantics for group services: each member falls back to org weekly.
                        const effectiveIntervals = assigned.map(mid => {
                            try {
                                const m = memberDefaultAvailability[String(mid)] || null;
                                let iv = _ccIntervalsFromAvailabilityMap(m, dow);
                                if (!iv.length) iv = _ccIntervalsFromAvailabilityMap(orgDefaultAvailability, dow);
                                return iv;
                            } catch (e) { return []; }
                        });

                        if (effectiveIntervals.some(iv => !iv || !iv.length)) return null;
                        let overlap = effectiveIntervals[0];
                        for (let i = 1; i < effectiveIntervals.length; i++) {
                            overlap = _ccIntersectIntervals(overlap, effectiveIntervals[i]);
                            if (!overlap.length) break;
                        }
                        if (overlap.length) return { start: _ccMinutesToTime(overlap[0][0]), end: _ccMinutesToTime(overlap[0][1]) };
                        return null;
                    }

                    // Unassigned service: default within org overall weekly windows
                    const orgInts = _ccIntervalsFromAvailabilityMap(orgDefaultAvailability, dow);
                    if (orgInts.length) return { start: _ccMinutesToTime(orgInts[0][0]), end: _ccMinutesToTime(orgInts[0][1]) };
                    return null;
                }

                // Member-scope
                if (target && memberDefaultAvailability[String(target)]) {
                    // Match backend semantics: member overall availability falls back to org weekly.
                    let ints = _ccIntervalsFromAvailabilityMap(memberDefaultAvailability[String(target)], dow);
                    if (!ints.length) ints = _ccIntervalsFromAvailabilityMap(orgDefaultAvailability, dow);
                    if (ints.length) return { start: _ccMinutesToTime(ints[0][0]), end: _ccMinutesToTime(ints[0][1]) };
                    return null;
                }

                // Org-scope
                const orgInts = _ccIntervalsFromAvailabilityMap(orgDefaultAvailability, dow);
                if (orgInts.length) return { start: _ccMinutesToTime(orgInts[0][0]), end: _ccMinutesToTime(orgInts[0][1]) };
                return null;
            } catch (e) {
                return null;
            }
        }

    // -----------------------------
    // 2️⃣ Helper: is date in the past
    // -----------------------------
    function isPastDate(dateStr) {
        const today = new Date();
        const date = parseYMD(dateStr);
        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        return date < todayMidnight;
    }

    
    function updateUnavailableDays() {
        // Service-scope parity: when a specific service is selected (svc:<id>),
        // use the same backend availability computation as the public booking page.
        // This ensures month visuals reflect *bookable* starts after applying bookings,
        // buffers, min notice, max booking days, overrides, resources, and freezes.
        try {
            if (typeof refreshServiceScopeMonthParity === 'function' && SELECTED_MEMBER && String(SELECTED_MEMBER).startsWith('svc:')) {
                // Only short-circuit to parity mode if we can resolve the selected service.
                // If a stale selection exists in localStorage (deleted service, etc.),
                // falling through ensures org/week-based month classes still update.
                const _svc = (typeof _svcForSelectedScope === 'function') ? _svcForSelectedScope() : null;
                if (_svc) {
                    refreshServiceScopeMonthParity();
                    // Still keep the overrides table updated (it lists per-date overrides regardless
                    // of whether a day has remaining slots).
                    try { renderOverridesTable(); } catch (e) { /* ignore */ }
                    return;
                }
            }
        } catch (e) { /* fall through to legacy */ }

        // Compute per-date full-day blocks from background events (so per-date overrides take precedence)
        const blockedDates = new Set();
        const availableOverrideDates = new Set();
        try {
            calendar.getEvents().forEach(ev => {
                try {
                    const props = ev.extendedProps || {};
                    if (props.override_type === 'blocked') {
                        blockedDates.add(ev.startStr.split('T')[0]);
                    } else if (props.override_type === 'available') {
                        availableOverrideDates.add(ev.startStr.split('T')[0]);
                    }
                } catch (e) { /* ignore per-event parse errors */ }
            });
        } catch (e) { /* ignore if calendar.getEvents fails */ }

        document.querySelectorAll('.fc-daygrid-day').forEach(dayCell => {
            const dateStr = dayCell.dataset.date; // e.g., "2025-11-19"
            if (!dateStr) return;
            const dayIndex = parseYMD(dateStr).getDay(); // 0=Sunday..6=Saturday (local parse)
            const isPast = isPastDate(dateStr);

            // Past dates should be visually distinct (greyed circle) but NOT treated as
            // "unavailable" in the sense of future availability settings. Unavailable
            // is a future-facing user setting and should not be applied retroactively.
            if (isPast) {
                dayCell.classList.remove('fc-day-unavailable');
                dayCell.classList.remove('fc-day-available');
                dayCell.classList.add('fc-day-past');
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    num.classList.add('past-day');
                    num.classList.remove('unavailable-number');
                    num.style.cursor = 'default';
                }
                return; // skip further unavailable/available processing for past dates
            }

            // Use classes to indicate available/unavailable so styles remain consistent
            // Precedence: per-date full-day blocks (unavailable) > per-date available overrides > weekly defaults
            if (blockedDates.has(dateStr)) {
                dayCell.classList.add('fc-day-unavailable');
                dayCell.classList.remove('fc-day-available');
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    num.classList.add('unavailable-number');
                    num.style.cursor = 'pointer';
                }
            } else if (availableOverrideDates.has(dateStr)) {
                dayCell.classList.add('fc-day-available');
                dayCell.classList.remove('fc-day-unavailable');
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    num.classList.remove('unavailable-number');
                    num.style.cursor = 'pointer';
                }
            } else if (defaultAvailability[dayIndex]?.unavailable) {
                dayCell.classList.add('fc-day-unavailable');
                dayCell.classList.remove('fc-day-available');
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    num.classList.add('unavailable-number');
                    num.style.cursor = 'pointer';
                }
            } else {
                dayCell.classList.add('fc-day-available');
                dayCell.classList.remove('fc-day-unavailable');
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    num.classList.remove('unavailable-number');
                    num.style.cursor = 'pointer';
                }
            }
        });
        // After updating day classes, refresh the overrides table so it reflects per-date overrides
        try { renderOverridesTable(); } catch (e) { console.warn('renderOverridesTable failed', e); }
    }

    // -----------------------------
    // Service-scope parity (month)
    // -----------------------------
    let __svcParityToken = 0;
    let __svcParityLastKey = null;
    let __svcParityLastMap = null;
    let __svcParityReadyRetries = 0;
    let __svcParityReadyLastAttempt = null;

    function _invalidateServiceScopeParityCache() {
        // Any per-date override creation/deletion can change real bookable availability.
        // When service scope is selected we must force a re-computation so day circles
        // flip immediately (and don't get stuck on a cached month map).
        try { __svcParityLastKey = null; } catch (e) {}
        try { __svcParityLastMap = null; } catch (e) {}
        // Bump token to cancel any in-flight background verification
        try { __svcParityToken = (__svcParityToken || 0) + 1; } catch (e) {}
    }

    function _svcForSelectedScope() {
        try {
            if (!SELECTED_MEMBER) return null;
            const raw = String(SELECTED_MEMBER);
            if (!raw.startsWith('svc:')) return null;
            const svcId = Number(raw.slice(4)) || null;
            if (!svcId) return null;
            const svc = (typeof svcById === 'function') ? svcById(svcId) : null;
            if (!svc || !svc.slug) return null;
            return svc;
        } catch (e) {
            return null;
        }
    }

    function _visibleDayDates() {
        const out = [];
        try {
            // Only include in-month cells; FullCalendar still renders out-of-month cells
            // even if we hide them via CSS.
            document.querySelectorAll('.fc-daygrid-day[data-date]:not(.fc-day-other)').forEach(el => {
                const d = el.getAttribute('data-date');
                if (d) out.push(d);
            });
        } catch (e) {}
        // De-dupe while preserving order
        try { return Array.from(new Set(out)); } catch (e) { return out; }
    }

    function _toIsoLocal(dateStr, hh, mm, ss) {
        // dateStr: YYYY-MM-DD
        try {
            const parts = String(dateStr).split('-');
            const y = Number(parts[0]);
            const m = Number(parts[1]);
            const d = Number(parts[2]);
            const pad = n => String(n).padStart(2, '0');
            return `${y}-${pad(m)}-${pad(d)}T${pad(hh)}:${pad(mm)}:${pad(ss || 0)}`;
        } catch (e) {
            return `${dateStr}T${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:00`;
        }
    }

    function _applyServiceScopeDayClasses(dayHasSlots) {
        try {
            document.querySelectorAll('.fc-daygrid-day').forEach(dayCell => {
                const dateStr = dayCell.dataset.date;
                if (!dateStr) return;
                const isPast = isPastDate(dateStr);
                if (isPast) {
                    dayCell.classList.remove('fc-day-unavailable');
                    dayCell.classList.remove('fc-day-available');
                    dayCell.classList.add('fc-day-past');
                    const num = dayCell.querySelector('.fc-daygrid-day-number');
                    if (num) {
                        num.classList.add('past-day');
                        num.classList.remove('unavailable-number');
                        num.style.cursor = 'default';
                    }
                    return;
                }

                const enabled = !!(dayHasSlots && dayHasSlots[dateStr]);
                if (enabled) {
                    dayCell.classList.add('fc-day-available');
                    dayCell.classList.remove('fc-day-unavailable');
                } else {
                    dayCell.classList.add('fc-day-unavailable');
                    dayCell.classList.remove('fc-day-available');
                }

                dayCell.style.background = 'transparent';
                const num = dayCell.querySelector('.fc-daygrid-day-number');
                if (num) {
                    // Keep clickable for override editing even when unavailable
                    num.style.cursor = 'pointer';
                    if (enabled) num.classList.remove('unavailable-number');
                    else num.classList.add('unavailable-number');
                }
            });
            // Now that service-scope parity has updated the month UI, recompute the
            // fully-booked protection set (this is async relative to events refetch).
            try { if (typeof _recomputeFullyBookedOutDates === 'function') _recomputeFullyBookedOutDates(); } catch (e) {}
        } catch (e) { console.warn('applyServiceScopeDayClasses failed', e); }
    }

    // -----------------------------
    // Service-scope calendar loading UX
    // -----------------------------
    function _ensureCalendarLoadingOverlay() {
        try {
            const calEl = document.getElementById('calendar');
            if (!calEl) return null;
            let overlay = calEl.querySelector('.cc-calendar-loading-overlay');
            if (overlay) return overlay;
            overlay = document.createElement('div');
            overlay.className = 'cc-calendar-loading-overlay';
            overlay.innerHTML = `
                <div class="cc-calendar-spinner" aria-hidden="true"></div>
                <div class="cc-calendar-loading-text">Loading availability…</div>
            `;
            calEl.appendChild(overlay);
            return overlay;
        } catch (e) {
            return null;
        }
    }

    function _setCalendarLoading(isLoading, message) {
        try {
            const calEl = document.getElementById('calendar');
            if (!calEl) return;
            const overlay = _ensureCalendarLoadingOverlay();
            if (overlay) {
                const textEl = overlay.querySelector('.cc-calendar-loading-text');
                if (textEl && typeof message === 'string' && message.trim()) {
                    textEl.textContent = message;
                } else if (textEl) {
                    textEl.textContent = 'Loading availability…';
                }
            }
            if (isLoading) calEl.classList.add('cc-calendar-loading');
            else calEl.classList.remove('cc-calendar-loading');
        } catch (e) { /* ignore */ }
    }

    // -----------------------------
    // Service-scope: no remaining availability (click-triggered modal)
    // -----------------------------
    function _ccSelectedServiceNameForNoAvailUI() {
        try {
            const svc = (typeof _svcForSelectedScope === 'function') ? _svcForSelectedScope() : null;
            const name = svc ? String((svc.name || svc.title || '')).trim() : '';
            if (name) return name;

            // Fallback 1: use the current scope label shown in the UI.
            try {
                const lbl = document.getElementById('ccScopeMenuButtonLabel');
                const t = lbl ? String(lbl.textContent || '').trim() : '';
                if (t) {
                    // Team labels can be "Member - Service"; we only want the service part.
                    const parts = t.split(' - ').map(s => String(s || '').trim()).filter(Boolean);
                    return parts.length ? parts[parts.length - 1] : t;
                }
            } catch (e) {}

            // Fallback 2: compute label from current selection.
            try {
                if (typeof getSelectionLabel === 'function') {
                    const t = String(getSelectionLabel() || '').trim();
                    if (t) {
                        const parts = t.split(' - ').map(s => String(s || '').trim()).filter(Boolean);
                        return parts.length ? parts[parts.length - 1] : t;
                    }
                }
            } catch (e) {}

            return 'This service';
        } catch (e) {
            return 'This service';
        }
    }

    function _ccShouldShowNoAvailModalForSelection() {
        try {
            const isSvcScope = !!(SELECTED_MEMBER && String(SELECTED_MEMBER).startsWith('svc:'));
            if (!isSvcScope) return false;
            // Only applies to Pro (non-Team) where services partition overall availability.
            if (!(IS_PRO && !IS_TEAM)) return false;
            return !!window.__ccServiceScopeNoAvailability;
        } catch (e) {
            return false;
        }
    }

    function _ensureSvcNoAvailabilityClickModal() {
        try {
            let modal = document.getElementById('ccSvcNoAvailabilityClickModal');
            if (modal) return modal;

            modal = document.createElement('div');
            modal.id = 'ccSvcNoAvailabilityClickModal';
            modal.style.display = 'none';
            modal.style.position = 'fixed';
            modal.style.inset = '0';
            modal.style.background = 'rgba(0,0,0,0.58)';
            modal.style.backdropFilter = 'blur(3px)';
            modal.style.zIndex = '300000';
            modal.style.alignItems = 'center';
            modal.style.justifyContent = 'center';
            modal.style.padding = '18px';
            modal.style.pointerEvents = 'auto';

            modal.innerHTML = `
                <div style="width:min(560px, 92vw); background: rgba(255,255,255,0.98); border: 1px solid rgba(226,232,240,0.95); border-radius: 16px; box-shadow: 0 22px 50px rgba(15,23,42,0.35); padding: 16px; position: relative;">
                    <button type="button" id="ccSvcNoAvailabilityClickModalX" aria-label="Close" style="position:absolute; right:12px; top:10px; width:34px; height:34px; border-radius:999px; border:1px solid rgba(148,163,184,0.35); background: rgba(148,163,184,0.10); color: #0f172a; cursor:pointer; font-size:18px; line-height:1;">×</button>
                    <div id="ccSvcNoAvailabilityClickModalTitle" style="font-weight: 800; font-size: 15px; color: var(--gray-900); padding-right: 44px;"></div>
                    <div id="ccSvcNoAvailabilityClickModalBody" style="margin-top: 8px; font-size: 13px; line-height: 1.4; color: var(--gray-700);"></div>
                </div>
            `;

            document.body.appendChild(modal);

            const closeX = document.getElementById('ccSvcNoAvailabilityClickModalX');
            if (closeX) {
                closeX.addEventListener('click', function(){
                    try {
                        modal.style.display = 'none';
                        document.body.style.overflow = '';
                    } catch (e) {}
                });
            }
            return modal;
        } catch (e) {
            return null;
        }
    }

    function ccShowSvcNoAvailabilityClickModal() {
        try {
            const modal = _ensureSvcNoAvailabilityClickModal();
            if (!modal) return;
            const titleEl = document.getElementById('ccSvcNoAvailabilityClickModalTitle');
            const bodyEl = document.getElementById('ccSvcNoAvailabilityClickModalBody');

            const svcName = _ccSelectedServiceNameForNoAvailUI();
            const prefix = (svcName && svcName !== 'This service') ? svcName : 'This service';
            const human = (prefix === 'This service') ? 'this service' : svcName;

            if (titleEl) titleEl.textContent = `${prefix} has no remaining availability`;
            if (bodyEl) {
                bodyEl.innerHTML = '';
                const line1 = document.createElement('div');
                line1.textContent = `There’s no open time left in your schedule for ${human}.`;
                bodyEl.appendChild(line1);
                const line2 = document.createElement('div');
                line2.style.marginTop = '8px';
                line2.textContent = 'To make room, remove days/times from other services (reduce their weekly availability) so this service has open space.';
                bodyEl.appendChild(line2);
                const line3 = document.createElement('div');
                line3.style.marginTop = '8px';
                line3.textContent = 'Or add more day(s)/time(s) to your overall availability so that the service has space to open.';
                bodyEl.appendChild(line3);
            }

            modal.style.display = 'flex';
            try { document.body.style.overflow = 'hidden'; } catch (e) {}
        } catch (e) { /* ignore */ }
    }

    function ccHideSvcNoAvailabilityClickModal() {
        try {
            const modal = document.getElementById('ccSvcNoAvailabilityClickModal');
            if (!modal) return;
            modal.style.display = 'none';
            document.body.style.overflow = '';
        } catch (e) { /* ignore */ }
    }

    function _ccUpdateSvcNoAvailabilityOverlayContent() {
        try {
            const titleEl = document.getElementById('ccSvcNoAvailabilityTitle');
            const bodyEl = document.getElementById('ccSvcNoAvailabilityBody');
            if (!titleEl || !bodyEl) return;

            const svcName = _ccSelectedServiceNameForNoAvailUI();
            const prefix = (svcName && svcName !== 'This service') ? svcName : 'This service';

            titleEl.textContent = `${prefix} has no remaining availability`;
            bodyEl.innerHTML = '';

            const line1 = document.createElement('div');
            line1.textContent = `There’s no open time left in your schedule for ${prefix === 'This service' ? 'this service' : svcName}. Weekly availability and date overrides are disabled for this service scope.`;
            bodyEl.appendChild(line1);

            const line2 = document.createElement('div');
            line2.style.marginTop = '8px';
            line2.textContent = 'To make room, remove days/times from other services (reduce their weekly availability) so this service has open space.';
            bodyEl.appendChild(line2);

            const line3 = document.createElement('div');
            line3.style.marginTop = '8px';
            line3.textContent = 'Or add more day(s)/time(s) to your overall availability so that the service has space to open.';
            bodyEl.appendChild(line3);
        } catch (e) { /* ignore */ }
    }

    function _ensureSvcNoAvailabilityOverlay() {
        try {
            const calEl = document.getElementById('calendar');
            if (!calEl) return null;

            let overlay = document.getElementById('ccSvcNoAvailabilityOverlay');
            if (overlay) return overlay;

            overlay = document.createElement('div');
            overlay.id = 'ccSvcNoAvailabilityOverlay';
            overlay.className = 'cc-svc-no-availability-overlay';
            overlay.innerHTML = `
                <div class="panel">
                    <div class="title" id="ccSvcNoAvailabilityTitle">This service has no remaining availability</div>
                    <div class="body" id="ccSvcNoAvailabilityBody"></div>
                    <div class="actions">
                        <button type="button" class="btn" id="ccSvcNoAvailabilityGoOverall">Go to Overall Availability</button>
                        <button type="button" class="btn secondary" id="ccSvcNoAvailabilityClose">Close</button>
                    </div>
                </div>
            `;
            calEl.appendChild(overlay);

            try { _ccUpdateSvcNoAvailabilityOverlayContent(); } catch (e) {}

            // Wire buttons once
            try {
                const goBtn = document.getElementById('ccSvcNoAvailabilityGoOverall');
                if (goBtn) {
                    goBtn.addEventListener('click', function(){
                        try {
                            if (typeof applySelection === 'function') applySelection(null);
                            overlay.style.display = 'none';
                        } catch (e) {}
                    });
                }
                const closeBtn = document.getElementById('ccSvcNoAvailabilityClose');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(){
                        try { overlay.style.display = 'none'; } catch (e) {}
                    });
                }
            } catch (e) {}

            return overlay;
        } catch (e) {
            return null;
        }
    }

    function _ccSelectedServiceScopeIsFullyBlockedAllWeek() {
        try {
            const isSvcScope = !!(SELECTED_MEMBER && String(SELECTED_MEMBER).startsWith('svc:'));
            if (!isSvcScope) return false;
            const svcId = String(SELECTED_MEMBER).slice(4);

            // Only hard-disable the calendar for Pro (non-Team) service scopes where services
            // partition overall availability. Team/member-based services should remain editable.
            try {
                if (!(IS_PRO && !IS_TEAM)) return false;
            } catch (e) {
                return false;
            }

            // Recompute constraints on-demand so we don't accidentally keep a stale
            // "fully blocked" state when the user switches services.
            let c = null;
            try {
                if (typeof _ccGetWeeklyEditorConstraints === 'function') {
                    c = _ccGetWeeklyEditorConstraints() || null;
                    try { window.__ccWeeklyServiceConstraints = c || null; } catch (e) {}
                }
            } catch (e) {
                c = null;
            }
            // Only fall back to cached constraints if they match the current service.
            if (!c) {
                const cached = window.__ccWeeklyServiceConstraints || null;
                try {
                    if (cached && String(cached.serviceId || '') === String(svcId)) c = cached;
                } catch (e) { c = null; }
            } else {
                try {
                    if (String(c.serviceId || '') !== String(svcId)) c = null;
                } catch (e) { c = null; }
            }
            if (!c || !Array.isArray(c.days) || c.days.length < 7) return false;

            // If this service is tied to staff availability (has assigned members), do not treat
            // it as globally read-only even if remaining is currently 0.
            try {
                if (Array.isArray(c.assignedMembers) && c.assignedMembers.length) return false;
            } catch (e) {}

            // Fully blocked when every weekday has no remaining time.
            return c.days.every(d => !!(d && d.fullyBlocked));
        } catch (e) {
            return false;
        }
    }

    function ccUpdateServiceScopeDisabledUI() {
        try {
            const calEl = document.getElementById('calendar');
            if (!calEl) return;
            const controlsEl = document.getElementById('calendar-controls');

            const noAvail = _ccSelectedServiceScopeIsFullyBlockedAllWeek();
            try { window.__ccServiceScopeNoAvailability = !!noAvail; } catch (e) {}

            // If the service has no remaining availability, make sure the month view reflects it:
            // - clear any existing selection highlight
            // - ensure month circles refresh for the current selection
            try {
                if (noAvail) {
                    try { if (typeof selectedDates !== 'undefined' && selectedDates && typeof selectedDates.clear === 'function') selectedDates.clear(); } catch (e) {}
                    try { document.querySelectorAll('.fc-daygrid-day-number.selected').forEach(el => el.classList.remove('selected')); } catch (e) {}
                    try { if (typeof updateUnavailableDays === 'function') updateUnavailableDays(); } catch (e) {}
                    try { setTimeout(function(){ try { if (typeof updateUnavailableDays === 'function') updateUnavailableDays(); } catch (e) {} }, 120); } catch (e) {}
                }
            } catch (e) { /* ignore */ }

            // Do NOT auto-disable or overlay the calendar. The calendar should still render
            // (it will show grey day circles when there are no bookable times). We only show
            // a full-screen modal when the user interacts with the calendar.
            try { calEl.classList.remove('cc-svc-no-availability'); } catch (e) {}
            try { if (controlsEl) controlsEl.classList.remove('cc-disabled'); } catch (e) {}
            try { const overlay = document.getElementById('ccSvcNoAvailabilityOverlay'); if (overlay) overlay.style.display = 'none'; } catch (e) {}
            try { if (!noAvail) ccHideSvcNoAvailabilityClickModal(); } catch (e) {}
        } catch (e) {
            /* ignore */
        }
    }

    async function refreshServiceScopeMonthParity() {
        const svc = _svcForSelectedScope();
        if (!svc) return;

        // If this service has no explicitly saved weekly availability windows, it must
        // remain unavailable until the user manually enables days/ranges and saves.
        // We still allow explicit per-date availability overrides to show as available.
        const svcHasExplicitWeekly = !!(svc && (svc.has_service_weekly_windows || false));
        const blockedDates = new Set();
        const availableOverrideDates = new Set();
        try {
            calendar.getEvents().forEach(ev => {
                try {
                    const props = ev.extendedProps || {};
                    if (props.override_type === 'blocked') {
                        blockedDates.add(ev.startStr.split('T')[0]);
                    } else if (props.override_type === 'available') {
                        availableOverrideDates.add(ev.startStr.split('T')[0]);
                    }
                } catch (e) { /* ignore */ }
            });
        } catch (e) { /* ignore */ }
        const dates = _visibleDayDates();
        if (!dates || dates.length === 0) {
            // FullCalendar sometimes hasn't attached month day cells yet (or is mid-rerender)
            // when we try to compute parity. Retry a few times so initial-load and scope-switch
            // don't require a hard refresh.
            try {
                const attemptKey = `${svc.slug}|${String(SELECTED_MEMBER || '')}`;
                if (__svcParityReadyLastAttempt !== attemptKey) {
                    __svcParityReadyLastAttempt = attemptKey;
                    __svcParityReadyRetries = 0;
                }
                if (__svcParityReadyRetries < 10) {
                    __svcParityReadyRetries += 1;
                    setTimeout(function(){
                        try { refreshServiceScopeMonthParity(); } catch (e) {}
                    }, 60);
                }
            } catch (e) {}
            return;
        }

        // If the service has no explicit weekly windows, treat the month as unavailable.
        // Only show explicit per-date availability overrides as available.
        if (!svcHasExplicitWeekly) {
            try {
                const today = new Date();
                const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const dayHasSlots = {};
                for (const dateStr of dates) {
                    let enabled = false;
                    try {
                        const d = parseYMD(dateStr);
                        if (d < todayMidnight) {
                            enabled = false;
                        } else if (blockedDates.has(dateStr)) {
                            enabled = false;
                        } else if (availableOverrideDates.has(dateStr)) {
                            enabled = true;
                        } else {
                            enabled = false;
                        }
                    } catch (e) {
                        enabled = false;
                    }
                    dayHasSlots[dateStr] = enabled;
                }

                _applyServiceScopeDayClasses(dayHasSlots);
                try { renderOverridesTable(); } catch (e) { /* ignore */ }
            } finally {
                try { _setCalendarLoading(false); } catch (e) {}
            }
            return;
        }

        const token = ++__svcParityToken;
        const sorted = dates.slice().sort();
        const minDate = sorted[0];
        const maxDate = sorted[sorted.length - 1];
        const key = `${svc.slug}|${minDate}|${maxDate}`;

        // Fast path: re-apply cached results for the same visible month/service
        if (__svcParityLastKey === key && __svcParityLastMap) {
            _applyServiceScopeDayClasses(__svcParityLastMap);
            try { _setCalendarLoading(false); } catch (e) {}
            return;
        }

        // Grey out calendar until parity finishes (prevents confusing partial render)
        try { _setCalendarLoading(true, 'Loading availability…'); } catch (e) {}

        const today = new Date();
        const todayMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());

        // Fetch server-effective settings (once) + batch summary in parallel.
        const cacheBuster = `&_t=${Date.now()}`;
        let eff = null;
        let summary = {};
        let batchOk = false;
        const startIsoRange = _toIsoLocal(minDate, 0, 0, 0);
        const endIsoRange = _toIsoLocal(maxDate, 23, 59, 59);
        try {
            const effUrl = `/bus/${orgSlug}/services/${svc.slug}/effective/?date=${encodeURIComponent(minDate)}`;
            const batchUrl = `/bus/${orgSlug}/services/${svc.slug}/availability/batch/?start=${encodeURIComponent(startIsoRange)}&end=${encodeURIComponent(endIsoRange)}${cacheBuster}`;
            const [effResp, batchResp] = await Promise.all([
                fetch(effUrl, { credentials: 'same-origin' }).catch(() => null),
                fetch(batchUrl, { credentials: 'same-origin' }).catch(() => null),
            ]);
            try { if (effResp && effResp.ok) eff = await effResp.json(); } catch (e) { eff = null; }
            try {
                if (batchResp && batchResp.ok) {
                    batchOk = true;
                    summary = await batchResp.json();
                }
            } catch (e) {
                batchOk = false;
                summary = {};
            }
        } catch (e) {
            eff = null;
            summary = {};
            batchOk = false;
        }

        // If the parity batch endpoint is unavailable (network error, 403/404, etc.),
        // fall back to the weekly_map-based month styling instead of greying out the
        // entire month as "no slots".
        if (!batchOk) {
            try {
                const weekly = Array.isArray(svc.weekly_map) ? svc.weekly_map : [[],[],[],[],[],[],[]];
                const dayHasSlots = {};
                for (const dateStr of dates) {
                    let enabled = false;
                    try {
                        if (blockedDates.has(dateStr)) enabled = false;
                        else if (availableOverrideDates.has(dateStr)) enabled = true;
                        else if (!svcHasExplicitWeekly) {
                            enabled = false;
                        } else {
                            const d = parseYMD(dateStr);
                            const dow = d.getDay();
                            enabled = !!(weekly && weekly[dow] && Array.isArray(weekly[dow]) && weekly[dow].length > 0);
                        }
                    } catch (e) {
                        enabled = false;
                    }
                    dayHasSlots[dateStr] = enabled;
                }

                // If this service has no remaining availability (Pro, non-Team), force all-grey.
                try {
                    const forceAllGrey = (typeof _ccSelectedServiceScopeIsFullyBlockedAllWeek === 'function')
                        ? _ccSelectedServiceScopeIsFullyBlockedAllWeek()
                        : false;
                    if (forceAllGrey) {
                        for (const dateStr of dates) {
                            try {
                                const d = parseYMD(dateStr);
                                if (d < todayMidnight) continue;
                            } catch (e) {}
                            dayHasSlots[dateStr] = false;
                        }
                    }
                } catch (e) { /* ignore */ }
                if (token !== __svcParityToken) return;
                _applyServiceScopeDayClasses(dayHasSlots);
                try { renderOverridesTable(); } catch (e) { /* ignore */ }
            } finally {
                try { _setCalendarLoading(false); } catch (e) {}
            }
            return;
        }

        // Cache effective settings for the selected service so other logic (fully-booked gating)
        // can distinguish policy-window unavailability (min notice / max booking days).
        try {
            if (!window.__ccServiceEffective) window.__ccServiceEffective = {};
            if (eff && svc && svc.slug) window.__ccServiceEffective[String(svc.slug)] = eff;
        } catch (e) { /* ignore */ }

        const useFixed = (eff && typeof eff.use_fixed_increment === 'boolean') ? !!eff.use_fixed_increment : !!svc.use_fixed_increment;
        const incVal = Math.max(5, Number((eff && eff.time_increment_minutes) || svc.time_increment_minutes || 30));
        let allowEndsForAvail = false;
        try {
            allowEndsForAvail = (eff && typeof eff.allow_ends_after_availability === 'boolean') ? !!eff.allow_ends_after_availability : !!svc.allow_ends_after_availability;
        } catch (e) { allowEndsForAvail = false; }

        const edgeVal = (function(){
            try {
                const raw = localStorage.getItem('edge_buffers_' + svc.slug);
                if (raw === '1' || raw === 'true') return 1;
                if (raw === '0' || raw === 'false') return 0;
            } catch (e) {}
            return 0;
        })();

        // Fast paint (matches public month behavior): apply batch summary immediately.
        // This makes circles appear quickly instead of waiting for per-day verification.
        const dayHasSlots = {};
        for (const dateStr of dates) {
            dayHasSlots[dateStr] = false;
            try {
                const d = parseYMD(dateStr);
                if (d < todayMidnight) continue;
            } catch (e) {}
            dayHasSlots[dateStr] = !!(summary && summary[dateStr]);
        }

        // If the service has no explicitly saved weekly windows, do NOT let it
        // "inherit" or auto-take newly freed overall availability. Keep the month
        // grey unless there is an explicit per-date availability override.
        try {
            if (!svcHasExplicitWeekly) {
                for (const dateStr of dates) {
                    try {
                        const d = parseYMD(dateStr);
                        if (d < todayMidnight) continue;
                    } catch (e) { /* ignore */ }
                    if (blockedDates.has(dateStr)) {
                        dayHasSlots[dateStr] = false;
                    } else if (availableOverrideDates.has(dateStr)) {
                        // Keep true if server says there are slots on this override day.
                        // (If server summary says false, leave false.)
                        dayHasSlots[dateStr] = !!dayHasSlots[dateStr];
                    } else {
                        dayHasSlots[dateStr] = false;
                    }
                }
            }
        } catch (e) { /* ignore */ }

        // If this service has *no remaining availability* (Pro, non-Team service scope),
        // force the entire month to display as unavailable (grey). This prevents
        // stale/global state from making the wrong service appear grey or blue.
        try {
            const forceAllGrey = (typeof _ccSelectedServiceScopeIsFullyBlockedAllWeek === 'function')
                ? _ccSelectedServiceScopeIsFullyBlockedAllWeek()
                : false;
            if (forceAllGrey) {
                for (const dateStr of dates) {
                    try {
                        const d = parseYMD(dateStr);
                        if (d < todayMidnight) continue;
                    } catch (e) { /* ignore */ }
                    dayHasSlots[dateStr] = false;
                }
            }
        } catch (e) { /* ignore */ }

        if (token !== __svcParityToken) return;
        _applyServiceScopeDayClasses(dayHasSlots);
        try { renderOverridesTable(); } catch (e) { /* ignore */ }
        // Remove the overlay once we've painted the month; refine in background.
        try { _setCalendarLoading(false); } catch (e) {}

        // Background verification: for days batch marked true, confirm slots exist.
        // This mirrors the public page's "verify detailed availability" idea, but
        // does NOT block rendering.
        const candidates = [];
        for (const dateStr of dates) {
            try {
                const d = parseYMD(dateStr);
                if (d < todayMidnight) continue;
            } catch (e) {}
            if (dayHasSlots[dateStr]) candidates.push(dateStr);
        }

        if (candidates.length === 0) {
            __svcParityLastKey = key;
            __svcParityLastMap = dayHasSlots;
            return;
        }

        (async () => {
            const incQueryBase = useFixed ? '' : `&inc=${incVal}`;
            const concurrency = 4;
            let idx = 0;
            let pendingApply = null;
            const scheduleApply = () => {
                if (pendingApply) return;
                pendingApply = setTimeout(() => {
                    pendingApply = null;
                    if (token !== __svcParityToken) return;
                    _applyServiceScopeDayClasses(dayHasSlots);
                }, 75);
            };

            async function worker() {
                while (true) {
                    const my = idx++;
                    if (my >= candidates.length) return;
                    const dateStr = candidates[my];
                    try {
                        const startIso = _toIsoLocal(dateStr, 0, 0, 0);
                        const endIso = _toIsoLocal(dateStr, 23, 59, 59);
                        const availUrl = `/bus/${orgSlug}/services/${svc.slug}/availability/?start=${encodeURIComponent(startIso)}&end=${encodeURIComponent(endIso)}${incQueryBase}&edge_buffers=${edgeVal}&allow_ends_after_availability=${allowEndsForAvail?1:0}${cacheBuster}`;
                        const r = await fetch(availUrl, { credentials: 'same-origin' });
                        const slots = r.ok ? await r.json() : [];
                        dayHasSlots[dateStr] = Array.isArray(slots) && slots.length > 0;
                    } catch (e) {
                        dayHasSlots[dateStr] = false;
                    }
                    scheduleApply();
                }
            }

            try {
                await Promise.all(Array.from({ length: Math.min(concurrency, candidates.length) }, () => worker()));
            } catch (e) { /* ignore */ }
            if (token !== __svcParityToken) return;

            if (pendingApply) {
                try { clearTimeout(pendingApply); } catch (e) {}
                pendingApply = null;
            }

            __svcParityLastKey = key;
            __svcParityLastMap = dayHasSlots;
            _applyServiceScopeDayClasses(dayHasSlots);
            try { renderOverridesTable(); } catch (e) { /* ignore */ }
        })();
    }

    // -----------------------------
    // 3️⃣ Render default availability table
    // -----------------------------
    // Global Custom Time Picker accessible across contexts
    function createCustomTimePickerGlobal(inputElement) {
        const picker = document.createElement('div');
        picker.className = 'custom-time-picker';

        const [initialHour, initialMinute] = (inputElement.value || '09:00').split(':');
        let selectedHour = initialHour;
        let selectedMinute = initialMinute;

        const isStart = inputElement.classList.contains('modal-range-start') || inputElement.classList.contains('range-start');
        const headerText = isStart ? 'Start Time' : 'End Time';

        function _ccGetAllowedIntervalsForInput(el){
            try {
                // Only constrain weekly editor rows for service scope selections.
                const dayIdx = parseInt(String(el?.dataset?.day ?? ''), 10);
                if (isNaN(dayIdx)) return null;
                const c = window.__ccWeeklyServiceConstraints || null;
                if (!c || !c.days || !c.days[dayIdx]) return null;
                const d = c.days[dayIdx];
                // Remaining = memberAllowed minus otherBlocked (mixed signature).
                if (!d || !Array.isArray(d.remaining)) return null;
                return d.remaining.slice();
            } catch (e) {
                return null;
            }
        }

        function _ccMinutesFromHHMM(v){
            try { return _minutesFromTimeStr(String(v || '00:00')); } catch (e) { return null; }
        }

        function _ccIsMinuteAllowed(min){
            try {
                if (min === null || min === undefined || isNaN(min)) return false;

                const allowed = _ccGetAllowedIntervalsForInput(inputElement);
                if (allowed === null) return true; // unconstrained
                if (!allowed.length) return false;

                // Also respect the other bound in the current row, if present.
                const row = inputElement.closest('.range-row, .modal-range-row');
                const startEl = row ? row.querySelector('.range-start, .modal-range-start') : null;
                const endEl = row ? row.querySelector('.range-end, .modal-range-end') : null;
                const startMin = startEl ? _ccMinutesFromHHMM(startEl.value) : null;
                const endMin = endEl ? _ccMinutesFromHHMM(endEl.value) : null;

                // Determine membership in allowed intervals.
                const inAllowed = allowed.some(r => {
                    try {
                        const s = parseInt(r.start, 10);
                        const e = parseInt(r.end, 10);
                        if (isNaN(s) || isNaN(e)) return false;
                        // Start: [s, e)
                        // End: (s, e]
                        if (isStart) return (s <= min) && (min < e);
                        return (s < min) && (min <= e);
                    } catch (e) {
                        return false;
                    }
                });
                if (!inAllowed) return false;

                // Enforce start < end within row.
                if (isStart && endMin !== null && !isNaN(endMin)) {
                    if (!(min < endMin)) return false;
                }
                if (!isStart && startMin !== null && !isNaN(startMin)) {
                    if (!(min > startMin)) return false;
                }

                return true;
            } catch (e) {
                return true;
            }
        }

        function _ccFirstAllowedMinuteForHour(hour){
            try {
                const h = parseInt(hour, 10);
                if (isNaN(h)) return null;
                const base = h * 60;
                for (let m = 0; m < 60; m++){
                    const min = base + m;
                    if (_ccIsMinuteAllowed(min)) return min;
                }
            } catch (e) {}
            return null;
        }

        function _ccSnapToAllowed(hh, mm){
            try {
                const h = parseInt(hh, 10);
                const m = parseInt(mm, 10);
                if (isNaN(h) || isNaN(m)) return null;
                const cur = h*60 + m;
                if (_ccIsMinuteAllowed(cur)) return cur;
                // Try first allowed in this hour
                const firstInHour = _ccFirstAllowedMinuteForHour(h);
                if (firstInHour !== null) return firstInHour;
                // Otherwise, scan forward for the next allowed minute in the day.
                for (let t = 0; t < 24*60; t++){
                    if (_ccIsMinuteAllowed(t)) return t;
                }
            } catch (e) {}
            return null;
        }

        picker.innerHTML = `
            <div class="time-picker-header">${headerText}</div>
            <div class="time-picker-display">${formatDisplayTime(selectedHour, selectedMinute)}</div>
            <div class="time-picker-selectors">
                <div class="time-selector">
                    <div class="time-selector-label">Hour</div>
                    <div class="time-scroll-container" data-type="hour"></div>
                </div>
                <div class="time-selector">
                    <div class="time-selector-label">Minute</div>
                    <div class="time-scroll-container" data-type="minute"></div>
                </div>
            </div>
            <div class="time-picker-actions">
                <button class="time-picker-btn cancel">Cancel</button>
                <button class="time-picker-btn confirm">Confirm</button>
            </div>
        `;

        const hourContainer = picker.querySelector('[data-type="hour"]');
        for (let h = 0; h < 24; h++) {
            const hourStr = String(h).padStart(2, '0');
            const opt = document.createElement('div');
            opt.className = 'time-option';
            // Disable hours that have no valid minutes under constraints.
            try {
                if (_ccFirstAllowedMinuteForHour(h) === null) opt.classList.add('disabled');
            } catch (e) {}
            if (hourStr === selectedHour) opt.classList.add('selected');
            opt.textContent = formatHour(h);
            opt.addEventListener('click', () => {
                hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedHour = hourStr;
                // If current minute is no longer allowed, snap to first allowed minute in this hour.
                try {
                    const snapped = _ccSnapToAllowed(selectedHour, selectedMinute);
                    if (snapped !== null) {
                        selectedHour = String(Math.floor(snapped / 60)).padStart(2, '0');
                        selectedMinute = String(snapped % 60).padStart(2, '0');
                    }
                } catch (e) {}
                updateDisplay();
                try { syncMinuteOptions(); } catch (e) {}
                opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            hourContainer.appendChild(opt);
        }

        const minuteContainer = picker.querySelector('[data-type="minute"]');
        for (let m = 0; m < 60; m++) {
            const minStr = String(m).padStart(2, '0');
            const opt = document.createElement('div');
            opt.className = 'time-option';
            if (minStr === selectedMinute) opt.classList.add('selected');
            opt.textContent = minStr;
            opt.addEventListener('click', () => {
                minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                opt.classList.add('selected');
                selectedMinute = minStr;
                updateDisplay();
                opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            minuteContainer.appendChild(opt);
        }

        function syncMinuteOptions(){
            try {
                const h = parseInt(selectedHour, 10);
                const opts = Array.from(minuteContainer.querySelectorAll('.time-option'));
                let hasSelected = false;
                for (const o of opts){
                    const mm = parseInt(o.textContent, 10);
                    const min = (isNaN(h) || isNaN(mm)) ? null : (h*60 + mm);
                    const ok = _ccIsMinuteAllowed(min);
                    o.classList.toggle('disabled', !ok);
                    if (ok && o.classList.contains('selected')) hasSelected = true;
                }
                if (!hasSelected){
                    const snap = _ccFirstAllowedMinuteForHour(h);
                    if (snap !== null) {
                        selectedHour = String(Math.floor(snap / 60)).padStart(2, '0');
                        selectedMinute = String(snap % 60).padStart(2, '0');
                        // Update selections
                        hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                        hourContainer.querySelectorAll('.time-option').forEach(o => {
                            if (String(o.textContent || '').includes(formatHour(parseInt(selectedHour,10)).split(' ')[0])) {
                                // no-op: we'll set selected by hourStr match below
                            }
                        });
                        hourContainer.querySelectorAll('.time-option').forEach(o => {
                            // hour options store hourStr, but only via closure; re-select by index
                        });
                        const hourIdx = parseInt(selectedHour, 10);
                        const hourOpt = hourContainer.querySelectorAll('.time-option')[hourIdx];
                        if (hourOpt) hourOpt.classList.add('selected');

                        minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                        const minuteOpt = minuteContainer.querySelectorAll('.time-option')[parseInt(selectedMinute,10)];
                        if (minuteOpt) minuteOpt.classList.add('selected');
                        updateDisplay();
                        // Recompute disabled state for the now-selected hour
                        for (const o of opts){
                            const mm = parseInt(o.textContent, 10);
                            const min = (isNaN(hourIdx) || isNaN(mm)) ? null : (hourIdx*60 + mm);
                            const ok = _ccIsMinuteAllowed(min);
                            o.classList.toggle('disabled', !ok);
                        }
                    }
                }
            } catch (e) { /* ignore */ }
        }

        function updateDisplay() {
            picker.querySelector('.time-picker-display').textContent = formatDisplayTime(selectedHour, selectedMinute);
        }
        function formatHour(h) {
            if (h === 0) return '12 AM';
            if (h < 12) return `${h} AM`;
            if (h === 12) return '12 PM';
            return `${h - 12} PM`;
        }
        function formatDisplayTime(h, m) {
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const h12 = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
            return `${h12}:${m} ${ampm}`;
        }

        setTimeout(() => {
            hourContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' });
            minuteContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' });
        }, 50);

        // Apply constraints immediately (snap initial selection + disable invalid options)
        try {
            const snapped = _ccSnapToAllowed(selectedHour, selectedMinute);
            if (snapped !== null) {
                selectedHour = String(Math.floor(snapped / 60)).padStart(2, '0');
                selectedMinute = String(snapped % 60).padStart(2, '0');
                // Apply selection state
                hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                const hourIdx = parseInt(selectedHour, 10);
                const hourOpt = hourContainer.querySelectorAll('.time-option')[hourIdx];
                if (hourOpt) hourOpt.classList.add('selected');
                minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                const minuteOpt = minuteContainer.querySelectorAll('.time-option')[parseInt(selectedMinute,10)];
                if (minuteOpt) minuteOpt.classList.add('selected');
                updateDisplay();
            }
            syncMinuteOptions();
        } catch (e) {}

        picker.querySelector('.confirm').addEventListener('click', (e) => {
            e.stopPropagation();
            inputElement.value = `${selectedHour}:${selectedMinute}`;
            try { inputElement.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) {}
            try { inputElement.dispatchEvent(new Event('change', { bubbles: true })); } catch (err) {}
            picker.remove();
        });
        picker.querySelector('.cancel').addEventListener('click', (e) => {
            e.stopPropagation();
            picker.remove();
        });
        setTimeout(() => {
            document.addEventListener('click', function closeOnOutside(e) {
                if (!picker.contains(e.target) && e.target !== inputElement) {
                    picker.remove();
                    document.removeEventListener('click', closeOnOutside);
                }
            });
        }, 100);

        return picker;
    }

    // Weekly availability save button: show only when there are unsaved changes.
    // Baseline is tracked per current selection (member/service/org target).
    const __ccWeeklyBaselineByTarget = {};
    let __ccWeeklyIniting = false;

    function __ccWeeklyTargetKey(){
        // Non-Team plans set SELECTED_MEMBER = null, but org-wide weekly defaults
        // still need dirty-tracking. Use a stable fallback key for org scope.
        try { return String((typeof ccOverrideTarget === 'function' ? ccOverrideTarget() : null) || 'org'); } catch (e) { return 'org'; }
    }

    function __ccWeeklySetSaveVisible(visible){
        const btn = document.getElementById('saveDefaultAvailabilityBtn');
        if (!btn) return;
        btn.style.display = visible ? 'inline-block' : 'none';
    }

    function displayDefaultAvailability() {
        const container = document.getElementById("defaultAvailabilityTable");
        container.innerHTML = "";
        const days = ["Sunday", "Monday","Tuesday","Wednesday","Thursday","Friday", "Saturday"];

        // Recompute service-scope constraint overlays each time we render the weekly editor.
        // This ensures changes to *other* services (freeing/reserving time) are reflected
        // immediately without requiring a full page refresh.
        try { if (typeof _ccRefreshConstraints === 'function') _ccRefreshConstraints(); } catch (e) { /* ignore */ }

        // Safety: if some other code path triggers a weekly re-render after the user
        // switched scopes/services, ensure `defaultAvailability` is re-sourced from
        // the currently selected target before we build DOM rows.
        try {
            const desiredKey = __ccWeeklyTargetKey();
            if (desiredKey && window.__ccWeeklyRenderedTargetKey !== desiredKey) {
                if (typeof window.__ccSelectDefaultAvailabilityFor === 'function') {
                    try {
                        __ccWeeklyIniting = true;
                        window.__ccSelectDefaultAvailabilityFor(SELECTED_MEMBER);
                    } finally {
                        __ccWeeklyIniting = false;
                    }
                }
                window.__ccWeeklyRenderedTargetKey = desiredKey;
            }
        } catch (e) { /* ignore */ }

        // Critical rule: an unconfigured service (no explicitly saved weekly windows)
        // must NOT auto-take newly freed availability. Keep it fully unavailable
        // until the user manually enables days/ranges and saves.
        //
        // Only apply this forced reset when we have no baseline yet for this target,
        // so we don't wipe unsaved user edits during the current session.
        try {
            const key = __ccWeeklyTargetKey();
            const sel = SELECTED_MEMBER;
            if (key && !Object.prototype.hasOwnProperty.call(__ccWeeklyBaselineByTarget, key)) {
                if (sel && String(sel).startsWith('svc:')) {
                    const svcId = String(sel).slice(4);
                    const svc = (Array.isArray(SERVICES) ? SERVICES.find(s => String(s.id) === String(svcId)) : null);
                    const hasExplicit = !!(svc && (svc.has_service_weekly_windows || false));
                    if (svc && !hasExplicit) {
                        const built = buildAvailabilityFromPayload([[],[],[],[],[],[],[]]);
                        for (const k of Object.keys(built)) defaultAvailability[k] = built[k];
                    }
                }
            }
        } catch (e) { /* ignore */ }

        function _ccWeeklyValidateDay(dayIndex, changedInputEl) {
            try {
                const cb = document.querySelector(`.unavailable-checkbox[data-day='${dayIndex}']`);
                if (cb && cb.checked) return true;
                const containerEl = document.getElementById(`ranges-container-${dayIndex}`);
                const rows = containerEl ? Array.from(containerEl.querySelectorAll('.range-row')) : [];
                const verdict = _ccValidateRangeRowsNoOverlap(rows, '.range-start', '.range-end');
                if (!verdict.ok) {
                    _ccToastRangeError(verdict.message);
                    _ccRevertToPrevValue(changedInputEl);
                    return false;
                }
                // Update prev snapshot for all inputs once valid
                for (const r of rows) {
                    try { _ccSetPrevValue(r.querySelector('.range-start')); } catch (e) {}
                    try { _ccSetPrevValue(r.querySelector('.range-end')); } catch (e) {}
                }
                return true;
            } catch (e) {
                return true;
            }
        }

        function _ccNormalizeWeeklyStateFromUI(){
            // Read the current UI state (not in-memory defaultAvailability) so the time picker is included.
            const out = [];
            for (let day = 0; day < 7; day++) {
                const containerEl = document.getElementById(`ranges-container-${day}`);
                const rows = containerEl ? Array.from(containerEl.querySelectorAll('.range-row')) : [];
                const ranges = [];
                for (const r of rows) {
                    const s = (r.querySelector('.range-start')?.value || '').trim();
                    const e = (r.querySelector('.range-end')?.value || '').trim();
                    if (!s || !e) continue;
                    ranges.push(`${s}-${e}`);
                }
                const cb = document.querySelector(`.unavailable-checkbox[data-day='${day}']`);
                const unavailableChecked = !!(cb && cb.checked);
                const unavailable = unavailableChecked || ranges.length === 0;

                // Normalize + sort ranges for stable comparison
                const normRanges = (unavailable ? [] : ranges)
                    .map(x => String(x).trim())
                    .filter(Boolean)
                    .map(x => {
                        const parts = x.split('-');
                        const a = (parts[0] || '').trim();
                        const b = (parts[1] || '').trim();
                        return { a, b, raw: `${a}-${b}` };
                    })
                    .filter(r => r.a && r.b)
                    .sort((r1, r2) => (r1.a === r2.a ? (r1.b < r2.b ? -1 : (r1.b > r2.b ? 1 : 0)) : (r1.a < r2.a ? -1 : 1)))
                    .map(r => r.raw);

                out.push({ unavailable: !!unavailable, ranges: normRanges });
            }
            return JSON.stringify(out);
        }

        function _ccUpdateWeeklySaveVisibility(){
            if (__ccWeeklyIniting) return;
            const key = __ccWeeklyTargetKey();
            if (!key) {
                __ccWeeklySetSaveVisible(false);
                return;
            }
            const cur = _ccNormalizeWeeklyStateFromUI();
            if (!Object.prototype.hasOwnProperty.call(__ccWeeklyBaselineByTarget, key)) {
                __ccWeeklyBaselineByTarget[key] = cur;
                __ccWeeklySetSaveVisible(false);
                return;
            }
            __ccWeeklySetSaveVisible(cur !== __ccWeeklyBaselineByTarget[key]);
        }

        function _ccSigKey(svc){
            try {
                if (svc && Array.isArray(svc.schedule_signature) && svc.schedule_signature.length) {
                    return svc.schedule_signature.map(x => String(x)).join('|');
                }
                // Fallback (older payloads)
                return [
                    String(svc?.duration ?? ''),
                    String(svc?.buffer_after ?? ''),
                    String(svc?.time_increment_minutes ?? ''),
                    String(!!svc?.use_fixed_increment),
                    String(!!svc?.allow_squished_bookings),
                    String(!!svc?.allow_ends_after_availability),
                    String(svc?.min_notice_hours ?? ''),
                    String(svc?.max_booking_days ?? ''),
                ].join('|');
            } catch (e) {
                return '';
            }
        }

        function _ccMinutes(hhmm){
            try { return _minutesFromTimeStr(String(hhmm || '00:00')); } catch (e) { return 0; }
        }

        function _ccMergeRanges(ranges){
            const out = [];
            const sorted = (ranges || []).slice().filter(r => r && r.start < r.end).sort((a,b) => a.start - b.start);
            for (const r of sorted){
                if (!out.length){ out.push({start:r.start,end:r.end}); continue; }
                const last = out[out.length-1];
                if (r.start <= last.end){ last.end = Math.max(last.end, r.end); }
                else out.push({start:r.start,end:r.end});
            }
            return out;
        }

        function _ccSubtractRanges(allowed, blocked){
            // Return segments in allowed that are not covered by blocked
            const A = _ccMergeRanges(allowed);
            const B = _ccMergeRanges(blocked);
            const out = [];
            let j = 0;
            for (const a of A){
                let cur = a.start;
                while (j < B.length && B[j].end <= cur) j++;
                let k = j;
                while (k < B.length && B[k].start < a.end){
                    const b = B[k];
                    if (b.start > cur) out.push({start: cur, end: Math.min(b.start, a.end)});
                    cur = Math.max(cur, b.end);
                    if (cur >= a.end) break;
                    k++;
                }
                if (cur < a.end) out.push({start: cur, end: a.end});
            }
            return _ccMergeRanges(out);
        }

        function _ccInvertRanges(allowed){
            const merged = _ccMergeRanges(allowed);
            const blocked = [];
            let cur = 0;
            for (const r of merged){
                if (cur < r.start) blocked.push({start:cur, end:r.start});
                cur = Math.max(cur, r.end);
            }
            if (cur < 24*60) blocked.push({start:cur, end:24*60});
            return blocked;
        }

        function _ccIntersectRanges(a, b){
            const A = _ccMergeRanges(a);
            const B = _ccMergeRanges(b);
            const out = [];
            let i=0, j=0;
            while (i < A.length && j < B.length){
                const s = Math.max(A[i].start, B[j].start);
                const e = Math.min(A[i].end, B[j].end);
                if (s < e) out.push({start:s,end:e});
                if (A[i].end < B[j].end) i++; else j++;
            }
            return out;
        }

        function _ccRangesFromWeeklyMap(weeklyMap, uiDayIdx){
            const out = [];
            try {
                const dayArr = (weeklyMap && Array.isArray(weeklyMap) && weeklyMap.length === 7) ? weeklyMap[uiDayIdx] : null;
                const ranges = Array.isArray(dayArr) ? dayArr : [];
                for (const r of ranges){
                    const parts = String(r || '').split('-');
                    const s = (parts[0] || '').trim();
                    const e = (parts[1] || '').trim();
                    if (!s || !e) continue;
                    const sm = _ccMinutes(s);
                    const em = _ccMinutes(e);
                    if (sm < em) out.push({start:sm,end:em});
                }
            } catch (e) {}
            return _ccMergeRanges(out);
        }

        function _ccGetWeeklyEditorConstraints(){
            // Applies when editing a service scope. For solo services: member availability minus
            // other solo services (mixed signature). For shared/group services: intersection of
            // member availability minus ALL members' other services.
            try {
                if (!SELECTED_MEMBER || !String(SELECTED_MEMBER).startsWith('svc:')) return null;
                const svcId = String(SELECTED_MEMBER).slice(4);
                const svc = SERVICES.find(s => String(s.id) === String(svcId));
                if (!svc) return null;

                // Pro (solo) scope: overall availability minus all other services.
                // This matches the mental model: you can't do two services at once.
                if (IS_PRO && !IS_TEAM) {
                    const daysOut = [];
                    const mySig = _ccSigKey(svc);

                    // Convert orgDefaultAvailability (defaultAvailability-like) to weeklyMap-style array.
                    const overallWeeklyMap = [[],[],[],[],[],[],[]];
                    for (let d=0; d<7; d++){
                        const info = orgDefaultAvailability[d] || {};
                        let ranges = [];
                        if (info && info.unavailable) {
                            ranges = [];
                        } else if (info.ranges && info.ranges.length) {
                            ranges = info.ranges;
                        } else if (info.start && info.end) {
                            ranges = [`${info.start}-${info.end}`];
                        }
                        overallWeeklyMap[d] = Array.isArray(ranges) ? ranges.slice() : [];
                    }

                    for (let d=0; d<7; d++){
                        const overallAllowed = _ccRangesFromWeeklyMap(overallWeeklyMap, d);

                        // Union of other services' weekly windows.
                        let otherRaw = [];
                        for (const os of (Array.isArray(SERVICES) ? SERVICES : [])) {
                            try {
                                if (!os) continue;
                                // Inactive services should not reserve time.
                                if (!os.is_active) continue;
                                if (String(os.id) === String(svcId)) continue;
                                // Same-signature services can share the same windows.
                                if (_ccSigKey(os) === mySig) continue;
                                otherRaw = otherRaw.concat(_ccRangesFromWeeklyMap(os.weekly_map, d));
                            } catch (e) {}
                        }

                        const otherBlocked = _ccIntersectRanges(_ccMergeRanges(otherRaw), overallAllowed);
                        const remaining = _ccSubtractRanges(overallAllowed, otherBlocked);
                        const fullyBlocked = (overallAllowed.length === 0) || (remaining.length === 0);
                        const shouldShow = fullyBlocked || (otherBlocked && otherBlocked.length > 0);

                        daysOut[d] = {
                            memberAllowed: overallAllowed,
                            memberBlocked: (overallAllowed.length ? _ccInvertRanges(overallAllowed) : [{start:0,end:24*60}]),
                            otherBlocked,
                            remaining,
                            fullyBlocked,
                            shouldShow,
                        };
                    }

                    return { serviceId: svcId, membershipId: null, assignedMembers: [], days: daysOut };
                }

                const assigned = (typeof getAssignedMembersForService === 'function') ? (getAssignedMembersForService(svc) || []) : (svc.assigned_members || []);
                const daysOut = [];

                if (!assigned || !assigned.length) return null;

                function _memberWeeklyMapFor(mid){
                    const memberPayload = (memberAvailMap && memberAvailMap[mid]) ? memberAvailMap[mid] : null;
                    const memberBuilt = memberPayload ? buildAvailabilityFromPayload(memberPayload) : orgDefaultAvailability;

                    // Convert memberBuilt (defaultAvailability-like) to a weeklyMap style for parsing.
                    const memberWeeklyMap = [[],[],[],[],[],[],[]];
                    for (let d=0; d<7; d++){
                        const info = memberBuilt[d] || {};
                        let ranges = [];
                        if (info && info.unavailable) {
                            ranges = [];
                        } else if (info.ranges && info.ranges.length) {
                            ranges = info.ranges;
                        } else if (info.start && info.end) {
                            ranges = [`${info.start}-${info.end}`];
                        }
                        memberWeeklyMap[d] = Array.isArray(ranges) ? ranges.slice() : [];
                    }
                    return memberWeeklyMap;
                }

                if (assigned.length === 1){
                    const mid = String(assigned[0]);
                    const memberWeeklyMap = _memberWeeklyMapFor(mid);
                    const mySig = _ccSigKey(svc);
                    const others = (typeof personalServicesForMember === 'function') ? (personalServicesForMember(mid) || []) : [];
                    const otherSvcs = others.filter(os => String(os.id) !== String(svcId) && !!(os && os.is_active));

                    for (let d=0; d<7; d++){
                        const memberAllowed = _ccRangesFromWeeklyMap(memberWeeklyMap, d);
                        // Block other solo services only when signatures differ (align with backend rule).
                        let otherRaw = [];
                        for (const os of otherSvcs){
                            try {
                                if (_ccSigKey(os) === mySig) continue;
                                otherRaw = otherRaw.concat(_ccRangesFromWeeklyMap(os.weekly_map, d));
                            } catch (e) {}
                        }
                        const otherBlocked = _ccIntersectRanges(_ccMergeRanges(otherRaw), memberAllowed);
                        const remaining = _ccSubtractRanges(memberAllowed, otherBlocked);
                        const fullyBlocked = (memberAllowed.length === 0) || (remaining.length === 0);
                        const shouldShow = fullyBlocked || (otherBlocked && otherBlocked.length > 0);
                        daysOut[d] = {
                            memberAllowed,
                            memberBlocked: (memberAllowed.length ? _ccInvertRanges(memberAllowed) : [{start:0,end:24*60}]),
                            otherBlocked,
                            remaining,
                            fullyBlocked,
                            shouldShow,
                        };
                    }
                    return { serviceId: svcId, membershipId: mid, assignedMembers: [mid], days: daysOut };
                }

                // Shared/group service: common member availability minus ALL members' other services.
                const memberWeeklyMaps = assigned.map(m => ({ mid: String(m), map: _memberWeeklyMapFor(String(m)) }));

                function _servicesForMember(mid){
                    try {
                        const idStr = String(mid);
                        return (Array.isArray(SERVICES) ? SERVICES : []).filter(s => {
                            if (!s || !s.is_active) return false;
                            const a = getAssignedMembersForService(s);
                            return a && a.some(x => String(x) === idStr);
                        });
                    } catch (e) { return []; }
                }

                for (let d=0; d<7; d++){
                    // Intersect memberAllowed across all assigned members
                    let commonAllowed = null;
                    for (const mm of memberWeeklyMaps){
                        const allowed = _ccRangesFromWeeklyMap(mm.map, d);
                        commonAllowed = (commonAllowed === null) ? allowed : _ccIntersectRanges(commonAllowed, allowed);
                        if (!commonAllowed.length) break;
                    }

                    // Union of all other services (any signature) across all members
                    let otherRaw = [];
                    for (const mm of memberWeeklyMaps){
                        const svcs = _servicesForMember(mm.mid);
                        for (const os of (svcs || [])){
                            try {
                                if (String(os.id) === String(svcId)) continue;
                                otherRaw = otherRaw.concat(_ccRangesFromWeeklyMap(os.weekly_map, d));
                            } catch (e) {}
                        }
                    }

                    const otherBlocked = _ccIntersectRanges(_ccMergeRanges(otherRaw), (commonAllowed || []));
                    const remaining = _ccSubtractRanges((commonAllowed || []), otherBlocked);
                    const fullyBlocked = (!commonAllowed || !commonAllowed.length) || (!remaining.length);
                    const shouldShow = fullyBlocked || (otherBlocked && otherBlocked.length > 0);

                    daysOut[d] = {
                        memberAllowed: (commonAllowed || []),
                        memberBlocked: ((commonAllowed && commonAllowed.length) ? _ccInvertRanges(commonAllowed) : [{start:0,end:24*60}]),
                        otherBlocked,
                        remaining,
                        fullyBlocked,
                        shouldShow,
                    };
                }

                return { serviceId: svcId, membershipId: null, assignedMembers: assigned.map(String), days: daysOut };
            } catch (e) {
                return null;
            }
        }

        function _ccFirstRemainingInterval(dayIndex){
            try {
                if (!_ccConstraints || !_ccConstraints.days || !_ccConstraints.days[dayIndex]) return null;
                const d = _ccConstraints.days[dayIndex];
                const rem = (d && Array.isArray(d.remaining)) ? d.remaining : [];
                if (!rem.length) return null;
                return { start: rem[0].start, end: rem[0].end };
            } catch (e) {
                return null;
            }
        }

        function _ccRenderConstraintsForDay(dayIndex, constraints){
            try {
                const wrap = document.querySelector(`.cc-constraints-wrap[data-day='${dayIndex}']`);
                const bar = document.querySelector(`.cc-constraints-bar[data-day='${dayIndex}']`);
                if (!wrap || !bar) return;
                if (!constraints || !constraints.days || !constraints.days[dayIndex]) {
                    wrap.style.display = 'none';
                    bar.innerHTML = '';
                    return;
                }

                const d = constraints.days[dayIndex];
                if (!d.shouldShow) {
                    wrap.style.display = 'none';
                    bar.innerHTML = '';
                    return;
                }

                wrap.style.display = 'block';
                bar.innerHTML = '';
                const toPct = (min) => (Math.max(0, Math.min(24*60, min)) / (24*60)) * 100;
                const fmtMin = (mins) => {
                    const m = Math.max(0, Math.round(Number(mins) || 0));
                    const h = Math.floor(m / 60);
                    const r = m % 60;
                    if (h <= 0) return `${r}m`;
                    if (r === 0) return `${h}h`;
                    return `${h}h ${r}m`;
                };
                const sumMins = (ranges) => {
                    try {
                        return (Array.isArray(ranges) ? ranges : []).reduce((acc, seg) => {
                            const s = Number(seg && seg.start);
                            const e = Number(seg && seg.end);
                            if (!isFinite(s) || !isFinite(e)) return acc;
                            return acc + Math.max(0, e - s);
                        }, 0);
                    } catch (e) { return 0; }
                };
                const addSeg = (seg, cls) => {
                    const div = document.createElement('div');
                    div.className = `cc-constraints-seg ${cls}`;
                    const left = toPct(seg.start);
                    const width = Math.max(0, toPct(seg.end) - left);
                    div.style.left = left + '%';
                    div.style.width = width + '%';

                    // Tooltips: help user understand what the color means.
                    try {
                        const mins = Math.max(0, (Number(seg.end) || 0) - (Number(seg.start) || 0));
                        if (cls === 'member') div.title = (IS_PRO && !IS_TEAM) ? `Outside overall availability (${fmtMin(mins)})` : `Outside member availability (${fmtMin(mins)})`;
                        else if (cls === 'other') div.title = `Reserved by other services (${fmtMin(mins)})`;
                    } catch (e) {}

                    // Inline labels (only when there's enough room to avoid clutter).
                    try {
                        if (width >= 18) {
                            const label = document.createElement('span');
                            label.className = 'cc-constraints-label';
                            label.textContent = (cls === 'member') ? ((IS_PRO && !IS_TEAM) ? 'Overall' : 'Member') : (cls === 'other' ? 'Other' : '');
                            if (label.textContent) div.appendChild(label);
                        }
                    } catch (e) {}

                    bar.appendChild(div);
                };

                // Member blocked is the baseline constraint; other-service blocks overlay.
                for (const seg of (d.memberBlocked || [])) addSeg(seg, 'member');
                for (const seg of (d.otherBlocked || [])) addSeg(seg, 'other');

                // Add/refresh a short caption that explains what's blocking.
                try {
                    let cap = wrap.querySelector('.cc-constraints-caption');
                    if (!cap) {
                        cap = document.createElement('div');
                        cap.className = 'cc-constraints-caption';
                        wrap.appendChild(cap);
                    }
                    const allowedM = sumMins(d.memberAllowed || []);
                    const otherM = sumMins(d.otherBlocked || []);
                    const remainingM = sumMins(d.remaining || []);

                    if (!allowedM) {
                        cap.textContent = (IS_PRO && !IS_TEAM)
                            ? 'Blocked: outside overall availability (no overlap).'
                            : 'Blocked: outside member availability (no overlap).';
                    } else if (!remainingM && otherM) {
                        cap.textContent = 'Blocked: reserved by other services (no bookable time left).';
                    } else if (!remainingM) {
                        cap.textContent = 'Blocked: no bookable time left for this service.';
                    } else if (otherM) {
                        cap.textContent = `Bookable: ${fmtMin(remainingM)} (some time reserved by other services).`;
                    } else {
                        // If shouldShow but no other blocks, it's usually a fully-blocked day.
                        cap.textContent = `Bookable: ${fmtMin(remainingM)}.`;
                    }
                } catch (e) {}
            } catch (e) { /* ignore */ }
        }

        // Constraints are derived from SERVICES + current selection. They must be refreshed
        // whenever availability changes or the selection changes.
        let _ccConstraints = null;
        function _ccRefreshConstraints(){
            try { _ccConstraints = _ccGetWeeklyEditorConstraints(); } catch (e) { _ccConstraints = null; }
            try { window.__ccWeeklyServiceConstraints = _ccConstraints || null; } catch (e) {}
            return _ccConstraints;
        }

        _ccRefreshConstraints();

        // Custom Time Picker Creator
        function createCustomTimePicker(inputElement) {
            const picker = document.createElement('div');
            picker.className = 'custom-time-picker';
            
            const [initialHour, initialMinute] = (inputElement.value || '09:00').split(':');
            let selectedHour = initialHour;
            let selectedMinute = initialMinute;
            
            picker.innerHTML = `
                <div class="time-picker-header">Select Time</div>
                <div class="time-picker-display">${formatDisplayTime(selectedHour, selectedMinute)}</div>
                <div class="time-picker-selectors">
                    <div class="time-selector">
                        <div class="time-selector-label">Hour</div>
                        <div class="time-scroll-container" data-type="hour"></div>
                    </div>
                    <div class="time-selector">
                        <div class="time-selector-label">Minute</div>
                        <div class="time-scroll-container" data-type="minute"></div>
                    </div>
                </div>
                <div class="time-picker-actions">
                    <button class="time-picker-btn cancel">Cancel</button>
                    <button class="time-picker-btn confirm">Confirm</button>
                </div>
            `;
            
            // Populate hours (0-23)
            const hourContainer = picker.querySelector('[data-type="hour"]');
            for (let h = 0; h < 24; h++) {
                const hourStr = String(h).padStart(2, '0');
                const opt = document.createElement('div');
                opt.className = 'time-option';
                if (hourStr === selectedHour) opt.classList.add('selected');
                opt.textContent = formatHour(h);
                opt.addEventListener('click', () => {
                    hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedHour = hourStr;
                    updateDisplay();
                    opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                hourContainer.appendChild(opt);
            }
            
            // Populate minutes (00-59)
            const minuteContainer = picker.querySelector('[data-type="minute"]');
            for (let m = 0; m < 60; m++) {
                const minStr = String(m).padStart(2, '0');
                const opt = document.createElement('div');
                opt.className = 'time-option';
                if (minStr === selectedMinute) opt.classList.add('selected');
                opt.textContent = minStr;
                opt.addEventListener('click', () => {
                    minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedMinute = minStr;
                    updateDisplay();
                    opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                });
                minuteContainer.appendChild(opt);
            }
            
            function updateDisplay() {
                picker.querySelector('.time-picker-display').textContent = formatDisplayTime(selectedHour, selectedMinute);
            }
            
            function formatHour(h) {
                if (h === 0) return '12 AM';
                if (h < 12) return `${h} AM`;
                if (h === 12) return '12 PM';
                return `${h - 12} PM`;
            }
            
            function formatDisplayTime(h, m) {
                const hour = parseInt(h);
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const h12 = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                return `${h12}:${m} ${ampm}`;
            }
            
            // Scroll selected items into view
            setTimeout(() => {
                hourContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' });
                minuteContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' });
            }, 50);
            
            // Confirm button
            picker.querySelector('.confirm').addEventListener('click', (e) => {
                e.stopPropagation();
                inputElement.value = `${selectedHour}:${selectedMinute}`;
                try { inputElement.dispatchEvent(new Event('input', { bubbles: true })); } catch (err) {}
                try { inputElement.dispatchEvent(new Event('change', { bubbles: true })); } catch (err) {}
                picker.remove();
            });
            
            // Cancel button
            picker.querySelector('.cancel').addEventListener('click', (e) => {
                e.stopPropagation();
                picker.remove();
            });
            
            // Close on outside click
            setTimeout(() => {
                document.addEventListener('click', function closeOnOutside(e) {
                    if (!picker.contains(e.target) && e.target !== inputElement) {
                        picker.remove();
                        document.removeEventListener('click', closeOnOutside);
                    }
                });
            }, 100);
            
            return picker;
        }

        // Helper to create a single range row (start/end + remove)
        function createRangeRow(dayIndex, startVal = '', endVal = '') {
            const row = document.createElement('div');
            row.className = 'range-row';

            // Wrap start input in positioned container
            const startContainer = document.createElement('div');
            startContainer.className = 'time-input-container';
            
            const start = document.createElement('input');
            start.type = 'time';
            start.className = 'range-start';
            start.value = startVal || '09:00';
            start.dataset.day = String(dayIndex);
            start.readOnly = true;
            start.style.cursor = 'pointer';
            start.addEventListener('change', function(){
                try { _ccUpdateWeeklySaveVisibility(); } catch (e) {}
                try { _ccWeeklyValidateDay(dayIndex, start); } catch (e) {}
            });
            
            function _ccOpenWeeklyPicker(inputEl, containerEl) {
                // Remove any existing pickers
                document.querySelectorAll('.custom-time-picker').forEach(p => p.remove());
                const picker = (typeof createCustomTimePickerGlobal === 'function' ? createCustomTimePickerGlobal : createCustomTimePicker)(inputEl);
                picker.classList.add('active');
                containerEl.appendChild(picker);
            }

            start.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                _ccOpenWeeklyPicker(start, startContainer);
            });
            // Mobile Safari: prevent the native time picker from opening.
            start.addEventListener('touchstart', function(e) {
                try { e.preventDefault(); } catch (_) {}
                e.stopPropagation();
                _ccOpenWeeklyPicker(start, startContainer);
            }, { passive: false });
            start.addEventListener('focus', function() {
                try {
                    const isTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
                    if (isTouch) start.blur();
                } catch (_) {}
            });
            
            startContainer.appendChild(start);

            // Wrap end input in positioned container
            const endContainer = document.createElement('div');
            endContainer.className = 'time-input-container';
            
            const end = document.createElement('input');
            end.type = 'time';
            end.className = 'range-end';
            end.value = endVal || '17:00';
            end.dataset.day = String(dayIndex);
            end.readOnly = true;
            end.style.cursor = 'pointer';
            end.addEventListener('change', function(){
                try { _ccUpdateWeeklySaveVisibility(); } catch (e) {}
                try { _ccWeeklyValidateDay(dayIndex, end); } catch (e) {}
            });
            
            end.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                _ccOpenWeeklyPicker(end, endContainer);
            });
            // Mobile Safari: prevent the native time picker from opening.
            end.addEventListener('touchstart', function(e) {
                try { e.preventDefault(); } catch (_) {}
                e.stopPropagation();
                _ccOpenWeeklyPicker(end, endContainer);
            }, { passive: false });
            end.addEventListener('focus', function() {
                try {
                    const isTouch = ('ontouchstart' in window) || (navigator && navigator.maxTouchPoints > 0);
                    if (isTouch) end.blur();
                } catch (_) {}
            });
            
            endContainer.appendChild(end);

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-range-btn';
            removeBtn.setAttribute('aria-label', 'Remove range');
            removeBtn.innerHTML = '<span class="remove-icon" aria-hidden="true">✖</span>';
            removeBtn.addEventListener('click', () => {
                try { row.remove(); } catch (e) {}
                // If the user removed the last range for a day, treat that day as unavailable.
                // This matches backend semantics (no rows => unavailable) and prevents the UI
                // from auto-adding a default range on re-render after save.
                try {
                    const containerEl = document.getElementById(`ranges-container-${dayIndex}`);
                    const hasAny = containerEl ? containerEl.querySelectorAll('.range-row').length > 0 : false;
                    if (!hasAny) {
                        const cb = document.querySelector(`.unavailable-checkbox[data-day='${dayIndex}']`);
                        if (cb && !cb.checked) {
                            cb.checked = true;
                            cb.dispatchEvent(new Event('change'));
                        } else {
                            // Ensure in-memory state still reflects the removal
                            defaultAvailability[dayIndex].unavailable = true;
                            defaultAvailability[dayIndex].ranges = [];
                        }
                    }
                } catch (e) {}
                try { _ccUpdateWeeklySaveVisibility(); } catch (e) {}
            });

            row.appendChild(startContainer);
            row.appendChild(endContainer);
            row.appendChild(removeBtn);

            // Initialize prev snapshot (used to revert invalid overlap edits)
            try { _ccSetPrevValue(start); } catch (e) {}
            try { _ccSetPrevValue(end); } catch (e) {}

            return row;
        }

        days.forEach((dayName, i) => {
            const dayIndex = i;
            const row = document.createElement('tr');

            row.innerHTML = `
                <td style="vertical-align:top; padding-top:10px; white-space:nowrap;">${dayName}</td>
                <td colspan="2" style="vertical-align:top; padding-left:24px;">
                    <div id="ranges-container-${dayIndex}" style="display:flex; flex-direction:column; gap:4px;"></div>
                    <div style="margin-top:6px;"><button type="button" class="add-range-btn" data-day="${dayIndex}" style="padding:6px 10px; background:#007bff; color:white; border:none; border-radius:6px; cursor:pointer;">Add range</button></div>
                    <div class="cc-constraints-wrap" data-day="${dayIndex}">
                        <div class="cc-constraints-bar" data-day="${dayIndex}"></div>
                    </div>
                </td>
                <td style="text-align:right; vertical-align:top; padding-top:18px; padding-right:8px;"><input type="checkbox" class="unavailable-checkbox" data-day="${dayIndex}" ${defaultAvailability[dayIndex].unavailable ? "checked" : ""}></td>
            `;

            container.appendChild(row);

            const rangesContainer = document.getElementById(`ranges-container-${dayIndex}`);
            const existing = defaultAvailability[dayIndex].ranges || [];
            if (existing.length) {
                existing.forEach(r => {
                    const parts = r.split('-');
                    const s = parts[0] ? parts[0].trim() : '09:00';
                    const e = parts[1] ? parts[1].trim() : '17:00';
                    rangesContainer.appendChild(createRangeRow(dayIndex, s, e));
                });
            } else {
                // if not unavailable, add a single blank row
                if (!defaultAvailability[dayIndex].unavailable) {
                    rangesContainer.appendChild(createRangeRow(dayIndex, defaultAvailability[dayIndex].start || '09:00', defaultAvailability[dayIndex].end || '17:00'));
                }
            }

            // Add button handler
            const addBtn = row.querySelector('.add-range-btn');
            addBtn.addEventListener('click', () => {
                // Add a new non-overlapping range. If service-scope constraints exist, fit within them.
                try {
                    const existingRows = Array.from(rangesContainer.querySelectorAll('.range-row'));
                    const existing = _ccCollectIntervalsFromRows(existingRows, '.range-start', '.range-end');
                    existing.sort((a,b) => (a.startMin === b.startMin ? a.endMin - b.endMin : a.startMin - b.startMin));
                    const lastEnd = existing.length ? existing[existing.length - 1].endMin : null;

                    let candidate = null;
                    try {
                        const first = _ccFirstRemainingInterval(dayIndex);
                        if (first) {
                            const startMin = Math.max(first.start, (lastEnd != null ? lastEnd : first.start));
                            const endMin = Math.min(first.end, startMin + 60);
                            if (endMin > startMin) candidate = { start: _ccHHMMFromMinutes(startMin), end: _ccHHMMFromMinutes(endMin) };
                        }
                    } catch (e) {}

                    if (!candidate) {
                        candidate = _ccSuggestNextNonOverlappingRange(existing, 60);
                    }

                    if (!candidate) {
                        _ccToastRangeError('No room to add another time range without overlapping.');
                        return;
                    }

                    rangesContainer.appendChild(createRangeRow(dayIndex, candidate.start, candidate.end));
                    try { _ccUpdateWeeklySaveVisibility(); } catch (e) {}
                    try { _ccWeeklyValidateDay(dayIndex, null); } catch (e) {}
                } catch (e) {
                    rangesContainer.appendChild(createRangeRow(dayIndex, '09:00', '10:00'));
                    try { _ccUpdateWeeklySaveVisibility(); } catch (e2) {}
                }
            });

            // Render constraint bar (service scope only)
            try { _ccRenderConstraintsForDay(dayIndex, _ccConstraints); } catch (e) {}

            // If this day is fully blocked in service scope, grey out and prevent editing.
            try {
                const dayInfo = (_ccConstraints && _ccConstraints.days) ? _ccConstraints.days[dayIndex] : null;
                // Only hard-lock when there's truly nothing the service can do on this day
                // AND the day currently has no ranges (so we don't deadlock the UI if legacy
                // data ever contains overlaps).
                const hasAnyUiRanges = (() => {
                    try { return !!(rangesContainer && rangesContainer.querySelectorAll('.range-row').length); } catch (e) { return false; }
                })();

                if (dayInfo && dayInfo.fullyBlocked && !hasAnyUiRanges) {
                    row.classList.add('cc-weekly-row-locked');
                    // Force UI to show unavailable + non-clickable
                    const cb = row.querySelector(`.unavailable-checkbox[data-day='${dayIndex}']`);
                    if (cb) {
                        cb.checked = true;
                        cb.disabled = true;
                    }
                    try {
                        if (addBtn) {
                            addBtn.disabled = true;
                            addBtn.style.display = 'none';
                        }
                    } catch (e) {}
                    // Remove any existing range rows in UI for this day (can't be valid anyway).
                    try { rangesContainer.innerHTML = ''; } catch (e) {}
                    try {
                        defaultAvailability[dayIndex].unavailable = true;
                        defaultAvailability[dayIndex].ranges = [];
                    } catch (e) {}
                } else if (dayInfo && dayInfo.fullyBlocked && hasAnyUiRanges) {
                    // Rare safety: fully blocked but the UI has ranges (shouldn't happen with valid data).
                    // Keep ranges editable so the user can fix it, but disable adding new ranges.
                    try {
                        if (addBtn) {
                            addBtn.disabled = true;
                        }
                    } catch (e) {}
                }
            } catch (e) {}
        });

        // During initial render, suppress dirty detection while we sync checkbox UI state.
        __ccWeeklyIniting = true;

        // Handle unavailable checkbox toggles (disable ranges UI when unavailable)
        // NOTE: do NOT apply changes to the calendar immediately here. Changes should
        // be saved by clicking the Save Defaults button. This prevents premature
        // application of availability while the user is still editing the defaults.
        document.querySelectorAll('.unavailable-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const day = this.dataset.day;
                // Update the in-memory defaultAvailability but do not mutate calendar yet
                defaultAvailability[day].unavailable = this.checked;
                const containerEl = document.getElementById(`ranges-container-${day}`);
                const addBtn = document.querySelector(`.add-range-btn[data-day='${day}']`);
                if (this.checked) {
                    // hide/disable ranges
                    containerEl.style.opacity = '0.5';
                    containerEl.querySelectorAll('input').forEach(i => i.disabled = true);
                    addBtn.disabled = true;
                } else {
                    containerEl.style.opacity = '1';
                    // If there are no existing range rows (user just toggled available), add a default range row
                    if (!containerEl.querySelectorAll('.range-row').length) {
                        const start = defaultAvailability[day].start || '09:00';
                        const end = defaultAvailability[day].end || '17:00';
                        containerEl.appendChild(createRangeRow(day, start, end));
                    }
                    containerEl.querySelectorAll('input').forEach(i => i.disabled = false);
                    addBtn.disabled = false;
                }
                // Do not call updateUnavailableDays() here; wait for Save Defaults to apply
                try { _ccUpdateWeeklySaveVisibility(); } catch (e) {}
            });
            // Trigger initial state (this will only set UI inputs; calendar not updated until save)
            checkbox.dispatchEvent(new Event('change'));
        });

        // End init: set baseline for this target to the freshly rendered state.
        __ccWeeklyIniting = false;
        try {
            const k = __ccWeeklyTargetKey();
            if (k) __ccWeeklyBaselineByTarget[k] = _ccNormalizeWeeklyStateFromUI();
        } catch (e) {}
        __ccWeeklySetSaveVisible(false);

        // Save handler (use onclick to avoid duplicate listeners)
        const saveBtn = document.getElementById('saveDefaultAvailabilityBtn');

        function _ensureAvailabilitySaveBanner(){
            let el = document.getElementById('cc-availability-save-banner');
            if (el) return el;
            el = document.createElement('div');
            el.id = 'cc-availability-save-banner';
            el.setAttribute('role', 'status');
            el.setAttribute('aria-live', 'polite');
            el.style.display = 'none';
            el.style.margin = '0 auto 10px auto';
            el.style.width = '100%';
            el.style.maxWidth = '920px';
            el.style.padding = '10px 12px';
            el.style.borderRadius = '10px';
            el.style.border = '1px solid #e5e7eb';
            el.style.background = '#f9fafb';
            el.style.color = '#111827';
            el.style.fontSize = '14px';
            el.style.lineHeight = '1.35';
            el.style.textAlign = 'center';
            // Place banner right above the Save button if possible.
            try {
                const parent = saveBtn && saveBtn.parentElement ? saveBtn.parentElement : null;
                if (parent) parent.insertBefore(el, saveBtn);
                else document.body.appendChild(el);
            } catch (e) {
                document.body.appendChild(el);
            }
            return el;
        }

        function _availabilitySaveHint(msg){
            const m = String(msg || '').toLowerCase();
            if (m.includes('overlaps another solo service')) {
                return "Tip: Either make the services' scheduling settings identical, or move one service to a non-overlapping day/time.";
            }
            if (m.includes("within the assigned member's weekly availability")) {
                return "Tip: Expand the member's overall availability first (or shrink the service window).";
            }
            if (m.includes('overall availability cannot exclude existing service availability')) {
                return 'Tip: Expand overall availability first, then save.';
            }
            return '';
        }

        function _ccFormatTime12h(hour24, minute){
            const h = Number(hour24);
            const m = String(minute == null ? '' : minute).padStart(2, '0');
            if (!Number.isFinite(h) || h < 0 || h > 23) return `${hour24}:${m}`;

            const suffix = h >= 12 ? 'PM' : 'AM';
            const h12 = (h % 12) === 0 ? 12 : (h % 12);
            return `${h12}:${m} ${suffix}`;
        }

        function _ccHumanize24hTimesInText(text){
            const s = String(text == null ? '' : text);
            // Convert any 24h-like time tokens (e.g. 9:00, 09:00, 17:30) to 12h with AM/PM.
            return s.replace(/\b([01]?\d|2[0-3]):([0-5]\d)\b/g, (match, hh, mm) => {
                return _ccFormatTime12h(hh, mm);
            });
        }

        function _showAvailabilitySaveBanner(kind, message, meta){
            const el = _ensureAvailabilitySaveBanner();
            const hint = _availabilitySaveHint(message);
            const safeMsg = String(message || '').trim();
            const friendlyMsg = _ccHumanize24hTimesInText(safeMsg);

            let scopeLabel = '';
            try {
                if (meta && meta.scopeLabel) scopeLabel = String(meta.scopeLabel || '').trim();
            } catch (e) { scopeLabel = ''; }

            // If the banner is shown repeatedly, avoid stacking multiple timers.
            try {
                if (window.__ccAvailabilitySaveBannerTimer) {
                    clearTimeout(window.__ccAvailabilitySaveBannerTimer);
                    window.__ccAvailabilitySaveBannerTimer = null;
                }
            } catch (e) {}

            el.style.display = 'block';
            if (kind === 'success') {
                el.style.border = '1px solid #86efac';
                el.style.background = '#ecfdf5';
                el.style.color = '#065f46';
                el.innerHTML = `<div style="font-weight:700">Saved</div><div style="margin-top:2px">${friendlyMsg || 'Weekly availability saved.'}</div>${scopeLabel ? `<div style="margin-top:6px; font-size:12px; opacity:0.95;">Scope: ${_ccEscapeHtml(scopeLabel)}</div>` : ''}`;

                // Auto-dismiss success after 5 seconds.
                try {
                    window.__ccAvailabilitySaveBannerTimer = setTimeout(() => {
                        try { _clearAvailabilitySaveBanner(); } catch (e) {}
                    }, 5000);
                } catch (e) {}
            } else {
                el.style.border = '1px solid #fecaca';
                el.style.background = '#fef2f2';
                el.style.color = '#7f1d1d';
                el.innerHTML = `<div style="font-weight:700">Couldn't save</div><div style="margin-top:2px">${friendlyMsg || 'The server rejected these changes.'}</div>${scopeLabel ? `<div style="margin-top:6px; font-size:12px; opacity:0.95;">Scope: ${_ccEscapeHtml(scopeLabel)}</div>` : ''}${hint ? `<div style="margin-top:6px;color:#991b1b"><strong>\u2022</strong> ${hint}</div>` : ''}`;
            }
            try { el.scrollIntoView({ behavior: 'smooth', block: 'nearest' }); } catch (e) {}
        }

        function _clearAvailabilitySaveBanner(){
            const el = document.getElementById('cc-availability-save-banner');
            if (!el) return;
            el.style.display = 'none';
            el.textContent = '';
        }

        function _ccEscapeHtml(s){
            try {
                return String(s == null ? '' : s)
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;');
            } catch (e) {
                return '';
            }
        }

        function _ensureOverridesSaveBanner(){
            const el = document.getElementById('cc-overrides-save-banner');
            const body = document.getElementById('cc-overrides-save-banner-body');
            const closeBtn = document.getElementById('cc-overrides-save-banner-close');
            if (!el || !body) return null;

            if (!el.__ccBound) {
                el.__ccBound = true;

                // Close button
                try {
                    if (closeBtn) {
                        closeBtn.addEventListener('click', (e) => {
                            try { e.preventDefault(); } catch (err) {}
                            _clearOverridesSaveBanner();
                        });
                    }
                } catch (e) {}

                // Action buttons inside banner
                try {
                    el.addEventListener('click', (e) => {
                        const btn = e && e.target && e.target.closest ? e.target.closest('button[data-cc-selection]') : null;
                        if (!btn) return;
                        try { e.preventDefault(); } catch (err) {}
                        const sel = btn.getAttribute('data-cc-selection');
                        if (!sel) return;
                        try {
                            if (typeof applySelection === 'function') applySelection(sel);
                            _clearOverridesSaveBanner();
                        } catch (err) { console.warn('Failed to switch selection', err); }
                    }, true);
                } catch (e) {}
            }

            return el;
        }

        function _ensureOverridesSaveBannerFloating(){
            try {
                const existing = document.getElementById('cc-overrides-save-banner-floating');
                if (existing) {
                    try {
                        try { existing.style.zIndex = '1000001'; } catch (e) {}
                        try { existing.style.pointerEvents = 'auto'; } catch (e) {}
                        if (!existing.__ccBound) {
                            existing.__ccBound = true;
                            const closeBtn = document.getElementById('cc-overrides-save-banner-floating-close');
                            if (closeBtn) {
                                try { closeBtn.setAttribute('onclick', "try{window.ccDismissOverrideBanner&&window.ccDismissOverrideBanner();}catch(e){}"); } catch (e) {}
                                try { closeBtn.style.position = 'relative'; closeBtn.style.zIndex = '1000002'; closeBtn.style.pointerEvents = 'auto'; } catch (e) {}
                                closeBtn.addEventListener('click', (e) => {
                                    try { e.preventDefault(); } catch (err) {}
                                    try { window.ccDismissOverrideBanner && window.ccDismissOverrideBanner(); } catch (e2) { try { _clearOverridesSaveBanner(); } catch (e3) {} }
                                });
                            }
                            existing.addEventListener('click', (e) => {
                                const btn = e && e.target && e.target.closest ? e.target.closest('button[data-cc-selection]') : null;
                                if (!btn) return;
                                try { e.preventDefault(); } catch (err) {}
                                const sel = btn.getAttribute('data-cc-selection');
                                if (!sel) return;
                                try {
                                    if (typeof applySelection === 'function') applySelection(sel);
                                    _clearOverridesSaveBanner();
                                } catch (err) { console.warn('Failed to switch selection', err); }
                            }, true);
                        }
                    } catch (e) {}
                    return existing;
                }

                const el = document.createElement('div');
                el.id = 'cc-overrides-save-banner-floating';
                el.setAttribute('role', 'status');
                el.setAttribute('aria-live', 'polite');
                el.style.display = 'none';
                el.style.position = 'fixed';
                el.style.left = '50%';
                el.style.top = '14px';
                el.style.transform = 'translateX(-50%)';
                el.style.zIndex = '1000001';
                el.style.pointerEvents = 'auto';
                el.style.maxWidth = 'min(920px, calc(100vw - 24px))';
                el.style.width = 'min(920px, calc(100vw - 24px))';
                el.style.padding = '12px 12px';
                el.style.borderRadius = '12px';
                el.style.border = '1px solid #fecaca';
                el.style.background = '#fef2f2';
                el.style.color = '#7f1d1d';
                el.style.boxShadow = '0 10px 22px rgba(0,0,0,0.18)';
                el.style.fontSize = '14px';
                el.style.lineHeight = '1.35';

                el.innerHTML = `
                    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:12px;">
                        <div id="cc-overrides-save-banner-floating-body"></div>
                        <button type="button" id="cc-overrides-save-banner-floating-close" onclick="try{window.ccDismissOverrideBanner&&window.ccDismissOverrideBanner();}catch(e){}" style="border:0; background:transparent; color:#7f1d1d; font-weight:800; cursor:pointer; padding:2px 6px; border-radius:8px;">×</button>
                    </div>
                `;

                document.body.appendChild(el);

                // Close button
                try {
                    const closeBtn = document.getElementById('cc-overrides-save-banner-floating-close');
                    if (closeBtn) {
                        try { closeBtn.style.position = 'relative'; closeBtn.style.zIndex = '1000002'; closeBtn.style.pointerEvents = 'auto'; } catch (e) {}
                        closeBtn.addEventListener('click', (e) => {
                            try { e.preventDefault(); } catch (err) {}
                            try { window.ccDismissOverrideBanner && window.ccDismissOverrideBanner(); } catch (e2) { _clearOverridesSaveBanner(); }
                        });
                    }
                } catch (e) {}

                // Action buttons inside banner
                try {
                    el.addEventListener('click', (e) => {
                        const btn = e && e.target && e.target.closest ? e.target.closest('button[data-cc-selection]') : null;
                        if (!btn) return;
                        try { e.preventDefault(); } catch (err) {}
                        const sel = btn.getAttribute('data-cc-selection');
                        if (!sel) return;
                        try {
                            if (typeof applySelection === 'function') applySelection(sel);
                            _clearOverridesSaveBanner();
                        } catch (err) { console.warn('Failed to switch selection', err); }
                    }, true);
                } catch (e) {}

                try { el.__ccBound = true; } catch (e) {}

                return el;
            } catch (e) {
                return null;
            }
        }

        function _clearOverridesSaveBanner(){
            // Clear whichever banners exist; do not return early if one is missing.
            try {
                const el = document.getElementById('cc-overrides-save-banner');
                const body = document.getElementById('cc-overrides-save-banner-body');
                if (el) el.style.display = 'none';
                if (body) body.innerHTML = '';
            } catch (e) {}

            try {
                const fel = document.getElementById('cc-overrides-save-banner-floating');
                const fbody = document.getElementById('cc-overrides-save-banner-floating-body');
                if (fel) fel.style.display = 'none';
                if (fbody) fbody.innerHTML = '';
            } catch (e) {}

            try {
                const hel = document.getElementById('cc-overrides-save-banner-hard');
                const hbody = document.getElementById('cc-overrides-save-banner-hard-body');
                if (hel) hel.style.display = 'none';
                if (hbody) hbody.innerHTML = '';
            } catch (e) {}
        }

        // Expose a global dismiss helper so inline onclick fallbacks work.
        try {
            window.ccDismissOverrideBanner = function(){
                try { window.__ccOverrideBannerSuppressUntil = Date.now() + 5000; } catch (e) {}
                try { _clearOverridesSaveBanner(); } catch (e) {}
            };
        } catch (e) {}

        function _ccSelectedServiceObj(){
            try {
                if (!SELECTED_MEMBER || !String(SELECTED_MEMBER).startsWith('svc:')) return null;
                const svcId = String(SELECTED_MEMBER).slice(4);
                return (Array.isArray(SERVICES) ? SERVICES.find(s => String(s.id) === String(svcId)) : null) || null;
            } catch (e) {
                return null;
            }
        }

        function _ccMemberNameByMembershipId(mid){
            try {
                const m = (Array.isArray(MEMBERS) ? MEMBERS.find(mm => String(mm.id) === String(mid)) : null);
                if (!m) return 'Member';
                if (typeof memberDisplayName === 'function') return memberDisplayName(m);
                return String(m.user__first_name || m.user__email || 'Member');
            } catch (e) {
                return 'Member';
            }
        }

        function _ccOrdinalSuffix(n){
            const v = Number(n) || 0;
            const mod100 = v % 100;
            if (mod100 >= 11 && mod100 <= 13) return 'th';
            switch (v % 10) {
                case 1: return 'st';
                case 2: return 'nd';
                case 3: return 'rd';
                default: return 'th';
            }
        }

        function _ccPrettyDateFromYMD(ymd){
            try {
                const s = String(ymd || '').trim();
                const m = s.match(/^(\d{4})-(\d{2})-(\d{2})$/);
                if (!m) return s;
                const year = Number(m[1]);
                const month = Number(m[2]);
                const day = Number(m[3]);
                const monthNames = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                const name = monthNames[month - 1] || null;
                if (!name || !day) return s;
                return `${name} ${day}${_ccOrdinalSuffix(day)}`;
            } catch (e) {
                return String(ymd || '');
            }
        }

        function _ccHumanizeOverrideMessage(message){
            try {
                const msg = String(message || '');
                // Replace ISO dates (YYYY-MM-DD) with friendly month/day format.
                return msg.replace(/\b(\d{4}-\d{2}-\d{2})\b/g, (full, ymd) => _ccPrettyDateFromYMD(ymd));
            } catch (e) {
                return String(message || '');
            }
        }

        // Export so global banner helpers (outside this closure) can use it.
        try { window.__ccHumanizeOverrideMessage = _ccHumanizeOverrideMessage; } catch (e) {}

        function _overrideSaveHints(message){
            const m = String(message || '').toLowerCase();
            const hints = [];
            if (m.includes('no overlapping availability') || m.includes('overlapping availability for this group service')) {
                hints.push('This is a group service: open per-date or weekly availability for the assigned members first (the times must overlap), then retry the service override.');
            }
            if (m.includes('member calendar override') || m.includes('member calendar first') || m.includes('unavailable by default for this member')) {
                hints.push("This is a solo-service constraint: create the per-date override in the member's calendar first, then switch back to the service and retry.");
            }
            if (m.includes('within the assigned member\'s weekly availability')) {
                hints.push("Expand the member's weekly availability (or shrink the override range), then retry.");
            }
            if (m.includes("within this service's weekly availability")) {
                hints.push('Expand the service weekly availability for that day (or choose a time inside it), then retry.');
            }
            if (m.includes('overlaps')) {
                hints.push('If you need this time for this service, override the other solo service to unavailable for that date (or adjust weekly partitions first).');
            }
            return hints;
        }

        // Export for any code paths that run outside thi