{% extends "calendar_app/base.html" %}
{% load circlecal_filters %}

{# Mobile-only: break out of base <main> constraints; keep normal base layout on sm+ #}
{% block main_class %}w-full max-w-none px-0 py-0 sm:max-w-6xl sm:mx-auto sm:px-4 sm:py-6 md:px-6 md:py-8{% endblock %}

{% block extra_head %}
<style>
  /* Match the palette tokens used in calendar.html/edit_service.html */
  :root {
    --primary-500: #3b82f6;
    --primary-600: #2563eb;
    --primary-700: #1d4ed8;
    --success-500: #10b981;
    --success-600: #059669;
    --danger-500: #ef4444;
    --danger-600: #dc2626;
    --gray-50: #f9fafb;
    --gray-100: #f3f4f6;
    --gray-200: #e5e7eb;
    --gray-300: #d1d5db;
    --gray-600: #4b5563;
    --gray-700: #374151;
    --gray-900: #111827;
  }

  /* Page-specific enhanced field styling (aligned with edit page) */
  .cc-field {
    border: 1px solid #d1d5db; /* gray-300 */
    background: #ffffff;
    padding: 0.7rem 0.9rem;
    border-radius: 0.5rem;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    font-size: 0.97rem;
    width: 100%;
  }
  /* For inputs that render a leading prefix (like the $ sign) */
  .cc-field.cc-has-prefix { padding-left: 2.1rem; }
  .cc-field[disabled] { background:#f8fafc; opacity:.9; }
  .cc-field:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,0.08); }
  /* Mobile: use ~95% screen width; restore existing padding on sm+ */
  .cc-page { width:95vw; max-width:78rem; margin:0 auto; padding:2.5rem 0; }
  @media (min-width:640px){ .cc-page { width:auto; padding:2.5rem 1.5rem; } }
  @media (min-width:768px){ .cc-page { padding:3rem 2rem; } }

  /* Mobile-only: slightly smaller placeholder/example text */
  @media (max-width: 640px) {
    .cc-field::placeholder { font-size: 0.85rem; }
  }
  .section-card { background:#fff; border:1px solid #e6edf3; border-radius:0.75rem; padding:1rem 1.25rem; margin-bottom:1rem; }
  .section-title { font-size:1rem; font-weight:600; margin-bottom:0.5rem; }

  /* Locked advanced settings overlay */
  .cc-adv-lock-wrap { position: relative; }
  .cc-adv-lock-wrap.cc-adv-locked,
  .cc-adv-lock-wrap.cc-adv-locked * {
    cursor: default !important;
  }
  .cc-adv-lock-overlay {
    position: absolute;
    inset: 0;
    z-index: 50;
    background: rgba(255, 255, 255, 0.01);
    cursor: default;
    border-radius: 0.5rem;
  }

  /* Service availability editor (copied from edit page for parity) */
  .availability-disabled { position: relative; opacity: 0.8; }
  .availability-disabled .availability-overlay { position: absolute; inset: 0; background: rgba(255,255,255,0.85); display:flex; align-items:center; justify-content:center; border-radius:0.75rem; z-index:20; }
  .availability-disabled .availability-overlay .msg { max-width:56rem; padding:1rem 1.5rem; text-align:center; color:#374151; }
  #svcAvailEditor .cc-svc-day-locked { opacity: 0.6; background: #f9fafb; }
  #svcAvailEditor .cc-svc-day-locked .svc-day-editor,
  #svcAvailEditor .cc-svc-day-locked .svc-day-editor * { pointer-events: none; }
  #svcAvailEditor .cc-svc-day-locked .svc-day-editor { cursor: not-allowed; }

  #svcAvailEditor .time-input-container { position: relative; display: inline-block; }
  #svcAvailEditor .svc-range-row { border: none; border-radius: 0; padding: 0; background: transparent; display: flex; align-items: center; gap: 10px; }
  /* Fallback spacing for browsers that don't support flex gap (older iOS Safari/WebViews). */
  #svcAvailEditor .svc-range-row .time-input-container { margin-right: 10px; }
  #svcAvailEditor .svc-range-row .time-input-container:last-of-type { margin-right: 0; }
  @supports (gap: 10px) {
    #svcAvailEditor .svc-range-row .time-input-container { margin-right: 0; }
  }
  #svcAvailEditor .svc-range-row .cc-field { border: 1px solid var(--gray-900); }
  #svcAvailEditor .range-start,
  #svcAvailEditor .range-end { text-align: center; padding: 6px 8px; border-radius: 8px; border: 1px solid var(--gray-900); background: white; font-weight: 600; min-width: 0; }

  #svcAvailEditor .custom-time-picker {
    position: absolute;
    top: calc(100% + 5px);
    left: 0;
    background: white;
    border: 1px solid var(--gray-300);
    border-radius: 12px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15), 0 4px 10px rgba(0, 0, 0, 0.1);
    z-index: 2000;
    padding: 16px;
    min-width: 280px;
    display: none;
    animation: svcSlideDown 0.2s ease-out;
  }
  @keyframes svcSlideDown {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  #svcAvailEditor .custom-time-picker.active { display: block; }
  #svcAvailEditor .time-picker-header { font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 12px; text-align: center; }
  #svcAvailEditor .time-picker-display { font-size: 32px; font-weight: 700; text-align: center; color: var(--primary-600); margin-bottom: 16px; font-variant-numeric: tabular-nums; letter-spacing: 0.05em; }
  #svcAvailEditor .time-picker-selectors { display: flex; gap: 12px; margin-bottom: 16px; }
  #svcAvailEditor .time-selector { flex: 1; display: flex; flex-direction: column; gap: 8px; }
  #svcAvailEditor .time-selector-label { font-size: 11px; font-weight: 600; text-transform: uppercase; color: var(--gray-600); text-align: center; letter-spacing: 0.5px; }
  #svcAvailEditor .time-scroll-container { height: 180px; overflow-y: auto; border: 1px solid var(--gray-200); border-radius: 8px; background: var(--gray-50); padding: 4px; }
  #svcAvailEditor .time-option { padding: 10px; text-align: center; cursor: pointer; border-radius: 6px; font-size: 15px; font-weight: 500; transition: all 0.15s ease; color: var(--gray-700); }
  #svcAvailEditor .time-option:hover { background: white; color: var(--primary-600); }
  #svcAvailEditor .time-option.selected { background: var(--primary-500); color: white; font-weight: 600; }
  #svcAvailEditor .time-option.disabled {
    opacity: 0.35;
    filter: grayscale(1);
    cursor: not-allowed;
    pointer-events: none;
  }
  #svcAvailEditor .time-picker-actions { display: flex; gap: 8px; margin-top: 12px; align-items: stretch; }
  #svcAvailEditor .time-picker-btn {
    flex: 1;
    padding: 10px;
    border: 1px solid var(--gray-300);
    border-radius: 8px;
    font-weight: 700;
    font-size: 13px;
    cursor: pointer;
    transition: all 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    line-height: 1.1;
  }
  #svcAvailEditor .time-picker-btn.confirm {
    background: var(--primary-600);
    border-color: var(--primary-700);
    color: #ffffff;
  }
  #svcAvailEditor .time-picker-btn.confirm:hover { background: var(--primary-700); }
  #svcAvailEditor .time-picker-btn.cancel {
    background: var(--gray-50);
    border-color: var(--gray-300);
    color: var(--gray-900);
  }
  #svcAvailEditor .time-picker-btn.cancel:hover { background: var(--gray-100); }

  /* Mobile: keep time range rows + picker fully within container */
  @media (max-width: 640px) {
    #svcAvailEditor .svc-range-row {
      flex-wrap: wrap;
      /* Avoid relying on flex gap (some mobile WebViews don't support it) */
      gap: 0;
    }
    #svcAvailEditor .svc-range-row .time-input-container {
      flex: 1 1 calc(50% - 10px);
      min-width: 0;
      margin-right: 10px;
    }
    #svcAvailEditor .svc-range-row .time-input-container:last-of-type {
      margin-right: 0;
    }
    #svcAvailEditor input.range-start,
    #svcAvailEditor input.range-end {
      width: 100%;
      max-width: none;
    }
    #svcAvailEditor .svc-range-row button {
      flex: 1 1 100%;
      text-align: left;
      padding: 6px 0;
    }

    #svcAvailEditor .custom-time-picker {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      animation: none;
      min-width: 0;
      width: min(360px, 92vw);
      max-width: 92vw;
      max-height: 90vh;
      overflow-y: auto;
      box-sizing: border-box;
      margin: 0;
      z-index: 2600;
    }
    #svcAvailEditor .time-picker-selectors {
      gap: 10px;
    }
    #svcAvailEditor .time-scroll-container {
      height: 160px;
    }
    #svcAvailEditor .time-picker-actions {
      gap: 10px;
    }
    #svcAvailEditor .time-picker-btn {
      min-width: 0;
    }
  }

  /* Extra-small mobile: 320px wide devices */
  @media (max-width: 360px) {
    #svcAvailEditor .svc-range-row {
      gap: 8px;
    }
    #svcAvailEditor .range-start,
    #svcAvailEditor .range-end {
      font-size: 10px;
      padding: 6px 4px;
      line-height: 1.2;
    }
    #svcAvailEditor .custom-time-picker {
      width: min(320px, 94vw);
      padding: 14px;
    }
    #svcAvailEditor .time-picker-display {
      font-size: 28px;
    }
    #svcAvailEditor .time-option {
      padding: 8px;
      font-size: 14px;
    }
    #svcAvailEditor .time-picker-btn {
      font-size: 13px;
      padding: 10px 8px;
    }
  }
</style>
{% endblock %}

{% block title %}New Service • {{ org.name }}{% endblock %}

{% block content %}
<div class="cc-page">
  <div class="mb-6 md:mb-10 text-center">
    <h1 class="text-3xl md:text-4xl font-bold mb-2">Add a Service</h1>
    <p class="text-sm md:text-base text-gray-600">Define what clients can book. Clear naming improves conversion.</p>
  </div>

  <div class="grid md:grid-cols-3 gap-8">
    <!-- Form -->
    <div class="md:col-span-2 bg-white border rounded-xl shadow-sm p-4 sm:p-8 cc-form">
            <script>
              function slugify(str){
                return str.toString().trim().toLowerCase()
                  .replace(/[^a-z0-9\s-]/g,'')
                  .replace(/\s+/g,'-')
                  .replace(/-+/g,'-');
              }
              const nameInput = document.getElementById('svcName');
              const slugPreview = document.getElementById('slugPreview');
              nameInput && nameInput.addEventListener('input', () => {
                const v = nameInput.value.trim();
                const full = v ? slugify(v) : 'preview';
                // Shorten visually to ~18 chars; underlying generation still full server-side
                slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
                slugPreview.setAttribute('title', full); // hover shows full slug
              });
            </script>
      {% if messages %}
        <div class="mb-6 space-y-2 text-center">
          {% for message in messages %}
            <div class="px-3 py-2 rounded text-sm {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-50 text-blue-700{% endif %}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" class="space-y-8 cc-form" novalidate>
        {% csrf_token %}

        <!-- Public visibility toggle (validated on create) -->
        <div class="section-card mb-4" style="border:1px solid #2563eb;background:#f0f9ff;box-shadow:0 2px 6px rgba(37,99,235,0.06);">
          <div class="flex items-center justify-between">
            <div>
              <label for="show_on_public_calendar" class="inline-flex items-center">
                <input type="checkbox" name="show_on_public_calendar" id="show_on_public_calendar" value="1"
                       {% if request.POST.show_on_public_calendar %}checked{% endif %}
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500 {% if not can_toggle_public %}opacity-60 cursor-not-allowed{% endif %}"
                       {% if not can_toggle_public %}disabled aria-disabled="true"{% endif %}>
                <div class="ml-3">
                  <div class="text-lg font-semibold text-gray-800">Show on public booking page</div>
                  <div class="text-sm text-gray-600">Clients can see and book this service</div>
                </div>
              </label>
              {% if not can_toggle_public %}
                <p class="mt-2 text-sm text-gray-700">Only owners/GMs can change public visibility.</p>
              {% endif %}
              <p class="mt-2 text-xs text-gray-500">We’ll validate availability + requirements after you create the service.</p>
            </div>
            <div class="text-sm text-gray-700">
              <span class="inline-flex items-center px-2 py-1 rounded bg-white text-gray-700">Important</span>
            </div>
          </div>
        </div>

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Service Name</label>
            <input name="name" id="svcName" type="text" required placeholder="e.g. 60-Minute Private Session"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Be specific (length + format). Helps clients pick faster.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Public URL Slug <span class="text-gray-400">(auto)</span></label>
            <div class="mt-1 flex items-center space-x-2 text-sm">
              <span class="text-gray-500 select-none">/service/</span>
              <span id="slugPreview" class="font-mono bg-gray-100 border rounded text-gray-700 cc-field slug-preview" style="border-width:1px">preview</span>
            </div>
            <p class="mt-2 text-xs text-gray-500">We generate this from the name. You can change it later only before the first booking; once bookings exist the URL becomes fixed to avoid breaking booking links.</p>
          </div>
        </div>

              <script>
                // Run wiring after DOM is ready so inputs exist when we attach handlers.
                document.addEventListener('DOMContentLoaded', function(){
                  try {
                    const fixed = document.getElementById('use_fixed_increment');
                    const squish = document.getElementById('allow_squished_bookings');
                    const incInput = document.getElementById('time_increment_minutes');
                    const form = document.querySelector('form.cc-form');
                    if (!incInput) return;

                    // Visual helper class
                    const style = document.createElement('style');
                    style.innerHTML = '.squish-disabled-label { opacity: 0.6; } .inc-disabled { opacity: 0.55; }';
                    document.head.appendChild(style);

                    const parentLabel = squish ? (squish.closest('label') || squish.parentNode) : null;

                    const initialIncVal = Number(incInput.value) || 30;

                    function setClientIncrementFromInput(val) {
                      try {
                        const raw = localStorage.getItem('client_view_settings') || '{}';
                        let parsed = {};
                        try { parsed = JSON.parse(raw); } catch(_) { parsed = {}; }
                        parsed.increment = Number(val) || 30;
                        localStorage.setItem('client_view_settings', JSON.stringify(parsed));
                        try { showToast('success', 'Client increment updated for Day Schedule modal.'); } catch(e){}
                      } catch (e) { console.warn('setClientIncrement failed', e); }
                    }

                    function updateState() {
                      const disabled = fixed && fixed.checked;
                      if (squish) {
                        try { squish.disabled = disabled; } catch(e){}
                        if (parentLabel) parentLabel.classList.toggle('squish-disabled-label', disabled);
                      }
                      if (incInput) {
                        try { incInput.disabled = disabled; } catch(e){}
                        incInput.classList.toggle('inc-disabled', disabled);
                      }
                    }

                    // attach handlers
                    if (incInput) {
                      incInput.addEventListener('change', function(ev){
                        try {
                          if (fixed && fixed.checked) {
                            try { showToast('warning', 'Disable Fixed Increments to change the client increment.'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const newVal = Number(incInput.value);
                          if (isNaN(newVal) || newVal < 5) {
                            try { showToast('warning', 'Enter a valid increment (5+ minutes).'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const confirmMsg = `Change client increment to ${newVal} minutes? This will update the Day Schedule modal's client view settings.`;
                          if (!confirm(confirmMsg)) {
                            incInput.value = initialIncVal;
                            return;
                          }
                          setClientIncrementFromInput(newVal);
                        } catch (e) { console.warn('inc change handler failed', e); }
                      });
                    }

                    if (form && incInput) {
                      form.addEventListener('submit', function(ev){
                        try {
                          const cur = Number(incInput.value);
                          if (!isNaN(initialIncVal) && cur !== Number(initialIncVal)) {
                            const ok = confirm(`You changed the slot increment from ${initialIncVal} to ${cur} minutes. Save this change to the service?`);
                            if (!ok) {
                              ev.preventDefault();
                              return false;
                            }
                            setClientIncrementFromInput(cur);
                          }
                        } catch (e) { /* allow submit on error */ }
                      });
                    }

                    // reflect localStorage changes into input
                    window.addEventListener('storage', function(e){
                      if (e.key === 'client_view_settings') {
                        try {
                          const parsed = JSON.parse(e.newValue || '{}');
                          if (parsed && typeof parsed.increment === 'number' && incInput && !(fixed && fixed.checked)) {
                            incInput.value = String(parsed.increment);
                          }
                        } catch (err) { /* ignore */ }
                      }
                    });

                    updateState();
                    try {
                      const raw = localStorage.getItem('client_view_settings');
                      if (raw && incInput && !(fixed && fixed.checked)) {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed.increment === 'number') {
                          incInput.value = String(parsed.increment);
                        }
                      }
                    } catch (e) { /* ignore parse errors */ }

                    if (fixed) fixed.addEventListener('change', updateState);
                  } catch (e) { console.warn('create_service increment wiring failed', e); }
                });
              </script>
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea name="description" rows="4" placeholder="Outline goals, structure, who it's for." class="cc-field mt-1 w-full"></textarea>
          <p class="mt-2 text-xs text-gray-500">Mention outcomes and any prerequisites.</p>
        </div>

        <div class="section-card cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
          <div class="section-title">Payment Methods</div>
          <div>
            <div class="space-y-3">
              <label class="inline-flex items-start">
                {% if not can_use_pro_team %}
                  <input type="hidden" name="allow_stripe_payments" value="1">
                {% endif %}
                <input type="checkbox" name="allow_stripe_payments" id="allow_stripe_payments" value="1"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                       checked
                       {% if not can_use_pro_team %}disabled{% endif %}>
                <span class="ml-2 text-sm text-gray-700">Accept card payments (Stripe)</span>
              </label>
              {% if can_use_pro_team %}
                <div class="ml-6 text-xs text-gray-500">Recommended: Stripe enables automatic payment confirmation and refunds.</div>
              {% endif %}

              <div class="ml-6">
                <div class="text-sm font-medium text-gray-700">Different form of payment</div>
                <div class="mt-2 space-y-2">
                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="venmo"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed or not can_use_pro_team %}disabled{% endif %}>
                    <span class="ml-2">Venmo</span>
                  </label>
                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="zelle"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed or not can_use_pro_team %}disabled{% endif %}>
                    <span class="ml-2">Zelle</span>
                  </label>

        

                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="cash"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed or not can_use_pro_team %}disabled{% endif %}>
                    <span class="ml-2">Offline (Cash)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required" style="border-radius:0.75rem;"></div>{% endif %}
          <p class="mt-2 text-xs text-gray-500">For paid services, you must enable at least one payment method.</p>
        </div>

        <!-- Group timing + client slot settings together (matches edit page layout) -->
        <div class="section-card" id="ccClientSlotSettings">
          <div class="section-title">Timing & client slot settings</div>

          <div class="grid sm:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
              <input name="duration" type="number" min="1" value="60"
                class="cc-field mt-1 w-full" />
              <p class="mt-2 text-xs text-gray-500">Total time blocked per booking.</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Price (USD)</label>
              <div class="relative mt-1">
                <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 text-sm select-none">$</span>
                <input name="price" type="number" step="0.01" value="0" min="0"
                  class="cc-field cc-has-prefix w-full" />
              </div>
              <p class="mt-2 text-xs text-gray-500">Set to 0 for free / included services.</p>
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-6 mt-4">
            <div>
              <!-- Prep buffer removed: buffer_before is deprecated and not used by availability/overlap logic -->
              <label class="block text-sm font-medium text-gray-700">Buffer Time Post-Service Appointment (minutes)</label>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
                <input name="buffer_after" type="number" value="0" min="0" {% if not can_use_pro_team %}disabled{% endif %}
                  class="cc-field mt-1 w-full" />
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-2 text-xs text-gray-500">Blocks time after each booking.</p>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700">Allow appointment to end after availability?</label>
              <div class="mt-2">
                <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                  <label class="inline-flex items-center">
                    <input type="checkbox" name="allow_ends_after_availability" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                    <span class="ml-2 text-sm text-gray-700">Allow clients to book a slot that starts inside availability even if the appointment ends after the availability window.</span>
                  </label>
                  {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
                </div>
              </div>
              <p class="mt-2 text-xs text-gray-500">If enabled, the last available time slot may finish after your configured daily availability end.</p>
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-6 mt-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Min Notice (hours)</label>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
                <input name="min_notice_hours" type="number" value="24" min="0"
                  class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-2 text-xs text-gray-500">Prevent last‑minute bookings (e.g. 24 = one day).</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Max Advance (days)</label>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
                <input name="max_booking_days" type="number" value="{% if can_use_pro_team %}30{% elif is_trialing %}31{% else %}30{% endif %}" min="1"
                  class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-2 text-xs text-gray-500">Limit how far out clients can book.</p>
              {% if is_trialing %}
                <p class="mt-2 text-xs text-gray-500">
                  During your trial, clients can book through the end of your trial{% if trial_end %} ({{ trial_end|date:"M j, Y" }}){% endif %}.
                  This setting takes effect after you purchase a subscription.
                </p>
              {% endif %}
            </div>
          </div>

          <div class="mt-4 p-3 rounded bg-blue-50 border border-blue-100 text-blue-800">
            <strong class="block">Configure slot increments</strong>
            <p class="text-sm">Slot increment stepping (how fine-grained client slots appear) is configured in the Day Schedule on the calendar. To preview how increments will appear to clients, open the Day Schedule and select a day on the calendar to inspect the time increments and hour blocks.</p>
            <p class="mt-2 text-sm text-gray-600">(After creating the service you can open the Calendar to inspect how increments and hour blocks appear for clients.)</p>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Client slot increment (minutes)</label>
              <input id="time_increment_minutes" name="time_increment_minutes" type="number" value="30" min="5" class="cc-field mt-1 w-40">
              <p class="mt-1 text-xs text-gray-500">This controls the visible client slot increment. When <em>Use fixed increments</em> is enabled, this value is ignored.</p>
            </div>
            <div>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="use_fixed_increment" id="use_fixed_increment" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                  <span class="ml-2 text-sm text-gray-700">Use fixed increments (service duration + buffer)</span>
                </label>
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-1 text-xs text-gray-500">When enabled, clients will only see anchors spaced by the service duration plus cleanup buffer.</p>
            </div>
            <div>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="allow_squished_bookings" id="allow_squished_bookings" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                  <span class="ml-2 text-sm text-gray-700">Allow squished bookings (permit slots that violate buffers)</span>
                </label>
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="pro" role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-1 text-xs text-gray-500">When enabled, the system will allow bookings that fit the service duration even if they don't satisfy the configured buffers. Owners will receive a notification when such bookings occur.</p>
            </div>
          </div>
        </div>

        {% if is_team_plan %}
        <!-- Assign service to one or more team members (Team plan users) -->
        <div class="section-card">
          <div class="section-title">Assign to team members</div>
          <p class="text-sm text-gray-600 mb-3">Select which team member(s) can deliver this service. Leave empty to make the service unassigned.</p>

          <div class="mb-3">
            <div id="member-dropdown" class="relative">
              <button type="button" id="member-dropdown-toggle" class="cc-field text-left w-full flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                <span id="member-dropdown-label">Select team members...</span>
                <span style="font-size:0.9rem;color:#6b7280">▾</span>
              </button>

              <div id="member-dropdown-panel" role="listbox" aria-multiselectable="true" style="display:none;position:absolute;z-index:60;left:0;right:0;margin-top:6px;background:#fff;border:1px solid #e6eef6;border-radius:6px;max-height:320px;overflow:auto;box-shadow:0 6px 18px rgba(16,24,40,0.06);">
                <div style="padding:8px;border-bottom:1px solid #eef3f8">
                  <input id="member-search" type="search" placeholder="Search team members..." class="cc-field" style="margin:0;" />
                </div>
                <div id="member-list" style="padding:8px;">
                  {% if org.members.all %}
                    {% for m in org.members.all %}
                      {% if m.is_active %}
                        {% with user=m.user %}
                          <div class="member-item flex items-center justify-between py-2 px-2 rounded hover:bg-gray-50" data-name="{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.email }}{% endif %}" data-id="{{ m.id }}">
                            <div>
                              <div class="text-sm text-gray-800">{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.email }}{% endif %}</div>
                              <div class="text-xs text-gray-500">{{ m.role|role_label }}</div>
                            </div>
                            <div class="select-indicator text-sm text-blue-600" aria-hidden="true">&nbsp;</div>
                          </div>
                        {% endwith %}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <div class="text-sm text-gray-500">No team members found for this business.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <script>
            (function(){
              try{
                const toggle = document.getElementById('member-dropdown-toggle');
                const panel = document.getElementById('member-dropdown-panel');
                const input = document.getElementById('member-search');
                const list = document.getElementById('member-list');
                const label = document.getElementById('member-dropdown-label');

                if (!toggle || !panel || !input || !list) return;

                const selected = new Set();
                try{
                  const initial = {{ assigned_member_ids|default:'[]'|safe }};
                  for (const v of initial){ selected.add(String(v)); }
                }catch(e){ }

                function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                function updateLabel(){
                  if (!selected.size){ label.textContent = 'Select team members...'; return; }
                  const items = [];
                  for (const it of list.querySelectorAll('.member-item')){
                    const id = it.getAttribute('data-id');
                    if (selected.has(id)) {
                      const nameEl = it.querySelector('.text-sm');
                      const name = nameEl ? nameEl.textContent.trim() : (it.getAttribute('data-name')||'');
                      items.push({id: String(id), name: name});
                    }
                  }
                  if (!items.length){ label.textContent = 'Select team members...'; return; }
                  label.innerHTML = items.map(function(itm){
                    return '<span class="member-chip" data-id="' + escapeHtml(itm.id) + '">' + escapeHtml(itm.name) + ' <span class="member-chip-remove" data-id="' + escapeHtml(itm.id) + '" title="Remove" aria-hidden="true">&times;</span></span>';
                  }).join(' ');
                }

                function syncHiddenInputs(){
                  Array.from(document.querySelectorAll('input[name="assigned_members"][data-generated]')).forEach(i => i.remove());
                  const form = toggle.closest('form');
                  if (!form) return;
                  for (const id of selected){
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'assigned_members';
                    inp.value = id;
                    inp.setAttribute('data-generated','1');
                    form.appendChild(inp);
                  }
                }

                async function refreshServiceAvailabilityConstraints(){
                  try{
                    const editor = document.getElementById('svcAvailEditor');

                    const url = new URL("{% url 'calendar_app:service_availability_constraints' org.slug %}", window.location.origin);
                    for (const id of selected){ url.searchParams.append('member_ids', String(id)); }

                    const resp = await fetch(url.toString(), { credentials: 'same-origin' });
                    if (!resp.ok) return;
                    const data = await resp.json();

                    try{
                      window.__ccWeeklyServiceConstraints = { days: (data.days || []).map(function(d){ return { remaining: (d && d.remaining) ? d.remaining : [] }; }) };
                    } catch(e){ /* ignore */ }

                    if (!editor) return;
                    for (let ui = 0; ui < 7; ui++){
                      const day = (data.days || [])[ui] || {};
                      const allowedEmpty = !!day.allowed_empty;
                      const allowedText = (day.allowed_ranges_text || '').trim();

                      const labelEl = editor.querySelector('.cc-allowed-label[data-ui="' + ui + '"]');
                      if (labelEl){
                        const shown = allowedText ? allowedText : '—';
                        labelEl.textContent = 'Allowed (client-facing): ' + shown;
                      }

                      const hidden = editor.querySelector('input.svc-avail-hidden[data-ui="' + ui + '"]');
                      const hasSvc = !!(hidden && (hidden.value || '').trim());

                      const card = hidden ? (hidden.closest('.border') || hidden.closest('div')) : null;
                      // If there is *no allowed time at all* for the selected assignees on this day,
                      // force the day to Unavailable (prevents keeping stale ranges).
                      const hardLock = allowedEmpty;
                      if (card){
                        card.classList.toggle('cc-svc-day-locked', hardLock);
                      }

                      if (allowedEmpty){
                        try{
                          if (hidden && hasSvc){
                            hidden.value = '';
                            try{ hidden.dispatchEvent(new Event('input', { bubbles: true })); }catch(e){}
                            try{ hidden.dispatchEvent(new Event('change', { bubbles: true })); }catch(e){}
                          }
                          const dayEditor = editor.querySelector('.svc-day-editor[data-ui="' + ui + '"]');
                          if (dayEditor){
                            const cb = dayEditor.querySelector('input.svc-unavail');
                            if (cb) cb.checked = true;
                            const ranges = dayEditor.querySelector('.svc-ranges');
                            if (ranges) ranges.innerHTML = '';
                          }
                        }catch(e){ /* ignore */ }
                      }

                      const meta = editor.querySelector('.cc-svc-day-meta[data-ui="' + ui + '"]');
                      if (meta){
                        meta.setAttribute('data-allowed-empty', allowedEmpty ? '1' : '0');
                        meta.setAttribute('data-hard-lock', hardLock ? '1' : '0');
                        meta.setAttribute('data-no-remaining', (allowedEmpty && hasSvc) ? '1' : '0');
                      }
                    }
                  }catch(e){ /* ignore */ }
                }

                for (const it of list.querySelectorAll('.member-item')){
                  const id = it.getAttribute('data-id');
                  const indicator = it.querySelector('.select-indicator');
                  if (selected.has(id)) { indicator.textContent = '✓'; it.classList.add('bg-blue-50'); }
                  it.addEventListener('click', function(){
                        if (selected.has(id)){
                          selected.delete(id); indicator.textContent = '\u00A0'; it.classList.remove('bg-blue-50');
                        }
                        else { selected.add(id); indicator.textContent = '✓'; it.classList.add('bg-blue-50'); }
                      updateLabel();
                      syncHiddenInputs();
                      refreshServiceAvailabilityConstraints();
                    });
                }

                input.addEventListener('input', function(){
                  const q = (input.value || '').toLowerCase().trim();
                  for (const it of list.querySelectorAll('.member-item')){
                    const name = (it.getAttribute('data-name')||'').toLowerCase();
                    it.style.display = name.indexOf(q) === -1 ? 'none' : '';
                  }
                });

                toggle.addEventListener('click', function(){
                  const open = panel.style.display !== 'none';
                  panel.style.display = open ? 'none' : 'block';
                  toggle.setAttribute('aria-expanded', String(!open));
                  if (!open) input.focus();
                });

                document.addEventListener('click', function(e){
                  if (!toggle.contains(e.target) && !panel.contains(e.target)){
                    panel.style.display = 'none';
                    toggle.setAttribute('aria-expanded','false');
                  }
                });

                label.addEventListener('click', function(e){
                  try{
                    const rem = e.target && (e.target.closest ? e.target.closest('.member-chip-remove') : null);
                    if (!rem) return;
                    const id = rem.getAttribute('data-id');
                    if (!id) return;
                    if (selected.has(id)){
                      selected.delete(id);
                      const it = list.querySelector('.member-item[data-id="' + id + '"]');
                      if (it){
                        const indicator = it.querySelector('.select-indicator');
                        if (indicator) indicator.textContent = '\u00A0';
                        it.classList.remove('bg-blue-50');
                      }
                      updateLabel();
                      syncHiddenInputs();
                      refreshServiceAvailabilityConstraints();
                      e.stopPropagation();
                      e.preventDefault();
                    }
                  }catch(err){ }
                });

                updateLabel();
                syncHiddenInputs();
                // Ensure the time picker constraints sync after the availability editor exists.
                if (document.readyState === 'loading') {
                  document.addEventListener('DOMContentLoaded', function(){ refreshServiceAvailabilityConstraints(); }, { once: true });
                } else {
                  refreshServiceAvailabilityConstraints();
                }
              }catch(e){ console.warn('member dropdown failed', e); }
            })();
          </script>
        </div>
        {% else %}
        <!-- Assign service to team members (Team-only; show locked card on non-team plans) -->
        <div class="section-card cc-adv-lock-wrap cc-adv-locked">
          <div class="section-title">Assign to team members</div>
          <p class="text-sm text-gray-600">Assigning staff is available on the Team plan.</p>
          <div class="mt-3">
            <input type="text" class="cc-field" value="Upgrade to Team to assign staff" disabled>
          </div>
          <div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="team" role="button" tabindex="0" aria-label="Upgrade required" style="border-radius:0.75rem;"></div>
        </div>
        {% endif %}

        <!-- Service availability (matches edit page UI; validated on create) -->
        <div class="section-card {% if not can_edit_service_availability or service_availability_fully_blocked %}availability-disabled{% endif %}">
          <div class="mt-0">
            <h2 class="text-base font-semibold text-center">Service availability</h2>

            <p class="text-sm text-gray-500 mt-3 text-center">
              Specify which days/times this service is offered. These must fit within the allowed window shown for each day.
            </p>

            <div class="mt-2 text-center">
              {% if not can_edit_service_availability %}
                <div class="text-xs text-gray-500">Service availability is available on Pro/Team plans. Upgrade to unlock per-service availability.</div>
              {% else %}
                <div class="text-xs text-gray-500">These weekly service availability settings are interchangeable with the Calendar page (when viewing this service). You can update them in either place.</div>
              {% endif %}
              <a id="cc-open-calendar-from-service" href="{% url 'calendar_app:calendar' org.slug %}"
                 class="inline-flex items-center px-3 py-2 mt-2 rounded-md text-sm font-medium border border-blue-600 text-blue-600 bg-white hover:bg-blue-50">
                Open in Calendar
              </a>
            </div>

            {% if not can_edit_service_availability %}
              <div class="availability-overlay" role="status" aria-live="polite">
                <div class="msg">
                  <strong class="block mb-1">Service availability disabled</strong>
                  <div class="text-sm">{{ service_availability_disabled_reason|default:"Service availability requires a Pro or Team subscription. Upgrade to unlock per-service availability." }}</div>
                </div>
              </div>
            {% elif service_availability_fully_blocked %}
              <div class="availability-overlay" role="status" aria-live="polite">
                <div class="msg">
                  <strong class="block mb-1">No remaining availability for this service</strong>
                  <div class="text-sm">{{ service_availability_fully_blocked_reason|default:"There’s no remaining time to schedule this service within your overall availability." }}</div>
                  <div class="text-sm mt-2">To make room, remove days/times from other services (or reduce their weekly availability) so this service has open space.</div>
                </div>
              </div>
            {% endif %}

            <div class="grid grid-cols-1 gap-3 mt-3" id="svcAvailEditor">
              {% for row in weekly_edit_rows %}
                <div class="border rounded-md p-3 bg-white {% if row.hard_lock %}cc-svc-day-locked{% endif %}">
                  <div class="flex items-center justify-between gap-3">
                    <div class="font-semibold text-gray-800" style="width:64px">{{ row.label }}</div>
                    <div class="text-xs text-gray-600 cc-allowed-label" data-ui="{{ row.ui }}">Allowed (client-facing): {{ row.allowed_ranges|default:row.org_ranges|default:'—' }}</div>
                  </div>

                  <input type="hidden"
                         name="svc_avail_{{ row.ui }}"
                         value="{{ row.svc_ranges }}"
                         class="svc-avail-hidden"
                         data-ui="{{ row.ui }}"
                         {% if not can_edit_service_availability or service_availability_fully_blocked %}disabled aria-disabled="true"{% endif %}>

                  <div class="mt-2 svc-day-editor" data-ui="{{ row.ui }}" {% if not can_edit_service_availability or service_availability_fully_blocked %}data-disabled="1"{% endif %}>
                    <div class="cc-svc-day-meta"
                         data-ui="{{ row.ui }}"
                         data-allowed-empty="{{ row.allowed_empty|yesno:'1,0' }}"
                         data-hard-lock="{{ row.hard_lock|yesno:'1,0' }}"
                         data-no-remaining="{{ row.no_remaining|yesno:'1,0' }}"
                         style="display:none;"></div>
                    <label class="inline-flex items-center text-sm text-gray-700">
                      <input type="checkbox" class="svc-unavail rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                             {% if not row.svc_ranges %}checked{% endif %}
                             {% if not can_edit_service_availability or service_availability_fully_blocked %}disabled aria-disabled="true"{% endif %}>
                      <span class="ml-2">Unavailable</span>
                    </label>
                    <div class="svc-ranges mt-2" style="display:flex; flex-direction:column; gap:8px;"></div>
                    <button type="button" class="svc-add-range mt-2 text-sm text-blue-600 hover:text-blue-700"
                            {% if not can_edit_service_availability or service_availability_fully_blocked %}disabled aria-disabled="true"{% endif %}>+ Add time range</button>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <script>
          // Per-day remaining allowed minutes for the service availability editor.
          // Matches calendar.html custom time picker constraint semantics.
          (function(){
            try { window.__ccWeeklyServiceConstraints = {{ svc_constraints_json|default:'null'|safe }}; } catch (e) { window.__ccWeeklyServiceConstraints = null; }
          })();
        </script>

        <script>
          // Service availability editor: time inputs -> hidden svc_avail_* fields
          (function(){
            try{
              // Calendar-like custom time picker (hour/minute scrollers)
              function createCustomTimePicker(inputElement){
                const picker = document.createElement('div');
                picker.className = 'custom-time-picker';

                const [initialHour, initialMinute] = (inputElement.value || '09:00').split(':');
                let selectedHour = initialHour;
                let selectedMinute = initialMinute;

                const isStart = inputElement.classList.contains('range-start') || inputElement.classList.contains('modal-range-start');
                const headerText = isStart ? 'Start Time' : 'End Time';

                function _minutesFromTimeStr(s){
                  try{
                    const v = String(s || '').trim();
                    const parts = v.split(':');
                    if (parts.length !== 2) return null;
                    const h = parseInt(parts[0], 10);
                    const m = parseInt(parts[1], 10);
                    if (isNaN(h) || isNaN(m)) return null;
                    return (h * 60) + m;
                  }catch(e){ return null; }
                }

                function _ccGetAllowedIntervalsForInput(el){
                  try {
                    const dayIdx = parseInt(String(el?.dataset?.day ?? ''), 10);
                    if (isNaN(dayIdx)) return null;
                    const c = window.__ccWeeklyServiceConstraints || null;
                    if (!c || !c.days || !c.days[dayIdx]) return null;
                    const d = c.days[dayIdx];
                    if (!d || !Array.isArray(d.remaining)) return null;
                    return d.remaining.slice();
                  } catch (e) {
                    return null;
                  }
                }

                function _ccIsMinuteAllowed(min){
                  try {
                    if (min === null || min === undefined || isNaN(min)) return false;
                    const allowed = _ccGetAllowedIntervalsForInput(inputElement);
                    if (allowed === null) return true; // unconstrained
                    if (!allowed.length) return false;

                    const row = inputElement.closest('.svc-range-row');
                    const startEl = row ? row.querySelector('.range-start') : null;
                    const endEl = row ? row.querySelector('.range-end') : null;
                    const startMin = startEl ? _minutesFromTimeStr(startEl.value) : null;
                    const endMin = endEl ? _minutesFromTimeStr(endEl.value) : null;

                    const inAllowed = allowed.some(r => {
                      try {
                        const s = parseInt(r.start, 10);
                        const e = parseInt(r.end, 10);
                        if (isNaN(s) || isNaN(e)) return false;
                        if (isStart) return (s <= min) && (min < e);
                        return (s < min) && (min <= e);
                      } catch (e) {
                        return false;
                      }
                    });
                    if (!inAllowed) return false;

                    if (isStart && endMin !== null && !isNaN(endMin)) {
                      if (!(min < endMin)) return false;
                    }
                    if (!isStart && startMin !== null && !isNaN(startMin)) {
                      if (!(min > startMin)) return false;
                    }
                    return true;
                  } catch (e) {
                    return true;
                  }
                }

                function _ccFirstAllowedMinuteForHour(hour){
                  try {
                    const h = parseInt(hour, 10);
                    if (isNaN(h)) return null;
                    const base = h * 60;
                    for (let m = 0; m < 60; m++){
                      const min = base + m;
                      if (_ccIsMinuteAllowed(min)) return min;
                    }
                  } catch (e) {}
                  return null;
                }

                function _ccSnapToAllowed(hh, mm){
                  try {
                    const h = parseInt(hh, 10);
                    const m = parseInt(mm, 10);
                    if (isNaN(h) || isNaN(m)) return null;
                    const cur = h*60 + m;
                    if (_ccIsMinuteAllowed(cur)) return cur;
                    const firstInHour = _ccFirstAllowedMinuteForHour(h);
                    if (firstInHour !== null) return firstInHour;
                    for (let t = 0; t < 24*60; t++){
                      if (_ccIsMinuteAllowed(t)) return t;
                    }
                  } catch (e) {}
                  return null;
                }

                picker.innerHTML = `
                  <div class="time-picker-header">${headerText}</div>
                  <div class="time-picker-display">${formatDisplayTime(selectedHour, selectedMinute)}</div>
                  <div class="time-picker-selectors">
                    <div class="time-selector">
                      <div class="time-selector-label">Hour</div>
                      <div class="time-scroll-container" data-type="hour"></div>
                    </div>
                    <div class="time-selector">
                      <div class="time-selector-label">Minute</div>
                      <div class="time-scroll-container" data-type="minute"></div>
                    </div>
                  </div>
                  <div class="time-picker-actions">
                    <button class="time-picker-btn cancel" type="button">Cancel</button>
                    <button class="time-picker-btn confirm" type="button">Confirm</button>
                  </div>
                `;

                const hourContainer = picker.querySelector('[data-type="hour"]');
                for (let h = 0; h < 24; h++){
                  const hourStr = String(h).padStart(2, '0');
                  const opt = document.createElement('div');
                  opt.className = 'time-option';
                  try { if (_ccFirstAllowedMinuteForHour(h) === null) opt.classList.add('disabled'); } catch (e) {}
                  if (hourStr === selectedHour) opt.classList.add('selected');
                  opt.textContent = formatHour(h);
                  opt.addEventListener('click', () => {
                    hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedHour = hourStr;
                    try {
                      const snapped = _ccSnapToAllowed(selectedHour, selectedMinute);
                      if (snapped !== null) {
                        selectedHour = String(Math.floor(snapped / 60)).padStart(2, '0');
                        selectedMinute = String(snapped % 60).padStart(2, '0');
                      }
                    } catch (e) {}
                    updateDisplay();
                    try { syncMinuteOptions(); } catch (e) {}
                    opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  });
                  hourContainer.appendChild(opt);
                }

                const minuteContainer = picker.querySelector('[data-type="minute"]');
                for (let m = 0; m < 60; m++){
                  const minStr = String(m).padStart(2, '0');
                  const opt = document.createElement('div');
                  opt.className = 'time-option';
                  if (minStr === selectedMinute) opt.classList.add('selected');
                  opt.textContent = minStr;
                  opt.addEventListener('click', () => {
                    minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    opt.classList.add('selected');
                    selectedMinute = minStr;
                    updateDisplay();
                    opt.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  });
                  minuteContainer.appendChild(opt);
                }

                function syncMinuteOptions(){
                  try {
                    const h = parseInt(selectedHour, 10);
                    const opts = Array.from(minuteContainer.querySelectorAll('.time-option'));
                    let hasSelected = false;
                    for (const o of opts){
                      const mm = parseInt(o.textContent, 10);
                      const min = (isNaN(h) || isNaN(mm)) ? null : (h*60 + mm);
                      const ok = _ccIsMinuteAllowed(min);
                      o.classList.toggle('disabled', !ok);
                      if (ok && o.classList.contains('selected')) hasSelected = true;
                    }
                    if (!hasSelected){
                      const snap = _ccFirstAllowedMinuteForHour(h);
                      if (snap !== null) {
                        selectedHour = String(Math.floor(snap / 60)).padStart(2, '0');
                        selectedMinute = String(snap % 60).padStart(2, '0');
                        hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                        const hourIdx = parseInt(selectedHour, 10);
                        const hourOpt = hourContainer.querySelectorAll('.time-option')[hourIdx];
                        if (hourOpt) hourOpt.classList.add('selected');
                        minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                        const minuteOpt = minuteContainer.querySelectorAll('.time-option')[parseInt(selectedMinute,10)];
                        if (minuteOpt) minuteOpt.classList.add('selected');
                        updateDisplay();
                        for (const o of opts){
                          const mm = parseInt(o.textContent, 10);
                          const min = (isNaN(hourIdx) || isNaN(mm)) ? null : (hourIdx*60 + mm);
                          const ok = _ccIsMinuteAllowed(min);
                          o.classList.toggle('disabled', !ok);
                        }
                      }
                    }
                  } catch (e) { /* ignore */ }
                }

                function updateDisplay(){
                  picker.querySelector('.time-picker-display').textContent = formatDisplayTime(selectedHour, selectedMinute);
                }
                function formatHour(h){
                  if (h === 0) return '12 AM';
                  if (h < 12) return `${h} AM`;
                  if (h === 12) return '12 PM';
                  return `${h - 12} PM`;
                }
                function formatDisplayTime(h, m){
                  const hour = parseInt(h, 10);
                  const ampm = hour >= 12 ? 'PM' : 'AM';
                  const h12 = hour === 0 ? 12 : (hour > 12 ? hour - 12 : hour);
                  return `${h12}:${m} ${ampm}`;
                }

                setTimeout(() => {
                  try{ hourContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' }); }catch(e){}
                  try{ minuteContainer.querySelector('.selected')?.scrollIntoView({ block: 'center' }); }catch(e){}
                }, 50);

                // Apply constraints immediately (snap initial selection + disable invalid options)
                try {
                  const snapped = _ccSnapToAllowed(selectedHour, selectedMinute);
                  if (snapped !== null) {
                    selectedHour = String(Math.floor(snapped / 60)).padStart(2, '0');
                    selectedMinute = String(snapped % 60).padStart(2, '0');
                    hourContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    const hourIdx = parseInt(selectedHour, 10);
                    const hourOpt = hourContainer.querySelectorAll('.time-option')[hourIdx];
                    if (hourOpt) hourOpt.classList.add('selected');
                    minuteContainer.querySelectorAll('.time-option').forEach(o => o.classList.remove('selected'));
                    const minuteOpt = minuteContainer.querySelectorAll('.time-option')[parseInt(selectedMinute,10)];
                    if (minuteOpt) minuteOpt.classList.add('selected');
                    updateDisplay();
                  }
                  syncMinuteOptions();
                } catch (e) {}

                picker.querySelector('.confirm').addEventListener('click', (e) => {
                  e.stopPropagation();
                  inputElement.value = `${selectedHour}:${selectedMinute}`;
                  try{ inputElement.dispatchEvent(new Event('input', { bubbles: true })); }catch(err){}
                  try{ inputElement.dispatchEvent(new Event('change', { bubbles: true })); }catch(err){}
                  picker.remove();
                });
                picker.querySelector('.cancel').addEventListener('click', (e) => {
                  e.stopPropagation();
                  picker.remove();
                });

                setTimeout(() => {
                  document.addEventListener('click', function closeOnOutside(ev){
                    try{
                      if (!picker.contains(ev.target) && ev.target !== inputElement) {
                        picker.remove();
                        document.removeEventListener('click', closeOnOutside);
                      }
                    }catch(e){ /* ignore */ }
                  });
                }, 100);

                return picker;
              }

              function normalizeTime(t){
                const s = String(t || '').trim();
                // accept HH:MM
                if (s.length === 5 && s[2] === ':') return s;
                return '';
              }

              function parseRanges(raw){
                const out = [];
                const s = String(raw || '').trim();
                if (!s) return out;
                const parts = s.split(',').map(x => x.trim()).filter(Boolean);
                for (const p of parts){
                  const seg = p.split('-').map(x => x.trim());
                  if (seg.length !== 2) continue;
                  const a = normalizeTime(seg[0]);
                  const b = normalizeTime(seg[1]);
                  if (!a || !b) continue;
                  out.push({start: a, end: b});
                }
                return out;
              }

              function buildRangeRow(startVal, endVal, onChange, onRemove, disabled, dayIdx){
                const row = document.createElement('div');
                row.className = 'svc-range-row';
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.gap = '10px';

                const startContainer = document.createElement('div');
                startContainer.className = 'time-input-container';
                const start = document.createElement('input');
                start.type = 'time';
                start.value = startVal || '';
                start.className = 'cc-field range-start';
                try{ start.dataset.day = String(dayIdx); }catch(e){}
                start.style.maxWidth = '140px';
                start.readOnly = true;
                start.style.cursor = 'pointer';
                startContainer.appendChild(start);

                const endContainer = document.createElement('div');
                endContainer.className = 'time-input-container';
                const end = document.createElement('input');
                end.type = 'time';
                end.value = endVal || '';
                end.className = 'cc-field range-end';
                try{ end.dataset.day = String(dayIdx); }catch(e){}
                end.style.maxWidth = '140px';
                end.readOnly = true;
                end.style.cursor = 'pointer';
                endContainer.appendChild(end);

                const remove = document.createElement('button');
                remove.type = 'button';
                remove.textContent = 'Remove';
                remove.className = 'text-sm text-gray-600 hover:text-gray-800';

                function fire(){ try{ onChange(); }catch(e){} }

                start.addEventListener('input', fire);
                end.addEventListener('input', fire);

                // Open custom picker on click (matches calendar default availability)
                start.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  try {
                    document.querySelectorAll('#svcAvailEditor .custom-time-picker').forEach(p => p.remove());
                    const picker = createCustomTimePicker(start);
                    picker.classList.add('active');
                    startContainer.appendChild(picker);
                  } catch (err) { /* ignore */ }
                });
                end.addEventListener('click', function(e){
                  e.preventDefault();
                  e.stopPropagation();
                  try {
                    document.querySelectorAll('#svcAvailEditor .custom-time-picker').forEach(p => p.remove());
                    const picker = createCustomTimePicker(end);
                    picker.classList.add('active');
                    endContainer.appendChild(picker);
                  } catch (err) { /* ignore */ }
                });
                remove.addEventListener('click', function(){
                  try{ onRemove(row); }catch(e){}
                  fire();
                });

                if (disabled){
                  start.disabled = true;
                  end.disabled = true;
                  remove.disabled = true;
                }

                row.appendChild(startContainer);
                row.appendChild(endContainer);
                row.appendChild(remove);

                row.__get = function(){
                  return { start: normalizeTime(start.value), end: normalizeTime(end.value) };
                };

                return row;
              }

              const editors = Array.from(document.querySelectorAll('.svc-day-editor'));
              for (const ed of editors){
                const ui = ed.getAttribute('data-ui');
                const disabled = ed.getAttribute('data-disabled') === '1';
                const hidden = document.querySelector('.svc-avail-hidden[data-ui="' + ui + '"]');
                const list = ed.querySelector('.svc-ranges');
                const unavail = ed.querySelector('.svc-unavail');
                const addBtn = ed.querySelector('.svc-add-range');
                if (!hidden || !list || !unavail || !addBtn) continue;

                // Lock behavior:
                // - hard-lock: there is no allowed time AND there are no current ranges for this day.
                // - no-remaining: there is no allowed time but ranges exist (e.g., a POSTed invalid value);
                //   allow editing/removal, but don't allow adding new ranges.
                const meta = ed.querySelector('.cc-svc-day-meta[data-ui="' + ui + '"]');
                const hardLock = !!(meta && meta.getAttribute('data-hard-lock') === '1');
                const noRemaining = !!(meta && meta.getAttribute('data-no-remaining') === '1');
                if (hardLock){
                  try { ed.closest('.border')?.classList.add('cc-svc-day-locked'); } catch (e) {}
                  try {
                    unavail.checked = true;
                    unavail.disabled = true;
                    list.textContent = '';
                    hidden.value = '';
                    addBtn.disabled = true;
                    addBtn.style.display = 'none';
                  } catch (e) {}
                  continue;
                }

                if (noRemaining){
                  try { addBtn.disabled = true; } catch (e) {}
                  try { addBtn.style.display = 'none'; } catch (e) {}
                }

                function syncHidden(){
                  if (unavail.checked){
                    hidden.value = '';
                    return;
                  }
                  const ranges = [];
                  for (const child of Array.from(list.children)){
                    if (!child.__get) continue;
                    const r = child.__get();
                    if (!r.start || !r.end) continue;
                    ranges.push(r.start + '-' + r.end);
                  }
                  hidden.value = ranges.join(',');
                }

                function setAvailabilityEnabled(){
                  const isUnavail = !!unavail.checked;
                  list.style.opacity = isUnavail ? '0.6' : '1';
                  addBtn.style.opacity = (isUnavail || disabled || noRemaining) ? '0.5' : '1';
                  try{ addBtn.disabled = isUnavail || disabled || noRemaining; }catch(e){}
                  for (const child of Array.from(list.children)){
                    try{
                      const inputs = child.querySelectorAll('input, button');
                      inputs.forEach(i => { i.disabled = disabled || isUnavail; });
                    }catch(e){}
                  }
                  if (isUnavail){
                    syncHidden();
                  }
                }

                function removeRow(node){
                  try{ node.remove(); }catch(e){}
                  try{
                    const hasAny = !!(list && list.children && list.children.length);
                    if (!hasAny){
                      unavail.checked = true;
                      list.textContent = '';
                      if (noRemaining){
                        try { addBtn.disabled = true; } catch (e) {}
                        try { addBtn.style.display = 'none'; } catch (e) {}
                      }
                      setAvailabilityEnabled();
                      syncHidden();
                    }
                  }catch(e){}
                }

                function addRow(startVal, endVal){
                  const row = buildRangeRow(startVal, endVal, syncHidden, removeRow, disabled, ui);
                  list.appendChild(row);
                }

                // init from hidden
                const initial = parseRanges(hidden.value);
                if (initial.length){
                  unavail.checked = false;
                  for (const r of initial) addRow(r.start, r.end);
                } else {
                  unavail.checked = true;
                }

                unavail.addEventListener('change', function(){
                  if (unavail.checked){
                    list.textContent = '';
                  } else {
                    if (noRemaining){
                      if (!list.children.length){
                        unavail.checked = true;
                      }
                    } else {
                      if (!list.children.length) addRow('09:00','17:00');
                    }
                  }
                  setAvailabilityEnabled();
                  syncHidden();
                });

                addBtn.addEventListener('click', function(){
                  if (disabled || unavail.checked || noRemaining) return;
                  addRow('09:00','17:00');
                  setAvailabilityEnabled();
                  syncHidden();
                });

                setAvailabilityEnabled();
                syncHidden();
              }
            }catch(e){ console.warn('svc availability editor init failed', e); }
          })();
        </script>

        <!-- Facility resources (capacity) -->
        <div class="section-card cc-adv-lock-wrap {% if not can_use_facility_resources %}cc-adv-locked{% endif %}">
          <div class="section-title">Facility resources (capacity)</div>
          <p class="text-sm text-gray-600 mb-3">When enabled, clients can only book this service if at least one linked facility resource has capacity.</p>

          <label class="inline-flex items-center">
            <input type="checkbox" name="requires_facility_resources" id="requires_facility_resources" value="1"
                   class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                   {% if not can_use_facility_resources %}disabled{% endif %}>
            <span class="ml-2 text-sm text-gray-700">Requires facility resources/capacity</span>
          </label>

          <div id="ccCreateResourcesPanel" class="mt-3" style="display:none;">
            <div class="flex items-center justify-between mb-2">
              <div class="text-sm font-medium text-gray-700">Select resources</div>
              <a href="{% url 'calendar_app:resources_page' org.slug %}" class="text-sm text-blue-600 hover:text-blue-700">Manage resources →</a>
            </div>

            {% if facility_resources %}
              <div class="space-y-2">
                {% for r in facility_resources %}
                  <label class="flex items-center justify-between p-2 rounded border border-gray-200">
                    <span class="text-sm text-gray-700">
                      {{ r.name }}
                      {% if not r.is_active %}<span class="text-xs text-gray-500">(inactive)</span>{% endif %}
                    </span>
                    <input type="checkbox" name="resource_ids" value="{{ r.id }}" class="rounded border-gray-300"
                           {% if not r.is_active %}disabled{% endif %}>
                  </label>
                {% endfor %}
              </div>
              <p class="mt-2 text-xs text-gray-500">Tip: link multiple resources if this service can run in multiple spaces.</p>
            {% else %}
              <div class="text-sm text-gray-700">No resources created yet. Create a space capacity first, then come back and enable this.</div>
            {% endif %}
          </div>

          {% if not can_use_facility_resources %}<div class="cc-adv-lock-overlay" data-cc-adv-lock data-cc-plan="team" role="button" tabindex="0" aria-label="Upgrade required" style="border-radius:0.75rem;"></div>{% endif %}
        </div>

        <script>
          (function(){
            try{
              const chk = document.getElementById('requires_facility_resources');
              const panel = document.getElementById('ccCreateResourcesPanel');
              if (!chk || !panel) return;
              function update(){
                const on = !!chk.checked;
                panel.style.display = on ? 'block' : 'none';
                for (const cb of panel.querySelectorAll('input[type="checkbox"][name="resource_ids"]')){
                  cb.disabled = !on || cb.hasAttribute('data-force-disabled');
                  if (!on) cb.checked = false;
                }
              }
              update();
              chk.addEventListener('change', update);
            }catch(e){ }
          })();
        </script>

        <!-- Refund Policy -->
        <div class="border-t pt-6 space-y-4">
          <h2 class="text-base font-semibold">Refund Policy (Service)</h2>
          <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
            <label class="inline-flex items-center">
              <input type="checkbox" name="refunds_allowed" id="refunds_allowed" value="1" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
              <span class="ml-2 text-sm text-gray-700">Allow refunds for this service</span>
            </label>
            {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Refund cutoff (hours)</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <input name="refund_cutoff_hours" type="number" value="24" min="1" class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">Inside this window, refunds are not permitted.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Custom refund policy text</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <textarea name="refund_policy_text" rows="3" class="cc-field mt-1 w-full" placeholder="Optional. Shown to clients in emails and pages." {% if not can_use_pro_team %}disabled{% endif %}></textarea>
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
          </div>
        </div>

        <script>
          // Refund policy fields: only editable on Pro/Team, and only when refunds are enabled.
          (function(){
            try{
              const CAN_USE_PRO_TEAM = {{ can_use_pro_team|yesno:'true,false' }};
              const chk = document.getElementById('refunds_allowed');
              const cutoff = document.querySelector('input[name="refund_cutoff_hours"]');
              const text = document.querySelector('textarea[name="refund_policy_text"]');
              if (!chk || !cutoff || !text) return;
              function update(){
                const enabled = CAN_USE_PRO_TEAM && !!chk.checked;
                try{ cutoff.disabled = !enabled; }catch(e){}
                try{ text.disabled = !enabled; }catch(e){}
              }
              chk.addEventListener('change', update);
              update();
            }catch(e){ /* ignore */ }
          })();
        </script>

        <div class="flex items-center justify-between pt-2">
          <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
          <button type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 shadow-sm">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
            Create Service
          </button>
        </div>
      </form>
    </div>

    <!-- Guidance Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border rounded-xl shadow-sm p-4 sm:p-6">
        <h2 class="text-sm font-semibold mb-3">Best Practices</h2>
        <ul class="space-y-3 text-sm text-gray-600">
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Include length in the name.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Keep description outcome‑focused.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Use buffers to avoid burnout.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Limit advance window to manage demand.</li>
        </ul>
      </div>
      {% if not can_use_pro_team %}
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 sm:p-6 text-sm text-blue-700">
        Upgrade to Pro or higher for advanced booking logic.
      </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-8 text-center">
    <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">← Back to Dashboard</a>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}

<div id="ccOfflinePaymentWarningModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10060;">
  <div style="background:#fff; border-radius:12px; width:min(620px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
    <div style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">Offline payment warning</div>
    <div style="color:#374151; font-size:0.95rem; line-height:1.4; margin-bottom:14px;">
      You enabled a payment method that is processed outside CircleCal (Venmo/Zelle/Cash). These methods cannot enforce automatic refunds by cutoff and clients can potentially not pay.
      <div style="margin-top:10px;">
        As the controller of your service, you have the right to refuse or provide service to anyone that fails to follow fair and established rules.
      </div>
      <div style="margin-top:10px;">
        It is much easier with only Stripe implemented, but that reduces flexibility for clients who want to pay another way besides card.
      </div>
      <div style="margin-top:10px; color:#6b7280;">
        You can change the form of payment for this service at any time.
      </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="ccOfflinePaymentWarningCancelBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Cancel</button>
      <button id="ccOfflinePaymentWarningConfirmBtn" type="button" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800;">I understand, create service</button>
    </div>
  </div>
</div>

<div id="ccAdvancedUpgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10050;">
  <div style="background:#fff; border-radius:12px; width:min(520px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
    <div id="ccAdvancedUpgradeTitle" style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">Upgrade required</div>
    <div id="ccAdvancedUpgradeBody" style="color:#374151; font-size:0.95rem; line-height:1.35; margin-bottom:14px;">
      A Pro subscription or higher is required to have access to the advanced settings features.
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="ccAdvancedUpgradeCancelBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Cancel</button>
      <button id="ccAdvancedUpgradeGoBtn" type="button" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800;">{% if cc_app_mode %}OK{% else %}View pricing{% endif %}</button>
    </div>
  </div>
</div>

<script>
  function slugify(str){
    return str.toString().trim().toLowerCase()
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-');
  }
  const nameInput = document.getElementById('svcName');
  const slugPreview = document.getElementById('slugPreview');
  nameInput && nameInput.addEventListener('input', () => {
    const v = nameInput.value.trim();
    const full = v ? slugify(v) : 'preview';
    // Shorten visually to ~18 chars; underlying generation still full server-side
    slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
    slugPreview.setAttribute('title', full); // hover shows full slug
  });
</script>

<script>
  (function(){
    try{
      const CAN_USE_PRO_TEAM = {{ can_use_pro_team|yesno:'true,false' }};
      const CAN_USE_FACILITY = {{ can_use_facility_resources|yesno:'true,false' }};
      const IS_TEAM_PLAN = {{ is_team_plan|yesno:'true,false' }};
      const CC_APP_MODE = {{ cc_app_mode|yesno:'true,false' }};
      const PRICING_URL = "{% url 'calendar_app:pricing_page' org.slug %}";
      const APP_PLANS_URL = "{% url 'calendar_app:app_plans_page' org.slug %}?cc_app=1";

      function openModal(requiredPlan){
        const req = (requiredPlan || 'pro').toLowerCase();

        // If somehow invoked for an already-allowed tier, do nothing.
        // (Overlays shouldn't exist in those cases, but keep this safe.)
        if (req === 'pro' && CAN_USE_PRO_TEAM) return;
        if (req === 'team' && IS_TEAM_PLAN) return;
        if (req === 'team' && CAN_USE_FACILITY) {
          // Facility resources specifically: only Team plan should pass.
          // If this is true, don't show upgrade.
          return;
        }

        const modal = document.getElementById('ccAdvancedUpgradeModal');
        const cancelBtn = document.getElementById('ccAdvancedUpgradeCancelBtn');
        const goBtn = document.getElementById('ccAdvancedUpgradeGoBtn');
        const titleEl = document.getElementById('ccAdvancedUpgradeTitle');
        const bodyEl = document.getElementById('ccAdvancedUpgradeBody');

        const bodyText = (req === 'team')
          ? 'A Team subscription is required to use this feature.'
          : 'A Pro subscription or higher is required to have access to the advanced settings features.';
        try{ if (titleEl) titleEl.textContent = 'Upgrade required'; }catch(e){}
        try{ if (bodyEl) bodyEl.textContent = bodyText; }catch(e){}

        if (!modal || !cancelBtn || !goBtn){
          if (CC_APP_MODE) {
            alert(bodyText + "\n\nThis feature isn’t available in the mobile app. You can view plan details in Plans or contact support.");
          } else {
            const go = confirm(bodyText + '\n\nPress OK to view pricing, or Cancel to stay here.');
            if (go) { try { window.location.href = PRICING_URL; } catch(e) {} }
          }
          return;
        }
        modal.style.display = 'flex';
        function close(){ try{ modal.style.display = 'none'; }catch(e){} }
        cancelBtn.onclick = function(e){ try{ e.preventDefault(); }catch(err){} close(); };
        goBtn.onclick = function(e){
          try{ e.preventDefault(); }catch(err){}
          if (CC_APP_MODE) {
            close();
            try { window.location.href = APP_PLANS_URL; } catch (err) {}
          } else {
            try{ window.location.href = PRICING_URL; }catch(err){}
          }
        };
        modal.onclick = function(e){ try{ if (e && e.target === modal) close(); }catch(err){} };
        try{
          document.addEventListener('keydown', function onKey(e){
            try{ if (e && e.key === 'Escape') close(); }catch(err){}
          }, { once: true });
        }catch(e){}
      }

      document.querySelectorAll('[data-cc-adv-lock]').forEach(function(el){
        el.addEventListener('click', function(e){
          try{ e.preventDefault(); e.stopPropagation(); }catch(err){}
          const required = (el.getAttribute('data-cc-plan') || 'pro');
          openModal(required);
        });
        el.addEventListener('keydown', function(e){
          try{
            if (!e) return;
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              const required = (el.getAttribute('data-cc-plan') || 'pro');
              openModal(required);
            }
          }catch(err){}
        });
      });
    }catch(e){ /* ignore */ }
  })();
</script>

<script>
  (function(){
    try{
      const form = document.querySelector('form.cc-form');
      if (!form) return;

      const ORG_HAS_VENMO = {{ org_has_venmo|yesno:'true,false' }};
      const ORG_HAS_ZELLE = {{ org_has_zelle|yesno:'true,false' }};
      const PROFILE_URL = "{% url 'accounts:profile' %}";

      const modal = document.getElementById('ccOfflinePaymentWarningModal');
      const cancelBtn = document.getElementById('ccOfflinePaymentWarningCancelBtn');
      const confirmBtn = document.getElementById('ccOfflinePaymentWarningConfirmBtn');

      let bypassOnce = false;
      function shouldWarn(){
        try{
          const priceEl = form.querySelector('input[name="price"]');
          const price = priceEl ? Number(priceEl.value || 0) : 0;
          const isPaid = (Number.isFinite(price) && price > 0);
          if (!isPaid) return false;
          const offlineChecked = Array.from(form.querySelectorAll('input[name="offline_methods"]:checked')).length > 0;
          return !!offlineChecked;
        }catch(e){ return false; }
      }

      function missingRequiredOfflineInfo(){
        try{
          const priceEl = form.querySelector('input[name="price"]');
          const price = priceEl ? Number(priceEl.value || 0) : 0;
          const isPaid = (Number.isFinite(price) && price > 0);
          if (!isPaid) return null;

          const selected = Array.from(form.querySelectorAll('input[name="offline_methods"]:checked'))
            .map(el => String(el.value || ''));

          if (selected.includes('venmo') && !ORG_HAS_VENMO) return 'venmo';
          if (selected.includes('zelle') && !ORG_HAS_ZELLE) return 'zelle';
          return null;
        }catch(e){ return null; }
      }

      function openModal(){
        if (!modal || !cancelBtn || !confirmBtn){
          const ok = confirm('You enabled a payment method processed outside CircleCal (Venmo/Zelle/Cash). These methods cannot enforce automatic refunds by cutoff and clients can potentially not pay.\n\nIt is easier with only Stripe, but less flexible.\n\nYou can change the form of payment for this service at any time.\n\nPress OK to continue, or Cancel to go back.');
          if (ok){ bypassOnce = true; try{ form.submit(); }catch(e){} }
          return;
        }
        modal.style.display = 'flex';
      }
      function closeModal(){ try{ if (modal) modal.style.display = 'none'; }catch(e){} }

      if (cancelBtn) cancelBtn.addEventListener('click', function(ev){ try{ ev.preventDefault(); }catch(e){} closeModal(); });
      if (confirmBtn) confirmBtn.addEventListener('click', function(ev){
        try{ ev.preventDefault(); }catch(e){}
        bypassOnce = true;
        closeModal();
        try{ form.submit(); }catch(e){}
      });
      if (modal){
        modal.addEventListener('click', function(e){ try{ if (e && e.target === modal) closeModal(); }catch(err){} });
      }

      form.addEventListener('submit', function(e){
        try{
          if (bypassOnce){ bypassOnce = false; return; }

          const missing = missingRequiredOfflineInfo();
          if (missing){
            e.preventDefault();
            const label = (missing === 'venmo') ? 'Venmo' : 'Zelle';
            alert(`To enable ${label} for a paid service, add your ${label} info on your Profile page first.\n\nGo to: ${PROFILE_URL}`);
            return;
          }

          if (!shouldWarn()) return;
          e.preventDefault();
          openModal();
        }catch(err){ /* fall through */ }
      });
    }catch(e){ /* ignore */ }
  })();
</script>
{% endblock %}
