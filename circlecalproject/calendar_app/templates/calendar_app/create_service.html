{% extends "calendar_app/base.html" %}

{% block extra_head %}
<style>
  /* Page-specific enhanced field styling (aligned with edit page) */
  .cc-field {
    border: 1px solid #d1d5db; /* gray-300 */
    background: #ffffff;
    padding: 0.7rem 0.9rem;
    border-radius: 0.5rem;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    font-size: 0.97rem;
    width: 100%;
  }
  .cc-field[disabled] { background:#f8fafc; opacity:.9; }
  .cc-field:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,0.08); }
  .cc-page { max-width:78rem; margin:0 auto; padding:2.5rem 1.5rem; }
  @media (min-width:768px){ .cc-page { padding:3rem 2rem; } }
  .section-card { background:#fff; border:1px solid #e6edf3; border-radius:0.75rem; padding:1rem 1.25rem; margin-bottom:1rem; }
  .section-title { font-size:1rem; font-weight:600; margin-bottom:0.5rem; }

  /* Locked advanced settings overlay */
  .cc-adv-lock-wrap { position: relative; }
  .cc-adv-lock-wrap.cc-adv-locked,
  .cc-adv-lock-wrap.cc-adv-locked * {
    cursor: default !important;
  }
  .cc-adv-lock-overlay {
    position: absolute;
    inset: 0;
    z-index: 50;
    background: rgba(255, 255, 255, 0.01);
    cursor: default;
    border-radius: 0.5rem;
  }
</style>
{% endblock %}

{% block title %}New Service • {{ org.name }}{% endblock %}

{% block content %}
<div class="cc-page">
  <div class="mb-6 md:mb-10 text-center">
    <h1 class="text-3xl md:text-4xl font-bold mb-2">Add a Service</h1>
    <p class="text-sm md:text-base text-gray-600">Define what clients can book. Clear naming improves conversion.</p>
  </div>

  <div class="grid md:grid-cols-3 gap-8">
    <!-- Form -->
    <div class="md:col-span-2 bg-white border rounded-xl shadow-sm p-8 cc-form">
            <script>
              function slugify(str){
                return str.toString().trim().toLowerCase()
                  .replace(/[^a-z0-9\s-]/g,'')
                  .replace(/\s+/g,'-')
                  .replace(/-+/g,'-');
              }
              const nameInput = document.getElementById('svcName');
              const slugPreview = document.getElementById('slugPreview');
              nameInput && nameInput.addEventListener('input', () => {
                const v = nameInput.value.trim();
                const full = v ? slugify(v) : 'preview';
                // Shorten visually to ~18 chars; underlying generation still full server-side
                slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
                slugPreview.setAttribute('title', full); // hover shows full slug
              });
            </script>
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for message in messages %}
            <div class="px-3 py-2 rounded text-sm {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-50 text-blue-700{% endif %}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" class="space-y-8 cc-form" novalidate>
        {% csrf_token %}

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Service Name</label>
            <input name="name" id="svcName" type="text" required placeholder="e.g. 60-Minute Private Session"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Be specific (length + format). Helps clients pick faster.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Public URL Slug <span class="text-gray-400">(auto)</span></label>
            <div class="mt-1 flex items-center space-x-2 text-sm">
              <span class="text-gray-500 select-none">/service/</span>
              <span id="slugPreview" class="font-mono bg-gray-100 border rounded text-gray-700 cc-field slug-preview" style="border-width:1px">preview</span>
            </div>
            <p class="mt-2 text-xs text-gray-500">We generate this from the name. You can change it later only before the first booking; once bookings exist the URL becomes fixed to avoid breaking booking links.</p>
          </div>
        </div>

              <script>
                // Run wiring after DOM is ready so inputs exist when we attach handlers.
                document.addEventListener('DOMContentLoaded', function(){
                  try {
                    const fixed = document.getElementById('use_fixed_increment');
                    const squish = document.getElementById('allow_squished_bookings');
                    const incInput = document.getElementById('time_increment_minutes');
                    const form = document.querySelector('form.cc-form');
                    if (!incInput) return;

                    // Visual helper class
                    const style = document.createElement('style');
                    style.innerHTML = '.squish-disabled-label { opacity: 0.6; } .inc-disabled { opacity: 0.55; }';
                    document.head.appendChild(style);

                    const parentLabel = squish ? (squish.closest('label') || squish.parentNode) : null;

                    const initialIncVal = Number(incInput.value) || 30;

                    function setClientIncrementFromInput(val) {
                      try {
                        const raw = localStorage.getItem('client_view_settings') || '{}';
                        let parsed = {};
                        try { parsed = JSON.parse(raw); } catch(_) { parsed = {}; }
                        parsed.increment = Number(val) || 30;
                        localStorage.setItem('client_view_settings', JSON.stringify(parsed));
                        try { showToast('success', 'Client increment updated for Day Schedule modal.'); } catch(e){}
                      } catch (e) { console.warn('setClientIncrement failed', e); }
                    }

                    function updateState() {
                      const disabled = fixed && fixed.checked;
                      if (squish) {
                        try { squish.disabled = disabled; } catch(e){}
                        if (parentLabel) parentLabel.classList.toggle('squish-disabled-label', disabled);
                      }
                      if (incInput) {
                        try { incInput.disabled = disabled; } catch(e){}
                        incInput.classList.toggle('inc-disabled', disabled);
                      }
                    }

                    // attach handlers
                    if (incInput) {
                      incInput.addEventListener('change', function(ev){
                        try {
                          if (fixed && fixed.checked) {
                            try { showToast('warning', 'Disable Fixed Increments to change the client increment.'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const newVal = Number(incInput.value);
                          if (isNaN(newVal) || newVal < 5) {
                            try { showToast('warning', 'Enter a valid increment (5+ minutes).'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const confirmMsg = `Change client increment to ${newVal} minutes? This will update the Day Schedule modal's client view settings.`;
                          if (!confirm(confirmMsg)) {
                            incInput.value = initialIncVal;
                            return;
                          }
                          setClientIncrementFromInput(newVal);
                        } catch (e) { console.warn('inc change handler failed', e); }
                      });
                    }

                    if (form && incInput) {
                      form.addEventListener('submit', function(ev){
                        try {
                          const cur = Number(incInput.value);
                          if (!isNaN(initialIncVal) && cur !== Number(initialIncVal)) {
                            const ok = confirm(`You changed the slot increment from ${initialIncVal} to ${cur} minutes. Save this change to the service?`);
                            if (!ok) {
                              ev.preventDefault();
                              return false;
                            }
                            setClientIncrementFromInput(cur);
                          }
                        } catch (e) { /* allow submit on error */ }
                      });
                    }

                    // reflect localStorage changes into input
                    window.addEventListener('storage', function(e){
                      if (e.key === 'client_view_settings') {
                        try {
                          const parsed = JSON.parse(e.newValue || '{}');
                          if (parsed && typeof parsed.increment === 'number' && incInput && !(fixed && fixed.checked)) {
                            incInput.value = String(parsed.increment);
                          }
                        } catch (err) { /* ignore */ }
                      }
                    });

                    updateState();
                    try {
                      const raw = localStorage.getItem('client_view_settings');
                      if (raw && incInput && !(fixed && fixed.checked)) {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed.increment === 'number') {
                          incInput.value = String(parsed.increment);
                        }
                      }
                    } catch (e) { /* ignore parse errors */ }

                    if (fixed) fixed.addEventListener('change', updateState);
                  } catch (e) { console.warn('create_service increment wiring failed', e); }
                });
              </script>
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea name="description" rows="4" placeholder="Outline goals, structure, who it's for." class="cc-field mt-1 w-full"></textarea>
          <p class="mt-2 text-xs text-gray-500">Mention outcomes and any prerequisites.</p>
        </div>

        

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
            <input name="duration" type="number" min="1" value="60"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Total time blocked per booking.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Price (USD)</label>
            <div class="relative mt-1">
              <span class="absolute left-3 top-2.5 text-gray-500 text-sm">$</span>
              <input name="price" type="number" step="0.01" value="0" min="0"
                class="cc-field pl-7 w-full" />
            </div>
            <p class="mt-2 text-xs text-gray-500">Set to 0 for free / included services.</p>
          </div>
        </div>

        <div class="section-card">
          <div class="section-title">Payment Methods</div>
          <div>
            <div class="space-y-3">
              <label class="inline-flex items-start">
                <input type="checkbox" name="allow_stripe_payments" id="allow_stripe_payments" value="1"
                       class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" checked>
                <span class="ml-2 text-sm text-gray-700">Accept card payments (Stripe)</span>
              </label>
              {% if can_use_pro_team %}
                <div class="ml-6 text-xs text-gray-500">Recommended: Stripe enables automatic payment confirmation and refunds.</div>
              {% endif %}

              <div class="ml-6">
                <div class="text-sm font-medium text-gray-700">Different form of payment</div>
                <div class="mt-2 space-y-2">
                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="venmo"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed %}disabled{% endif %}>
                    <span class="ml-2">Venmo</span>
                  </label>
                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="zelle"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed %}disabled{% endif %}>
                    <span class="ml-2">Zelle</span>
                  </label>

        

                  <label class="flex items-center text-sm text-gray-700">
                    <input type="checkbox" name="offline_methods" value="cash"
                           class="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                           {% if not offline_methods_allowed %}disabled{% endif %}>
                    <span class="ml-2">Offline (Cash)</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          <p class="mt-2 text-xs text-gray-500">For paid services, you must enable at least one payment method.</p>
        </div>

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <!-- Prep buffer removed: buffer_before is deprecated and not used by availability/overlap logic -->
            <label class="block text-sm font-medium text-gray-700">Buffer Time Post-Service Appointment (minutes)</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <input name="buffer_after" type="number" value="0" min="0" {% if not can_use_pro_team %}disabled{% endif %}
                class="cc-field mt-1 w-full" />
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">Blocks time after each booking.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Allow appointment to end after availability?</label>
            <div class="mt-2">
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="allow_ends_after_availability" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                  <span class="ml-2 text-sm text-gray-700">Allow clients to book a slot that starts inside availability even if the appointment ends after the availability window.</span>
                </label>
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
            </div>
            <p class="mt-2 text-xs text-gray-500">If enabled, the last available time slot may finish after your configured daily availability end.</p>
          </div>
        </div>

        <div class="mt-4 p-3 rounded bg-blue-50 border border-blue-100 text-blue-800">
          <strong class="block">Configure slot increments</strong>
          <p class="text-sm">Slot increment stepping (how fine-grained client slots appear) is configured in the Day Schedule on the calendar. To preview how increments will appear to clients, open the Day Schedule and select a day on the calendar to inspect the time increments and hour blocks.</p>
          <p class="mt-2 text-sm text-gray-600">(After creating the service you can open the Calendar to inspect how increments and hour blocks appear for clients.)</p>
        </div>

        <!-- Per-service slot settings: allow choosing fixed increments or allowing squished bookings -->

        <div class="border rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Client slot increment (minutes)</label>
              <input id="time_increment_minutes" name="time_increment_minutes" type="number" value="30" min="5" class="cc-field mt-1 w-40">
              <p class="mt-1 text-xs text-gray-500">This controls the visible client slot increment. When <em>Use fixed increments</em> is enabled, this value is ignored.</p>
            </div>
            <div>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="use_fixed_increment" id="use_fixed_increment" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                  <span class="ml-2 text-sm text-gray-700">Use fixed increments (service duration + buffer)</span>
                </label>
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-1 text-xs text-gray-500">When enabled, clients will only see anchors spaced by the service duration plus cleanup buffer.</p>
            </div>
            <div>
              <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
                <label class="inline-flex items-center">
                  <input type="checkbox" name="allow_squished_bookings" id="allow_squished_bookings" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
                  <span class="ml-2 text-sm text-gray-700">Allow squished bookings (permit slots that violate buffers)</span>
                </label>
                {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
              </div>
              <p class="mt-1 text-xs text-gray-500">When enabled, the system will allow bookings that fit the service duration even if they don't satisfy the configured buffers. Owners will receive a notification when such bookings occur.</p>
            </div>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Min Notice (hours)</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <input name="min_notice_hours" type="number" value="24" min="0"
                class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">Prevent last‑minute bookings (e.g. 24 = one day).</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Max Advance (days)</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <input name="max_booking_days" type="number" value="{% if can_use_pro_team %}30{% elif is_trialing %}31{% else %}30{% endif %}" min="1"
                class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">Limit how far out clients can book.</p>
            {% if is_trialing %}
              <p class="mt-2 text-xs text-gray-500">
                During your trial, clients can book through the end of your trial{% if trial_end %} ({{ trial_end|date:"M j, Y" }}){% endif %}.
                This setting takes effect after you purchase a subscription.
              </p>
            {% endif %}
          </div>
        </div>

        {% if is_team_plan %}
        <!-- Assign service to one or more team members (Team plan users) -->
        <div class="section-card">
          <div class="section-title">Assign to team members</div>
          <p class="text-sm text-gray-600 mb-3">Select which team member(s) can deliver this service. Leave empty to make the service unassigned.</p>

          <div class="mb-3">
            <div id="member-dropdown" class="relative">
              <button type="button" id="member-dropdown-toggle" class="cc-field text-left w-full flex items-center justify-between" aria-haspopup="listbox" aria-expanded="false">
                <span id="member-dropdown-label">Select team members...</span>
                <span style="font-size:0.9rem;color:#6b7280">▾</span>
              </button>

              <div id="member-dropdown-panel" role="listbox" aria-multiselectable="true" style="display:none;position:absolute;z-index:60;left:0;right:0;margin-top:6px;background:#fff;border:1px solid #e6eef6;border-radius:6px;max-height:320px;overflow:auto;box-shadow:0 6px 18px rgba(16,24,40,0.06);">
                <div style="padding:8px;border-bottom:1px solid #eef3f8">
                  <input id="member-search" type="search" placeholder="Search team members..." class="cc-field" style="margin:0;" />
                </div>
                <div id="member-list" style="padding:8px;">
                  {% if org.members.all %}
                    {% for m in org.members.all %}
                      {% if m.is_active %}
                        {% with user=m.user %}
                          <div class="member-item flex items-center justify-between py-2 px-2 rounded hover:bg-gray-50" data-name="{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.email }}{% endif %}" data-id="{{ m.id }}">
                            <div>
                              <div class="text-sm text-gray-800">{% if user.first_name or user.last_name %}{{ user.first_name }} {{ user.last_name }}{% else %}{{ user.email }}{% endif %}</div>
                              <div class="text-xs text-gray-500">{{ m.role|title }}</div>
                            </div>
                            <div class="select-indicator text-sm text-blue-600" aria-hidden="true">&nbsp;</div>
                          </div>
                        {% endwith %}
                      {% endif %}
                    {% endfor %}
                  {% else %}
                    <div class="text-sm text-gray-500">No team members found for this business.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>

          <script>
            (function(){
              try{
                const toggle = document.getElementById('member-dropdown-toggle');
                const panel = document.getElementById('member-dropdown-panel');
                const input = document.getElementById('member-search');
                const list = document.getElementById('member-list');
                const label = document.getElementById('member-dropdown-label');

                if (!toggle || !panel || !input || !list) return;

                const selected = new Set();
                try{
                  const initial = {{ assigned_member_ids|default:'[]'|safe }};
                  for (const v of initial){ selected.add(String(v)); }
                }catch(e){ }

                function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
                function updateLabel(){
                  if (!selected.size){ label.textContent = 'Select team members...'; return; }
                  const items = [];
                  for (const it of list.querySelectorAll('.member-item')){
                    const id = it.getAttribute('data-id');
                    if (selected.has(id)) {
                      const nameEl = it.querySelector('.text-sm');
                      const name = nameEl ? nameEl.textContent.trim() : (it.getAttribute('data-name')||'');
                      items.push({id: String(id), name: name});
                    }
                  }
                  if (!items.length){ label.textContent = 'Select team members...'; return; }
                  label.innerHTML = items.map(function(itm){
                    return '<span class="member-chip" data-id="' + escapeHtml(itm.id) + '">' + escapeHtml(itm.name) + ' <span class="member-chip-remove" data-id="' + escapeHtml(itm.id) + '" title="Remove" aria-hidden="true">&times;</span></span>';
                  }).join(' ');
                }

                function syncHiddenInputs(){
                  Array.from(document.querySelectorAll('input[name="assigned_members"][data-generated]')).forEach(i => i.remove());
                  const form = toggle.closest('form');
                  if (!form) return;
                  for (const id of selected){
                    const inp = document.createElement('input');
                    inp.type = 'hidden';
                    inp.name = 'assigned_members';
                    inp.value = id;
                    inp.setAttribute('data-generated','1');
                    form.appendChild(inp);
                  }
                }

                for (const it of list.querySelectorAll('.member-item')){
                  const id = it.getAttribute('data-id');
                  const indicator = it.querySelector('.select-indicator');
                  if (selected.has(id)) { indicator.textContent = '✓'; it.classList.add('bg-blue-50'); }
                  it.addEventListener('click', function(){
                        if (selected.has(id)){
                          selected.delete(id); indicator.textContent = '\u00A0'; it.classList.remove('bg-blue-50');
                        }
                        else { selected.add(id); indicator.textContent = '✓'; it.classList.add('bg-blue-50'); }
                      updateLabel();
                      syncHiddenInputs();
                    });
                }

                input.addEventListener('input', function(){
                  const q = (input.value || '').toLowerCase().trim();
                  for (const it of list.querySelectorAll('.member-item')){
                    const name = (it.getAttribute('data-name')||'').toLowerCase();
                    it.style.display = name.indexOf(q) === -1 ? 'none' : '';
                  }
                });

                toggle.addEventListener('click', function(){
                  const open = panel.style.display !== 'none';
                  panel.style.display = open ? 'none' : 'block';
                  toggle.setAttribute('aria-expanded', String(!open));
                  if (!open) input.focus();
                });

                document.addEventListener('click', function(e){
                  if (!toggle.contains(e.target) && !panel.contains(e.target)){
                    panel.style.display = 'none';
                    toggle.setAttribute('aria-expanded','false');
                  }
                });

                label.addEventListener('click', function(e){
                  try{
                    const rem = e.target && (e.target.closest ? e.target.closest('.member-chip-remove') : null);
                    if (!rem) return;
                    const id = rem.getAttribute('data-id');
                    if (!id) return;
                    if (selected.has(id)){
                      selected.delete(id);
                      const it = list.querySelector('.member-item[data-id="' + id + '"]');
                      if (it){
                        const indicator = it.querySelector('.select-indicator');
                        if (indicator) indicator.textContent = '\u00A0';
                        it.classList.remove('bg-blue-50');
                      }
                      updateLabel();
                      syncHiddenInputs();
                      e.stopPropagation();
                      e.preventDefault();
                    }
                  }catch(err){ }
                });

                updateLabel();
                syncHiddenInputs();
              }catch(e){ console.warn('member dropdown failed', e); }
            })();
          </script>
        </div>
        {% endif %}

        <!-- Refund Policy -->
        <div class="border-t pt-6 space-y-4">
          <h2 class="text-base font-semibold">Refund Policy (Service)</h2>
          <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}" style="display:inline-block;">
            <label class="inline-flex items-center">
              <input type="checkbox" name="refunds_allowed" id="refunds_allowed" value="1" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500" {% if not can_use_pro_team %}disabled{% endif %}>
              <span class="ml-2 text-sm text-gray-700">Allow refunds for this service</span>
            </label>
            {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Refund cutoff (hours)</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <input name="refund_cutoff_hours" type="number" value="24" min="1" class="cc-field mt-1 w-full" {% if not can_use_pro_team %}disabled{% endif %} />
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
            <p class="mt-2 text-xs text-gray-500">Inside this window, refunds are not permitted.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Custom refund policy text</label>
            <div class="cc-adv-lock-wrap {% if not can_use_pro_team %}cc-adv-locked{% endif %}">
              <textarea name="refund_policy_text" rows="3" class="cc-field mt-1 w-full" placeholder="Optional. Shown to clients in emails and pages." {% if not can_use_pro_team %}disabled{% endif %}></textarea>
              {% if not can_use_pro_team %}<div class="cc-adv-lock-overlay" data-cc-adv-lock role="button" tabindex="0" aria-label="Upgrade required"></div>{% endif %}
            </div>
          </div>
        </div>

        <script>
          // Refund policy fields: only editable on Pro/Team, and only when refunds are enabled.
          (function(){
            try{
              const CAN_USE_PRO_TEAM = {{ can_use_pro_team|yesno:'true,false' }};
              const chk = document.getElementById('refunds_allowed');
              const cutoff = document.querySelector('input[name="refund_cutoff_hours"]');
              const text = document.querySelector('textarea[name="refund_policy_text"]');
              if (!chk || !cutoff || !text) return;
              function update(){
                const enabled = CAN_USE_PRO_TEAM && !!chk.checked;
                try{ cutoff.disabled = !enabled; }catch(e){}
                try{ text.disabled = !enabled; }catch(e){}
              }
              chk.addEventListener('change', update);
              update();
            }catch(e){ /* ignore */ }
          })();
        </script>

        <div class="flex items-center justify-between pt-2">
          <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
          <button type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 shadow-sm">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
            Create Service
          </button>
        </div>
      </form>
    </div>

    <!-- Guidance Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border rounded-xl shadow-sm p-6">
        <h2 class="text-sm font-semibold mb-3">Best Practices</h2>
        <ul class="space-y-3 text-sm text-gray-600">
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Include length in the name.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Keep description outcome‑focused.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Use buffers to avoid burnout.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Limit advance window to manage demand.</li>
        </ul>
      </div>
      {% if not can_use_pro_team %}
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-sm text-blue-700">
        Upgrade to Pro or higher for advanced booking logic.
      </div>
      {% endif %}
    </div>
  </div>

  <div class="mt-8 text-center">
    <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">← Back to Dashboard</a>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}

<div id="ccOfflinePaymentWarningModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10060;">
  <div style="background:#fff; border-radius:12px; width:min(620px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
    <div style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">Offline payment warning</div>
    <div style="color:#374151; font-size:0.95rem; line-height:1.4; margin-bottom:14px;">
      You enabled a payment method that is processed outside CircleCal (Venmo/Zelle/Cash). These methods cannot enforce automatic refunds by cutoff and clients can potentially not pay.
      <div style="margin-top:10px;">
        As the controller of your service, you have the right to refuse or provide service to anyone that fails to follow fair and established rules.
      </div>
      <div style="margin-top:10px;">
        It is much easier with only Stripe implemented, but that reduces flexibility for clients who want to pay another way besides card.
      </div>
      <div style="margin-top:10px; color:#6b7280;">
        You can change the form of payment for this service at any time.
      </div>
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="ccOfflinePaymentWarningCancelBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Cancel</button>
      <button id="ccOfflinePaymentWarningConfirmBtn" type="button" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800;">I understand, create service</button>
    </div>
  </div>
</div>

<div id="ccAdvancedUpgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10050;">
  <div style="background:#fff; border-radius:12px; width:min(520px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
    <div style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">Upgrade required</div>
    <div style="color:#374151; font-size:0.95rem; line-height:1.35; margin-bottom:14px;">
      A Pro subscription or higher is required to have access to the advanced settings features.
    </div>
    <div style="display:flex; justify-content:flex-end; gap:10px;">
      <button id="ccAdvancedUpgradeCancelBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Cancel</button>
      <button id="ccAdvancedUpgradeGoBtn" type="button" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800;">View pricing</button>
    </div>
  </div>
</div>

<script>
  function slugify(str){
    return str.toString().trim().toLowerCase()
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-');
  }
  const nameInput = document.getElementById('svcName');
  const slugPreview = document.getElementById('slugPreview');
  nameInput && nameInput.addEventListener('input', () => {
    const v = nameInput.value.trim();
    const full = v ? slugify(v) : 'preview';
    // Shorten visually to ~18 chars; underlying generation still full server-side
    slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
    slugPreview.setAttribute('title', full); // hover shows full slug
  });
</script>

<script>
  (function(){
    try{
      const CAN_USE_PRO_TEAM = {{ can_use_pro_team|yesno:'true,false' }};
      if (CAN_USE_PRO_TEAM) return;
      const PRICING_URL = "{% url 'calendar_app:pricing_page' org.slug %}";

      function openModal(){
        const modal = document.getElementById('ccAdvancedUpgradeModal');
        const cancelBtn = document.getElementById('ccAdvancedUpgradeCancelBtn');
        const goBtn = document.getElementById('ccAdvancedUpgradeGoBtn');
        if (!modal || !cancelBtn || !goBtn){
          const go = confirm('A Pro subscription or higher is required to have access to the advanced settings features.\n\nPress OK to view pricing, or Cancel to stay here.');
          if (go) { try { window.location.href = PRICING_URL; } catch(e) {} }
          return;
        }
        modal.style.display = 'flex';
        function close(){ try{ modal.style.display = 'none'; }catch(e){} }
        cancelBtn.onclick = function(e){ try{ e.preventDefault(); }catch(err){} close(); };
        goBtn.onclick = function(e){ try{ e.preventDefault(); }catch(err){} try{ window.location.href = PRICING_URL; }catch(err){} };
        modal.onclick = function(e){ try{ if (e && e.target === modal) close(); }catch(err){} };
        try{
          document.addEventListener('keydown', function onKey(e){
            try{ if (e && e.key === 'Escape') close(); }catch(err){}
          }, { once: true });
        }catch(e){}
      }

      document.querySelectorAll('[data-cc-adv-lock]').forEach(function(el){
        el.addEventListener('click', function(e){
          try{ e.preventDefault(); e.stopPropagation(); }catch(err){}
          openModal();
        });
        el.addEventListener('keydown', function(e){
          try{
            if (!e) return;
            if (e.key === 'Enter' || e.key === ' ') {
              e.preventDefault();
              openModal();
            }
          }catch(err){}
        });
      });
    }catch(e){ /* ignore */ }
  })();
</script>

<script>
  (function(){
    try{
      const form = document.querySelector('form.cc-form');
      if (!form) return;

      const ORG_HAS_VENMO = {{ org_has_venmo|yesno:'true,false' }};
      const ORG_HAS_ZELLE = {{ org_has_zelle|yesno:'true,false' }};
      const PROFILE_URL = "{% url 'accounts:profile' %}";

      const modal = document.getElementById('ccOfflinePaymentWarningModal');
      const cancelBtn = document.getElementById('ccOfflinePaymentWarningCancelBtn');
      const confirmBtn = document.getElementById('ccOfflinePaymentWarningConfirmBtn');

      let bypassOnce = false;
      function shouldWarn(){
        try{
          const priceEl = form.querySelector('input[name="price"]');
          const price = priceEl ? Number(priceEl.value || 0) : 0;
          const isPaid = (Number.isFinite(price) && price > 0);
          if (!isPaid) return false;
          const offlineChecked = Array.from(form.querySelectorAll('input[name="offline_methods"]:checked')).length > 0;
          return !!offlineChecked;
        }catch(e){ return false; }
      }

      function missingRequiredOfflineInfo(){
        try{
          const priceEl = form.querySelector('input[name="price"]');
          const price = priceEl ? Number(priceEl.value || 0) : 0;
          const isPaid = (Number.isFinite(price) && price > 0);
          if (!isPaid) return null;

          const selected = Array.from(form.querySelectorAll('input[name="offline_methods"]:checked'))
            .map(el => String(el.value || ''));

          if (selected.includes('venmo') && !ORG_HAS_VENMO) return 'venmo';
          if (selected.includes('zelle') && !ORG_HAS_ZELLE) return 'zelle';
          return null;
        }catch(e){ return null; }
      }

      function openModal(){
        if (!modal || !cancelBtn || !confirmBtn){
          const ok = confirm('You enabled a payment method processed outside CircleCal (Venmo/Zelle/Cash). These methods cannot enforce automatic refunds by cutoff and clients can potentially not pay.\n\nIt is easier with only Stripe, but less flexible.\n\nYou can change the form of payment for this service at any time.\n\nPress OK to continue, or Cancel to go back.');
          if (ok){ bypassOnce = true; try{ form.submit(); }catch(e){} }
          return;
        }
        modal.style.display = 'flex';
      }
      function closeModal(){ try{ if (modal) modal.style.display = 'none'; }catch(e){} }

      if (cancelBtn) cancelBtn.addEventListener('click', function(ev){ try{ ev.preventDefault(); }catch(e){} closeModal(); });
      if (confirmBtn) confirmBtn.addEventListener('click', function(ev){
        try{ ev.preventDefault(); }catch(e){}
        bypassOnce = true;
        closeModal();
        try{ form.submit(); }catch(e){}
      });
      if (modal){
        modal.addEventListener('click', function(e){ try{ if (e && e.target === modal) closeModal(); }catch(err){} });
      }

      form.addEventListener('submit', function(e){
        try{
          if (bypassOnce){ bypassOnce = false; return; }

          const missing = missingRequiredOfflineInfo();
          if (missing){
            e.preventDefault();
            const label = (missing === 'venmo') ? 'Venmo' : 'Zelle';
            alert(`To enable ${label} for a paid service, add your ${label} info on your Profile page first.\n\nGo to: ${PROFILE_URL}`);
            return;
          }

          if (!shouldWarn()) return;
          e.preventDefault();
          openModal();
        }catch(err){ /* fall through */ }
      });
    }catch(e){ /* ignore */ }
  })();
</script>
{% endblock %}
