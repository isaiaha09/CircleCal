{% extends "calendar_app/base.html" %}

{% block extra_head %}
<style>
  /* Page-specific enhanced field styling (aligned with edit page) */
  .cc-field {
    border: 1px solid #d1d5db; /* gray-300 */
    background: #ffffff;
    padding: 0.7rem 0.9rem;
    border-radius: 0.5rem;
    box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    font-size: 0.97rem;
    width: 100%;
  }
  .cc-field[disabled] { background:#f8fafc; opacity:.9; }
  .cc-field:focus { outline:none; border-color:#2563eb; box-shadow:0 0 0 4px rgba(37,99,235,0.08); }
  .cc-page { max-width:78rem; margin:0 auto; padding:2.5rem 1.5rem; }
  @media (min-width:768px){ .cc-page { padding:3rem 2rem; } }
  .section-card { background:#fff; border:1px solid #e6edf3; border-radius:0.75rem; padding:1rem 1.25rem; margin-bottom:1rem; }
  .section-title { font-size:1rem; font-weight:600; margin-bottom:0.5rem; }
</style>
{% endblock %}

{% block title %}New Service • {{ org.name }}{% endblock %}

{% block content %}
<div class="cc-page">
  <div class="mb-6 md:mb-10 text-center">
    <h1 class="text-3xl md:text-4xl font-bold mb-2">Add a Service</h1>
    <p class="text-sm md:text-base text-gray-600">Define what clients can book. Clear naming improves conversion.</p>
  </div>

  <div class="grid md:grid-cols-3 gap-8">
    <!-- Form -->
    <div class="md:col-span-2 bg-white border rounded-xl shadow-sm p-8 cc-form">
            <script>
              function slugify(str){
                return str.toString().trim().toLowerCase()
                  .replace(/[^a-z0-9\s-]/g,'')
                  .replace(/\s+/g,'-')
                  .replace(/-+/g,'-');
              }
              const nameInput = document.getElementById('svcName');
              const slugPreview = document.getElementById('slugPreview');
              nameInput && nameInput.addEventListener('input', () => {
                const v = nameInput.value.trim();
                const full = v ? slugify(v) : 'preview';
                // Shorten visually to ~18 chars; underlying generation still full server-side
                slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
                slugPreview.setAttribute('title', full); // hover shows full slug
              });
            </script>
      {% if messages %}
        <div class="mb-6 space-y-2">
          {% for message in messages %}
            <div class="px-3 py-2 rounded text-sm {% if message.tags == 'error' %}bg-red-100 text-red-700{% elif message.tags == 'success' %}bg-green-100 text-green-700{% else %}bg-blue-50 text-blue-700{% endif %}">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <form method="post" class="space-y-8 cc-form" novalidate>
        {% csrf_token %}

        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Service Name</label>
            <input name="name" id="svcName" type="text" required placeholder="e.g. 60-Minute Private Session"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Be specific (length + format). Helps clients pick faster.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Public URL Slug <span class="text-gray-400">(auto)</span></label>
            <div class="mt-1 flex items-center space-x-2 text-sm">
              <span class="text-gray-500 select-none">/service/</span>
              <span id="slugPreview" class="font-mono bg-gray-100 border rounded text-gray-700 cc-field slug-preview" style="border-width:1px">preview</span>
            </div>
            <p class="mt-2 text-xs text-gray-500">We generate this from the name. You can change it later only before the first booking; once bookings exist the URL becomes fixed to avoid breaking booking links.</p>
          </div>
        </div>

              <script>
                // Run wiring after DOM is ready so inputs exist when we attach handlers.
                document.addEventListener('DOMContentLoaded', function(){
                  try {
                    const fixed = document.getElementById('use_fixed_increment');
                    const squish = document.getElementById('allow_squished_bookings');
                    const incInput = document.getElementById('time_increment_minutes');
                    const form = document.querySelector('form.cc-form');
                    if (!incInput) return;

                    // Visual helper class
                    const style = document.createElement('style');
                    style.innerHTML = '.squish-disabled-label { opacity: 0.6; } .inc-disabled { opacity: 0.55; }';
                    document.head.appendChild(style);

                    const parentLabel = squish ? (squish.closest('label') || squish.parentNode) : null;

                    const initialIncVal = Number(incInput.value) || 30;

                    function setClientIncrementFromInput(val) {
                      try {
                        const raw = localStorage.getItem('client_view_settings') || '{}';
                        let parsed = {};
                        try { parsed = JSON.parse(raw); } catch(_) { parsed = {}; }
                        parsed.increment = Number(val) || 30;
                        localStorage.setItem('client_view_settings', JSON.stringify(parsed));
                        try { showToast('success', 'Client increment updated for Day Schedule modal.'); } catch(e){}
                      } catch (e) { console.warn('setClientIncrement failed', e); }
                    }

                    function updateState() {
                      const disabled = fixed && fixed.checked;
                      if (squish) {
                        try { squish.disabled = disabled; } catch(e){}
                        if (parentLabel) parentLabel.classList.toggle('squish-disabled-label', disabled);
                      }
                      if (incInput) {
                        try { incInput.disabled = disabled; } catch(e){}
                        incInput.classList.toggle('inc-disabled', disabled);
                      }
                    }

                    // attach handlers
                    if (incInput) {
                      incInput.addEventListener('change', function(ev){
                        try {
                          if (fixed && fixed.checked) {
                            try { showToast('warning', 'Disable Fixed Increments to change the client increment.'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const newVal = Number(incInput.value);
                          if (isNaN(newVal) || newVal < 5) {
                            try { showToast('warning', 'Enter a valid increment (5+ minutes).'); } catch(e){}
                            incInput.value = initialIncVal;
                            return;
                          }
                          const confirmMsg = `Change client increment to ${newVal} minutes? This will update the Day Schedule modal's client view settings.`;
                          if (!confirm(confirmMsg)) {
                            incInput.value = initialIncVal;
                            return;
                          }
                          setClientIncrementFromInput(newVal);
                        } catch (e) { console.warn('inc change handler failed', e); }
                      });
                    }

                    if (form && incInput) {
                      form.addEventListener('submit', function(ev){
                        try {
                          const cur = Number(incInput.value);
                          if (!isNaN(initialIncVal) && cur !== Number(initialIncVal)) {
                            const ok = confirm(`You changed the slot increment from ${initialIncVal} to ${cur} minutes. Save this change to the service?`);
                            if (!ok) {
                              ev.preventDefault();
                              return false;
                            }
                            setClientIncrementFromInput(cur);
                          }
                        } catch (e) { /* allow submit on error */ }
                      });
                    }

                    // reflect localStorage changes into input
                    window.addEventListener('storage', function(e){
                      if (e.key === 'client_view_settings') {
                        try {
                          const parsed = JSON.parse(e.newValue || '{}');
                          if (parsed && typeof parsed.increment === 'number' && incInput && !(fixed && fixed.checked)) {
                            incInput.value = String(parsed.increment);
                          }
                        } catch (err) { /* ignore */ }
                      }
                    });

                    updateState();
                    try {
                      const raw = localStorage.getItem('client_view_settings');
                      if (raw && incInput && !(fixed && fixed.checked)) {
                        const parsed = JSON.parse(raw);
                        if (parsed && typeof parsed.increment === 'number') {
                          incInput.value = String(parsed.increment);
                        }
                      }
                    } catch (e) { /* ignore parse errors */ }

                    if (fixed) fixed.addEventListener('change', updateState);
                  } catch (e) { console.warn('create_service increment wiring failed', e); }
                });
              </script>
        <div>
          <label class="block text-sm font-medium text-gray-700">Description</label>
          <textarea name="description" rows="4" placeholder="Outline goals, structure, who it's for." class="cc-field mt-1 w-full"></textarea>
          <p class="mt-2 text-xs text-gray-500">Mention outcomes and any prerequisites.</p>
        </div>

        

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
            <input name="duration" type="number" min="1" value="60"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Total time blocked per booking.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Price (USD)</label>
            <div class="relative mt-1">
              <span class="absolute left-3 top-2.5 text-gray-500 text-sm">$</span>
              <input name="price" type="number" step="0.01" value="0" min="0"
                class="cc-field pl-7 w-full" />
            </div>
            <p class="mt-2 text-xs text-gray-500">Set to 0 for free / included services.</p>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <!-- Prep buffer removed: buffer_before is deprecated and not used by availability/overlap logic -->
            <label class="block text-sm font-medium text-gray-700">Cleanup Buffer (minutes)</label>
            <input name="buffer_after" type="number" value="0" min="0"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Blocks time after each booking.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Allow appointment to end after availability?</label>
            <div class="mt-2">
              <label class="inline-flex items-center">
                <input type="checkbox" name="allow_ends_after_availability" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Allow clients to book a slot that starts inside availability even if the appointment ends after the availability window.</span>
              </label>
            </div>
            <p class="mt-2 text-xs text-gray-500">If enabled, the last available time slot may finish after your configured daily availability end.</p>
          </div>
        </div>

        <div class="mt-4 p-3 rounded bg-blue-50 border border-blue-100 text-blue-800">
          <strong class="block">Configure slot increments</strong>
          <p class="text-sm">Slot increment stepping (how fine-grained client slots appear) is configured in the Day Schedule on the calendar. To preview how increments will appear to clients, open the Day Schedule and select a day on the calendar to inspect the time increments and hour blocks.</p>
          <p class="mt-2 text-sm text-gray-600">(After creating the service you can open the Calendar to inspect how increments and hour blocks appear for clients.)</p>
        </div>

        <!-- Per-service slot settings: allow choosing fixed increments or allowing squished bookings -->

        <div class="border rounded-lg p-4 mb-4">
          <div class="grid grid-cols-1 gap-3">
            <div>
              <label class="block text-sm font-medium text-gray-700">Client slot increment (minutes)</label>
              <input id="time_increment_minutes" name="time_increment_minutes" type="number" value="30" min="5" class="cc-field mt-1 w-40">
              <p class="mt-1 text-xs text-gray-500">This controls the visible client slot increment. When <em>Use fixed increments</em> is enabled, this value is ignored.</p>
            </div>
            <div>
              <label class="inline-flex items-center">
                <input type="checkbox" name="use_fixed_increment" id="use_fixed_increment" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Use fixed increments (service duration + buffer)</span>
              </label>
              <p class="mt-1 text-xs text-gray-500">When enabled, clients will only see anchors spaced by the service duration plus cleanup buffer.</p>
            </div>
            <div>
              <label class="inline-flex items-center">
                <input type="checkbox" name="allow_squished_bookings" id="allow_squished_bookings" value="1" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span class="ml-2 text-sm text-gray-700">Allow squished bookings (permit slots that violate buffers)</span>
              </label>
              <p class="mt-1 text-xs text-gray-500">When enabled, the system will allow bookings that fit the service duration even if they don't satisfy the configured buffers. Owners will receive a notification when such bookings occur.</p>
            </div>
          </div>
        </div>

        <div class="grid sm:grid-cols-2 gap-6">
          <div>
            <label class="block text-sm font-medium text-gray-700">Min Notice (hours)</label>
            <input name="min_notice_hours" type="number" value="1" min="0"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Prevent last‑minute bookings (e.g. 24 = one day).</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Max Advance (days)</label>
            <input name="max_booking_days" type="number" value="30" min="1"
              class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Limit how far out clients can book.</p>
          </div>
        </div>

        <!-- Refund Policy -->
        <div class="border-t pt-6 space-y-4">
          <h2 class="text-base font-semibold">Refund Policy (Service)</h2>
          <div class="flex items-center">
            <input type="checkbox" name="refunds_allowed" id="refunds_allowed" checked class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <label for="refunds_allowed" class="ml-2 text-sm text-gray-700">Allow refunds for this service</label>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Refund cutoff (hours)</label>
            <input name="refund_cutoff_hours" type="number" value="24" min="0" class="cc-field mt-1 w-full" />
            <p class="mt-2 text-xs text-gray-500">Inside this window, refunds are not permitted.</p>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700">Custom refund policy text</label>
            <textarea name="refund_policy_text" rows="3" class="cc-field mt-1 w-full" placeholder="Optional. Shown to clients in emails and pages."></textarea>
          </div>
        </div>

        <div class="flex items-center justify-between pt-2">
          <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">Cancel</a>
          <button type="submit" class="inline-flex items-center gap-2 px-5 py-2.5 rounded-lg bg-blue-600 text-white text-sm font-semibold hover:bg-blue-700 shadow-sm">
            <svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14m7-7H5"/></svg>
            Create Service
          </button>
        </div>
      </form>
    </div>

    <!-- Guidance Sidebar -->
    <div class="space-y-6">
      <div class="bg-white border rounded-xl shadow-sm p-6">
        <h2 class="text-sm font-semibold mb-3">Best Practices</h2>
        <ul class="space-y-3 text-sm text-gray-600">
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Include length in the name.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Keep description outcome‑focused.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Use buffers to avoid burnout.</li>
          <li class="flex items-start"><span class="text-green-500 mr-2">✓</span> Limit advance window to manage demand.</li>
        </ul>
      </div>
      <div class="bg-blue-50 border border-blue-200 rounded-xl p-6 text-sm text-blue-700">
        Need recurring packages or group sessions? Upgrade to Pro for advanced booking logic.
      </div>
    </div>
  </div>

  <div class="mt-8 text-center">
    <a href="{% url 'calendar_app:dashboard' org.slug %}" class="text-sm text-gray-500 hover:text-gray-700">← Back to Dashboard</a>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
  function slugify(str){
    return str.toString().trim().toLowerCase()
      .replace(/[^a-z0-9\s-]/g,'')
      .replace(/\s+/g,'-')
      .replace(/-+/g,'-');
  }
  const nameInput = document.getElementById('svcName');
  const slugPreview = document.getElementById('slugPreview');
  nameInput && nameInput.addEventListener('input', () => {
    const v = nameInput.value.trim();
    const full = v ? slugify(v) : 'preview';
    // Shorten visually to ~18 chars; underlying generation still full server-side
    slugPreview.textContent = full.length > 18 ? full.slice(0,18) + '…' : full;
    slugPreview.setAttribute('title', full); // hover shows full slug
  });
</script>
  </script>
{% endblock %}
