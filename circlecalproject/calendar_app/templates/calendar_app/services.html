{% extends "calendar_app/base.html" %}
{% block title %}Services – {{ org.name }}{% endblock %}

{# Mobile-only: break out of base <main> constraints; keep normal base layout on sm+ #}
{% block main_class %}w-full max-w-none px-0 py-0 sm:max-w-6xl sm:mx-auto sm:px-4 sm:py-6 md:px-6 md:py-8{% endblock %}

{% block content %}
<div class="w-[95vw] mx-auto max-w-5xl px-0 py-8 box-border overflow-x-hidden sm:w-full sm:px-4">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <div>
            <h1 class="text-2xl font-bold text-blue-700 text-center sm:text-left">Services</h1>
            <p class="text-sm text-gray-600">Create and manage your bookable services.</p>
        </div>
        <a href="{% url 'calendar_app:create_service' org.slug %}"
           {% if not can_add_more_services %}data-cc-service-limit="1"{% endif %}
           class="btn-primary inline-flex items-center justify-center px-4 py-2 text-sm w-full sm:w-auto">
            + Create Service
        </a>
    </div>

    {% if embed_widget_available and embed_services_embed_src %}
        <div class="bg-white border border-blue-100 rounded-xl p-6 shadow-lg mb-6">
            <div class="flex items-start justify-between gap-3">
                <div>
                    <h2 class="text-lg font-bold text-blue-700">Embed widget</h2>
                    <p class="text-sm text-gray-600 mt-1">Copy and paste this into your website to show your services and availability.</p>

                    <div class="mt-4 bg-blue-50 border border-blue-100 rounded-xl p-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="bg-white border border-blue-100 rounded-xl p-4">
                                <div class="text-sm font-bold text-blue-800">Embed</div>
                                <div class="text-sm text-gray-700 mt-1">Paste the iframe code into your website.</div>
                            </div>
                            <div class="bg-white border border-blue-100 rounded-xl p-4">
                                <div class="text-sm font-bold text-blue-800">Custom domain (recommended)</div>
                                <div class="text-sm text-gray-700 mt-1">Use a booking subdomain like <span class="font-mono">booking.yoursite.com</span> so the booking flow can reliably stay inside the iframe.</div>
                            </div>
                        </div>

                        <div class="mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3">
                            <div class="text-sm text-gray-700">
                                Set up your booking subdomain in Custom Domain settings.
                            </div>
                            <a href="{% url 'calendar_app:org_custom_domain_settings' org.slug %}" class="btn-ghost inline-flex items-center justify-center px-4 py-2 text-sm">Custom domain settings →</a>
                        </div>

                        {% if org.custom_domain and org.custom_domain_verified %}
                            <div class="mt-3 pt-3 border-t border-blue-100 text-sm text-gray-700">
                                <span class="font-semibold text-blue-800">Tip:</span>
                                Once verified, use this as your iframe <span class="font-mono">src</span> (so the booking flow stays reliably embedded):
                                <div class="mt-2">
                                    {% if has_active_services %}
                                        <span class="font-mono">https://{{ org.custom_domain }}{% url 'bookings:public_org_page' org.slug %}?embed=1&key={{ embed_key|default:'' }}</span>
                                    {% else %}
                                        <span class="font-mono text-gray-500">Activate a service to view this URL</span>
                                    {% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-blue-100">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                    <div class="text-sm font-semibold text-blue-800">Embed code</div>
                    <button
                        type="button"
                        class="btn-primary py-2 px-3 text-sm w-full sm:w-auto"
                        onclick="window.ccCopyText('cc-embed-services-iframe', 'Embed code copied to clipboard.')"
                        {% if not has_active_services %}data-cc-requires-active-service="1"{% endif %}
                    >Copy code</button>
                </div>
                <textarea
                    id="cc-embed-services-iframe"
                    readonly
                    rows="3"
                    class="w-full mt-3 text-xs bg-gray-50 text-gray-800 border border-blue-100 rounded-xl p-3 font-mono"
                    {% if not has_active_services %}disabled aria-disabled="true"{% endif %}
                >{% if has_active_services %}&lt;iframe src=&quot;{{ embed_services_embed_src }}&quot; style=&quot;width:100%;height:900px;border:0;&quot; loading=&quot;lazy&quot;&gt;&lt;/iframe&gt;{% else %}Activate at least 1 service to copy embed code.{% endif %}</textarea>
                <p class="text-xs text-gray-500 mt-2">Tip: adjust <span class="font-mono">height</span> as needed for your page layout.</p>
            </div>
        </div>
    {% endif %}

    {% if services %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            {% for service in services %}
                <div class="bg-white border border-blue-100 rounded-xl p-6 shadow-lg">
                    <div class="flex justify-between items-start mb-2">
                        <h2 class="text-xl font-bold text-gray-900">
                            {{ service.name }}
                            {% if service.assigned_names %}
                                <span class="text-sm font-normal text-gray-500">&mdash; with {{ service.assigned_names|join:", " }}</span>
                            {% endif %}
                        </h2>
                        
                    </div>
                    
                    <p class="text-gray-600 text-sm">{{ service.description|default:"No description" }}</p>
                    
                    <div class="mt-4 bg-gray-50 border border-gray-100 rounded-xl p-4">
                        <div class="grid grid-cols-2 gap-3 text-sm text-gray-700">
                            <div>
                                <div class="text-xs text-gray-500">Duration</div>
                                <div class="font-semibold text-gray-900">{{ service.duration }} min</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Price</div>
                                <div class="font-semibold text-gray-900">${{ service.price }}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Min Notice</div>
                                <div class="font-semibold text-gray-900">{{ service.min_notice_hours }}h</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500">Max Days</div>
                                <div class="font-semibold text-gray-900">{{ service.max_booking_days }}</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-blue-100 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                        <a href="{% url 'bookings:services_page' org.slug service.slug %}"
                           target="_blank"
                           class="btn-ghost inline-flex items-center justify-center px-4 py-2 text-sm w-full sm:w-auto">
                            View public page →
                        </a>
                        <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 sm:gap-3 w-full sm:w-auto">
                            <a href="{% url 'calendar_app:edit_service' org.slug service.id %}" 
                               class="btn-primary inline-flex items-center justify-center px-4 py-2 text-sm w-full sm:w-auto">
                                Edit
                            </a>
                            <form method="post" action="{% url 'calendar_app:delete_service' org.slug service.id %}" 
                                  onsubmit="return confirm('Delete {{ service.name }}? This cannot be undone.');"
                                  class="m-0 inline-flex items-center w-full sm:w-auto">
                                {% csrf_token %}
                                <button type="submit" class="btn-danger inline-flex items-center justify-center px-4 py-2 text-sm w-full sm:w-auto">
                                    Delete
                                </button>
                            </form>
                        </div>
                    </div>

                    {% if embed_widget_available and service.embed_src %}
                        <div class="mt-3">
                            <details class="text-sm">
                                <summary class="cursor-pointer text-blue-700 font-semibold underline">Embed this service</summary>
                                <div class="mt-2">
                                    <div class="mt-3 pt-3 border-t border-blue-100">
                                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
                                            <div class="text-xs font-semibold text-blue-800">Embed code</div>
                                            <button
                                                type="button"
                                                class="btn-primary py-2 px-3 text-xs w-full sm:w-auto"
                                                onclick="window.ccCopyText('cc-embed-service-{{ service.id }}', 'Service embed code copied to clipboard.')"
                                                {% if not has_active_services %}data-cc-requires-active-service="1"{% endif %}
                                            >Copy code</button>
                                        </div>
                                        <textarea
                                            id="cc-embed-service-{{ service.id }}"
                                            readonly
                                            rows="3"
                                            class="w-full mt-2 text-xs bg-gray-50 text-gray-800 border border-blue-100 rounded-xl p-3 font-mono"
                                            {% if not has_active_services %}disabled aria-disabled="true"{% endif %}
                                        >{% if has_active_services %}&lt;iframe src=&quot;{{ service.embed_src }}&quot; style=&quot;width:100%;height:900px;border:0;&quot; loading=&quot;lazy&quot;&gt;&lt;/iframe&gt;{% else %}Activate at least 1 service to copy embed code.{% endif %}</textarea>
                                    </div>
                                </div>
                            </details>
                        </div>
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="bg-white border border-blue-100 rounded-xl p-8 text-center shadow-lg">
            <p class="text-gray-600 mb-4">No services created yet.</p>
            <a href="{% url 'calendar_app:create_service' org.slug %}" 
               class="btn-primary inline-flex items-center justify-center px-4 py-2 text-sm w-full sm:w-auto">
                Create Your First Service
            </a>
        </div>
    {% endif %}

    <div class="mt-6">
        <a href="{% url 'calendar_app:dashboard' org.slug %}" 
           class="text-blue-700 hover:underline text-sm font-semibold">
            ← Back to Dashboard
        </a>
    </div>

    <div id="ccCopyToast" class="fixed bottom-6 right-6 z-50 hidden" aria-live="polite" aria-atomic="true">
        <div class="bg-white border border-blue-100 rounded-xl shadow-lg px-4 py-3">
            <div id="ccCopyToastText" class="text-sm font-semibold text-gray-900">Copied to clipboard.</div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<div id="ccNoActiveServicesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10060;">
    <div style="background:#fff; border-radius:12px; width:min(560px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
        <div style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">No active services</div>
        <div style="color:#374151; font-size:0.95rem; line-height:1.35; margin-bottom:14px;">
            You don’t have any <span style="font-weight:800;">active</span> services yet. Activate at least 1 service to copy embeds/iframes or use a custom domain for embedding.
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px; flex-wrap:wrap;">
            <button id="ccNoActiveServicesCloseBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Close</button>
            <a href="{% url 'calendar_app:create_service' org.slug %}" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800; text-decoration:none; display:inline-flex; align-items:center;">Create a service</a>
        </div>
    </div>
</div>

<div id="ccServiceLimitUpgradeModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); backdrop-filter:blur(4px); justify-content:center; align-items:center; z-index:10050;">
    <div style="background:#fff; border-radius:12px; width:min(520px, 92vw); padding:18px 18px 16px 18px; box-shadow:0 18px 50px rgba(0,0,0,0.25);">
        <div style="font-weight:800; font-size:1.05rem; margin-bottom:8px; color:#111827;">Upgrade required</div>
        <div style="color:#374151; font-size:0.95rem; line-height:1.35; margin-bottom:14px;">
            Your current plan only allows 1 service. Upgrade to add more services.
        </div>
        <div style="display:flex; justify-content:flex-end; gap:10px;">
            <button id="ccServiceLimitUpgradeCancelBtn" type="button" style="background:#e5e7eb; color:#111827; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700;">Cancel</button>
            <button id="ccServiceLimitUpgradeGoBtn" type="button" style="background:#2563eb; color:white; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:800;">{% if cc_app_mode %}OK{% else %}View pricing{% endif %}</button>
        </div>
    </div>
</div>

<script>
    window.CC_HAS_ACTIVE_SERVICES = {{ has_active_services|yesno:'true,false' }};

    window.ccPromptNoActiveServices = function(){
        try{
            const modal = document.getElementById('ccNoActiveServicesModal');
            const closeBtn = document.getElementById('ccNoActiveServicesCloseBtn');
            if (!modal || !closeBtn) {
                alert('No active services. Activate at least 1 service to copy embeds/iframes or use custom domains.');
                return false;
            }
            modal.style.display = 'flex';
            function close(){ try{ modal.style.display = 'none'; }catch(e){} }
            closeBtn.onclick = function(e){ try{ e.preventDefault(); }catch(err){} close(); };
            modal.onclick = function(e){ try{ if (e && e.target === modal) close(); }catch(err){} };
            try{
                document.addEventListener('keydown', function onKey(e){
                    try{ if (e && e.key === 'Escape') close(); }catch(err){}
                }, { once: true });
            }catch(e){}
        }catch(e){
            alert('No active services. Activate at least 1 service to copy embeds/iframes or use custom domains.');
        }
        return false;
    };

    window.ccCopyText = function(textareaId, message){
        try{
            // Block embed/iframe/custom-domain copying until at least one service is active.
            if (!window.CC_HAS_ACTIVE_SERVICES) {
                window.ccPromptNoActiveServices && window.ccPromptNoActiveServices();
                return;
            }
        }catch(e){}

        function showToast(msg){
            try{
                const toast = document.getElementById('ccCopyToast');
                const text = document.getElementById('ccCopyToastText');
                if (!toast || !text) return;
                text.textContent = msg || 'Copied to clipboard.';
                toast.classList.remove('hidden');
                window.clearTimeout(window.__ccCopyToastTimer);
                window.__ccCopyToastTimer = window.setTimeout(function(){
                    try{ toast.classList.add('hidden'); }catch(e){}
                }, 2200);
            }catch(e){}
        }

        try{
            const el = document.getElementById(textareaId);
            if (!el) return;
            const value = el.value || el.textContent || '';

            // Prefer Clipboard API when available.
            if (navigator && navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(value).then(function(){
                    showToast(message || 'Copied to clipboard.');
                }).catch(function(){
                    try{
                        el.focus();
                        el.select();
                        try{ document.execCommand('copy'); }catch(e){}
                    }catch(e){}
                    showToast(message || 'Copied to clipboard.');
                });
                return;
            }

            // Fallback for older browsers.
            try{
                el.focus();
                el.select();
                try{ document.execCommand('copy'); }catch(e){}
            }catch(e){}
            showToast(message || 'Copied to clipboard.');
        }catch(e){}
    };

    // Extra safety: prevent “copy” buttons from doing anything when no services are active.
    (function(){
        try{
            if (window.CC_HAS_ACTIVE_SERVICES) return;
            document.querySelectorAll('[data-cc-requires-active-service]')
                .forEach(function(btn){
                    try{
                        btn.addEventListener('click', function(e){
                            try{ e.preventDefault(); e.stopPropagation(); }catch(err){}
                            window.ccPromptNoActiveServices && window.ccPromptNoActiveServices();
                            return false;
                        });
                    }catch(e){}
                });
        }catch(e){}
    })();

    (function(){
        try{
            const CC_APP_MODE = {{ cc_app_mode|yesno:'true,false' }};
            const PRICING_URL = "{% url 'calendar_app:pricing_page' org.slug %}";
            const APP_PLANS_URL = "{% url 'calendar_app:app_plans_page' org.slug %}?cc_app=1";
            const shouldAutoOpen = {{ show_upgrade_modal|yesno:'true,false' }};

            function openModal(){
                const modal = document.getElementById('ccServiceLimitUpgradeModal');
                const cancelBtn = document.getElementById('ccServiceLimitUpgradeCancelBtn');
                const goBtn = document.getElementById('ccServiceLimitUpgradeGoBtn');
                if (!modal || !cancelBtn || !goBtn){
                    if (CC_APP_MODE) {
                        alert('Your current plan only allows 1 service.\n\nThis feature isn’t available in the mobile app. You can view plan details in Plans or contact support.');
                    } else {
                        const go = confirm('Your current plan only allows 1 service.\n\nPress OK to view pricing, or Cancel to stay here.');
                        if (go) { try { window.location.href = PRICING_URL; } catch(e) {} }
                    }
                    return;
                }
                modal.style.display = 'flex';
                function close(){ try{ modal.style.display = 'none'; }catch(e){} }
                cancelBtn.onclick = function(e){ try{ e.preventDefault(); }catch(err){} close(); };
                goBtn.onclick = function(e){
                    try{ e.preventDefault(); }catch(err){}
                    if (CC_APP_MODE) {
                        close();
                        try { window.location.href = APP_PLANS_URL; } catch (err) {}
                    } else {
                        try{ window.location.href = PRICING_URL; }catch(err){}
                    }
                };
                modal.onclick = function(e){ try{ if (e && e.target === modal) close(); }catch(err){} };
                try{
                    document.addEventListener('keydown', function onKey(e){
                        try{ if (e && e.key === 'Escape') close(); }catch(err){}
                    }, { once: true });
                }catch(e){}
            }

            // Intercept attempts to create a second service on Basic/Trial
            document.querySelectorAll('[data-cc-service-limit]').forEach(function(el){
                el.addEventListener('click', function(e){
                    try{ e.preventDefault(); e.stopPropagation(); }catch(err){}
                    openModal();
                });
                el.addEventListener('keydown', function(e){
                    try{
                        if (!e) return;
                        if (e.key === 'Enter' || e.key === ' ') {
                            e.preventDefault();
                            openModal();
                        }
                    }catch(err){}
                });
            });

            if (shouldAutoOpen) {
                openModal();
            }
        }catch(e){ /* ignore */ }
    })();
</script>
{% endblock %}
