{% extends "calendar_app/base.html" %}
{% load circlecal_filters %}

{# Mobile-only: break out of base <main> constraints; keep normal base layout on sm+ #}
{% block main_class %}w-full max-w-none px-0 py-0 sm:max-w-6xl sm:mx-auto sm:px-4 sm:py-10{% endblock %}

{% block content %}

<style>
    .team-container { max-width: 1100px; margin: 40px auto; padding: 0 20px; }
    .team-header { text-align: center; margin-bottom: 50px; }
    .team-header h1 { font-size: 2.5rem; font-weight: bold; color: #1f2937; margin-bottom: 8px; }
    .team-header p { color: #6b7280; font-size: 1.1rem; }
    
    .section-title { font-size: 1.5rem; font-weight: 600; color: #1f2937; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
    .section-title::before { content: ''; width: 4px; height: 24px; background: #3b82f6; border-radius: 2px; }
    
    /* Member Cards */
    .members-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 20px; margin-bottom: 50px; }
    .member-card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; transition: all 0.2s ease; }
    .member-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
    
    .member-header { display: flex; align-items: center; gap: 15px; margin-bottom: 16px; }
    .member-avatar { width: 50px; height: 50px; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem; font-weight: bold; flex-shrink: 0; }
    .member-info h3 { font-size: 1.1rem; font-weight: 600; color: #1f2937; margin: 0 0 4px 0; }
    .member-info p { color: #6b7280; font-size: 0.9rem; margin: 0; }
    
    .member-role { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 500; margin-bottom: 16px; }
    .role-owner { background: #fef3c7; color: #92400e; }
    .role-admin { background: #dbeafe; color: #1e40af; }
    .role-manager { background: #d1fae5; color: #065f46; }
    .role-staff { background: #e5e7eb; color: #374151; }
    
    .member-actions { display: flex; gap: 8px; }
    .action-btn { padding: 8px 16px; border-radius: 8px; font-size: 0.9rem; font-weight: 500; cursor: pointer; border: none; transition: all 0.2s ease; text-decoration: none; display: inline-block; text-align: center; }
    .btn-change-role { background: #f3f4f6; color: #374151; position: relative; }
    .btn-change-role:hover { background: #e5e7eb; }
    .btn-remove { background: #fee2e2; color: #dc2626; }
    .btn-remove:hover { background: #fecaca; }
    
    /* Dropdown */
    .dropdown { position: relative; display: inline-block; }
    .dropdown-content { display: none; position: absolute; background: white; min-width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 8px; z-index: 1; margin-top: 4px; border: 1px solid #e5e7eb; overflow: hidden; }
    .dropdown:hover .dropdown-content { display: block; }
    .dropdown-content::before { content: ''; position: absolute; top: -10px; left: 0; right: 0; height: 10px; }
    .dropdown-content a { color: #374151; padding: 12px 16px; text-decoration: none; display: block; font-size: 0.9rem; transition: background 0.15s ease; }
    .dropdown-content a:hover { background: #f3f4f6; }
    
    /* Invite Form */
    .invite-section { background: white; border-radius: 12px; padding: 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; max-width: 500px; }
    .form-group { margin-bottom: 20px; }
    .form-group label { display: block; font-weight: 500; color: #374151; margin-bottom: 8px; font-size: 0.95rem; }
    .form-control { width: 100%; padding: 10px 14px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; transition: border 0.2s ease; }
    .form-control:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }
    .btn-invite { background: #3b82f6; color: white; padding: 12px 24px; border-radius: 8px; font-weight: 500; border: none; cursor: pointer; font-size: 1rem; width: 100%; transition: background 0.2s ease; }
    .btn-invite:hover { background: #2563eb; }
    
    .empty-state { text-align: center; padding: 60px 20px; color: #9ca3af; }
    .empty-state svg { width: 80px; height: 80px; margin-bottom: 16px; }

    /* Mobile-only: 95% width containers + prevent right overflow */
    @media (max-width: 640px) {
        .team-container {
            width: 95vw;
            max-width: 95vw;
            margin: 24px auto;
            padding: 0;
        }

        .team-header { margin-bottom: 28px; }
        .team-header h1 { font-size: 2rem; }
        .team-header p { font-size: 1rem; }

        .members-grid {
            grid-template-columns: 1fr;
            gap: 16px;
            margin-bottom: 28px;
        }

        .member-card { padding: 18px; }

        .member-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .member-info p,
        .member-info h3 {
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .member-actions {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .action-btn { width: 100%; }

        /* Keep dropdown menu from overflowing card bounds on mobile */
        .dropdown { width: 100%; }
        .dropdown-content {
            left: 0;
            right: 0;
            width: 100%;
            min-width: 0;
        }

        .invite-section {
            width: 100%;
            max-width: 100%;
            padding: 18px;
        }

        /* Toasts should not create horizontal scroll */
        #cc-toast-container {
            right: 12px !important;
            left: 12px !important;
            transform: none !important;
        }
        #cc-toast-container > div { min-width: 0 !important; width: auto !important; }
    }
</style>

<div class="team-container">
    <!-- Toast container for showing messages -->
    <div id="cc-toast-container" aria-live="polite" style="position:fixed;top:20px;left:50%;transform:translateX(-50%);z-index:9999;width:min(520px, calc(100vw - 24px));"></div>

    {% if messages %}
    <script>
        (function(){
            const msgs = [];
            {% for m in messages %}
                msgs.push({level: '{{ m.tags }}', text: '{{ m|escapejs }}'});
            {% endfor %}
            function showToast(msg){
                const c = document.getElementById('cc-toast-container');
                if(!c) return;
                const el = document.createElement('div');
                el.className = 'cc-toast ' + (msg.level || 'info');
                el.textContent = msg.text;
                el.style.marginTop = '8px';
                el.style.padding = '12px 16px';
                el.style.borderRadius = '8px';
                el.style.boxShadow = '0 6px 18px rgba(0,0,0,0.12)';
                el.style.background = (msg.level && msg.level.indexOf('error')!==-1) ? '#fee2e2' : '#1f2937';
                el.style.color = (msg.level && msg.level.indexOf('error')!==-1) ? '#991b1b' : 'white';
                el.style.minWidth = '220px';
                c.appendChild(el);
                setTimeout(()=>{ el.style.opacity = '0'; el.style.transition='opacity 300ms'; setTimeout(()=>c.removeChild(el),350); }, 5000);
            }
            document.addEventListener('DOMContentLoaded', function(){ msgs.forEach(showToast); });
        })();
    </script>
    {% endif %}
    <div class="team-header">
        <h1>{{ org.name }}</h1>
        <p>Manage your staff and their roles</p>
    </div>

    <div class="section-title">Staff</div>
    
    {% if members %}
    <div class="members-grid">
        {% for m in members %}
        <div class="member-card">
            <div class="member-header">
                <div class="member-avatar">{{ m.user.username|slice:":1"|upper }}</div>
                <div class="member-info">
                    <h3>{{ m.user.username }}</h3>
                    <p>{{ m.user.email }}</p>
                </div>
            </div>
            
            <span class="member-role role-{{ m.role }}">{{ m.role|role_label }}</span>
            
            <div class="member-actions">
                {% if m.role == 'owner' or m.user_id == org.owner_id %}
                    <div class="action-btn" style="background:#fef3c7;color:#92400e;cursor:default;">Owner (locked)</div>
                {% else %}
                    <div class="dropdown">
                        <button class="action-btn btn-change-role">Change Role ▾</button>
                        <div class="dropdown-content">
                            <a href="{% url 'calendar_app:update_member_role' org.slug m.id %}?role=admin">GM</a>
                            <a href="{% url 'calendar_app:update_member_role' org.slug m.id %}?role=manager">Manager</a>
                            <a href="{% url 'calendar_app:update_member_role' org.slug m.id %}?role=staff">Staff</a>
                        </div>
                    </div>
                    <a href="{% url 'calendar_app:remove_member' org.slug m.id %}" class="action-btn btn-remove" onclick="return confirm('Remove {{ m.user.username }} from the team?')">Remove</a>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
        <p>No staff yet. Invite someone to get started!</p>
    </div>
    {% endif %}

    <div class="section-title" style="margin-top: 30px;">Invite New Staff Member</div>
    
    <div class="invite-section">
        <form action="{% url 'calendar_app:invite_member' org.slug %}" method="POST">
            {% csrf_token %}
            <div class="form-group">
                <label>Email Address</label>
                <input type="email" class="form-control" name="email" placeholder="colleague@example.com" required>
            </div>

            <div class="form-group">
                <label>Role</label>
                <select name="role" class="form-control">
                    <option value="staff">Staff — Basic access</option>
                    <option value="manager">Manager — Can manage bookings</option>
                    <option value="admin">GM — Full access except billing</option>
                </select>
            </div>

            <button type="submit" class="btn-invite">Send Invitation</button>
        </form>
    </div>
</div>

{% endblock %}
