{% extends "calendar_app/base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<div class="max-w-5xl mx-auto px-4 py-8">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-bold text-blue-700">Your Profile</h1>
    <button type="button" class="save-profile-btn btn-primary py-2 px-3 text-sm">Save Changes</button>
  </div>

  {% if stripe_connect_modal_enabled and stripe_connect_start_url %}
  <div id="stripe-connect-leave-modal" class="hidden fixed inset-0 z-50">
    <div class="absolute inset-0 bg-black/50"></div>
    <div class="relative min-h-full flex items-center justify-center p-4">
      <div class="w-full max-w-lg bg-white rounded-xl shadow-lg border border-blue-100">
        <div class="px-6 py-5 border-b border-blue-50">
          <h2 class="text-lg font-bold text-blue-800">Connect Stripe to accept card payments</h2>
        </div>
        <div class="px-6 py-5 text-sm text-gray-700 space-y-3">
          <p>
            Before you set up the rest of your business in CircleCal, you’ll be directed to Stripe to
            enter your business info so you can accept card payments.
          </p>
          <p class="text-xs text-gray-500">
            You can come back to CircleCal after completing Stripe’s setup.
          </p>
        </div>
        <div class="px-6 py-4 border-t border-blue-50 flex items-center justify-end gap-3">
          <button type="button" id="stripe-connect-stay" class="btn-ghost px-4 py-2">Stay on Profile</button>
          <button type="button" id="stripe-connect-go" class="btn-primary px-4 py-2">Continue to Stripe</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      var modal = document.getElementById('stripe-connect-leave-modal');
      var stayBtn = document.getElementById('stripe-connect-stay');
      var goBtn = document.getElementById('stripe-connect-go');
      if (!modal || !stayBtn || !goBtn) return;

      function openModal() {
        modal.classList.remove('hidden');
      }
      function closeModal() {
        modal.classList.add('hidden');
      }

      // Intercept navigation away from this page (links). Form submissions (Save) are unaffected.
      document.addEventListener('click', function (e) {
        var target = e.target;
        if (!target) return;
        var a = target.closest ? target.closest('a') : null;
        if (!a) return;
        if (a.closest && a.closest('#stripe-connect-leave-modal')) return;
        var href = a.getAttribute('href') || '';
        if (!href) return;
        if (href.charAt(0) === '#') return;
        if (href.toLowerCase().indexOf('javascript:') === 0) return;

        // Allow logout without interception.
        if (href.indexOf('/accounts/logout') === 0 || href.indexOf('{% url "accounts:logout" %}') === 0) return;

        // Block leaving and show modal.
        e.preventDefault();
        openModal();
      }, true);

      stayBtn.addEventListener('click', function (e) {
        e.preventDefault();
        closeModal();
      });

      goBtn.addEventListener('click', function (e) {
        e.preventDefault();
        window.location.href = "{{ stripe_connect_start_url }}";
      });

      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          closeModal();
        }
      });

      {% if stripe_connect_modal_auto_open %}
      // Auto-open after login when user isn't connected yet.
      setTimeout(function () {
        openModal();
      }, 0);
      {% endif %}
    })();
  </script>
  {% endif %}

  {# Remove local messages block to avoid duplicates; base.html already renders messages #}

  <form id="profile-form" method="post" enctype="multipart/form-data" class="bg-white border border-blue-100 rounded-xl p-6 shadow-lg">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="mb-4 text-sm text-red-700 bg-red-100 px-3 py-2 rounded">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    <div class="flex flex-col items-center mb-6">
       <div class="w-32 h-32 rounded-full bg-gray-50 border-4 border-blue-300 mb-2 flex items-center justify-center overflow-hidden" style="box-sizing:border-box;padding:6px;">
        {% if user.profile.avatar %}
          <img id="avatar-preview" src="{{ user.profile.avatar.url }}?v={{ user.profile.avatar.name|urlencode }}" alt="Profile Picture" class="w-full h-full object-cover" />
        {% else %}
           <svg class="w-16 h-16 text-blue-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" preserveAspectRatio="xMidYMid meet" stroke="currentColor" aria-hidden="true" style="display:block;margin:auto;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.4" d="M16 11c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM4 20c0-3.314 2.686-6 6-6h4c3.314 0 6 2.686 6 6" />
          </svg>
        {% endif %}
      </div>
      <span class="text-sm font-medium text-blue-800">Profile Picture</span>
      <span id="avatar-filename" class="text-xs text-gray-400 mt-1" {% if user.profile.avatar %}{% endif %}></span>
    </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {% if user_org_role == 'staff' %}
        <!-- Staff layout: Email full-width, First/Last side-by-side, Display Name full-width -->
        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-blue-800 mb-2">Email</label>
          <input type="email" name="email" value="{{ user.email }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">First Name</label>
          <input type="text" name="first_name" value="{{ user.first_name }}" required class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>
        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">Last Name</label>
          <input type="text" name="last_name" value="{{ user.last_name }}" required class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-blue-800 mb-2">Display Name <span class="text-xs font-medium text-gray-500">(optional)</span></label>
          <input type="text" name="display_name" value="{{ user.profile.display_name|default_if_none:'' }}" placeholder="e.g. Sam Taylor or Sam T." class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
          <p class="text-xs text-gray-500 mt-2">This is the name shown to clients in confirmation emails for appointments with you. If left empty, we will use your First and Last name.</p>
        </div>

      {% else %}
        <!-- Non-staff layout: Username (if shown) and Email side-by-side, then First/Last, then Display Name -->
        {% if user_org_role != 'staff' %}
        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">Username</label>
          <input type="text" name="username" value="{{ user.username }}" required class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>
        {% endif %}

        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">Email</label>
          <input type="email" name="email" value="{{ user.email }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>

        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">First Name</label>
          <input type="text" name="first_name" value="{{ user.first_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>
        <div>
          <label class="block text-sm font-semibold text-blue-800 mb-2">Last Name</label>
          <input type="text" name="last_name" value="{{ user.last_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        </div>

        <div class="md:col-span-2">
          <label class="block text-sm font-semibold text-blue-800 mb-2">Display Name <span class="text-xs font-medium text-gray-500">(optional)</span></label>
          <input type="text" name="display_name" value="{{ user.profile.display_name|default_if_none:'' }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
          <p class="text-xs text-gray-500 mt-2">This is the name shown to clients in confirmation emails for appointments with you. If left empty, we will use your First and Last name.</p>
        </div>

      {% endif %}
    </div>
    <div class="grid grid-cols-1 gap-4 mt-4">
      <div class="bg-gray-50 border border-gray-100 rounded-lg p-4 timezone-panel">
        <div class="flex items-center justify-center gap-8">
          <div class="text-center">
            <label class="block text-sm font-semibold text-blue-800 mb-1">Your Timezone <span class="text-xs font-medium text-gray-500">(for your account)</span></label>
            <p class="text-sm text-gray-700 font-medium"><span class="timezone-select">{{ form.timezone }}</span></p>
          </div>
          <div>
            <div class="timezone-info inline-block bg-white border border-gray-100 rounded-lg p-3 flex flex-col gap-2 items-start">
              <div class="text-sm text-gray-600">Displayed times are adjusted to this timezone. This controls how dates and times are displayed to you in the UI and in notifications.</div>
              <div class="text-sm text-gray-500">Does not affect the business scheduling timezone. Availability and booked times will be based on the timezone you set for your business</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-span-2 mt-4">
      <label class="block text-sm font-semibold text-blue-800 mb-2">Profile Picture</label>
      <div class="flex items-center gap-3">
        <span class="text-sm text-gray-600">Change:</span>
        <label for="id_avatar" class="btn-ghost inline-flex items-center gap-2">Choose File</label>
        <span id="cc-current-filename" data-fullname="{% if user.profile.avatar %}{{ user.profile.avatar.name }}{% endif %}" class="text-sm text-gray-700">{% if user.profile.avatar %}{{ user.profile.avatar.name }}{% else %}No file selected{% endif %}</span>
        <div class="ml-3 clearable-file-inline">{{ form.avatar }}</div>
      </div>
      {% if form.avatar.errors %}
        <div class="text-xs text-red-700 mt-1">{{ form.avatar.errors }}</div>
      {% endif %}
      <p class="text-xs text-gray-500 mt-1">JPG, PNG, or WebP up to 5MB. Images are automatically resized for avatars. Explicit images are not allowed.</p>
    </div>
    <div class="mt-6 flex justify-end">
      <button id="save-btn" type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
    </div>

  <div class="mt-8 bg-white border border-blue-100 rounded-xl p-6 shadow-lg max-w-5xl mx-auto">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Security</h2>
    <p class="text-sm text-gray-600 mb-4">Protect your account — change password, enable two-factor authentication, and manage recovery options.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="md:col-span-2 flex flex-col gap-3">
        <a href="{% url 'accounts:password_change' %}" class="btn-primary inline-flex items-center gap-2 w-60 justify-center py-2">Change Password</a>

        <div>
          {% if request.user.is_verified %}
            <div class="flex items-center gap-3">
              <span class="inline-flex items-center px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 border border-emerald-100">2FA Enabled</span>
              <a href="{% url 'two_factor:backup_tokens' %}" class="btn-ghost">Backup Codes</a>
              <a href="{% url 'two_factor:disable' %}" class="btn-danger">Disable 2FA</a>
            </div>
            <p class="text-xs text-gray-500 mt-2">You have two-factor authentication enabled. Keep your backup codes in a safe place.</p>
          {% else %}
            <a href="{% url 'two_factor:profile' %}" class="btn-primary inline-flex items-center gap-2 w-60 justify-center py-2">Enable Two-factor Authentication</a>
            <p class="text-xs text-gray-500 mt-2">Add an extra layer of security to your account by enabling 2FA (recommended).</p>
          {% endif %}
        </div>
      </div>

      <div class="profile-preferences bg-gray-50 rounded-lg p-4">
        <h3 class="text-sm font-semibold text-blue-800 mb-3">Preferences</h3>
        <div class="flex flex-col gap-3">
          <label class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-gray-800">Email Alerts</div>
              <div class="text-xs text-gray-500">Receive important account emails</div>
            </div>
            <div>
              {{ form.email_alerts }}
            </div>
          </label>

          <label class="flex items-center justify-between">
            <div>
              <div class="text-sm font-medium text-gray-800">Booking Reminders</div>
              <div class="text-xs text-gray-500">Get reminders for upcoming bookings</div>
            </div>
            <div>
              {{ form.booking_reminders }}
            </div>
          </label>
        </div>
      </div>
    </div>

    <div class="mt-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <a href="{% url 'accounts:deactivate_confirm' %}" class="inline-flex w-full items-center justify-center px-4 py-2 border border-yellow-300 text-yellow-700 rounded-lg hover:bg-yellow-50">Deactivate Account</a>
        <a href="{% url 'accounts:delete_confirm' %}" class="inline-flex w-full items-center justify-center px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50">Delete Account</a>
      </div>
    </div>
  </div>

  {% if activities %}
  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-lg max-w-5xl mx-auto">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Recent Logins</h2>
    <div class="py-2 max-h-64 overflow-y-auto pr-2">
      <ul class="space-y-3">
        {% for a in activities %}
          <li class="bg-white/50 border border-slate-100 rounded-lg p-3 flex flex-col space-y-2">
            <div class="text-sm text-gray-700">{{ a.timestamp|date:"l, F jS, Y" }} at {{ a.timestamp|date:"g:iA"|lower }}</div>
            <div class="text-xs text-gray-500" title="{{ a.user_agent }}">{{ a.ip_address|default:"-" }} — {{ a.user_agent|default:"-" }}</div>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-lg max-w-5xl mx-auto">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Billing</h2>
    {% if organization and subscription %}
      <div class="text-base text-gray-800">
        <div><span class="font-semibold">Business:</span> {{ organization.name }}</div>
        <div><span class="font-semibold">Plan:</span> <span class="text-lg font-semibold text-blue-800">{{ subscription.plan.name|default:"—" }}</span></div>
        <div><span class="font-semibold">Status:</span> <span class="font-medium">{{ subscription.status }}</span></div>
        {% if subscription.trial_end %}
          <div><span class="font-semibold">Trial ends:</span> {{ subscription.trial_end|date:"l, F jS, Y" }} at {{ subscription.trial_end|date:"g:iA"|lower }}</div>
        {% endif %}
        {% if subscription.current_period_end %}
          <div><span class="font-semibold">Current period ends:</span> {{ subscription.current_period_end|date:"l, F jS, Y" }} at {{ subscription.current_period_end|date:"g:iA"|lower }}</div>
        {% endif %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No billing data for your current business.</p>
    {% endif %}
  </div>

  {% if organization and user_org_role == 'owner' %}
  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-lg max-w-5xl mx-auto">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Venmo / Zelle (Payment Info)</h2>
    <p class="text-sm text-gray-600 mb-4">
      Optional. If you enable Venmo or Zelle as a payment method on a paid service, you must provide the corresponding info here so CircleCal can display a QR code to clients.
    </p>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Venmo</label>
        <input type="text" name="offline_venmo" value="{{ org_offline_venmo|default:'' }}" placeholder="e.g. @yourhandle or https://venmo.com/u/yourhandle"
               class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        <p class="text-xs text-gray-500 mt-2">Used to generate a client-facing QR code when Venmo is selected.</p>
      </div>

      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Zelle</label>
        <input type="text" name="offline_zelle" value="{{ org_offline_zelle|default:'' }}" placeholder="e.g. your-email@example.com or +1 (555) 555-5555"
               class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
        <p class="text-xs text-gray-500 mt-2">Used to generate a client-facing QR code when Zelle is selected.</p>
      </div>
    </div>
  </div>
  {% endif %}

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-lg">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Team & Businesses</h2>
    {% if memberships %}
      <ul class="text-sm text-gray-700 space-y-2">
        {% for m in memberships %}
          <li>{{ m.organization.name }} — {{ m.role|title }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-gray-600">You are not a member of any business yet.</p>
    {% endif %}
    {% if pending_invites %}
      <div class="mt-3">
        <h3 class="font-semibold text-sm text-blue-800 mb-1">Pending Invites</h3>
        <ul class="text-sm text-gray-700 space-y-1">
          {% for inv in pending_invites %}
            <li>{{ inv.organization.name }} — {{ inv.role|title }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
  </form>
  <div class="max-w-5xl mx-auto px-4 py-4 flex justify-end">
    <button type="button" class="save-profile-btn btn-primary py-2 px-4">Save Changes</button>
  </div>
</div>
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" />
  <style>
    /* Ensure the clear anchor inherits muted color if we don't override via JS */
    .clearable-file-input a { color: inherit; }
    /* Style file input: hide real input and use labeled button */
    input[type=file] { display: none; }
    label[for="id_avatar"] { cursor: pointer; }
    #cc-current-filename { color: #334155; }
    /* Profile page UI polish */
    .btn-primary { background: linear-gradient(90deg,#2563eb,#4f46e5); color: white; padding: .45rem .9rem; border-radius: .5rem; display:inline-block; min-width:10rem; text-align:center; transition: transform 160ms ease, box-shadow 160ms ease, filter 160ms ease; }
    .btn-ghost { background: transparent; border: 1px solid #e5e7eb; padding: .4rem .6rem; border-radius: .5rem; transition: background 120ms ease, border-color 120ms ease; }
    .btn-danger { background: white; border: 1px solid #f87171; color: #b91c1c; padding: .4rem .6rem; border-radius: .5rem; transition: transform 120ms ease, box-shadow 120ms ease; }
    .btn-primary, .btn-ghost, .btn-danger { cursor: pointer; }
    .btn-primary:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(37,99,235,0.12); filter: brightness(1.03); }
    .btn-ghost:hover { background: #f8fafc; border-color: #dbeafe; }
    .btn-danger:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(248,113,113,0.08); }

    /* Toggle-style checkboxes inside profile preferences */
    .profile-preferences input[type=checkbox] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 44px;
      height: 24px;
      background: #e6eefc;
      border-radius: 9999px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: background 150ms ease-in-out;
    }
    .profile-preferences input[type=checkbox]::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 9999px;
      box-shadow: 0 1px 2px rgba(16,24,40,0.06);
      transition: transform 150ms ease-in-out;
    }
    .profile-preferences input[type=checkbox]:checked { background: linear-gradient(90deg,#34d399,#10b981); }
    .profile-preferences input[type=checkbox]:checked::after { transform: translateX(20px); }

    /* Avatar clear toggle to match preference toggles and sit inline */
    .clearable-file-inline .clearable-file-input { display: inline-flex; align-items: center; gap: .5rem; }
    .clearable-file-inline .clearable-file-input input[type=checkbox] {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 44px;
      height: 24px;
      background: #e6eefc;
      border-radius: 9999px;
      position: relative;
      cursor: pointer;
      outline: none;
      transition: background 150ms ease-in-out;
    }
    .clearable-file-inline .clearable-file-input input[type=checkbox]::after {
      content: '';
      position: absolute;
      top: 3px;
      left: 3px;
      width: 18px;
      height: 18px;
      background: white;
      border-radius: 9999px;
      box-shadow: 0 1px 2px rgba(16,24,40,0.06);
      transition: transform 150ms ease-in-out;
    }
    .clearable-file-inline .clearable-file-input input[type=checkbox]:checked { background: linear-gradient(90deg,#34d399,#10b981); }
    .clearable-file-inline .clearable-file-input input[type=checkbox]:checked::after { transform: translateX(20px); }
    .clearable-file-inline .clearable-file-input a { display: none; }

    /* Slightly stronger section shadows for polish */
    .shadow-lg { box-shadow: 0 8px 20px rgba(2,6,23,0.06); }

    /* Timezone panel sizing */
    .timezone-panel { min-height: 10rem; display: flex; align-items: center; }

    /* Make the timezone select visually stand out inside the gray panel */
    .timezone-select select#id_timezone,
    .timezone-select select[name="timezone"] {
      background: #ffffff;
      border: 1px solid #c7d2fe; /* subtle blue */
      padding: .5rem .75rem;
      border-radius: .5rem;
      box-shadow: 0 8px 22px rgba(79,70,229,0.08);
      color: #0f172a;
      font-weight: 600;
      min-width: 18rem;
      outline: none;
    }
    .timezone-select select#id_timezone:focus,
    .timezone-select select[name="timezone"]:focus { box-shadow: 0 10px 30px rgba(79,70,229,0.12); border-color:#6366f1; }

    /* Right-side timezone info box tweaks */
    .timezone-info { max-width: 36ch; }

    /* Ensure the flex row spans full width and push the info box to the right edge */
    .timezone-panel > .flex { width: 100%; }
    .timezone-info { margin-left: auto; display: block; }
  </style>
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
      <script>
    (function() {
      const fileInput = document.getElementById('id_avatar');
      const form = document.getElementById('profile-form');
      const saveBtn = document.getElementById('save-btn');
      const avatarPreview = document.getElementById('avatar-preview');
      // prefer compact filename element; fallback to legacy id
      const avatarFilenameEl = document.getElementById('avatar-filename') || document.getElementById('cc-current-filename');

      // Normalize any server-rendered path to basename by reading the data-fullname attribute
      if (avatarFilenameEl) {
        const dataFull = avatarFilenameEl.dataset && avatarFilenameEl.dataset.fullname;
        let basename = '';
        if (dataFull) {
          const txt = dataFull.trim();
          const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
          basename = lastSlash !== -1 ? txt.slice(lastSlash + 1) : txt;
          avatarFilenameEl.textContent = basename;
        } else if (avatarFilenameEl.textContent) {
          const txt2 = avatarFilenameEl.textContent.trim();
          const lastSlash2 = Math.max(txt2.lastIndexOf('/'), txt2.lastIndexOf('\\'));
          basename = lastSlash2 !== -1 ? txt2.slice(lastSlash2 + 1) : txt2;
          avatarFilenameEl.textContent = basename;
        }
        // Also update the ClearableFileInput "Currently" anchor text if present
        if (basename) {
          try {
            const clearable = fileInput.closest('.clearable-file-input');
            if (clearable) {
              const anchor = clearable.querySelector('a');
              if (anchor) anchor.textContent = basename;
            }
          } catch (e) {}
            // Extra Save buttons (outside the form) should submit the main profile form
            try {
              const extraSaveBtns = document.querySelectorAll('.save-profile-btn');
              if (extraSaveBtns.length) {
                extraSaveBtns.forEach(btn => {
                  btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    if (!form) return;
                    // disable all save buttons to prevent double submits
                    document.querySelectorAll('.save-profile-btn, #save-btn').forEach(b => { try { b.disabled = true; } catch (err) {} });
                    const mainSave = document.getElementById('save-btn');
                    if (mainSave) mainSave.textContent = 'Saving...';
                    form.submit();
                  });
                });
              }
            } catch (e) {}
        }
        // Mirror filename into our compact display
        try {
          const cc = document.getElementById('cc-current-filename');
          if (cc) cc.textContent = basename || (avatarFilenameEl.textContent || 'No file selected');
        } catch (e) {}

          // Force-replace ClearableFileInput anchor with a grey basename span
          (function fixClearableDisplay() {
            try {
              document.querySelectorAll('.clearable-file-input').forEach(span => {
                // If we've already inserted our replacement, skip
                if (span.querySelector('.cc-basename')) return;
                // Determine basename from data attribute if available, else from anchor text
                let basename = '';
                const anchor = span.querySelector('a');
                if (anchor && anchor.textContent) {
                  const txt = anchor.textContent.trim();
                  const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
                  basename = lastSlash !== -1 ? txt.slice(lastSlash + 1) : txt;
                  // remove the anchor so path disappears entirely
                  anchor.remove();
                } else if (avatarFilenameEl && avatarFilenameEl.textContent) {
                  basename = avatarFilenameEl.textContent.trim();
                } else {
                  // fallback to profile_pic.jpg
                  basename = 'profile_pic.jpg';
                }

                // Create replacement span and insert before the clear checkbox if present
                const repl = document.createElement('span');
                repl.className = 'cc-basename text-xs';
                repl.textContent = basename;
                repl.style.color = '#94a3b8';
                repl.style.marginLeft = '4px';
                // Find checkbox or other control to insert before, otherwise append
                const checkbox = span.querySelector('input[type=checkbox], input[type=radio]');
                if (checkbox) {
                  span.insertBefore(repl, checkbox);
                } else {
                  span.appendChild(repl);
                }
              });
            } catch (e) {}
          })();
      }
      // Robustly update ClearableFileInput anchors so they show only the basename and are greyed,
      // while preserving the Clear checkbox functionality. Uses MutationObserver as a fallback.
      (function updateClearableAnchors() {
        function setAnchorText(a) {
          if (!a) return;
          const txt = (a.textContent || '').trim();
          let bn = txt;
          // If anchor contains a path, extract basename
          const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
          if (lastSlash !== -1) bn = txt.slice(lastSlash + 1);
          // If anchor is an href to media, prefer basename from href
          try {
            if (a.href) {
              const hrefParts = a.getAttribute('href').split('/');
              const last = hrefParts[hrefParts.length-1];
              if (last) bn = last;
            }
          } catch (e) {}
          a.textContent = bn;
          a.style.color = '#94a3b8';
        }

        function walkAndUpdate() {
          document.querySelectorAll('.clearable-file-input').forEach(span => {
            const a = span.querySelector('a');
            if (a) setAnchorText(a);
          });
        }

        walkAndUpdate();
        // run again shortly after load in case widget renders later
        setTimeout(walkAndUpdate, 150);

        // Observe DOM changes to update anchors injected later
        try {
          const mo = new MutationObserver(() => {
            walkAndUpdate();
          });
          mo.observe(document.body, { childList: true, subtree: true });
        } catch (e) {}
      })();
        // Attach handlers for extra Save buttons even if avatar input isn't present
        try {
          const extraSaveBtns = document.querySelectorAll('.save-profile-btn');
          if (extraSaveBtns.length) {
            extraSaveBtns.forEach(btn => {
              btn.addEventListener('click', function(e) {
                e.preventDefault();
                const mainForm = document.getElementById('profile-form');
                if (!mainForm) return;
                // disable all save buttons to prevent double submits
                document.querySelectorAll('.save-profile-btn, #save-btn').forEach(b => { try { b.disabled = true; } catch (err) {} });
                const mainSave = document.getElementById('save-btn');
                if (mainSave) mainSave.textContent = 'Saving...';
                mainForm.submit();
              });
            });
          }
        } catch (e) {}

        if (!fileInput) return;

      // Create a lightweight modal for cropping
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl p-4 w-[90vw] max-w-xl">
          <div class="mb-3 text-blue-800 font-semibold">Adjust your avatar</div>
          <div style="max-height:60vh;" class="overflow-hidden">
            <img id="cropper-image" alt="Crop preview" style="max-width:100%; display:block;">
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="crop-cancel" type="button" class="px-4 py-2 rounded border border-gray-300">Cancel</button>
            <button id="crop-apply" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Apply</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const imgEl = modal.querySelector('#cropper-image');
      const btnApply = modal.querySelector('#crop-apply');
      const btnCancel = modal.querySelector('#crop-cancel');
      let cropper = null;

      function openModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
      function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); if (cropper) { cropper.destroy(); cropper = null; } }

      fileInput.addEventListener('change', function(e) {
        const originalFile = e.target.files && e.target.files[0];
        if (!originalFile) return;
        // Rename the selected file immediately to profile_pic.jpg so the input shows the desired name
        try {
          const dtReplace = new DataTransfer();
          const renamed = new File([originalFile], 'profile_pic.jpg', { type: originalFile.type });
          dtReplace.items.add(renamed);
          fileInput.files = dtReplace.files;
        } catch (err) {
          // If DataTransfer isn't available, fall back to the original file
        }
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        // Update visible filename caption (show basename only)
        let newBasename = '';
        if (avatarFilenameEl) {
          const name = file.name || '';
          const lastSlash = Math.max(name.lastIndexOf('/'), name.lastIndexOf('\\'));
          newBasename = lastSlash !== -1 ? name.slice(lastSlash + 1) : name;
          avatarFilenameEl.textContent = newBasename;
        try { const cc2 = document.getElementById('cc-current-filename'); if (cc2) cc2.textContent = newBasename || 'No file selected'; } catch (e) {}
        }
        // Update the widget's "Currently:" anchor text
        try {
          const clearable = fileInput.closest('.clearable-file-input');
          if (clearable) {
            const anchor = clearable.querySelector('a');
            if (anchor && newBasename) anchor.textContent = newBasename;
          }
        } catch (e) {}
        const url = URL.createObjectURL(file);
        imgEl.src = url;
        openModal();
        setTimeout(() => {
          cropper = new Cropper(imgEl, {
            aspectRatio: 1,
            viewMode: 1,
            // Allow resizing the crop box (circle) and moving it
            dragMode: 'crop',
            cropBoxMovable: true,
            cropBoxResizable: true,
            guides: true,
            background: false,
            autoCropArea: 0.8,
            movable: true,
            zoomable: true,
            scalable: false,
            rotatable: false,
            responsive: true,
            ready() {
              // Make crop box look circular via CSS tweak
              const face = modal.querySelector('.cropper-face');
              const viewBox = modal.querySelector('.cropper-view-box');
              if (face) face.style.borderRadius = '9999px';
              if (viewBox) viewBox.style.borderRadius = '9999px';
            }
          });
        }, 50);
      });

      btnCancel.addEventListener('click', () => {
        // Reset file input if user cancels
        fileInput.value = '';
        closeModal();
      });

      btnApply.addEventListener('click', async () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
        if (!canvas) return;
        canvas.toBlob((blob) => {
          if (!blob) return;
          const file = new File([blob], 'profile_pic.jpg', { type: 'image/jpeg' });
          // Assign cropped file back to the file input via DataTransfer
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          // Update visible filename caption after crop (basename) and widget anchor
          if (avatarFilenameEl) {
            const name2 = file.name || '';
            const lastSlash2 = Math.max(name2.lastIndexOf('/'), name2.lastIndexOf('\\'));
            const bn = lastSlash2 !== -1 ? name2.slice(lastSlash2 + 1) : name2;
            avatarFilenameEl.textContent = bn;
            try {
              const clearable2 = fileInput.closest('.clearable-file-input');
              if (clearable2) {
                const anchor2 = clearable2.querySelector('a');
                if (anchor2) anchor2.textContent = bn;
              }
            } catch (e) {}
            try { const cc3 = document.getElementById('cc-current-filename'); if (cc3) cc3.textContent = bn || 'No file selected'; } catch (e) {}
          }
          // Update on-page preview immediately
          try {
            const previewUrl = URL.createObjectURL(file);
            if (avatarPreview) {
              avatarPreview.src = previewUrl;
            }
          } catch (e) {}
          URL.revokeObjectURL(imgEl.src);
          closeModal();
        }, 'image/jpeg', 0.92);
      });

      // Light feedback on submit
      if (form && saveBtn) {
        form.addEventListener('submit', () => {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
        });
      }

      // Require password on delete and show explicit confirmation
      try {
        const deleteForm = document.getElementById('delete-account-form');
        const deleteBtn = document.getElementById('delete-account-button');
        const deletePassword = document.getElementById('delete-password');
        if (deleteForm && deleteBtn && deletePassword) {
          deleteForm.addEventListener('submit', function(e) {
            if (!deletePassword.value || deletePassword.value.trim().length === 0) {
              e.preventDefault();
              alert('Please enter your password to confirm account deletion.');
              deletePassword.focus();
              return false;
            }
            const ok = confirm('This will permanently delete your account and all associated data. This action cannot be undone. Continue?');
            if (!ok) {
              e.preventDefault();
              return false;
            }
            // allow submit
          });
        }
      } catch (e) {}
    })();
  </script>
{% endblock %}
