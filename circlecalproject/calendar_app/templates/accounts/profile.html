{% extends "calendar_app/base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold text-blue-700 mb-4">Your Profile</h1>

  {# Remove local messages block to avoid duplicates; base.html already renders messages #}

  <form id="profile-form" method="post" enctype="multipart/form-data" class="bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="mb-4 text-sm text-red-700 bg-red-100 px-3 py-2 rounded">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    {% if user.profile.avatar %}
      <div class="flex flex-col items-center mb-6">
        <img id="avatar-preview" src="{{ user.profile.avatar.url }}?v={{ user.profile.avatar.name|urlencode }}" alt="Avatar" class="w-32 h-32 rounded-full object-cover border-4 border-blue-300 mb-2" />
        <span class="text-xs text-gray-500">Current Avatar</span>
      </div>
    {% endif %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Username</label>
        <input type="text" name="username" value="{{ user.username }}" required class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Email</label>
        <input type="email" name="email" value="{{ user.email }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">First Name</label>
        <input type="text" name="first_name" value="{{ user.first_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Last Name</label>
        <input type="text" name="last_name" value="{{ user.last_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Timezone</label>
        {{ form.timezone }}
      </div>
      <div class="flex items-center gap-4">
        <label class="inline-flex items-center">
          {{ form.email_alerts }}
          <span class="ml-2 text-sm text-blue-800">Email Alerts</span>
        </label>
        <label class="inline-flex items-center">
          {{ form.booking_reminders }}
          <span class="ml-2 text-sm text-blue-800">Booking Reminders</span>
        </label>
      </div>
    </div>
    <div class="col-span-2 mt-4">
      <label class="block text-sm font-semibold text-blue-800 mb-2">Avatar</label>
      {{ form.avatar }}
      {% if form.avatar.errors %}
        <div class="text-xs text-red-700 mt-1">{{ form.avatar.errors }}</div>
      {% endif %}
      <p class="text-xs text-gray-500 mt-1">Upload a clear photo (any orientation). Explicit images are not allowed.</p>
    </div>
    <div class="mt-6 flex justify-end">
      <button id="save-btn" type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
    </div>
  </form>

  <div class="mt-8 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Security</h2>
    <p class="text-sm text-gray-600 mb-4">Change your password and manage security settings.</p>
    <a href="{% url 'accounts:password_change' %}" class="inline-block bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Change Password</a>
    <div class="mt-3 flex flex-wrap gap-3">
      {% if request.user.is_verified %}
        <a href="{% url 'two_factor:profile' %}" class="inline-block px-4 py-2 rounded-lg border border-emerald-300 text-emerald-700 hover:bg-emerald-50">2FA Enabled</a>
        <a href="{% url 'two_factor:backup_tokens' %}" class="inline-block px-4 py-2 rounded-lg border border-blue-300 text-blue-700 hover:bg-blue-50">Backup Codes</a>
        <a href="{% url 'two_factor:disable' %}" class="inline-block px-4 py-2 rounded-lg border border-red-300 text-red-700 hover:bg-red-50">Disable 2FA</a>
      {% else %}
        <a href="{% url 'two_factor:profile' %}" class="inline-block px-4 py-2 rounded-lg border border-blue-300 text-blue-700 hover:bg-blue-50">Enable 2FA</a>
      {% endif %}
    </div>
    <div class="mt-4">
      <form action="{% url 'accounts:delete_account' %}" method="post" onsubmit="return confirm('This will permanently delete your account. Continue?');">
        {% csrf_token %}
        <button type="submit" class="mt-2 inline-flex items-center px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50">Delete Account</button>
      </form>
    </div>
  </div>

  {% if activities %}
  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Recent Logins</h2>
    <ul class="text-sm text-gray-700 space-y-1">
      {% for a in activities %}
        <li class="flex justify-between">
          <span>{{ a.timestamp|date:"Y-m-d H:i" }}</span>
          <span class="truncate max-w-[60%]" title="{{ a.user_agent }}">{{ a.ip_address|default:"-" }} — {{ a.user_agent|default:"-" }}</span>
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Billing</h2>
    {% if organization and subscription %}
      <div class="text-sm text-gray-700">
        <div><span class="font-semibold">Business:</span> {{ organization.name }}</div>
        <div><span class="font-semibold">Plan:</span> {{ subscription.plan.name|default:"—" }}</div>
        <div><span class="font-semibold">Status:</span> {{ subscription.status }}</div>
        {% if subscription.trial_end %}
          <div><span class="font-semibold">Trial ends:</span> {{ subscription.trial_end|date:"Y-m-d" }}</div>
        {% endif %}
        {% if subscription.current_period_end %}
          <div><span class="font-semibold">Current period ends:</span> {{ subscription.current_period_end|date:"Y-m-d" }}</div>
        {% endif %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No billing data for your current business.</p>
    {% endif %}
  </div>

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Team & Businesses</h2>
    {% if memberships %}
      <ul class="text-sm text-gray-700 space-y-2">
        {% for m in memberships %}
          <li>{{ m.organization.name }} — {{ m.role|title }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-gray-600">You are not a member of any business yet.</p>
    {% endif %}
    {% if pending_invites %}
      <div class="mt-3">
        <h3 class="font-semibold text-sm text-blue-800 mb-1">Pending Invites</h3>
        <ul class="text-sm text-gray-700 space-y-1">
          {% for inv in pending_invites %}
            <li>{{ inv.organization.name }} — {{ inv.role|title }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" />
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script>
    (function() {
      const fileInput = document.getElementById('id_avatar');
      const form = document.getElementById('profile-form');
      const saveBtn = document.getElementById('save-btn');
      const avatarPreview = document.getElementById('avatar-preview');
      if (!fileInput) return;

      // Create a lightweight modal for cropping
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl p-4 w-[90vw] max-w-xl">
          <div class="mb-3 text-blue-800 font-semibold">Adjust your avatar</div>
          <div style="max-height:60vh;" class="overflow-hidden">
            <img id="cropper-image" alt="Crop preview" style="max-width:100%; display:block;">
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="crop-cancel" type="button" class="px-4 py-2 rounded border border-gray-300">Cancel</button>
            <button id="crop-apply" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Apply</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const imgEl = modal.querySelector('#cropper-image');
      const btnApply = modal.querySelector('#crop-apply');
      const btnCancel = modal.querySelector('#crop-cancel');
      let cropper = null;

      function openModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
      function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); if (cropper) { cropper.destroy(); cropper = null; } }

      fileInput.addEventListener('change', function(e) {
        const file = e.target.files && e.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        imgEl.src = url;
        openModal();
        setTimeout(() => {
          cropper = new Cropper(imgEl, {
            aspectRatio: 1,
            viewMode: 1,
            // Allow resizing the crop box (circle) and moving it
            dragMode: 'crop',
            cropBoxMovable: true,
            cropBoxResizable: true,
            guides: true,
            background: false,
            autoCropArea: 0.8,
            movable: true,
            zoomable: true,
            scalable: false,
            rotatable: false,
            responsive: true,
            ready() {
              // Make crop box look circular via CSS tweak
              const face = modal.querySelector('.cropper-face');
              const viewBox = modal.querySelector('.cropper-view-box');
              if (face) face.style.borderRadius = '9999px';
              if (viewBox) viewBox.style.borderRadius = '9999px';
            }
          });
        }, 50);
      });

      btnCancel.addEventListener('click', () => {
        // Reset file input if user cancels
        fileInput.value = '';
        closeModal();
      });

      btnApply.addEventListener('click', async () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
        if (!canvas) return;
        canvas.toBlob((blob) => {
          if (!blob) return;
          const file = new File([blob], 'avatar.jpg', { type: 'image/jpeg' });
          // Assign cropped file back to the file input via DataTransfer
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          // Update on-page preview immediately
          try {
            const previewUrl = URL.createObjectURL(file);
            if (avatarPreview) {
              avatarPreview.src = previewUrl;
            }
          } catch (e) {}
          URL.revokeObjectURL(imgEl.src);
          closeModal();
        }, 'image/jpeg', 0.92);
      });

      // Light feedback on submit
      if (form && saveBtn) {
        form.addEventListener('submit', () => {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
        });
      }
    })();
  </script>
{% endblock %}
