{% extends "calendar_app/base.html" %}
{% block title %}Profile{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 py-8">
  <h1 class="text-2xl font-bold text-blue-700 mb-4">Your Profile</h1>

  {# Remove local messages block to avoid duplicates; base.html already renders messages #}

  <form id="profile-form" method="post" enctype="multipart/form-data" class="bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    {% csrf_token %}
    {% if form.non_field_errors %}
      <div class="mb-4 text-sm text-red-700 bg-red-100 px-3 py-2 rounded">
        {{ form.non_field_errors }}
      </div>
    {% endif %}
    {% if user.profile.avatar %}
      <div class="flex flex-col items-center mb-6">
        <img id="avatar-preview" src="{{ user.profile.avatar.url }}?v={{ user.profile.avatar.name|urlencode }}" alt="Profile Picture" class="w-32 h-32 rounded-full object-cover border-4 border-blue-300 mb-2" />
        <span class="text-xs text-gray-500">Profile Picture</span>
        <span id="avatar-filename" class="text-xs text-gray-400 mt-1" {% if user.profile.avatar %}{% endif %}></span>
      </div>
    {% endif %}
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Username</label>
        <input type="text" name="username" value="{{ user.username }}" required class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Email</label>
        <input type="email" name="email" value="{{ user.email }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">First Name</label>
        <input type="text" name="first_name" value="{{ user.first_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Last Name</label>
        <input type="text" name="last_name" value="{{ user.last_name }}" class="w-full px-4 py-3 text-base rounded-xl border-2 border-blue-400 bg-white text-blue-900 focus:outline-none focus:ring-4 focus:ring-blue-200 focus:border-blue-600" />
      </div>
    </div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
      <div>
        <label class="block text-sm font-semibold text-blue-800 mb-2">Timezone</label>
        {{ form.timezone }}
      </div>
      <div class="flex items-center gap-4">
        <label class="inline-flex items-center">
          {{ form.email_alerts }}
          <span class="ml-2 text-sm text-blue-800">Email Alerts</span>
        </label>
        <label class="inline-flex items-center">
          {{ form.booking_reminders }}
          <span class="ml-2 text-sm text-blue-800">Booking Reminders</span>
        </label>
      </div>
    </div>
    <div class="col-span-2 mt-4">
      <label class="block text-sm font-semibold text-blue-800 mb-2">Profile Picture</label>
      {{ form.avatar }}
      {% if form.avatar.errors %}
        <div class="text-xs text-red-700 mt-1">{{ form.avatar.errors }}</div>
      {% endif %}
      <p class="text-xs text-gray-500 mt-1">Upload a clear photo (any orientation). Explicit images are not allowed.</p>
    </div>
    <div class="mt-6 flex justify-end">
      <button id="save-btn" type="submit" class="bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Save Changes</button>
    </div>
  </form>

  <div class="mt-8 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Security</h2>
    <p class="text-sm text-gray-600 mb-4">Change your password and manage security settings.</p>
    <a href="{% url 'accounts:password_change' %}" class="inline-block bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg hover:bg-blue-700">Change Password</a>
    <div class="mt-3 flex flex-wrap gap-3">
      {% if request.user.is_verified %}
        <a href="{% url 'two_factor:profile' %}" class="inline-block px-4 py-2 rounded-lg border border-emerald-300 text-emerald-700 hover:bg-emerald-50">2FA Enabled</a>
        <a href="{% url 'two_factor:backup_tokens' %}" class="inline-block px-4 py-2 rounded-lg border border-blue-300 text-blue-700 hover:bg-blue-50">Backup Codes</a>
        <a href="{% url 'two_factor:disable' %}" class="inline-block px-4 py-2 rounded-lg border border-red-300 text-red-700 hover:bg-red-50">Disable 2FA</a>
      {% else %}
        <a href="{% url 'two_factor:profile' %}" class="inline-block px-4 py-2 rounded-lg border border-blue-300 text-blue-700 hover:bg-blue-50">Enable 2FA</a>
      {% endif %}
    </div>
    <div class="mt-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <a href="{% url 'accounts:deactivate_confirm' %}" class="inline-flex w-full items-center justify-center px-4 py-2 border border-yellow-300 text-yellow-700 rounded-lg hover:bg-yellow-50">Deactivate Account</a>
        </div>
        <div>
          <a href="{% url 'accounts:delete_confirm' %}" class="inline-flex w-full items-center justify-center px-4 py-2 border border-red-300 text-red-700 rounded-lg hover:bg-red-50">Delete Account</a>
        </div>
      </div>
    </div>
  </div>

  {% if activities %}
  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-2">Recent Logins</h2>
    <ul class="text-sm text-gray-700 space-y-1">
      {% for a in activities %}
        <li class="flex justify-between">
          <span>{{ a.timestamp|date:"Y-m-d H:i" }}</span>
          <span class="truncate max-w-[60%]" title="{{ a.user_agent }}">{{ a.ip_address|default:"-" }} — {{ a.user_agent|default:"-" }}</span>
        </li>
      {% endfor %}
    </ul>
  </div>
  {% endif %}

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Billing</h2>
    {% if organization and subscription %}
      <div class="text-sm text-gray-700">
        <div><span class="font-semibold">Business:</span> {{ organization.name }}</div>
        <div><span class="font-semibold">Plan:</span> {{ subscription.plan.name|default:"—" }}</div>
        <div><span class="font-semibold">Status:</span> {{ subscription.status }}</div>
        {% if subscription.trial_end %}
          <div><span class="font-semibold">Trial ends:</span> {{ subscription.trial_end|date:"Y-m-d" }}</div>
        {% endif %}
        {% if subscription.current_period_end %}
          <div><span class="font-semibold">Current period ends:</span> {{ subscription.current_period_end|date:"Y-m-d" }}</div>
        {% endif %}
      </div>
    {% else %}
      <p class="text-sm text-gray-600">No billing data for your current business.</p>
    {% endif %}
  </div>

  <div class="mt-6 bg-white border border-blue-100 rounded-xl p-6 shadow-sm">
    <h2 class="text-lg font-bold text-blue-700 mb-3">Team & Businesses</h2>
    {% if memberships %}
      <ul class="text-sm text-gray-700 space-y-2">
        {% for m in memberships %}
          <li>{{ m.organization.name }} — {{ m.role|title }}</li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-sm text-gray-600">You are not a member of any business yet.</p>
    {% endif %}
    {% if pending_invites %}
      <div class="mt-3">
        <h3 class="font-semibold text-sm text-blue-800 mb-1">Pending Invites</h3>
        <ul class="text-sm text-gray-700 space-y-1">
          {% for inv in pending_invites %}
            <li>{{ inv.organization.name }} — {{ inv.role|title }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.css" />
  <style>
    /* Ensure the clear anchor inherits muted color if we don't override via JS */
    .clearable-file-input a { color: inherit; }
  </style>
{% endblock %}

{% block extra_scripts %}
  <script src="https://unpkg.com/cropperjs@1.5.13/dist/cropper.min.js"></script>
  <script>
    (function() {
      const fileInput = document.getElementById('id_avatar');
      const form = document.getElementById('profile-form');
      const saveBtn = document.getElementById('save-btn');
      const avatarPreview = document.getElementById('avatar-preview');
      const avatarFilenameEl = document.getElementById('avatar-filename');

      // Normalize any server-rendered path to basename by reading the data-fullname attribute
      if (avatarFilenameEl) {
        const dataFull = avatarFilenameEl.dataset && avatarFilenameEl.dataset.fullname;
        let basename = '';
        if (dataFull) {
          const txt = dataFull.trim();
          const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
          basename = lastSlash !== -1 ? txt.slice(lastSlash + 1) : txt;
          avatarFilenameEl.textContent = basename;
        } else if (avatarFilenameEl.textContent) {
          const txt2 = avatarFilenameEl.textContent.trim();
          const lastSlash2 = Math.max(txt2.lastIndexOf('/'), txt2.lastIndexOf('\\'));
          basename = lastSlash2 !== -1 ? txt2.slice(lastSlash2 + 1) : txt2;
          avatarFilenameEl.textContent = basename;
        }
        // Also update the ClearableFileInput "Currently" anchor text if present
        if (basename) {
          try {
            const clearable = fileInput.closest('.clearable-file-input');
            if (clearable) {
              const anchor = clearable.querySelector('a');
              if (anchor) anchor.textContent = basename;
            }
          } catch (e) {}
        }

          // Force-replace ClearableFileInput anchor with a grey basename span
          (function fixClearableDisplay() {
            try {
              document.querySelectorAll('.clearable-file-input').forEach(span => {
                // If we've already inserted our replacement, skip
                if (span.querySelector('.cc-basename')) return;
                // Determine basename from data attribute if available, else from anchor text
                let basename = '';
                const anchor = span.querySelector('a');
                if (anchor && anchor.textContent) {
                  const txt = anchor.textContent.trim();
                  const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
                  basename = lastSlash !== -1 ? txt.slice(lastSlash + 1) : txt;
                  // remove the anchor so path disappears entirely
                  anchor.remove();
                } else if (avatarFilenameEl && avatarFilenameEl.textContent) {
                  basename = avatarFilenameEl.textContent.trim();
                } else {
                  // fallback to profile_pic.jpg
                  basename = 'profile_pic.jpg';
                }

                // Create replacement span and insert before the clear checkbox if present
                const repl = document.createElement('span');
                repl.className = 'cc-basename text-xs';
                repl.textContent = basename;
                repl.style.color = '#94a3b8';
                repl.style.marginLeft = '4px';
                // Find checkbox or other control to insert before, otherwise append
                const checkbox = span.querySelector('input[type=checkbox], input[type=radio]');
                if (checkbox) {
                  span.insertBefore(repl, checkbox);
                } else {
                  span.appendChild(repl);
                }
              });
            } catch (e) {}
          })();
      }
      // Robustly update ClearableFileInput anchors so they show only the basename and are greyed,
      // while preserving the Clear checkbox functionality. Uses MutationObserver as a fallback.
      (function updateClearableAnchors() {
        function setAnchorText(a) {
          if (!a) return;
          const txt = (a.textContent || '').trim();
          let bn = txt;
          // If anchor contains a path, extract basename
          const lastSlash = Math.max(txt.lastIndexOf('/'), txt.lastIndexOf('\\'));
          if (lastSlash !== -1) bn = txt.slice(lastSlash + 1);
          // If anchor is an href to media, prefer basename from href
          try {
            if (a.href) {
              const hrefParts = a.getAttribute('href').split('/');
              const last = hrefParts[hrefParts.length-1];
              if (last) bn = last;
            }
          } catch (e) {}
          a.textContent = bn;
          a.style.color = '#94a3b8';
        }

        function walkAndUpdate() {
          document.querySelectorAll('.clearable-file-input').forEach(span => {
            const a = span.querySelector('a');
            if (a) setAnchorText(a);
          });
        }

        walkAndUpdate();
        // run again shortly after load in case widget renders later
        setTimeout(walkAndUpdate, 150);

        // Observe DOM changes to update anchors injected later
        try {
          const mo = new MutationObserver(() => {
            walkAndUpdate();
          });
          mo.observe(document.body, { childList: true, subtree: true });
        } catch (e) {}
      })();
      if (!fileInput) return;

      // Create a lightweight modal for cropping
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 bg-black/60 hidden items-center justify-center z-50';
      modal.innerHTML = `
        <div class="bg-white rounded-xl p-4 w-[90vw] max-w-xl">
          <div class="mb-3 text-blue-800 font-semibold">Adjust your avatar</div>
          <div style="max-height:60vh;" class="overflow-hidden">
            <img id="cropper-image" alt="Crop preview" style="max-width:100%; display:block;">
          </div>
          <div class="mt-4 flex justify-end gap-2">
            <button id="crop-cancel" type="button" class="px-4 py-2 rounded border border-gray-300">Cancel</button>
            <button id="crop-apply" type="button" class="px-4 py-2 rounded bg-blue-600 text-white">Apply</button>
          </div>
        </div>`;
      document.body.appendChild(modal);

      const imgEl = modal.querySelector('#cropper-image');
      const btnApply = modal.querySelector('#crop-apply');
      const btnCancel = modal.querySelector('#crop-cancel');
      let cropper = null;

      function openModal() { modal.classList.remove('hidden'); modal.classList.add('flex'); }
      function closeModal() { modal.classList.add('hidden'); modal.classList.remove('flex'); if (cropper) { cropper.destroy(); cropper = null; } }

      fileInput.addEventListener('change', function(e) {
        const originalFile = e.target.files && e.target.files[0];
        if (!originalFile) return;
        // Rename the selected file immediately to profile_pic.jpg so the input shows the desired name
        try {
          const dtReplace = new DataTransfer();
          const renamed = new File([originalFile], 'profile_pic.jpg', { type: originalFile.type });
          dtReplace.items.add(renamed);
          fileInput.files = dtReplace.files;
        } catch (err) {
          // If DataTransfer isn't available, fall back to the original file
        }
        const file = fileInput.files && fileInput.files[0];
        if (!file) return;
        // Update visible filename caption (show basename only)
        let newBasename = '';
        if (avatarFilenameEl) {
          const name = file.name || '';
          const lastSlash = Math.max(name.lastIndexOf('/'), name.lastIndexOf('\\'));
          newBasename = lastSlash !== -1 ? name.slice(lastSlash + 1) : name;
          avatarFilenameEl.textContent = newBasename;
        }
        // Update the widget's "Currently:" anchor text
        try {
          const clearable = fileInput.closest('.clearable-file-input');
          if (clearable) {
            const anchor = clearable.querySelector('a');
            if (anchor && newBasename) anchor.textContent = newBasename;
          }
        } catch (e) {}
        const url = URL.createObjectURL(file);
        imgEl.src = url;
        openModal();
        setTimeout(() => {
          cropper = new Cropper(imgEl, {
            aspectRatio: 1,
            viewMode: 1,
            // Allow resizing the crop box (circle) and moving it
            dragMode: 'crop',
            cropBoxMovable: true,
            cropBoxResizable: true,
            guides: true,
            background: false,
            autoCropArea: 0.8,
            movable: true,
            zoomable: true,
            scalable: false,
            rotatable: false,
            responsive: true,
            ready() {
              // Make crop box look circular via CSS tweak
              const face = modal.querySelector('.cropper-face');
              const viewBox = modal.querySelector('.cropper-view-box');
              if (face) face.style.borderRadius = '9999px';
              if (viewBox) viewBox.style.borderRadius = '9999px';
            }
          });
        }, 50);
      });

      btnCancel.addEventListener('click', () => {
        // Reset file input if user cancels
        fileInput.value = '';
        closeModal();
      });

      btnApply.addEventListener('click', async () => {
        if (!cropper) return;
        const canvas = cropper.getCroppedCanvas({ width: 512, height: 512, imageSmoothingQuality: 'high' });
        if (!canvas) return;
        canvas.toBlob((blob) => {
          if (!blob) return;
          const file = new File([blob], 'profile_pic.jpg', { type: 'image/jpeg' });
          // Assign cropped file back to the file input via DataTransfer
          const dt = new DataTransfer();
          dt.items.add(file);
          fileInput.files = dt.files;
          // Update visible filename caption after crop (basename) and widget anchor
          if (avatarFilenameEl) {
            const name2 = file.name || '';
            const lastSlash2 = Math.max(name2.lastIndexOf('/'), name2.lastIndexOf('\\'));
            const bn = lastSlash2 !== -1 ? name2.slice(lastSlash2 + 1) : name2;
            avatarFilenameEl.textContent = bn;
            try {
              const clearable2 = fileInput.closest('.clearable-file-input');
              if (clearable2) {
                const anchor2 = clearable2.querySelector('a');
                if (anchor2) anchor2.textContent = bn;
              }
            } catch (e) {}
          }
          // Update on-page preview immediately
          try {
            const previewUrl = URL.createObjectURL(file);
            if (avatarPreview) {
              avatarPreview.src = previewUrl;
            }
          } catch (e) {}
          URL.revokeObjectURL(imgEl.src);
          closeModal();
        }, 'image/jpeg', 0.92);
      });

      // Light feedback on submit
      if (form && saveBtn) {
        form.addEventListener('submit', () => {
          saveBtn.disabled = true;
          saveBtn.textContent = 'Saving...';
        });
      }

      // Require password on delete and show explicit confirmation
      try {
        const deleteForm = document.getElementById('delete-account-form');
        const deleteBtn = document.getElementById('delete-account-button');
        const deletePassword = document.getElementById('delete-password');
        if (deleteForm && deleteBtn && deletePassword) {
          deleteForm.addEventListener('submit', function(e) {
            if (!deletePassword.value || deletePassword.value.trim().length === 0) {
              e.preventDefault();
              alert('Please enter your password to confirm account deletion.');
              deletePassword.focus();
              return false;
            }
            const ok = confirm('This will permanently delete your account and all associated data. This action cannot be undone. Continue?');
            if (!ok) {
              e.preventDefault();
              return false;
            }
            // allow submit
          });
        }
      } catch (e) {}
    })();
  </script>
{% endblock %}
