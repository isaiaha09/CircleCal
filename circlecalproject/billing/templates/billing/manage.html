{% extends "calendar_app/base.html" %}
{% load static %}

{% block title %}Manage Billing – {{ org.name }}{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto mt-6 md:mt-10 bg-white/90 backdrop-blur border border-gray-200 rounded-xl shadow-sm p-4 md:p-6">
  <h1 class="text-xl md:text-2xl font-semibold mb-3 md:mb-4">Billing Management</h1>
  <p class="text-xs md:text-sm text-gray-600 mb-4 md:mb-6">Manage subscription, payment methods, and invoices for <strong>{{ org.name }}</strong>.</p>

  {% if checkout_status == 'success' %}
    <div id="cc-checkout-success" class="mb-4 p-3 rounded border-l-4 border-green-400 bg-green-50 text-sm text-green-800">
      Payment received — updating your subscription now…
    </div>
  {% endif %}

  <!-- Preview modal (hidden by default) -->
  <div id="cc-preview-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl mx-4">
      <div class="p-4 border-b">
        <h3 class="text-lg font-semibold">Preview plan change</h3>
      </div>
      <div class="p-4" id="cc-preview-body">
        <div class="flex flex-col md:flex-row gap-4">
          <!-- Left: detailed lines -->
          <div class="flex-1" id="cc-preview-lines" class="space-y-2 text-sm text-gray-700"></div>

          <!-- Right summary removed; billing date will be placed under the immediate total -->
        </div>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="cc-preview-cancel" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Cancel</button>
        <button id="cc-preview-confirm" class="px-3 py-2 rounded bg-indigo-600 text-white hover:bg-indigo-700">Confirm change</button>
      </div>
    </div>
  </div>

  {# Current Plan Section #}
  <section class="mb-8" id="current-plan-section">
    <h2 class="text-xl font-semibold mb-2">Current Plan</h2>
    {% if subscription %}
      <div class="border rounded-lg p-4 bg-gradient-to-br from-indigo-50 to-blue-50 relative">
        <div class="flex items-start justify-between">
          <div class="pr-4">
            <div class="flex items-center gap-3">
              <h3 class="text-lg font-bold text-indigo-900">{{ display_plan.name }}</h3>
              {% if applied_discount %}
                <span class="inline-flex items-center px-3 py-1 rounded bg-green-100 text-green-800 text-sm font-semibold">Discount: {% if applied_discount.percent_off %}{{ applied_discount.percent_off }}%{% else %}${{ applied_discount.amount_off_cents|floatformat:-2|default_if_none:"" }}{% endif %} ({{ applied_discount.code }})</span>
              {% endif %}
              {% if trial_remaining_seconds %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold">On Trial</span>
              {% elif subscription.status|lower == 'trialing' %}
                <span class="inline-flex items-center px-3 py-1 rounded-full bg-yellow-100 text-yellow-800 text-sm font-semibold">On Trial</span>
              {% endif %}
            </div>
            <p class="text-2xl font-bold text-indigo-600 mt-1">${{ display_plan.price|floatformat:2 }}<span class="text-sm font-normal text-gray-600">/{{ display_plan.billing_period }}</span></p>
            {% if display_plan.description %}
              <p class="text-sm text-gray-600 mt-2">{{ display_plan.description }}</p>
            {% endif %}
          </div>
          
        </div>

      </div>
      {% if trial_remaining_seconds %}
        <div class="mt-3 p-3 rounded border-l-4 border-yellow-300 bg-yellow-50 text-sm text-yellow-800">
          You are currently on a free{% if trial_total_days %} {{ trial_total_days }}-day{% endif %} trial — <strong id="trialSummary">{{ trial_remaining_days }} day(s) left</strong>. You can add a card below and convert to a paid plan at any time.
        </div>
      {% endif %}
    {% endif %}
  </section>

  <!-- Subscription Change Modal -->
  <div id="subscription-change-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
    <div class="bg-white rounded-lg shadow-xl w-full max-w-lg mx-4">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-lg font-semibold">Subscription Change</h3>
        <button id="sc-close" class="text-gray-500 hover:text-gray-700">✕</button>
      </div>
      <div class="p-4" id="sc-body">
        <div class="space-y-3 text-sm text-gray-700">
          <div><strong>Type:</strong> <span id="sc-type"></span></div>
          <div><strong>New plan:</strong> <span id="sc-new-plan"></span></div>
          <div><strong>Effective:</strong> <span id="sc-effective"></span></div>
          <div><strong>Amount:</strong> <span id="sc-amount"></span></div>
          <div id="sc-card-row"><strong>Card:</strong> <span id="sc-card"></span></div>
          <div id="sc-invoice-row"><strong>Stripe Invoice:</strong> <a id="sc-invoice-link" href="#" target="_blank"></a></div>
          <div><strong>Status:</strong> <span id="sc-status"></span></div>
        </div>
      </div>
      <div class="p-4 border-t flex justify-between gap-2">
        <div class="flex items-center gap-2">
          <button id="sc-cancel-btn" class="px-3 py-2 rounded bg-red-600 text-white hover:bg-red-700 hidden">Cancel scheduled change</button>
        </div>
        <div>
          <button id="sc-close-2" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200">Close</button>
        </div>
      </div>
    </div>
  </div>
  
  
  
  {# Subscription Details Section #}
  <section class="mb-8" id="subscription-section">
    <h2 class="text-xl font-semibold mb-2">Subscription Details</h2>
    {% if subscription %}
      <div class="text-sm">
        <div class="flex items-center justify-between space-x-4">
          <div>
            <div><strong>Status:</strong> {{ subscription.status }}{% if subscription.cancel_at_period_end %} (cancels at period end){% endif %}</div>
            {% if subscription.current_period_end %}
              <div><strong>Period Ends:</strong> {{ subscription.current_period_end|date:"M j, Y g:i A" }}</div>
            {% endif %}
            {# Show next charge amount/date in the subscription details when available #}
            {% if upcoming_invoice_adjusted %}
              <div class="mt-2"><strong>Next charge:</strong> <strong>${{ upcoming_invoice_adjusted.adjusted|floatformat:2 }}</strong>{% if upcoming_invoice.billing_date %} on <strong>{{ upcoming_invoice.billing_date|date:"M j, Y g:i A" }}</strong>{% endif %}</div>
              <div class="text-sm text-green-700 mt-1">Discount: -${{ upcoming_invoice_adjusted.discount_amount|floatformat:2 }} — Original: <s>${{ upcoming_invoice_adjusted.original|floatformat:2 }}</s></div>
            {% elif upcoming_invoice %}
              <div class="mt-2"><strong>Next charge:</strong> <strong>${{ upcoming_invoice.amount_due_dollars|floatformat:2 }}</strong>{% if upcoming_invoice.billing_date %} on <strong>{{ upcoming_invoice.billing_date|date:"M j, Y g:i A" }}</strong>{% endif %}</div>
            {% endif %}

            {% if not trial_remaining_seconds and next_billing_iso %}
              <div class="text-sm mt-2"><strong>Next charge in:</strong> <span id="nextChargeCountdown">—</span></div>
            {% endif %}
          </div>
          <div class="flex items-center gap-2">
            {% if subscription.cancel_at_period_end %}
              <button id="reactivateBtn" class="px-3 py-2 text-xs md:text-sm rounded bg-green-600 text-white hover:bg-green-700">Reactivate</button>
            {% else %}
              <button id="cancelBtn" class="px-3 py-1 text-xs rounded bg-yellow-500 text-white hover:bg-yellow-600 md:px-4 md:py-2 md:text-sm">Cancel at Period End</button>
            {% endif %}
            {% if trial_remaining_seconds %}
              <button id="immediateCancelBtn" class="px-3 py-1 text-xs rounded bg-red-700 text-white hover:bg-red-800 md:px-4 md:py-2 md:text-sm" data-is-trial="true">Immediate Cancel</button>
            {% else %}
              <button id="immediateCancelBtn" class="px-3 py-1 text-xs rounded bg-red-700 text-white hover:bg-red-800 md:px-4 md:py-2 md:text-sm" data-is-trial="false">Immediate Cancel</button>
            {% endif %}
          </div>
        </div>
        {% if trial_remaining_seconds %}
          <div class="text-sm mt-2"><strong>Trial:</strong> <span id="trialCountdown">{{ trial_remaining_days }} day(s)</span> remaining (ends {{ subscription.trial_end|date:"M j, Y g:i A" }})</div>
        {% elif subscription.trial_end %}
          <div class="mt-2"><strong>Trial Ends:</strong> {{ subscription.trial_end|date:"M j, Y g:i A" }}</div>
        {% endif %}
      </div>
      {% if scheduled_plan %}
        <div class="mt-3 p-3 rounded border-l-4 border-blue-300 bg-blue-50 text-sm text-blue-800 flex items-center justify-between">
          <div>
            Scheduled change:
            <strong>
              {% if scheduled_change_is_downgrade %}
                Downgrade to {{ scheduled_plan.name }}
              {% elif scheduled_change_is_downgrade == False %}
                Upgrade to {{ scheduled_plan.name }}
              {% else %}
                Change to {{ scheduled_plan.name }}
              {% endif %}
            </strong>
            <span class="ml-1 text-xs text-gray-700">(will take effect at period end on <strong>{{ subscription.scheduled_change_at|date:"M j, Y g:i A" }}</strong>)</span>
          </div>
          <div>
            <button id="cancelScheduledBtn" class="px-3 py-1 rounded bg-gray-100 text-sm hover:bg-gray-200">Cancel scheduled change</button>
          </div>
        </div>
      {% endif %}
    {% else %}
      <div class="text-sm text-gray-600">No active subscription. Choose a plan on the pricing page.</div>
    {% endif %}
  </section>
  {# Previously separate cancel buttons moved inline above. #}

  {# Change Plan Section - moved below Payment Methods for better flow #}

  {# Payment Methods Section #}
  <section class="mb-8" id="payment-method-section">
    <h2 class="text-xl font-semibold mb-2">Payment Methods</h2>
    <div id="paymentMethodsList" class="space-y-2 mb-4">
      {% if org.stripe_customer_id %}
        {% for pm in payment_methods %}
          <div class="flex flex-col sm:flex-row sm:items-center justify-between border rounded px-3 py-2 text-sm" data-pm-id="{{ pm.id }}">
            <div class="min-w-0">
              <div class="truncate font-medium">**** {{ pm.card.last4 }} — {{ pm.card.brand|title }}</div>
              <div class="text-xs text-gray-600 truncate">exp {{ pm.card.exp_month }}/{{ pm.card.exp_year }} {% if pm.id == default_payment_method_id %}<span class="ml-1 inline-block bg-green-100 text-green-700 px-2 py-0.5 rounded text-xs">Default</span>{% endif %}</div>
            </div>
            <div class="flex gap-2 mt-2 sm:mt-0 flex-wrap">
                {% if pm.id != default_payment_method_id %}
                  <button class="set-default-btn text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300 whitespace-nowrap" data-id="{{ pm.id }}">Set Default</button>
                {% endif %}
                {% if pm.id == default_payment_method_id %}
                  <button class="delete-pm-btn text-xs px-2 py-1 rounded bg-red-100 text-red-700 opacity-50 cursor-not-allowed whitespace-nowrap" disabled title="Default payment method — add another card before removing">Remove</button>
                  <span class="text-xs text-gray-500 italic ml-2 block sm:inline">Default payment method — add another card before removing.</span>
                {% else %}
                  <button class="delete-pm-btn text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200 whitespace-nowrap" data-id="{{ pm.id }}">Remove</button>
                {% endif %}
            </div>
          </div>
        {% empty %}
          <div class="text-sm text-gray-600">No payment methods yet.</div>
        {% endfor %}
      {% else %}
        <div class="text-sm text-gray-600">No payment methods yet. You can add a card below even before a subscription — we'll create a Stripe customer for you when you save the card.</div>
      {% endif %}
    </div>

    <div class="border rounded p-4 bg-gray-50">
      <h3 class="text-sm font-medium mb-2">Add / Update Card</h3>
      <div id="payment-element" class="mb-3"></div>
      <button id="saveCardBtn" class="px-3 py-2 text-sm rounded bg-blue-600 text-white">Save Card</button>
      <div id="pmStatus" class="text-xs mt-2 text-gray-600"></div>
    </div>
  </section>
  {# Change Plan Section: placed after Payment Methods so users add a card first #}
  {% if subscription %}
  <section class="mb-8" id="change-plan-section">
    <h2 class="text-xl font-semibold mb-2">Change Plan</h2>
    <div class="flex flex-col sm:flex-row gap-2">
      <select id="changePlanSelect" class="border rounded px-2 py-1 text-xs md:text-sm flex-1">
        <option value="">-- Select Plan --</option>
        {% for p in plans %}
          <option value="{{ p.id }}">{{ p.name }} ({{ p.price }} / {{ p.billing_period }})</option>
        {% endfor %}
      </select>
      <button id="changePlanBtn" class="px-3 py-2 text-xs md:text-sm rounded bg-indigo-600 text-white hover:bg-indigo-700 whitespace-nowrap">Update Plan</button>
    </div>
  </section>
  {% endif %}
  {# Invoices Section #}
  <section class="mb-8 relative" id="invoices-section">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-xl font-semibold">Invoices</h2>
      <div class="flex items-center space-x-3">
        <button id="openFiltersBtn" class="px-3 py-1 rounded bg-gray-100 hover:bg-gray-200 text-sm">Filters</button>
      </div>
    </div>

    <!-- Floating Filters Panel (non-blocking) -->
    <div id="invoice-filters-panel" class="absolute right-0 top-0 z-20 hidden w-full max-w-sm md:max-w-md">
      <div class="bg-white rounded-lg shadow-lg border border-gray-200">
        <div class="p-3 border-b flex items-center justify-between">
          <h3 class="text-md font-semibold">Filters</h3>
          <button id="closeFiltersBtn" class="text-gray-500 hover:text-gray-700">✕</button>
        </div>
        <div class="p-3 space-y-3 text-sm text-gray-700">
          {% if months and months|length > 0 %}
            <div class="flex items-center justify-between">
              <label class="text-sm text-gray-600">Month</label>
              <select id="invoiceMonthSelect" class="text-sm border rounded px-2 py-1">
                {% for m in months %}
                  <option value="{{ m.key }}" {% if m.key == selected_month %}selected{% endif %}>{{ m.label }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}

          <div class="flex items-center justify-between">
            <label class="text-sm text-gray-600">Sort</label>
            <select id="invSortSelect" class="text-sm border rounded px-2 py-1">
              <option value="latest" {% if current_inv_sort == 'latest' %}selected{% endif %}>Latest</option>
              <option value="earliest" {% if current_inv_sort == 'earliest' %}selected{% endif %}>Earliest</option>
              <option value="lowest" {% if current_inv_sort == 'lowest' %}selected{% endif %}>Least expensive</option>
              <option value="highest" {% if current_inv_sort == 'highest' %}selected{% endif %}>Most expensive</option>
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm text-gray-600">Card</label>
            <select id="invCardSelect" class="text-sm border rounded px-2 py-1">
              <option value="">All cards</option>
              {% for c in invoice_card_options %}
                <option value="{{ c }}" {% if c == current_inv_card %}selected{% endif %}>**** {{ c }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm text-gray-600">Status</label>
            <select id="invStatusSelect" class="text-sm border rounded px-2 py-1">
              <option value="">All statuses</option>
              {% for s in invoice_status_options %}
                <option value="{{ s }}" {% if s == current_inv_status %}selected{% endif %}>{{ s|capfirst }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="flex items-center justify-between">
            <label class="text-sm text-gray-600">Show archived</label>
            <input id="showArchivedToggle" type="checkbox" {% if show_archived %}checked{% endif %} />
          </div>
        </div>
      </div>
    </div>
    <style>
      /* Row enter/leave animations */
      .cc-row { transition: transform 260ms ease, opacity 260ms ease; }
      .cc-row-enter { opacity: 0; transform: translateY(-6px) scale(0.995); }
      /* cc-row-hidden should only fade/translate the row and disable pointer events.
        Avoid collapsing height/padding/margin so layout doesn't jump during cross-fade. */
      .cc-row-hidden { opacity: 0 !important; transform: translateY(-6px) scale(0.995); pointer-events: none; }

      /* Hide invoice lists until JS applies filters to avoid flicker */
      .cc-hide-until-js { visibility: hidden; }

      /* Mobile invoice card list: show on small screens, hide on md+ */
      #invoicesListMobile { display: none; }
      /* Mobile card transitions
        cc-mobile-card mirrors table row transitions for cross-fade */
      .cc-mobile-card { transition: transform 260ms ease, opacity 260ms ease; }
      .cc-mobile-enter { opacity: 0; transform: translateY(-6px) scale(0.995); }
      .cc-mobile-hidden { opacity: 0 !important; transform: translateY(-6px) scale(0.995); pointer-events: none; }
      @media (max-width: 767px) {
        #invoicesListMobile { display: block; }
        #invoicesTable { display: none; }
      }
    </style>
    <script>
          (function(){
            const defaultCardLast4 = "{{ default_card_last4|default:''|escapejs }}";
        const panel = document.getElementById('invoice-filters-panel');
        const openBtn = document.getElementById('openFiltersBtn');
        const closeBtn = document.getElementById('closeFiltersBtn');

        function showPanel(){ if (!panel) return; panel.classList.remove('hidden'); }
        function hidePanel(){ if (!panel) return; panel.classList.add('hidden'); }

        openBtn?.addEventListener('click', (e)=>{ e.preventDefault(); showPanel(); });
        closeBtn?.addEventListener('click', (e)=>{ e.preventDefault(); hidePanel(); });

        // When any filter changes, apply client-side filters live (no page reload)
        ['invSortSelect','invCardSelect','invStatusSelect','invoiceMonthSelect','showArchivedToggle'].forEach(id => {
          const el = document.getElementById(id);
          if (!el) return;
          el.addEventListener('change', function(){
            try { if (typeof applyInvoiceFilters === 'function') applyInvoiceFilters(); } catch (e) { console.error(e); }
          });
        });

        // close panel when clicking outside (but keep it non-blocking)
        document.addEventListener('click', function(e){
          if (!panel || panel.classList.contains('hidden')) return;
          const isInside = panel.contains(e.target) || openBtn.contains(e.target);
          if (!isInside) hidePanel();
        });
      })();
    </script>
    {% if trial_remaining_seconds %}
      <div class="text-sm text-gray-600">On trial – invoices will appear after trial ends.</div>
    {% elif invoices %}

      <div id="invoicesListMobile" class="space-y-3 mb-3 md:hidden cc-hide-until-js"></div>
      <table id="invoicesTable" class="w-full text-sm border cc-hide-until-js">
        <thead class="bg-gray-100">
          <tr>
            <th class="p-2 text-left">Date</th>
            <th class="p-2 text-left">Amount</th>
            <th class="p-2 text-left">Card</th>
            <th class="p-2 text-left">Status</th>
            <th class="p-2 text-left">Actions</th>
          </tr>
        </thead>
        <tbody>
        {% for inv in paged_invoices %}
            <tr class="border-t"
              data-inv-id="{{ inv.raw.id|default:'' }}"
              data-amount="{{ inv.amount_display_dollars|default:0 }}"
              data-card="{{ inv.card_last4|default:default_card_last4|default:'' }}"
              data-status="{% if inv.raw.pseudo %}{{ inv.raw.status|default:'scheduled' }}{% else %}{{ inv.status|default:'' }}{% endif %}"
              data-created="{{ inv.created|date:'c' }}"
              data-pseudo="{{ inv.raw.pseudo|default_if_none:False }}"
              data-hidden="{{ inv.hidden|yesno:'1,0' }}"
            >
            <td class="p-2">
              {% if inv.created %}
                <div>{{ inv.created|date:"M j, Y" }}</div>
                <div class="text-xs text-gray-500">{{ inv.created|date:"g:i A" }}</div>
              {% else %}
                —
              {% endif %}
            </td>
            <td class="p-2">${{ inv.amount_display_dollars|floatformat:2 }}</td>
            <td class="p-2">
              {% if inv.raw.pseudo %}
                <span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-800 text-xs font-semibold">Scheduled change</span>
              {% else %}
                {% with display_last4=inv.card_last4|default:default_card_last4 %}
                  {% if display_last4 %}
                    **** {{ display_last4 }}{% if inv.card_brand %} ({{ inv.card_brand }}){% endif %}
                  {% else %}
                    —
                  {% endif %}
                {% endwith %}
              {% endif %}
            </td>
            <td class="p-2">
              {% if inv.raw.pseudo %}
                <span class="inline-flex items-center px-2 py-1 rounded bg-blue-100 text-blue-800 text-sm">{{ inv.raw.type|capfirst }}</span>
              {% else %}
                {{ inv.status }}
              {% endif %}
            </td>
            <td class="p-2">
              {% if inv.raw.pseudo and inv.raw.id %}
                {% with eff=inv.raw.effective_at|default:inv.created %}
                <button class="view-change-btn text-indigo-600" 
                  data-change-id="{{ inv.raw.id }}"
                  data-change-type="{{ inv.raw.change_type }}"
                  data-new-plan-name="{{ inv.raw.new_plan_name }}"
                  data-effective-at="{{ eff|date:'c' }}"
                  data-amount-cents="{{ inv.raw.amount_cents|default:0 }}"
                  data-card-brand="{{ inv.raw.card_brand|default_if_none:'' }}"
                  data-card-last4="{{ inv.raw.card_last4|default_if_none:'' }}"
                  data-stripe-invoice-id="{{ inv.raw.stripe_invoice_id|default_if_none:'' }}"
                  data-status="{{ inv.raw.status|default_if_none:'' }}"
                >View change</button>
                {% endwith %}
              {% elif inv.hosted_invoice_url %}
                <a href="{{ inv.hosted_invoice_url }}" class="text-indigo-600" target="_blank">View</a>
                {% if inv.hidden %}
                  <button class="text-sm ml-3 unhide-inv-btn text-green-600" data-inv-id="{{ inv.raw.id }}">Unhide</button>
                {% else %}
                  <button class="text-sm ml-3 hide-inv-btn text-gray-600" data-inv-id="{{ inv.raw.id }}">Hide</button>
                  <button class="text-sm ml-3 void-inv-btn text-red-600" data-inv-id="{{ inv.raw.id }}">Void</button>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
        {% endfor %}
        <tr id="no-results-row" class="border-t hidden">
          <td class="p-6 text-center text-gray-500" colspan="5">No invoices match your filters.</td>
        </tr>
        </tbody>
      </table>
      <div class="mt-3 text-center">
        <button id="invoicesLoadMore" class="px-3 py-2 rounded bg-gray-100 hover:bg-gray-200 hidden">Load more</button>
      </div>
      <script>
        // Do NOT auto-apply 'Show archived' when the checkbox is toggled.
        // The Filters modal's Apply button controls when filters (including "Show archived") take effect.

        // client-side will read per-invoice `data-hidden` if needed
        // NOTE: month changes are handled client-side in applyInvoiceFilters (no reload)
    
        // Client-side invoice filtering and sorting (supports AJAX rendering when server-side is enabled)
        (function(){
          const useAjax = true; // AJAX filtering always enabled
          let currentPage = 1;

          function buildParams() {
            const params = new URLSearchParams();
            const sort = document.getElementById('invSortSelect')?.value || '';
            const card = document.getElementById('invCardSelect')?.value || '';
            const status = document.getElementById('invStatusSelect')?.value || '';
            const month = document.getElementById('invoiceMonthSelect')?.value || '';
            const showArchived = !!document.getElementById('showArchivedToggle')?.checked;
            if (sort) params.set('inv_sort', sort);
            if (card) params.set('inv_card', card);
            if (status) params.set('inv_status', status);
            if (month) params.set('invoice_month', month);
            if (showArchived) params.set('show_archived', '1');
            return params;
          }

          function renderInvoiceRows(items, append=false, meta={}) {
            const tbody = document.querySelector('#invoicesTable tbody');
            const mobile = document.getElementById('invoicesListMobile');
            // Allow rendering when either table or mobile container exists.
            if (!tbody && !mobile) return;
            // Diagnostic logging to help trace why mobile cards might be missing
            try { console.debug('renderInvoiceRows called', { itemsCount: items.length, append: append, hasTbody: !!tbody, hasMobile: !!mobile }); } catch (e) {}
            const noResults = document.getElementById('no-results-row');
            // build table rows
            // when not appending, mark new rows with an enter class so they
            // start hidden and can transition to visible smoothly
            const enterClass = append ? '' : ' cc-row-enter';
            let html = '';
            for (const inv of items) {
              const createdIso = inv.created_iso || '';
              let createdDateStr = '';
              let createdTimeStr = '';
              if (createdIso) {
                try {
                  const d = new Date(createdIso);
                  const parts = new Intl.DateTimeFormat(undefined, { month: 'short', day: '2-digit', year: 'numeric' }).formatToParts(d);
                  const month = (parts.find(p=>p.type==='month')||{}).value || '';
                  const day = (parts.find(p=>p.type==='day')||{}).value || '';
                  const year = (parts.find(p=>p.type==='year')||{}).value || '';
                  createdDateStr = `${month}, ${day} ${year}`;
                  createdTimeStr = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: true }).format(d);
                } catch (e) {
                  createdDateStr = createdIso;
                  createdTimeStr = '';
                }
              }
              const amount = inv.amount_display_dollars != null ? '$' + Number(inv.amount_display_dollars).toFixed(2) : '—';
              const cardLast4 = (inv.card_last4 || defaultCardLast4 || '');
              const card = cardLast4 ? ('**** ' + cardLast4 + (inv.card_brand ? (' (' + inv.card_brand + ')') : '')) : '—';
              const status = inv.pseudo ? (inv.status || '') : (inv.status || '');
              const hiddenAttr = inv.hidden ? '1' : '0';
              const dataInvId = inv.id || '';
              html += `<tr class="border-t cc-row${enterClass}" data-inv-id="${dataInvId}" data-amount="${amount}" data-card="${cardLast4}" data-status="${status}" data-created="${createdIso}" data-pseudo="${inv.pseudo ? '1' : '0'}" data-hidden="${hiddenAttr}">`;
              html += `<td class="p-2">${createdDateStr ? `<div>${createdDateStr}</div><div class="text-xs text-gray-500">${createdTimeStr}</div>` : '—'}</td>`;
              html += `<td class="p-2">${amount}</td>`;
              html += `<td class="p-2">${inv.pseudo ? '<span class="inline-flex items-center px-2 py-0.5 rounded bg-blue-50 text-blue-800 text-xs font-semibold">Scheduled change</span>' : card}</td>`;
              html += `<td class="p-2">${inv.pseudo ? `<span class="inline-flex items-center px-2 py-1 rounded bg-blue-100 text-blue-800 text-sm">${(inv.status||'').toString()}</span>` : (inv.status || '')}</td>`;
              html += `<td class="p-2">`;
              if (inv.pseudo) {
                html += `<button class="view-change-btn text-indigo-600" data-change-id="${dataInvId}">View change</button>`;
              } else if (inv.hosted_invoice_url) {
                html += `<a href="${inv.hosted_invoice_url}" class="text-indigo-600" target="_blank">View</a>`;
                if (inv.hidden) html += ` <button class="text-sm ml-3 unhide-inv-btn text-green-600" data-inv-id="${dataInvId}">Unhide</button>`;
                else html += ` <button class="text-sm ml-3 hide-inv-btn text-gray-600" data-inv-id="${dataInvId}">Hide</button> <button class="text-sm ml-3 void-inv-btn text-red-600" data-inv-id="${dataInvId}">Void</button>`;
              } else {
                html += '—';
              }
              html += `</td></tr>`;
            }
            if (tbody) {
              if (append) {
                const nr = tbody.querySelector('#no-results-row');
                if (nr) nr.insertAdjacentHTML('beforebegin', html); else tbody.insertAdjacentHTML('beforeend', html);
              } else {
                const nr = tbody.querySelector('#no-results-row');
                const nrHTML = nr ? nr.outerHTML : '';
                tbody.innerHTML = html + nrHTML;
              }
            }

            // mobile cards
            const enterClassMobile = append ? '' : ' cc-mobile-enter';
            let mhtml = '';
            for (const inv of items) {
              const createdIso = inv.created_iso || '';
              let createdDateStr = '';
              let createdTimeStr = '';
              if (createdIso) {
                try {
                  const d = new Date(createdIso);
                  const parts = new Intl.DateTimeFormat(undefined, { month: 'short', day: '2-digit', year: 'numeric' }).formatToParts(d);
                  const month = (parts.find(p=>p.type==='month')||{}).value || '';
                  const day = (parts.find(p=>p.type==='day')||{}).value || '';
                  const year = (parts.find(p=>p.type==='year')||{}).value || '';
                  createdDateStr = `${month}, ${day} ${year}`;
                  createdTimeStr = new Intl.DateTimeFormat(undefined, { hour: '2-digit', minute: '2-digit', hour12: true }).format(d);
                } catch (e) {
                  createdDateStr = createdIso;
                  createdTimeStr = '';
                }
              }
              const amount = inv.amount_display_dollars != null ? '$' + Number(inv.amount_display_dollars).toFixed(2) : '—';
              const cardLast4Mobile = (inv.card_last4 || defaultCardLast4 || '');
              const card = cardLast4Mobile ? ('**** ' + cardLast4Mobile) : '—';
              const status = inv.status || '';
              const hiddenBadge = inv.hidden ? '<span class="text-xs text-gray-500 ml-2">(archived)</span>' : '';
              mhtml += `<div class="border rounded p-3 bg-white shadow-sm cc-mobile-card${enterClassMobile}">`;
              mhtml += `<div class="flex justify-between items-start"><div class="text-sm font-medium">${createdDateStr || '—'}</div><div class="text-sm font-semibold">${amount}</div></div>`;
              if (createdTimeStr) mhtml += `<div class="text-xs text-gray-600 mt-1 text-right">${createdTimeStr}</div>`;
              mhtml += `<div class="text-xs text-gray-600 mt-1">${card} ${hiddenBadge}</div>`;
              mhtml += `<div class="text-xs text-gray-600 mt-2">${status}</div>`;
              mhtml += `</div>`;
            }
            // Update mobile list (only if container exists). Do this after mhtml is
            // constructed so we don't reference an undefined variable.
            if (mobile) {
              if (append) {
                mobile.insertAdjacentHTML('beforeend', mhtml);
              } else {
                try { console.debug('mobile before len', mobile.innerHTML.length); } catch (e) {}
                mobile.innerHTML = mhtml;
                try { console.debug('mobile after len', mobile.innerHTML.length); } catch (e) {}
              }
            }

            // animate rows
            // animate newly added rows; if we replaced the HTML after a timeout,
            // ensure animation runs after the DOM update. Use a short delay to
            // allow the replacement to complete before querying the new rows.
            setTimeout(()=>{
              // Table rows
              const newRows = Array.from(tbody.querySelectorAll('tr.cc-row'));
              newRows.forEach(r => requestAnimationFrame(()=> r.classList.remove('cc-row-enter')));
              // Mobile cards
              const newCards = Array.from(document.querySelectorAll('#invoicesListMobile .cc-mobile-card'));
              newCards.forEach(c => requestAnimationFrame(()=> c.classList.remove('cc-mobile-enter')));

              // Rebind invoice action buttons after new rows/cards are in DOM
              bindInvoiceButtons();
            }, 280);
            // show/hide load more based on meta
            const loadMoreBtn = document.getElementById('invoicesLoadMore');
            if (loadMoreBtn) {
              if (meta && meta.has_more) loadMoreBtn.classList.remove('hidden'); else loadMoreBtn.classList.add('hidden');
            }
          }

          function bindInvoiceButtons() {
            // No-op: delegated handlers are used (avoid adding duplicate listeners)
            return;
          }

          async function hideHandler(e){
            const invId = this.getAttribute('data-inv-id');
            if (!confirm('Hide this invoice from the UI?')) return;
            showLoading();
            try {
              const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/hide/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
              const payload = await resp.json();
              showToast('info', 'Invoice hidden');
              applyInvoiceFilters();
            } catch (e) { showToast('error', 'Hide failed'); }
            hideLoading();
          }

          async function unhideHandler(e){
            const invId = this.getAttribute('data-inv-id');
            if (!confirm('Unhide this invoice?')) return;
            showLoading();
            try {
              const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/unhide/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
              const payload = await resp.json();
              showToast('success', 'Invoice unhidden');
              applyInvoiceFilters();
            } catch (e) { showToast('error', 'Unhide failed'); }
            hideLoading();
          }

          async function voidHandler(e){
            const invId = this.getAttribute('data-inv-id');
            if (!confirm('Void this invoice? This may not be reversible.')) return;
            showLoading();
            try {
              const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/void/`, { method: 'POST', headers: {'X-CSRFToken': csrftoken} });
              const payload = await resp.json();
              if (payload && payload.error) { showToast('error', 'Void failed: ' + payload.error); }
              else showToast('success', 'Invoice voided');
              applyInvoiceFilters();
            } catch (e) { showToast('error', 'Void failed'); }
            hideLoading();
          }

          async function applyInvoiceFilters(resetPage=true){
            if (resetPage) currentPage = 1;
            const params = buildParams();
            if (useAjax) {
              try {
                params.set('as_json','1');
                params.set('page', String(currentPage));
                params.set('page_size', '25');
                const url = window.location.pathname + '?' + params.toString();
                const resp = await fetch(url);
                if (!resp.ok) throw new Error('Fetch failed');
                const payload = await resp.json();
                const items = payload.data || [];
                const meta = payload.meta || {};
                renderInvoiceRows(items, currentPage > 1, meta);
                return;
              } catch (e) {
                console.error('AJAX invoice fetch failed', e);
              }
            }

            // Fallback to client-side filtering when AJAX is not enabled
            const sort = document.getElementById('invSortSelect')?.value || '';
            const card = document.getElementById('invCardSelect')?.value || '';
            const status = document.getElementById('invStatusSelect')?.value || '';
            const month = document.getElementById('invoiceMonthSelect')?.value || '';
            const showArchived = !!document.getElementById('showArchivedToggle')?.checked;
            const table = document.getElementById('invoicesTable');
            if (!table) return;
            const tbody = table.querySelector('tbody');
            if (!tbody) return;
            // exclude the dedicated "no results" row from data rows
            let rows = Array.from(tbody.querySelectorAll('tr:not(#no-results-row)'));

            // Filter rows
            rows.forEach(r => {
              const rCard = (r.getAttribute('data-card') || '').trim();
              const rStatus = (r.getAttribute('data-status') || '').trim().toLowerCase();
              const rCreated = r.getAttribute('data-created') || '';
              const rHidden = r.getAttribute('data-hidden') || '0';
              let show = true;
              if (card) {
                show = show && (rCard === card);
              }
              if (status) {
                show = show && (rStatus === status.toLowerCase());
              }
              // Month filter: compare YYYY-MM
              if (month) {
                try {
                  const d = rCreated ? new Date(rCreated) : null;
                  if (d) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth()+1).padStart(2,'0');
                    const rowKey = `${y}-${m}`;
                    // if month value contains full date or extra text, compare prefix
                    if (month.length >= 7) {
                      show = show && (rowKey === month.substring(0,7));
                    } else {
                      show = show && (rowKey === month);
                    }
                  } else {
                    show = false;
                  }
                } catch (e) { show = show && false; }
              }

              // Show archived toggle: if archived not allowed, hide rows with data-hidden == '1'
              if (!showArchived && String(rHidden) === '1') {
                show = false;
              }
              // animate hide/show via class toggles instead of immediate display:none
              try {
                // cancel any pending hide timeout
                if (r.__hideTimeout) { clearTimeout(r.__hideTimeout); r.__hideTimeout = null; }
                if (show) {
                  // ensure element is in flow then remove hidden class to animate in
                  if (r.style.display === 'none') r.style.display = '';
                  // force reflow before removing class
                  void r.offsetHeight;
                  r.classList.remove('cc-row-hidden');
                } else {
                  // add hidden class to animate out, then set display:none after transition
                  if (!r.classList.contains('cc-row-hidden')) r.classList.add('cc-row-hidden');
                  r.__hideTimeout = setTimeout(()=>{ try{ r.style.display = 'none'; r.__hideTimeout = null; }catch(e){} }, 260);
                }
              } catch (e) { r.style.display = show ? '' : 'none'; }
            });

            // Recompute visible rows for sorting (exclude rows hidden or pending hide)
            rows = rows.filter(r => r.style.display !== 'none' && !r.classList.contains('cc-row-hidden'));

            // show/hide the no-results row
            const noResults = document.getElementById('no-results-row');
            if (noResults) {
              if (rows.length === 0) noResults.classList.remove('hidden'); else noResults.classList.add('hidden');
            }

            // Sorting
            function parseAmount(r){
              const v = r.getAttribute('data-amount') || '0';
              // remove any dollar sign or commas
              return parseFloat(String(v).replace(/[^0-9.-]+/g, '')) || 0;
            }
            function parseCreated(r){
              const v = r.getAttribute('data-created');
              const d = v ? new Date(v) : new Date(0);
              return d.getTime();
            }

            // Support legacy select values: latest/earliest/lowest/highest
            let normalizedSort = sort;
            if (sort === 'latest') normalizedSort = 'date_newest';
            else if (sort === 'earliest') normalizedSort = 'date_oldest';
            else if (sort === 'lowest') normalizedSort = 'amount_asc';
            else if (sort === 'highest') normalizedSort = 'amount_desc';

            if (normalizedSort === 'amount_asc') {
              rows.sort((a,b) => parseAmount(a) - parseAmount(b));
            } else if (normalizedSort === 'amount_desc') {
              rows.sort((a,b) => parseAmount(b) - parseAmount(a));
            } else if (normalizedSort === 'date_newest') {
              rows.sort((a,b) => parseCreated(b) - parseCreated(a));
            } else if (normalizedSort === 'date_oldest') {
              rows.sort((a,b) => parseCreated(a) - parseCreated(b));
            }

            // Re-attach rows in sorted order
            rows.forEach(r => tbody.appendChild(r));
          }

          // Persist filters into localStorage and load them on page load
          const storageKey = 'cc_invoice_filters_{{ org.slug }}';
          function saveFiltersToStorage(){
            try{
              const payload = {
                inv_sort: document.getElementById('invSortSelect')?.value || '',
                inv_card: document.getElementById('invCardSelect')?.value || '',
                inv_status: document.getElementById('invStatusSelect')?.value || '',
                invoice_month: document.getElementById('invoiceMonthSelect')?.value || '',
                show_archived: !!document.getElementById('showArchivedToggle')?.checked,
              };
              localStorage.setItem(storageKey, JSON.stringify(payload));
            }catch(e){/*ignore*/}
          }

          function loadFiltersFromStorage(){
            try{
              const raw = localStorage.getItem(storageKey);
              if (!raw) return false;
              const obj = JSON.parse(raw);
              if (obj.inv_sort) { const s = document.getElementById('invSortSelect'); if (s) s.value = obj.inv_sort; }
              if (obj.inv_card) { const s = document.getElementById('invCardSelect'); if (s) s.value = obj.inv_card; }
              if (obj.inv_status) { const s = document.getElementById('invStatusSelect'); if (s) s.value = obj.inv_status; }
              if (obj.invoice_month) { const s = document.getElementById('invoiceMonthSelect'); if (s) s.value = obj.invoice_month; }
              if (typeof obj.show_archived !== 'undefined') { const s = document.getElementById('showArchivedToggle'); if (s) s.checked = !!obj.show_archived; }
              return true;
            }catch(e){ return false; }
          }

          ['invSortSelect','invCardSelect','invStatusSelect','invoiceMonthSelect','showArchivedToggle'].forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            el.addEventListener('change', ()=>{ saveFiltersToStorage(); applyInvoiceFilters(true); });
          });

          // Load more button
          document.getElementById('invoicesLoadMore')?.addEventListener('click', function(){
            currentPage += 1;
            applyInvoiceFilters(false);
          });

          // On load: try to load saved filters, apply them immediately, then reveal lists
          document.addEventListener('DOMContentLoaded', function(){
            // If saved filters found, load and apply them
            const loaded = loadFiltersFromStorage();
            if (loaded) {
              try{ applyInvoiceFilters(true); }catch(e){ console.error(e); }
            } else {
              try{ applyInvoiceFilters(true); }catch(e){ console.error(e); }
            }
            // Reveal lists now that filtering has been applied (or at least requested)
            const tableEl = document.getElementById('invoicesTable');
            const mobileEl = document.getElementById('invoicesListMobile');
            requestAnimationFrame(()=>{
              if (tableEl) {
                tableEl.classList.remove('cc-hide-until-js');
                tableEl.style.display = '';
              }
              if (mobileEl) {
                mobileEl.classList.remove('cc-hide-until-js');
                // Force mobile list visible on small viewports in case CSS was
                // overridden elsewhere. Use an inline !important fallback when
                // computed style still hides the element.
                try {
                  if (window.matchMedia && window.matchMedia('(max-width: 767px)').matches) {
                    mobileEl.style.display = 'block';
                  } else {
                    mobileEl.style.display = '';
                  }
                  // Diagnostic: if another stylesheet is still forcing display:none
                  const comp = window.getComputedStyle(mobileEl).display;
                  if (comp === 'none' && window.matchMedia && window.matchMedia('(max-width: 767px)').matches) {
                    // Force with important to override other rules only on small viewports
                    mobileEl.style.setProperty('display', 'block', 'important');
                    mobileEl.style.visibility = 'visible';
                    console.warn('billing.manage: invoicesListMobile forced visible for small viewport (computed display was none)');
                  }
                } catch (e) {
                  mobileEl.style.display = '';
                }
              }
            });
          });
          // Also run immediately in case DOMContentLoaded already fired
          applyInvoiceFilters();
        })();
      </script>
      <script>
        // Bind discount card button after DOM ready (button sits later in DOM)
        document.addEventListener('DOMContentLoaded', function(){
          try {
            const btn = document.getElementById('viewDiscountInvoiceBtn');
            if (btn) {
              btn.addEventListener('click', function(){
                const invSection = document.getElementById('invoices-section');
                if (invSection) invSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
              });
            }
          } catch (e) { console.error('bind viewDiscountInvoiceBtn', e); }
        });
      </script>
    {% else %}
      <div class="text-sm text-gray-600">No invoices yet.</div>
    {% endif %}
  </section>

  {# Upcoming Invoice Section #}
  <section class="mb-4" id="upcoming-invoice-section">
    <h2 class="text-xl font-semibold mb-2">Upcoming Invoice</h2>
    {# Always-visible discount card: shows adjusted next charge when a local discount exists #}
    {% if upcoming_invoice_adjusted %}
      <div class="mb-3 p-4 border rounded bg-green-50">
        <div class="flex items-start justify-between">
          <div>
            <div class="text-sm text-green-800 font-semibold">Discount applied to next charge</div>
            <div class="text-2xl font-bold text-green-700 mt-1">${{ upcoming_invoice_adjusted.adjusted|floatformat:2 }} <span class="text-sm text-gray-600">of <s>${{ upcoming_invoice_adjusted.original|floatformat:2 }}</s></span></div>
            <div class="text-sm text-green-700 mt-1">Discount: -${{ upcoming_invoice_adjusted.discount_amount|floatformat:2 }}</div>
            {% if upcoming_invoice and upcoming_invoice.billing_date %}
              <div class="text-xs text-gray-700 mt-1">Next billing date: <strong>{{ upcoming_invoice.billing_date|date:"F j, Y" }}</strong></div>
            {% endif %}
          </div>
          <div class="ml-4">
            <button id="viewDiscountInvoiceBtn" class="px-3 py-2 rounded bg-green-600 text-white hover:bg-green-700">View in Invoices</button>
          </div>
        </div>
      </div>
    {% endif %}
    {% if trial_remaining_seconds %}
      <div class="text-sm text-gray-600">No charges during trial.</div>
    {% elif upcoming_invoice %}
      <div class="text-sm">
        Next charge: <strong>${{ upcoming_invoice.amount_due_dollars|floatformat:2 }}</strong>{% if upcoming_invoice.billing_date %} on <strong>{{ upcoming_invoice.billing_date|date:"F j, Y" }}</strong>{% endif %}
        {% if upcoming_invoice_adjusted %}
          <div class="text-sm text-green-700 mt-1">Discount: -${{ upcoming_invoice_adjusted.discount_amount|floatformat:2 }} — New total: <strong>${{ upcoming_invoice_adjusted.adjusted|floatformat:2 }}</strong></div>
        {% elif applied_discount and not upcoming_invoice %}
          <div class="text-sm text-green-700 mt-1">Discount scheduled: {{ applied_discount.code }} — {{ applied_discount.proration_behavior }}</div>
        {% endif %}
      </div>
    {% else %}
      <div class="text-sm text-gray-600">No upcoming invoice.</div>
    {% endif %}
  </section>

  
</div>

<script src="https://js.stripe.com/v3/"></script>
<script>
(function(){
  const publishableKey = "{{ stripe_publishable_key }}";
  const orgSlug = "{{ org.slug }}";
  const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || getCookie('csrftoken');
  const checkoutStatus = "{{ checkout_status|default:''|escapejs }}";
  const checkoutSubId = "{{ checkout_sub_id|default:''|escapejs }}";

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  // If we just returned from embedded checkout, sync subscription immediately (local dev often has no webhooks).
  (async function(){
    try {
      if (checkoutStatus === 'success') {
        try { showToast('success', 'Payment received — updating subscription…', 4200); } catch(e) {}
      }
      if (checkoutStatus === 'success' && checkoutSubId) {
        await fetch(`/billing/api/bus/${orgSlug}/subscription/sync/${encodeURIComponent(String(checkoutSubId))}/`, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          credentials: 'same-origin',
        });
        // Reload without query params so refreshes show clean URLs and updated plan.
        const cleanUrl = window.location.origin + window.location.pathname;
        window.location.replace(cleanUrl);
      }
    } catch(e) {
      try { console.error('checkout sync failed', e); } catch(err) {}
      try { showToast('error', 'Payment succeeded, but syncing is still processing. Refresh in a moment.', 5200); } catch(e2) {}
    }
  })();

  // Small helper to highlight and briefly pulse an element to draw attention
  function highlightAndPulse(el) {
    if (!el) return;
    const prevOutline = el.style.outline;
    const prevBox = el.style.boxShadow;
    el.style.outline = '3px solid rgba(59,130,246,0.9)';
    el.style.boxShadow = '0 0 12px rgba(59,130,246,0.6)';
    el.scrollIntoView({ behavior: 'smooth', block: 'center' });
    setTimeout(() => {
      el.style.outline = prevOutline || '';
      el.style.boxShadow = prevBox || '';
    }, 3500);
  }

  // Use the global site-wide `showToast(type, message, timeout)` helper
  // defined in the base template. This file previously provided a
  // local message-first wrapper; we've removed it to standardize the
  // signature. If the global helper is not present, callers will need
  // a fallback — however templates extending the base should provide it.

  // showLoading/hideLoading are provided globally by base template

  // Payment Element setup
  const paymentSection = document.getElementById('payment-element');
  if (paymentSection) {
    fetch(`/billing/api/bus/${orgSlug}/payment_method/setup_intent/`, {
      method: 'POST',
      headers: { 'X-CSRFToken': csrftoken }
    }).then(r => r.json()).then(data => {
      const stripe = Stripe(publishableKey);
      const elements = stripe.elements({ clientSecret: data.client_secret });
      const paymentElement = elements.create('payment');
      paymentElement.mount('#payment-element');

      document.getElementById('saveCardBtn').addEventListener('click', async () => {
        const pmStatusEl = document.getElementById('pmStatus');
        pmStatusEl.textContent = 'Saving card...';
        try {
          // Confirm the SetupIntent client-side without redirect so we can capture the
          // resulting payment method id and set it as the customer's default via API.
          const result = await stripe.confirmSetup({
            elements,
            // Provide a return_url for SCA redirects as a fallback. Using
            // `redirect: 'if_required'` prevents unconditional redirects
            // and only redirects when the bank requires it.
            confirmParams: { return_url: window.location.origin + '/bus/' + orgSlug + '/billing/setup_return/' },
            redirect: 'if_required'
          });
          if (result.error) {
            pmStatusEl.textContent = result.error.message || 'Failed to save card.';
            return;
          }

          const setupIntent = result.setupIntent || result;
          const paymentMethodId = setupIntent && setupIntent.payment_method;
          if (!paymentMethodId) {
            pmStatusEl.textContent = 'Saved card, but no payment method id was returned.';
            return;
          }

          // Call backend to set this payment method as the default for invoices
          const resp = await fetch(`/billing/api/bus/${orgSlug}/payment_method/default/`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
            body: JSON.stringify({ payment_method_id: paymentMethodId })
          });

          if (!resp.ok) {
            const txt = await resp.text().catch(() => 'server error');
            pmStatusEl.textContent = 'Card saved but failed to set default: ' + txt;
            return;
          }

          pmStatusEl.textContent = 'Card saved and set as default.';
          showToast('success', 'Card saved and set as default.');

          // Update in-memory default id so the refreshed list shows remove disabled
          defaultPaymentId = paymentMethodId;
          hasDefaultPayment = true;

          // Fetch the fresh list of payment methods and update the UI without reload
          try {
            const listResp = await fetch(`/billing/api/bus/${orgSlug}/payment_method/list/`);
              if (listResp.ok) {
              const payload = await listResp.json();
              const container = document.getElementById('paymentMethodsList');
              if (container) {
                // Rebuild the list inner HTML
                const items = payload.data || [];
                // Update in-memory flag to indicate we have payment methods now
                hasAnyPayment = (items.length > 0);
                let html = '';
                if (items.length === 0) {
                  html = '<div class="text-sm text-gray-600">No payment methods yet.</div>';
                } else {
                  for (const pm of items) {
                    const isDefault = (pm.id === defaultPaymentId);
                    html += `\n  <div class="flex items-center justify-between border rounded px-3 py-2 text-sm" data-pm-id="${pm.id}">\n    <div>**** ${pm.last4} — ${pm.brand || ''} exp ${pm.exp_month}/${pm.exp_year}`;
                    if (isDefault) html += ` <span class="ml-2 text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">Default</span>`;
                    html += `</div>\n    <div class="flex gap-2">`;
                    if (!isDefault) {
                      html += `<button class="set-default-btn text-xs px-2 py-1 rounded bg-gray-200 hover:bg-gray-300" data-id="${pm.id}">Set Default</button>`;
                    }
                    if (isDefault) {
                      html += `<button class="delete-pm-btn text-xs px-2 py-1 rounded bg-red-100 text-red-700 opacity-50 cursor-not-allowed" disabled title="Default payment method — add another card before removing">Remove</button>`;
                      html += `<span class="text-xs text-gray-500 italic ml-2 block sm:inline">Default payment method — add another card before removing.</span>`;
                    } else {
                      html += `<button class="delete-pm-btn text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200" data-id="${pm.id}">Remove</button>`;
                    }
                    html += `</div>\n  </div>`;
                  }
                }
                container.innerHTML = html;

                // Re-bind event handlers for the new buttons
                document.querySelectorAll('.set-default-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                    const pmId = btn.getAttribute('data-id');
                    fetch(`/billing/api/bus/${orgSlug}/payment_method/default/`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                      body: JSON.stringify({ payment_method_id: pmId })
                    }).then(r => r.json()).then(() => {
                      showToast('success', 'Default payment method updated.');
                      setTimeout(()=> window.location.reload(), 700);
                    });
                  });
                });

                document.querySelectorAll('.delete-pm-btn').forEach(btn => {
                  btn.addEventListener('click', () => {
                    const pmId = btn.getAttribute('data-id');
                    if (!confirm('Remove this payment method?')) return;
                    fetch(`/billing/api/bus/${orgSlug}/payment_method/delete/`, {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                      body: JSON.stringify({ payment_method_id: pmId })
                    })
                      .then(r => { if (!r.ok) throw new Error('Delete failed'); return r.json(); })
                      .then(() => { showToast('info', 'Payment method removed.'); setTimeout(()=> window.location.reload(),700); })
                      .catch(err => showToast('error', 'Delete failed: ' + err.message));
                  });
                });
              }
            }
          } catch (err) {
            // ignore refresh errors, still show success
          }
        } catch (err) {
          pmStatusEl.textContent = err && err.message ? err.message : 'Unexpected error saving card.';
        }
      });
    });
  }
  // Delegate invoice action clicks so dynamically-rendered rows always work
  document.addEventListener('click', function(e){
    const hideBtn = e.target.closest && e.target.closest('.hide-inv-btn');
    if (hideBtn) {
      e.preventDefault();
      (async function(){
        const invId = hideBtn.getAttribute('data-inv-id');
        if (!invId) return;
        if (!confirm('Hide this invoice from the UI?')) return;
        try { showLoading(); } catch (e) {}
        try {
          const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/hide/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
          if (!resp.ok) throw new Error('Hide failed');
          try { showToast('info', 'Invoice hidden'); } catch(e){}
          try { applyInvoiceFilters(); } catch(e) { /* fallback: hide row */ const row=document.querySelector(`tr[data-inv-id="${invId}"]`); if(row) row.style.display='none'; }
        } catch (err) {
          try { showToast('error', 'Failed to hide invoice.'); } catch(e){}
        } finally { try { hideLoading(); } catch(e){} }
      })();
      return;
    }

    const unhideBtn = e.target.closest && e.target.closest('.unhide-inv-btn');
    if (unhideBtn) {
      e.preventDefault();
      (async function(){
        const invId = unhideBtn.getAttribute('data-inv-id');
        if (!invId) return;
        if (!confirm('Unhide this invoice?')) return;
        try { showLoading(); } catch (e) {}
        try {
          const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/unhide/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
          if (!resp.ok) throw new Error('Unhide failed');
          // Refresh visible rows via the same client-side filtering so the UI state stays consistent
          try { applyInvoiceFilters(); } catch(e) { /* fallback: show row */ const row=document.querySelector(`tr[data-inv-id="${invId}"]`); if(row) { row.style.display=''; row.classList.remove('cc-row-hidden'); } }
          try { showToast('success', 'Invoice unhidden'); } catch(e){}
        } catch (err) {
          try { showToast('error', 'Failed to unhide invoice.'); } catch(e){}
        } finally { try { hideLoading(); } catch(e){} }
      })();
      return;
    }

    const voidBtn = e.target.closest && e.target.closest('.void-inv-btn');
    if (voidBtn) {
      e.preventDefault();
      (async function(){
        const invId = voidBtn.getAttribute('data-inv-id');
        if (!invId) return;
        if (!confirm('Void this invoice in Stripe? This cannot be undone.')) return;
        try { showLoading(); } catch (e) {}
        try {
          const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/void/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
          const payload = await resp.json().catch(()=> ({}));
          if (!resp.ok) { try{ showToast('error', payload.error || 'Failed to void invoice'); }catch(e){} }
          else {
            const row = document.querySelector(`tr[data-inv-id="${invId}"]`);
            if (row) {
              row.setAttribute('data-status','voided');
              const tds = row.querySelectorAll('td');
              if (tds && tds.length >= 4) tds[3].innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-red-100 text-red-700 text-sm">Voided</span>';
            }
            try { showToast('success', 'Invoice voided.'); } catch(e){}
          }
        } catch (err) {
          try { showToast('error', 'Failed to void invoice.'); } catch(e){}
        } finally { try { hideLoading(); } catch(e){} }
      })();
      return;
    }
  });

  // Subscription-change modal handler
  function populateSubscriptionChangeFields(data) {
    try {
      document.getElementById('sc-type').textContent = (data.changeType || '').replace(/_/g, ' ').toUpperCase();
      document.getElementById('sc-new-plan').textContent = data.newPlanName || '—';
      const eff = data.effectiveAt ? new Date(data.effectiveAt) : null;
      document.getElementById('sc-effective').textContent = eff ? eff.toLocaleString() : '—';
      document.getElementById('sc-amount').textContent = formatMoney(data.amountCents || 0);
      if (data.cardBrand || data.cardLast4) {
        document.getElementById('sc-card').textContent = `${data.cardBrand || ''} **** ${data.cardLast4 || ''}`;
        document.getElementById('sc-card-row').style.display = 'block';
      } else {
        document.getElementById('sc-card-row').style.display = 'none';
      }
      if (data.stripeInvoiceId) {
        const link = document.getElementById('sc-invoice-link');
        link.href = `https://dashboard.stripe.com/invoices/${data.stripeInvoiceId}`;
        link.textContent = data.stripeInvoiceId;
        document.getElementById('sc-invoice-row').style.display = 'block';
      } else {
        document.getElementById('sc-invoice-row').style.display = 'none';
      }
      document.getElementById('sc-status').textContent = data.status || '';
    } catch (e) {
      console.error('populateSubscriptionChangeFields error', e);
    }
  }

  function formatMoney(cents) {
    try {
      const v = Number(cents) / 100.0;
      return '$' + v.toFixed(2);
    } catch (e) {
      return '$0.00';
    }
  }

  function openSubscriptionChangeModal(data) {
    const modal = document.getElementById('subscription-change-modal');
    if (!modal) return;
    document.getElementById('sc-type').textContent = (data.changeType || '').replace(/_/g, ' ').toUpperCase();
    document.getElementById('sc-new-plan').textContent = data.newPlanName || '—';
    const eff = data.effectiveAt ? new Date(data.effectiveAt) : null;
    document.getElementById('sc-effective').textContent = eff ? eff.toLocaleString() : '—';
    document.getElementById('sc-amount').textContent = formatMoney(data.amountCents || 0);
    if (data.cardBrand || data.cardLast4) {
      document.getElementById('sc-card').textContent = `${data.cardBrand || ''} **** ${data.cardLast4 || ''}`;
      document.getElementById('sc-card-row').style.display = 'block';
    } else {
      document.getElementById('sc-card-row').style.display = 'none';
    }
    if (data.stripeInvoiceId) {
      const link = document.getElementById('sc-invoice-link');
      link.href = `https://dashboard.stripe.com/invoices/${data.stripeInvoiceId}`;
      link.textContent = data.stripeInvoiceId;
      document.getElementById('sc-invoice-row').style.display = 'block';
    } else {
      document.getElementById('sc-invoice-row').style.display = 'none';
    }
    document.getElementById('sc-status').textContent = data.status || '';
    // store the current change id and status on modal for later actions
    modal.dataset.currentChangeId = data.changeId || '';
    modal.dataset.currentChangeStatus = data.status || '';
    // show/hide cancel button when scheduled
    const cancelBtn = document.getElementById('sc-cancel-btn');
    if (cancelBtn) {
      if ((data.status || '').toLowerCase() === 'scheduled') {
        cancelBtn.classList.remove('hidden');
      } else {
        cancelBtn.classList.add('hidden');
      }
    }
    modal.classList.remove('hidden');
    modal.classList.add('flex');
  }

  function closeSubscriptionChangeModal() {
    const modal = document.getElementById('subscription-change-modal');
    if (!modal) return;
    modal.classList.remove('flex');
    modal.classList.add('hidden');
  }

  document.addEventListener('click', function(e){
    const btn = e.target.closest('.view-change-btn');
    if (!btn) return;
    const data = {
      changeId: btn.getAttribute('data-change-id'),
      changeType: btn.getAttribute('data-change-type'),
      newPlanName: btn.getAttribute('data-new-plan-name'),
      effectiveAt: btn.getAttribute('data-effective-at'),
      amountCents: parseInt(btn.getAttribute('data-amount-cents') || '0', 10),
      cardBrand: btn.getAttribute('data-card-brand'),
      cardLast4: btn.getAttribute('data-card-last4'),
      stripeInvoiceId: btn.getAttribute('data-stripe-invoice-id'),
      status: btn.getAttribute('data-status') || ''
    };
    openSubscriptionChangeModal(data);
  });

  document.getElementById('sc-close')?.addEventListener('click', closeSubscriptionChangeModal);
  document.getElementById('sc-close-2')?.addEventListener('click', closeSubscriptionChangeModal);
  // Cancel scheduled change button handler
  document.getElementById('sc-cancel-btn')?.addEventListener('click', async function(){
    const modal = document.getElementById('subscription-change-modal');
    if (!modal) return;
    const changeId = modal.dataset.currentChangeId;
    if (!changeId) return;
    if (!confirm('Cancel this scheduled change?')) return;
    try {
      showLoading();
      const resp = await fetch(`/billing/api/bus/${orgSlug}/subscription/cancel_scheduled/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/json' },
      });
      if (!resp.ok) {
        const txt = await resp.text().catch(()=> 'error');
        showToast('error', 'Failed to cancel scheduled change: ' + txt);
        hideLoading();
        return;
      }
      const payload = await resp.json().catch(()=> ({}));
      showToast('success', 'Scheduled change cancelled');
      // Update the corresponding invoice row in the table if present
      const row = document.querySelector(`tr[data-inv-id="${changeId}"]`);
      if (row) {
        row.setAttribute('data-status', 'cancelled');
        // update status cell (4th td)
        const tds = row.querySelectorAll('td');
        if (tds && tds.length >= 4) {
          tds[3].innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-gray-200 text-gray-800 text-sm">Cancelled</span>';
          // also update action cell (last) to show —
          tds[4].innerHTML = '—';
          // update card column badge
          if (tds.length >= 3) {
            tds[2].innerHTML = '<span class="inline-flex items-center px-2 py-0.5 rounded bg-gray-100 text-gray-700 text-xs">Cancelled</span>';
          }
        }
      }
      closeSubscriptionChangeModal();
      hideLoading();
    } catch (e) {
      hideLoading();
      showToast('error', 'Failed to cancel scheduled change');
    }
  });

  // Set default payment method
  document.querySelectorAll('.set-default-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pmId = btn.getAttribute('data-id');
      showLoading();
      fetch(`/billing/api/bus/${orgSlug}/payment_method/default/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ payment_method_id: pmId })
      }).then(r => r.json()).then(() => { hideLoading(); window.location.reload(); }).catch(()=> { hideLoading(); window.location.reload(); });
    });
  });

  // Delete payment method
  document.querySelectorAll('.delete-pm-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const pmId = btn.getAttribute('data-id');
      if (!confirm('Remove this payment method?')) return;
      showLoading();
      fetch(`/billing/api/bus/${orgSlug}/payment_method/delete/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify({ payment_method_id: pmId })
      })
        .then(r => {
          if (!r.ok) {
            return r.text().then(t => { throw new Error(t); });
          }
          return r.json();
        })
        .then(() => { hideLoading(); window.location.reload(); })
                    .catch(err => { hideLoading(); showToast('error', 'Delete failed: ' + err.message); });
    });
  });

  // Hide invoice action
  document.querySelectorAll('.hide-inv-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const invId = btn.getAttribute('data-inv-id');
      if (!confirm('Hide this invoice from the UI?')) return;
      showLoading();
      try {
        const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/hide/`, {
          method: 'POST', headers: { 'X-CSRFToken': csrftoken }
        });
        if (!resp.ok) throw new Error('Failed');
        // Hide the row in the table
        const row = document.querySelector(`tr[data-inv-id="${invId}"]`);
        if (row) row.style.display = 'none';
        showToast('info', 'Invoice hidden.');
      } catch (e) {
        showToast('error', 'Failed to hide invoice.');
      } finally { hideLoading(); }
    });
  });

  // Void invoice action
  document.querySelectorAll('.void-inv-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const invId = btn.getAttribute('data-inv-id');
      if (!confirm('Void this invoice in Stripe? This cannot be undone.')) return;
      showLoading();
      try {
        const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/void/`, {
          method: 'POST', headers: { 'X-CSRFToken': csrftoken }
        });
        const payload = await resp.json().catch(()=> ({}));
        if (!resp.ok) {
          showToast('error', payload.error || 'Failed to void invoice');
        } else {
          // Mark row as voided visually
          const row = document.querySelector(`tr[data-inv-id="${invId}"]`);
          if (row) {
            row.setAttribute('data-status', 'voided');
            const tds = row.querySelectorAll('td');
            if (tds && tds.length >= 4) {
              tds[3].innerHTML = '<span class="inline-flex items-center px-2 py-1 rounded bg-red-100 text-red-700 text-sm">Voided</span>';
            }
          }
          showToast('success', 'Invoice voided.');
        }
      } catch (e) {
        showToast('error', 'Failed to void invoice.');
      } finally { hideLoading(); }
    });
  });

  // Unhide invoice action (only shown when viewing archived)
  document.querySelectorAll('.unhide-inv-btn').forEach(btn => {
    btn.addEventListener('click', async () => {
      const invId = btn.getAttribute('data-inv-id');
      if (!confirm('Unhide this invoice?')) return;
      showLoading();
      try {
        const resp = await fetch(`/billing/api/bus/${orgSlug}/invoice/${invId}/unhide/`, {
          method: 'POST', headers: { 'X-CSRFToken': csrftoken }
        });
        if (!resp.ok) throw new Error('Failed');
        const row = document.querySelector(`tr[data-inv-id="${invId}"]`);
        if (row) row.style.display = 'none';
        showToast('Invoice unhidden.', 'success');
      } catch (e) {
        showToast('Failed to unhide invoice.', 'error');
      } finally { hideLoading(); }
    });
  });

  // Cancel/reactivate subscription
  const cancelBtn = document.getElementById('cancelBtn');
  if (cancelBtn) cancelBtn.addEventListener('click', () => {
    showLoading();
    fetch(`/billing/api/bus/${orgSlug}/subscription/cancel/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
      .then(() => { hideLoading(); window.location.reload(); }).catch(()=> { hideLoading(); window.location.reload(); });
  });
  const reactivateBtn = document.getElementById('reactivateBtn');
  if (reactivateBtn) reactivateBtn.addEventListener('click', () => {
    showLoading();
    fetch(`/billing/api/bus/${orgSlug}/subscription/reactivate/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
      .then(() => { hideLoading(); window.location.reload(); }).catch(()=> { hideLoading(); window.location.reload(); });
  });
  const immediateCancelBtn = document.getElementById('immediateCancelBtn');
  if (immediateCancelBtn) immediateCancelBtn.addEventListener('click', () => {
    const isTrial = immediateCancelBtn.getAttribute('data-is-trial') === 'true';
    // Helper modal for immediate-cancel choices
    function openImmediateCancelModal(selectedPlan, hasPaymentMethod) {
      const overlay = document.createElement('div');
      overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';

      const box = document.createElement('div');
      box.className = 'bg-white rounded-lg shadow-lg p-6 max-w-lg w-full text-center';

      const title = document.createElement('div');
      title.className = 'text-lg font-semibold mb-2';
      title.textContent = 'End Trial — Choose an action';
      box.appendChild(title);

      const msg = document.createElement('div');
      msg.className = 'mb-4 text-sm text-gray-800';
      msg.textContent = 'Would you like to immediately cancel your trial and delete your account, or convert your trial to a paid subscription now?';
      box.appendChild(msg);

      const btnRow = document.createElement('div');
      btnRow.className = 'flex justify-center gap-3 mt-4';

      const deleteBtn = document.createElement('button');
      deleteBtn.className = 'px-4 py-2 bg-red-600 text-white rounded';
      deleteBtn.textContent = 'Delete account and cancel';
      deleteBtn.onclick = async function() {
        try {
          // call account delete endpoint
          const resp = await fetch('/accounts/delete/', { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
          if (!resp.ok) {
            const txt = await resp.text().catch(()=>null);
            throw new Error(txt || 'Failed to delete account');
          }
          // successful delete will redirect (server side); but ensure we navigate
          window.location.href = '/';
        } catch (e) {
          showToast('Failed to delete account: ' + (e && e.message ? e.message : String(e)), 'error');
        }
      };

      const convertBtn = document.createElement('button');
      convertBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded';
      convertBtn.textContent = 'Convert to selected plan';
      convertBtn.onclick = function() {
        document.body.removeChild(overlay);
        // If no plan selected, send user to the Change Plan section
        if (!selectedPlan) {
          const changePlanSection = document.getElementById('change-plan-section');
          if (changePlanSection) {
            changePlanSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
            changePlanSection.style.border = '2px solid #3b82f6';
            setTimeout(() => { changePlanSection.style.border = ''; }, 3000);
          }
          return;
        }
        // If plan selected but no payment method, prompt to add one
        if (!hasPaymentMethod) {
          showToast('Please add a payment method first before converting your trial to a paid subscription. Scroll down to the "Add / Update Card" section.', 'info', 6000);
          const pmSection = document.getElementById('payment-method-section');
          if (pmSection) highlightAndPulse(pmSection);
          return;
        }
        // Otherwise, proceed with preview flow like Update Plan
        try { window.__ccTrialImmediate = true; } catch (e) {}
        const query = new URLSearchParams();
        query.set('start_immediately', 'true');
        fetch(`/billing/api/bus/${orgSlug}/subscription/preview_change/${selectedPlan}/?` + query.toString(), { method: 'GET', headers: { 'X-CSRFToken': csrftoken } })
          .then(async r => { if (!r.ok) { const txt = await r.text().catch(()=> 'server error'); throw new Error(txt || 'preview failed'); } return r.json(); })
          .then(preview => openPreviewModal(preview, selectedPlan))
          .catch(err => showToast('Preview failed: ' + err.message, 'error'));
      };

      const cancelBtn = document.createElement('button');
      cancelBtn.className = 'px-4 py-2 bg-gray-200 rounded';
      cancelBtn.textContent = 'Close';
      cancelBtn.onclick = function(){ document.body.removeChild(overlay); };

      btnRow.appendChild(deleteBtn);
      btnRow.appendChild(convertBtn);
      btnRow.appendChild(cancelBtn);
      box.appendChild(btnRow);
      overlay.appendChild(box);
      document.body.appendChild(overlay);
    }

    if (isTrial) {
      const planSelect = document.getElementById('changePlanSelect');
      const selectedPlan = planSelect ? planSelect.value : null;
      const hasPaymentMethod = !!document.querySelector('#paymentMethodsList [data-pm-id]');
      openImmediateCancelModal(selectedPlan, hasPaymentMethod);
    } else {
      // Regular immediate cancel for active subscription
      if(!confirm('Immediate cancel will terminate access now. Continue?')) return;
      fetch(`/billing/api/bus/${orgSlug}/subscription/cancel/`, { 
        method: 'POST', 
        headers: { 
          'X-CSRFToken': csrftoken,
          'Content-Type': 'application/json'
        }, 
        body: JSON.stringify({ immediate: true })
      })
        .then(r => {
          if (!r.ok) {
            return r.text().then(t => { throw new Error(t); });
          }
          return r.json();
        })
        .then(() => window.location.reload())
        .catch(err => showToast('Cancel failed: ' + err.message, 'error'));
    }
  });

  // Cancel scheduled plan change
  const cancelScheduledBtn = document.getElementById('cancelScheduledBtn');
  if (cancelScheduledBtn) cancelScheduledBtn.addEventListener('click', () => {
    if (!confirm('Cancel the scheduled plan change?')) return;
    fetch(`/billing/api/bus/${orgSlug}/subscription/cancel_scheduled/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }})
      .then(async (r) => {
        if (!r.ok) {
          const txt = await r.text().catch(() => 'server error');
          throw new Error(txt || 'failed');
        }
        return r.json();
      })
      .then(() => { showToast('Scheduled change cancelled.', 'success'); setTimeout(()=>window.location.reload(),600); })
      .catch(err => showToast('Failed to cancel: ' + err.message, 'error'));
  });

  // Small helper to show a styled confirm modal for trial -> immediate start
  function openTrialConfirmModal(onConfirm, onCancel) {
    // Create overlay
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
    overlay.id = 'cc-trial-confirm-overlay';

    const box = document.createElement('div');
    box.className = 'bg-white rounded-lg shadow-lg p-6 max-w-md w-full text-center';

    const msg = document.createElement('div');
    msg.className = 'mb-4 text-sm text-gray-800';
    msg.textContent = 'You are currently on a trial. Click Confirm to end the trial and start the selected plan immediately (you will be billed), or Cancel to wait until the trial ends to begin the new plan.';
    box.appendChild(msg);

    const btnRow = document.createElement('div');
    btnRow.className = 'flex justify-end gap-3';

    const cancelBtn = document.createElement('button');
    cancelBtn.className = 'px-4 py-2 bg-gray-200 rounded';
    cancelBtn.textContent = 'Cancel';
    cancelBtn.onclick = function(){
      document.body.removeChild(overlay);
      try { onCancel && onCancel(); } catch(e) { console.error(e); }
    };

    const okBtn = document.createElement('button');
    okBtn.className = 'px-4 py-2 bg-blue-600 text-white rounded';
    okBtn.textContent = 'Confirm';
    okBtn.onclick = function(){
      document.body.removeChild(overlay);
      try { onConfirm && onConfirm(); } catch(e) { console.error(e); }
    };

    btnRow.appendChild(cancelBtn);
    btnRow.appendChild(okBtn);
    box.appendChild(btnRow);
    overlay.appendChild(box);
    document.body.appendChild(overlay);

    // close on Escape
    function onKey(e){ if (e.key === 'Escape') { if (document.body.contains(overlay)) document.body.removeChild(overlay); document.removeEventListener('keydown', onKey); onCancel && onCancel(); } }
    document.addEventListener('keydown', onKey);
  }


  // Change plan
  const changePlanBtn = document.getElementById('changePlanBtn');
  let hasDefaultPayment = {{ default_payment_method_id|yesno:"true,false" }};
  let hasAnyPayment = {{ has_payment_methods|yesno:"true,false" }};
  let defaultPaymentId = "{{ default_payment_method_id|default:''|escapejs }}";
  const subscriptionActive = {{ subscription.active|yesno:"true,false"|default:'false' }};
  const subscriptionStatus = "{{ subscription.status|default:"" }}";
  if (changePlanBtn) changePlanBtn.addEventListener('click', () => {
    const planId = document.getElementById('changePlanSelect').value;
    if (!planId) return;

    // If there are no payment methods at all, prompt user to add one first
    if (!hasAnyPayment) {
      showToast('Please add a payment method before updating your subscription. You can add a card in the "Add / Update Card" box below.', 'info', 6000);
      const pmSection = document.getElementById('payment-method-section');
      if (pmSection) highlightAndPulse(pmSection);
      return;
    }

    // Before changing, preview prorations via the server so we can show a
    // confirmation modal when an immediate charge will occur.
    fetch(`/billing/api/bus/${orgSlug}/subscription/preview_change/${planId}/`, {
      method: 'GET',
      headers: { 'X-CSRFToken': csrftoken }
    })
      .then(async r => {
        if (!r.ok) {
          const txt = await r.text().catch(() => 'server error');
          throw new Error(txt || 'preview failed');
        }
        return r.json();
      })
      .then(preview => {
        // Decide whether this will bill immediately (amount_due > 0)
        const amount = Number(preview.amount_due_dollars || 0);
        const billingDate = preview.billing_date || null;

        // If trialing, ask whether to start immediately or wait using a modal
        // instead of the native confirm dialog so we can style it consistently.
        if (subscriptionStatus.toLowerCase() === 'trialing') {
          openTrialConfirmModal(
            // onConfirm -> start immediately
            function() {
              // mark that the user requested immediate start from trial
              window.__ccTrialImmediate = true;
              // Request preview that includes start_immediately to show full price now.
              const query = new URLSearchParams();
              query.set('start_immediately', 'true');
              fetch(`/billing/api/bus/${orgSlug}/subscription/preview_change/${planId}/?` + query.toString(), {
                method: 'GET',
                headers: { 'X-CSRFToken': csrftoken }
              })
                .then(async r => { if (!r.ok) { const txt = await r.text().catch(()=>'server error'); throw new Error(txt||'preview failed'); } return r.json(); })
                .then(preview2 => openPreviewModal(preview2, planId))
                .catch(err => showToast('Preview failed: ' + err.message, 'error'));
            },
            // onCancel -> schedule change after trial
            function() {
              window.__ccTrialImmediate = false;
              return fetch(`/billing/api/bus/${orgSlug}/subscription/change_plan/${planId}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ start_immediately: false })
              }).then(r => { if (!r.ok) throw new Error('Schedule failed'); return r.json(); }).then(p => { if (p && p.message) showToast(p.message,'info'); setTimeout(()=>window.location.reload(),500); });
            }
          );
          return; // we've handled the trial flow via the modal
        }

        // If the preview indicates an immediate charge, show a confirmation
        // If user chose to start immediately from trial, request a preview
        // that includes start_immediately so server simulates the first charge.
        // Populate and open modal with preview breakdown. Confirm button will proceed.
        openPreviewModal(preview, planId);
      })
        .catch(err => showToast('Preview failed: ' + err.message, 'error'));
  });

  // Trial countdown
  const trialSeconds = {{ trial_remaining_seconds|default:"null" }};
  const trialEndIso = "{{ trial_end_iso|default:"" }}";
  if (trialSeconds && (document.getElementById('trialCountdown') || document.getElementById('trialSummary'))) {
    const el = document.getElementById('trialCountdown');
    const summaryEl = document.getElementById('trialSummary');
    function fmt(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400)/3600);
      const m = Math.floor((seconds % 3600)/60);
      const s = seconds % 60;
      let parts = [];
      if (d>0) parts.push(d + 'd');
      parts.push(String(h).padStart(2,'0') + 'h');
      parts.push(String(m).padStart(2,'0') + 'm');
      parts.push(String(s).padStart(2,'0') + 's');
      return parts.join(' ');
    }
    let remain = trialSeconds;
    const render = function(){
      const txt = fmt(remain);
      if (el) el.textContent = txt;
      if (summaryEl) summaryEl.textContent = txt;
    };
    render();
    const timer = setInterval(()=>{
      remain -= 1;
      if (remain <= 0) {
        clearInterval(timer);
        if (el) el.textContent = 'ending...';
        if (summaryEl) summaryEl.textContent = 'ending...';
        window.location.reload();
      } else {
        render();
      }
    },1000);
  }

  // Next charge / period end countdown (non-trial)
  const nextBillingIso = "{{ next_billing_iso|default:"" }}";
  if (!trialSeconds && nextBillingIso && document.getElementById('nextChargeCountdown')) {
    const el = document.getElementById('nextChargeCountdown');
    function fmt(seconds) {
      const d = Math.floor(seconds / 86400);
      const h = Math.floor((seconds % 86400)/3600);
      const m = Math.floor((seconds % 3600)/60);
      const s = seconds % 60;
      let parts = [];
      if (d>0) parts.push(d + 'd');
      parts.push(String(h).padStart(2,'0') + 'h');
      parts.push(String(m).padStart(2,'0') + 'm');
      parts.push(String(s).padStart(2,'0') + 's');
      return parts.join(' ');
    }
    function parseIso(s) {
      try {
        const d = new Date(s);
        if (!isNaN(d.getTime())) return d;
      } catch (e) {}
      return null;
    }
    const target = parseIso(nextBillingIso);
    if (target) {
      function tick(){
        const now = new Date();
        const diff = Math.floor((target.getTime() - now.getTime()) / 1000);
        if (diff <= 0) {
          el.textContent = 'due soon';
          return false;
        }
        el.textContent = fmt(diff);
        return true;
      }
      tick();
      const timer = setInterval(function(){
        const ok = tick();
        if (!ok) clearInterval(timer);
      }, 1000);
    }
  }
})();
</script>
<script>
// Modal helpers for preview
function openPreviewModal(preview, planId) {
  // Ensure we have CSRF token and org slug available in this scope
  const csrftoken = (function(){
    const el = document.querySelector('[name=csrfmiddlewaretoken]');
    if (el && el.value) return el.value;
    const name = 'csrftoken';
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i=0;i<cookies.length;i++){
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length+1) === (name + '=')) {
          return decodeURIComponent(cookie.substring(name.length+1));
        }
      }
    }
    return '';
  })();
  const orgSlug = "{{ org.slug }}";

  const modal = document.getElementById('cc-preview-modal');
  // Track whether this preview was requested as an immediate trial conversion
  modal.dataset.fromTrialImmediate = window.__ccTrialImmediate ? 'true' : 'false';
  // clear the transient flag so subsequent actions are not affected
  window.__ccTrialImmediate = false;
  const linesContainer = document.getElementById('cc-preview-lines');
  linesContainer.innerHTML = '';

  // Only render immediate/proration lines on the left
  const prorationLines = preview.proration_lines || [];

  const imHeader = document.createElement('div');
  imHeader.className = 'text-sm font-medium mb-2';
  imHeader.textContent = 'Immediate charges (prorations & pending items)';
  linesContainer.appendChild(imHeader);

  if (prorationLines.length === 0) {
    const d = document.createElement('div'); d.className = 'text-sm text-gray-600'; d.textContent = 'No immediate charge.'; linesContainer.appendChild(d);
  } else {
    for (const ln of prorationLines) {
      const div = document.createElement('div');
      div.className = 'flex justify-between';
      div.innerHTML = `<div>${ln.description || 'Proration' }${ln.quantity ? ' x'+ln.quantity : ''}</div><div>$${(Number(ln.amount)||0).toFixed(2)}</div>`;
      linesContainer.appendChild(div);
    }
  }

  // Compute immediate/proration total from the displayed proration lines using
  // integer cents to avoid floating point rounding differences.
  const prorationTotalCents = prorationLines.reduce((sum, ln) => sum + Math.round((Number(ln.amount) || 0) * 100), 0);
  const prorationTotal = prorationTotalCents / 100.0;
  // Insert total below the immediate charges (left column) and left-align it
  const totalLeftDiv = document.createElement('div');
  // Make this a row with label left and amount right
  totalLeftDiv.className = 'mt-3 font-semibold flex justify-between items-center';
  totalLeftDiv.id = 'cc-preview-total-left';
  const totalLabel = document.createElement('div');
  totalLabel.textContent = 'Immediate due:';
  const totalAmt = document.createElement('div');
  totalAmt.className = 'font-bold text-right';
  totalAmt.textContent = '$' + prorationTotal.toFixed(2);
  totalLeftDiv.appendChild(totalLabel);
  totalLeftDiv.appendChild(totalAmt);
  linesContainer.appendChild(totalLeftDiv);

  // Format billing date to MM-DD-YYYY and 12-hour time (AM/PM) without a
  // space before AM/PM (e.g. 01-04-2026 08:26PM)
  function formatBillingDate(raw) {
    if (!raw) return '';
    const m = raw.match(/^(\d{4})-(\d{2})-(\d{2})[ T](\d{2}):(\d{2}):(\d{2})/);
    if (!m) return raw;
    const y = parseInt(m[1],10), mo = parseInt(m[2],10)-1, d = parseInt(m[3],10);
    let hh = parseInt(m[4],10), mm = parseInt(m[5],10);
    const ampm = hh >= 12 ? 'PM' : 'AM';
    const hour12 = ((hh + 11) % 12) + 1;
    const dd = String(d).padStart(2,'0');
    const month = String(mo+1).padStart(2,'0');
    const datePart = `${month}-${dd}-${y}`;
    const timePart = `${String(hour12).padStart(2,'0')}:${String(mm).padStart(2,'0')}${ampm}`;
    return `${datePart} ${timePart}`;
  }

  // Create and append a billing-date row below the immediate total: label left, date right
  const billingRow = document.createElement('div');
  billingRow.className = 'mt-1 flex justify-between items-center text-xs text-gray-500';
  const billingLabel = document.createElement('div');
  billingLabel.textContent = 'Next Billing Date';
  const billingValue = document.createElement('div');
  billingValue.id = 'cc-preview-billing-date';
  billingValue.textContent = preview.billing_date ? formatBillingDate(preview.billing_date) : '';
  billingRow.appendChild(billingLabel);
  billingRow.appendChild(billingValue);
  linesContainer.appendChild(billingRow);

  modal.dataset.planId = planId;
  // Populate the subscription-change fields live so the modal shows current preview info
  try {
    // Attempt to derive plan name from the select if available
    let planName = '';
    try { const sel = document.getElementById('changePlanSelect'); if (sel) planName = sel.querySelector(`option[value="${planId}"]`)?.textContent || ''; } catch(e) {}
    const changeData = {
      changeType: 'preview',
      newPlanName: planName || '',
      effectiveAt: preview.billing_date || null,
      amountCents: Math.round((Number(preview.amount_due_dollars || 0) || 0) * 100),
      cardBrand: null,
      cardLast4: null,
      stripeInvoiceId: (preview.raw && preview.raw.id) || null,
      status: 'preview'
    };
    populateSubscriptionChangeFields(changeData);
  } catch (e) { console.error('populate sc from preview', e); }
  modal.classList.remove('hidden');
  modal.classList.add('flex');

  document.getElementById('cc-preview-cancel').onclick = function(){ closePreviewModal(); };
  document.getElementById('cc-preview-confirm').onclick = function(){
    const pid = modal.dataset.planId;
    showLoading();
    fetch(`/billing/api/bus/${orgSlug}/subscription/change_plan/${pid}/`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
      body: JSON.stringify({ start_immediately: true })
    })
      .then(async (r) => {
        if (!r.ok) {
          const text = await r.text().catch(()=>null);
          throw new Error(text || 'Failed to change plan');
        }
        return r.json();
      })
      .then((payload) => {
        hideLoading();
        closePreviewModal();
        // If the server returned invoice details, surface them to the user
            if (payload && payload.invoice) {
          try {
            const inv = payload.invoice;
            const amt = (Number(inv.amount_paid || inv.amount_due || 0) / 100.0).toFixed(2);
            const brand = inv.card_brand || '';
            const last4 = inv.card_last4 ? ' ****' + inv.card_last4 : '';
            const msg = `Charged $${amt} to ${brand}${last4}`;
            showToast(msg, 'success');
          } catch (e) {
            // ignore presentation errors
          }
        } else if (payload && payload.message) {
          // Suppress the info toast when this change was initiated by a
          // trial-user choosing to start immediately (one-off behavior).
          const fromTrial = modal.dataset.fromTrialImmediate === 'true';
          if (!fromTrial) showToast(payload.message, 'info');
        }
        setTimeout(()=>window.location.reload(), 500);
      })
        .catch(err => { hideLoading(); closePreviewModal(); showToast('Update failed: ' + (err && err.message ? err.message : String(err)), 'error'); });
  };
}

function closePreviewModal(){
  const modal = document.getElementById('cc-preview-modal');
  modal.classList.remove('flex');
  modal.classList.add('hidden');
}
</script>
{% endblock %}
